<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vibing</title>
    <style>
      :root {
        --bg: #0f1221;
        --fg: #e6e8f0;
        --muted: #9aa3b2;
        --accent: #8b5cf6;
      }
      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--fg);
        background: radial-gradient(1200px 800px at 70% 10%, #1b1f3a, var(--bg));
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        width: min(720px, 92vw);
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px;
        padding: 28px 24px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        backdrop-filter: blur(6px);
      }
      h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
        letter-spacing: 0.3px;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 18px;
      }
      #content {
        font-size: 18px;
        line-height: 1.6;
        background: rgba(255,255,255,0.04);
        border: 1px dashed rgba(255,255,255,0.12);
        border-radius: 12px;
        padding: 16px;
      }
      .footer {
        margin-top: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: var(--muted);
      }
      .badge {
        display: inline-block;
        background: rgba(139, 92, 246, 0.18);
        color: #d4c2ff;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(139, 92, 246, 0.35);
        letter-spacing: 0.2px;
      }
    </style>
  </head>
  <body>
    <!-- BEGIN_EDITABLE -->
      <section id="content">
<div id="murmur1651" aria-label="PRISM WEAVE — Edition 1651">
  <style>
    /* Prism Weave — Edition 1651 */
    #murmur1651{
      --ink:#eef3ff;
      --muted:#9fb0d7;
      --paper:#0a0d15;
      --ring:rgba(255,255,255,.12);
      --a:#8fd3fe;
      --b:#c5b6ff;
      --c:#ff9aa2;
      --pad: clamp(18px,4vw,48px);
      position:relative;
      display:grid;
      grid-template-rows:auto 1fr auto;
      min-height:92svh;
      border-radius: 32px;
      overflow: clip;
      color: var(--ink);
      background:
        radial-gradient(140% 100% at 10% -10%, color-mix(in oklab, var(--a) 18%, transparent), transparent 56%),
        radial-gradient(140% 100% at 110% 120%, color-mix(in oklab, var(--b) 20%, transparent), transparent 58%),
        linear-gradient(180deg, #0a0d15, #0f1628 60%, #0a0d15);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06), 0 80px 240px rgba(0,0,0,.7);
      isolation:isolate;
      --mx:0; --my:0;
    }
    #murmur1651::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(100% 80% at 50% -10%, rgba(255,255,255,.08), transparent 60%),
        repeating-linear-gradient(90deg, rgba(255,255,255,.02) 0 1px, transparent 1px 12px);
      mix-blend-mode: overlay; opacity:.35; pointer-events:none;
    }
    #murmur1651[data-theme="day"]{
      --paper:#f7f9ff;
      --ink:#0b1426;
      --muted:#657190;
      --ring:rgba(11,20,38,.14);
      background:
        radial-gradient(140% 100% at 10% -10%, color-mix(in oklab, var(--a) 22%, transparent), transparent 56%),
        radial-gradient(140% 100% at 110% 120%, color-mix(in oklab, var(--b) 24%, transparent), transparent 58%),
        linear-gradient(180deg,#ffffff,#f3f6ff 70%, #eaf0ff);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.9), 0 80px 160px rgba(10,13,21,.16);
    }
    #murmur1651 .mast{
      position:relative; z-index:2;
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      margin: var(--pad);
      padding: clamp(12px,1.6vw,18px) clamp(14px,2vw,22px);
      border: 1px solid var(--ring);
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      backdrop-filter: blur(12px) saturate(160%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.18), 0 18px 60px rgba(0,0,0,.35);
    }
    #murmur1651 .brand{
      display:flex; align-items:center; gap:14px;
    }
    #murmur1651 .sigil{
      --s: clamp(36px, 5vw, 60px);
      width:var(--s); height:var(--s); border-radius:16px;
      background: conic-gradient(from 0deg, var(--a), var(--b), var(--c), var(--a));
      mask: radial-gradient(circle at 40% 40%, #000 62%, transparent 65%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35), 0 10px 30px rgba(0,0,0,.5);
      animation: spin1651 16s linear infinite;
    }
    @keyframes spin1651 { to { transform: rotate(360deg) } }
    #murmur1651 .logo{
      display:flex; flex-direction:column; gap:4px;
    }
    #murmur1651 .logo .title{
      font: 900 clamp(22px,5.2vw,56px)/.95 ui-sans-serif, system-ui, "SF Pro";
      letter-spacing:.01em;
      background: linear-gradient(90deg, #fff, color-mix(in oklab, var(--b) 60%, var(--a)));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      filter: drop-shadow(0 6px 22px rgba(92,146,255,.22));
      transform: translate3d(calc(var(--mx)*6px), calc(var(--my)*-6px), 0);
      transition: transform .15s ease;
    }
    #murmur1651 .logo .kicker{
      font: 800 11px/1 ui-sans-serif, system-ui; letter-spacing:.28em; text-transform:uppercase; color: var(--muted);
    }
    #murmur1651 .actions{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    #murmur1651 .action{
      display:inline-flex; align-items:center; justify-content:center;
      height:36px; min-width:36px; padding:0 12px; border-radius:999px;
      border:1px solid var(--ring);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
      color:var(--ink); font:700 12px/1 ui-sans-serif, system-ui; letter-spacing:.2px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.18), 0 10px 28px rgba(0,0,0,.3);
      cursor:pointer; transition: transform .12s ease, box-shadow .2s ease;
    }
    #murmur1651 .action:hover{ transform: translateY(-1px); box-shadow: 0 18px 40px rgba(0,0,0,.45); }
    #murmur1651 .toggle{
      width:70px; height:36px; border-radius:999px; position:relative;
      border:1px solid var(--ring); background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.05));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.22), 0 10px 30px rgba(0,0,0,.32);
      cursor:pointer;
    }
    #murmur1651 .toggle .nub{
      position:absolute; inset:4px; width:28px; height:28px; border-radius:50%;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,.55)),
        radial-gradient(circle at 50% 120%, var(--b), transparent 60%);
      border:1px solid rgba(255,255,255,.2); box-shadow: 0 8px 20px rgba(0,0,0,.5);
      transform: translateX(0); transition: transform .22s cubic-bezier(.2,.8,.2,1), filter .2s ease;
    }
    #murmur1651 .toggle[data-on="1"] .nub{ transform: translateX(34px); filter: hue-rotate(40deg); }

    /* Stage */
    #murmur1651 .stage{
      position:relative; z-index:1; padding: clamp(6px, 3.6vw, 22px);
      display:grid; grid-template-rows: 1fr auto; place-items:center;
    }
    #murmur1651 .viewport{
      position:relative; width:min(1200px, 96vw); aspect-ratio: 1.5;
      border-radius: 32px; overflow:hidden;
      border:1px solid var(--ring);
      background: linear-gradient(180deg, color-mix(in oklab, var(--paper) 94%, transparent), color-mix(in oklab, var(--paper) 100%, transparent)),
                  radial-gradient(80% 60% at 50% 0%, rgba(255,255,255,.06), transparent 70%);
      box-shadow: 0 90px 180px rgba(0,0,0,.65), inset 0 1px 0 rgba(255,255,255,.22);
      transform:
        rotateX(calc(var(--my)*-5deg))
        rotateY(calc(var(--mx)* 5deg))
        translate3d(calc(var(--mx)*14px), calc(var(--my)*-14px), 0);
      transition: transform .15s ease;
      isolation:isolate;
    }
    #murmur1651 canvas#loom{ position:absolute; inset:0; width:100%; height:100%; display:block; }

    /* Centered typographic beacon */
    #murmur1651 .beacon{
      position:absolute; inset:auto 0 18% 0; margin:auto; text-align:center; z-index:2; pointer-events:none;
      mix-blend-mode: normal;
    }
    #murmur1651 .beacon .name{
      font: 900 clamp(28px, 6.2vw, 86px)/.95 ui-sans-serif, system-ui;
      letter-spacing:.005em;
      background: linear-gradient(90deg, #fff, color-mix(in oklab, var(--a) 70%, var(--b)));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      filter: drop-shadow(0 8px 26px rgba(90,140,255,.28));
    }
    #murmur1651 .halo{
      position:absolute; left:50%; transform:translateX(-50%); top:calc(50% - clamp(40px,10vw,120px));
      width:min(60vw,680px); aspect-ratio: 2.2 / 1; border-radius: 60%/80%;
      border:1px solid var(--ring);
      background:
        radial-gradient(100% 200% at 50% 0%, color-mix(in oklab, var(--a) 18%, transparent), transparent 60%),
        conic-gradient(from 0deg at 50% 50%, color-mix(in oklab, var(--b) 50%, transparent) 0 25%, transparent 25% 50%, color-mix(in oklab, var(--c) 50%, transparent) 50% 75%, transparent 75% 100%);
      filter: blur(18px) saturate(140%);
      opacity:.45; animation: orbit1651 22s linear infinite;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.2);
    }
    @keyframes orbit1651{ to { transform: translateX(-50%) rotate(360deg) } }

    #murmur1651 .caption{
      position:relative; z-index:2; margin-top: 14px; text-align:center;
      font: 800 clamp(14px,2.1vw,18px)/1.5 ui-sans-serif, system-ui; color: color-mix(in oklab, var(--ink) 86%, transparent);
      letter-spacing:.02em;
    }
    #murmur1651 .caption .soft{
      display:block; margin-top:8px; letter-spacing:.28em; text-transform:uppercase;
      font: 700 11px/1.1 ui-sans-serif, system-ui; color:var(--muted);
    }

    /* Dock */
    #murmur1651 .dock{
      position:relative; z-index:3;
      margin: 0 auto; transform: translateY(-20px);
      display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:center;
      padding: 10px 12px; border-radius: 16px;
      border:1px solid var(--ring);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
      backdrop-filter: blur(10px) saturate(160%);
      box-shadow: 0 18px 50px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.2);
    }
    #murmur1651 .swatch{ display:flex; align-items:center; gap:6px; padding:6px 8px; border-radius:12px; border:1px solid var(--ring); background: linear-gradient(180deg, rgba(255,255,255,.1), rgba(255,255,255,.03)); }
    #murmur1651 .sw{ width:18px; height:18px; border-radius:50%; border:1px solid var(--ring); box-shadow: inset 0 1px 0 rgba(255,255,255,.25); cursor:pointer; }
    #murmur1651 .chip{ display:inline-flex; align-items:center; gap:10px; padding:8px 10px; border-radius:12px; border:1px solid var(--ring); background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04)); color:var(--ink); font: 800 12px/1 ui-sans-serif, system-ui; }
    #murmur1651 .chip output{ min-width:3ch; text-align:right; }
    #murmur1651 input[type="range"]{ -webkit-appearance:none; appearance:none; height:22px; width:150px; background:transparent; cursor:pointer; }
    #murmur1651 input[type="range"]::-webkit-slider-runnable-track,
    #murmur1651 input[type="range"]::-moz-range-track{
      height:6px; border-radius:999px;
      background: linear-gradient(90deg, var(--a), var(--b), var(--c));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.25);
    }
    #murmur1651 input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none; appearance:none; margin-top:-6px; width:18px; height:18px; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.6)); border:1px solid rgba(255,255,255,.2); box-shadow: 0 6px 18px rgba(0,0,0,.5);
    }
    #murmur1651 input[type="range"]::-moz-range-thumb{
      width:18px; height:18px; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.6)); border:1px solid rgba(255,255,255,.2); box-shadow: 0 6px 18px rgba(0,0,0,.5);
    }

    /* Footer */
    #murmur1651 .foot{
      position:relative; z-index:2; margin: 0 var(--pad) var(--pad);
      padding-top: 12px; border-top:1px dashed var(--ring);
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      font: 400 12px/1.6 ui-sans-serif, system-ui; color:var(--muted);
    }
    #murmur1651 .pulse{ width:8px; height:8px; border-radius:50%; background: radial-gradient(circle at 30% 30%, #fff, var(--b)); box-shadow: 0 0 14px color-mix(in oklab, var(--b) 70%, transparent); animation: ping1651 3s ease-in-out infinite; }
    @keyframes ping1651{ 0%,100%{ transform: scale(1); opacity:.9 } 50%{ transform: scale(1.22); opacity:1 } }

    /* Motion safe */
    #murmur1651.paused, #murmur1651.paused * { animation-play-state: paused !important; }
    @media (prefers-reduced-motion: reduce){
      #murmur1651 .sigil{ animation: none !important; }
      #murmur1651 .halo{ animation-duration: 0s !important; }
    }
  </style>

  <div class="mast" role="toolbar" aria-label="Prism Weave controls">
    <div class="brand">
      <div class="sigil" aria-hidden="true"></div>
      <div class="logo">
        <div class="title">Prism Weave</div>
        <div class="kicker">Edition 1651 · kinetic field sketch</div>
      </div>
    </div>
    <div class="actions">
      <div class="toggle" id="theme" data-on="0" role="button" aria-pressed="false" title="Day / Night">
        <span class="nub" aria-hidden="true"></span>
      </div>
      <button class="action" id="regenerate" title="Regenerate pattern">Weave</button>
      <button class="action" id="pause" aria-pressed="false" title="Pause">Pause</button>
      <button class="action" id="save" title="Save image">Save</button>
    </div>
  </div>

  <div class="stage">
    <div class="viewport" id="view">
      <canvas id="loom" role="img" aria-label="Color threads drifting through a dynamic flow field"></canvas>
      <div class="halo" aria-hidden="true"></div>
      <div class="beacon" aria-hidden="true">
        <div class="name">A quiet storm of color</div>
      </div>
    </div>

    <div class="dock" role="group" aria-label="Weave settings">
      <div class="swatch" aria-label="Palette">
        <button class="sw" aria-label="Aurora" data-pal="0" style="background: linear-gradient(135deg,#8fd3fe,#c5b6ff)"></button>
        <button class="sw" aria-label="Saffron" data-pal="1" style="background: linear-gradient(135deg,#fbbf24,#fb7185)"></button>
        <button class="sw" aria-label="Meadow" data-pal="2" style="background: linear-gradient(135deg,#22d3ee,#34d399)"></button>
        <button class="sw" aria-label="Nocturne" data-pal="3" style="background: linear-gradient(135deg,#60a5fa,#f472b6)"></button>
        <button class="sw" aria-label="Horizon" data-pal="4" style="background: linear-gradient(135deg,#a3e635,#facc15)"></button>
        <button class="sw" aria-label="Porcelain" data-pal="5" style="background: linear-gradient(135deg,#93c5fd,#fbcfe8)"></button>
      </div>
      <label class="chip" for="flow">Flow <output id="flowOut">1.00</output><input id="flow" type="range" value="1.0" min="0.3" max="2.2" step="0.01" /></label>
      <label class="chip" for="glow">Glow <output id="glowOut">80</output><input id="glow" type="range" value="80" min="0" max="200" step="1" /></label>
      <label class="chip" for="warp">Warp <output id="warpOut">50</output><input id="warp" type="range" value="50" min="0" max="100" step="1" /></label>
    </div>

    <div class="caption" aria-live="polite" id="caption">
      Threads follow an invisible wind.
      <span class="soft">drag across the field · 1–6 for palettes · W weave · T theme · S save · Space pause</span>
    </div>
  </div>

  <div class="foot">
    <div><span class="pulse" aria-hidden="true"></span> Prism Weave runs best with light motion.</div>
    <span id="last-updated">Last updated: 2025-12-31 13:27:51 EST</span>
  </div>

  <script>
    (function(){
      const root   = document.getElementById('murmur1651');
      const view   = document.getElementById('view');
      const canvas = document.getElementById('loom');
      const ctx    = canvas.getContext('2d', {alpha:true});
      const themeT = document.getElementById('theme');
      const regen  = document.getElementById('regenerate');
      const pauseB = document.getElementById('pause');
      const saveB  = document.getElementById('save');
      const flow   = document.getElementById('flow');
      const glow   = document.getElementById('glow');
      const warp   = document.getElementById('warp');
      const flowOut= document.getElementById('flowOut');
      const glowOut= document.getElementById('glowOut');
      const warpOut= document.getElementById('warpOut');
      const caption= document.getElementById('caption');
      const lastUpdated = document.getElementById('last-updated');

      // Timestamp
      try{
        const fmt = new Intl.DateTimeFormat([], { dateStyle:'medium', timeStyle:'short' });
        lastUpdated.textContent = 'Last updated: ' + fmt.format(new Date());
      }catch(e){ lastUpdated.textContent = 'Last updated: ' + new Date().toLocaleString(); }

      // Palettes
      const palettes = [
        ['#8fd3fe','#c5b6ff','#ff9aa2'], // aurora
        ['#fbbf24','#fb7185','#fde68a'], // saffron
        ['#22d3ee','#34d399','#86efac'], // meadow
        ['#60a5fa','#f472b6','#9ae6b4'], // nocturne
        ['#a3e635','#facc15','#fb7185'], // horizon
        ['#93c5fd','#fbcfe8','#ddd6fe']  // porcelain
      ];
      function applyPalette([a,b,c]){
        root.style.setProperty('--a', a);
        root.style.setProperty('--b', b);
        root.style.setProperty('--c', c);
      }
      applyPalette(palettes[0]);
      root.querySelectorAll('.sw').forEach((b,i)=> b.addEventListener('click', ()=> applyPalette(palettes[i])));

      // Theme
      let isDay = false;
      function setTheme(day){
        isDay = day;
        root.dataset.theme = isDay ? 'day' : '';
        themeT.dataset.on = isDay ? '1' : '0';
        themeT.setAttribute('aria-pressed', String(isDay));
        veil(true);
      }
      themeT.addEventListener('click', ()=> setTheme(!isDay));
      setTheme(false);

      // Controls
      const syncFlow = ()=> flowOut.textContent = (+flow.value).toFixed(2);
      const syncGlow = ()=> glowOut.textContent = glow.value;
      const syncWarp = ()=> warpOut.textContent = warp.value;
      flow.addEventListener('input', syncFlow); syncFlow();
      glow.addEventListener('input', syncGlow); syncGlow();
      warp.addEventListener('input', syncWarp); syncWarp();

      // Canvas sizing
      let DPR = Math.min(2, window.devicePixelRatio||1), W=0,H=0,CX=0,CY=0;
      function fit(){
        const r = view.getBoundingClientRect();
        W = Math.max(1, Math.floor(r.width));
        H = Math.max(1, Math.floor(r.height));
        CX = W/2; CY = H/2;
        canvas.width = Math.floor(W*DPR);
        canvas.height = Math.floor(H*DPR);
        ctx.setTransform(DPR,0,0,DPR,0,0);
        veil(true);
        seedField();
        seedParticles();
      }
      new ResizeObserver(fit).observe(view);

      // Pointer -> parallax + attractor
      let pointer = {x:null, y:null}, lastMove = performance.now();
      root.addEventListener('pointermove', (e)=>{
        const rr = root.getBoundingClientRect();
        const vr = view.getBoundingClientRect();
        pointer.x = e.clientX - vr.left;
        pointer.y = e.clientY - vr.top;
        const mx = (e.clientX - rr.left)/rr.width - .5;
        const my = (e.clientY - rr.top)/rr.height - .5;
        root.style.setProperty('--mx', mx.toFixed(3));
        root.style.setProperty('--my', my.toFixed(3));
        lastMove = performance.now();
      }, {passive:true});
      root.addEventListener('pointerleave', ()=>{
        root.style.setProperty('--mx', 0);
        root.style.setProperty('--my', 0);
        pointer.x = null; pointer.y = null;
      });

      // Field + particles
      let seed = Math.random()*1000;
      let tPhase = 0;
      let grid, gw, gh, gScale;
      let particles = [];

      function seedField(){
        gScale = Math.max(18, Math.min(W,H)/18);
        gw = Math.ceil(W / gScale)+2;
        gh = Math.ceil(H / gScale)+2;
        grid = new Float32Array(gw*gh);
        for(let y=0;y<gh;y++){
          for(let x=0;x<gw;x++){
            grid[y*gw+x] = 0;
          }
        }
      }

      function seedParticles(){
        const count = Math.floor((W*H)/12000) + 260;
        particles = Array.from({length:count}, ()=>({
          x: Math.random()*W,
          y: Math.random()*H,
          px: null, py: null,
          age: 0,
          jitter: Math.random()*1000,
          hueSlot: Math.floor(Math.random()*3)
        }));
      }

      function accents(){
        const cs = getComputedStyle(root);
        return [cs.getPropertyValue('--a').trim(), cs.getPropertyValue('--b').trim(), cs.getPropertyValue('--c').trim()];
      }

      function fieldAngle(x,y,tt){
        // lightweight curl-ish noise using trigonometric mixing
        const s = (+warp.value)/100;
        const nx = (x + seed*40) * (0.003 + s*0.006);
        const ny = (y - seed*30) * (0.003 + s*0.006);
        const a = Math.sin(nx*2.1 + Math.cos(ny*1.3 + tt*.7))*1.2
                + Math.cos(ny*2.3 - Math.sin(nx*1.7 + tt*.6))*1.2;
        return a;
      }

      function veil(fill){
        ctx.globalCompositeOperation='source-over';
        if(fill){
          ctx.clearRect(0,0,W,H);
          ctx.fillStyle = isDay ? '#ffffff' : '#0a0d15';
          ctx.fillRect(0,0,W,H);
        }
      }

      // Caption shuffle
      const lines = [
        'Threads follow an invisible wind.',
        'Color finds the path the air suggests.',
        'A map of motion, drawn in light.',
        'Silk paths over a hidden sea.',
        'Where the field bends, threads agree.'
      ];
      function shuffleCaption(){
        caption.firstChild.nodeValue = lines[Math.floor(Math.random()*lines.length)];
      }

      function regenerate(){
        seed = Math.random()*1000;
        tPhase = Math.random()*1000;
        shuffleCaption();
        seedField();
        seedParticles();
      }
      regen.addEventListener('click', regenerate);

      // Pause
      let paused = false;
      function setPaused(p){
        paused = p;
        root.classList.toggle('paused', paused);
        pauseB.setAttribute('aria-pressed', String(paused));
      }
      pauseB.addEventListener('click', ()=> setPaused(!paused));

      // Save
      saveB.addEventListener('click', ()=>{
        const link = document.createElement('a');
        link.download = 'prism-weave-' + Date.now() + '.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      });

      // Draw loop
      let last = performance.now();
      function loop(now){
        const dt = Math.min(2.5, (now - last)*0.06) * (+flow.value);
        last = now;

        // Idle attractor orbit
        if(!pointer.x && !pointer.y && now - lastMove > 1600){
          const tt = now*0.0004;
          pointer.x = CX + Math.cos(tt)*W*0.18;
          pointer.y = CY + Math.sin(tt*1.1)*H*0.14;
        }

        if(!paused){
          // film pass
          const fog = isDay ? 0.06 : 0.04;
          ctx.globalCompositeOperation='source-over';
          ctx.fillStyle = isDay ? `rgba(255,255,255,${fog})` : `rgba(10,13,21,${fog})`;
          ctx.fillRect(0,0,W,H);

          const [A,B,C] = accents();
          const cols = [A,B,C];

          ctx.globalCompositeOperation = isDay ? 'multiply' : 'lighter';
          ctx.lineCap = 'round';
          ctx.lineJoin = 'round';

          tPhase += dt*0.004;

          for(let i=0;i<particles.length;i++){
            const p = particles[i];
            const angle = fieldAngle(p.x, p.y, tPhase + p.jitter*0.001);
            const s = 0.8 + (+warp.value)/100 * 0.6;
            const vx = Math.cos(angle) * s;
            const vy = Math.sin(angle) * s;

            // pointer influence
            let ax=0, ay=0;
            if(pointer.x!=null && pointer.y!=null){
              const dx = pointer.x - p.x;
              const dy = pointer.y - p.y;
              const d = Math.hypot(dx,dy)+0.001;
              const G = 0.18 * (1 + (+warp.value)/160);
              ax = dx/d * G;
              ay = dy/d * G;
            }

            p.px = p.px==null ? p.x : p.x;
            p.py = p.py==null ? p.y : p.y;

            p.x += vx * dt + ax * dt;
            p.y += vy * dt + ay * dt;
            p.age += dt;

            // wrap + reseed
            if(p.x< -10 || p.x> W+10 || p.y< -10 || p.y> H+10 || p.age> 800){
              p.x = Math.random()*W;
              p.y = Math.random()*H;
              p.px = p.x; p.py = p.y; p.age = 0;
              p.hueSlot = Math.floor(Math.random()*3);
            }

            const col = cols[p.hueSlot];
            ctx.strokeStyle = col;
            ctx.shadowColor = col;
            ctx.lineWidth = 0.5 + Math.sin((p.jitter+p.age)*0.02)*0.35 + (+warp.value)/100*0.15;
            ctx.shadowBlur = (+glow.value) * (isDay?0.5:1.05);

            ctx.beginPath();
            ctx.moveTo(p.px, p.py);
            ctx.lineTo(p.x, p.y);
            ctx.stroke();

            // occasional bokeh
            if((i%37)===0){
              ctx.shadowBlur = (+glow.value) * (isDay?0.35:0.9);
              ctx.fillStyle = col;
              ctx.beginPath();
              ctx.arc(p.x, p.y, 0.8 + Math.random()*2.2, 0, Math.PI*2);
              ctx.fill();
            }

            p.px = p.x; p.py = p.y;
          }
        }

        requestAnimationFrame(loop);
      }

      // Keyboard
      root.tabIndex = 0;
      root.addEventListener('keydown', (e)=>{
        const k = e.key.toLowerCase();
        if(k===' '){ e.preventDefault(); pauseB.click(); }
        if(k==='t'){ themeT.click(); }
        if(k==='w'){ regen.click(); }
        if(k==='s'){ saveB.click(); }
        if(k==='1'){ applyPalette(palettes[0]); }
        if(k==='2'){ applyPalette(palettes[1]); }
        if(k==='3'){ applyPalette(palettes[2]); }
        if(k==='4'){ applyPalette(palettes[3]); }
        if(k==='5'){ applyPalette(palettes[4]); }
        if(k==='6'){ applyPalette(palettes[5]); }
        if(k==='+'||k==='='){ glow.stepUp(); flow.stepUp(); warp.stepUp(); glow.dispatchEvent(new Event('input')); flow.dispatchEvent(new Event('input')); warp.dispatchEvent(new Event('input')); }
        if(k==='-'||k==='_'){ glow.stepDown(); flow.stepDown(); warp.stepDown(); glow.dispatchEvent(new Event('input')); flow.dispatchEvent(new Event('input')); warp.dispatchEvent(new Event('input')); }
      });

      // Reduced motion default pause
      if(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches){
        setPaused(true);
      }

      fit(); requestAnimationFrame(loop);
    }());
  </script>
</div>
      </section>
      <!-- END_EDITABLE -->
    <script>
      // Only show a local placeholder if the agent hasn't written a timestamp yet
      const el = document.getElementById('last-updated');
      if (el && (!el.textContent || el.textContent.includes('not yet'))) {
        const now = new Date();
        el.textContent = `Last updated: ${now.toLocaleString(undefined, { hour12: false })}`;
      }
    </script>
  </body>
  </html>


