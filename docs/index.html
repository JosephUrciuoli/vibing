<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vibing</title>
    <style>
      :root {
        --bg: #0f1221;
        --fg: #e6e8f0;
        --muted: #9aa3b2;
        --accent: #8b5cf6;
      }
      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--fg);
        background: radial-gradient(1200px 800px at 70% 10%, #1b1f3a, var(--bg));
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        width: min(720px, 92vw);
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px;
        padding: 28px 24px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        backdrop-filter: blur(6px);
      }
      h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
        letter-spacing: 0.3px;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 18px;
      }
      #content {
        font-size: 18px;
        line-height: 1.6;
        background: rgba(255,255,255,0.04);
        border: 1px dashed rgba(255,255,255,0.12);
        border-radius: 12px;
        padding: 16px;
      }
      .footer {
        margin-top: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: var(--muted);
      }
      .badge {
        display: inline-block;
        background: rgba(139, 92, 246, 0.18);
        color: #d4c2ff;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(139, 92, 246, 0.35);
        letter-spacing: 0.2px;
      }
    </style>
  </head>
  <body>
    <!-- BEGIN_EDITABLE -->
      <section id="content">
<section id="sonata556" aria-label="SONATA 556 — Prismatic Weave">
  <style>
    /* SONATA — Iteration 556 (scoped) */
    #sonata556 {
      --ink: #eaf2ff;
      --muted: #a9b3c9;

      --bg1: #05060b;
      --bg2: #0a0f1f;

      --p1: #9afff0; /* mist */
      --p2: #a9b1ff; /* hush */
      --p3: #ffb5c9; /* bloom */
      --p4: #ffe59a; /* ember */

      --glass: color-mix(in srgb, #ffffff 8%, transparent);
      --ring: rgba(255,255,255,.10);

      position: relative;
      min-height: 96vh;
      display: grid;
      place-items: center;
      padding: clamp(16px, 5vw, 56px);
      color: var(--ink);
      font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      border-radius: 36px;
      overflow: hidden;
      isolation: isolate;
      background:
        radial-gradient(140% 140% at 80% -10%, color-mix(in srgb, var(--p2) 12%, transparent) 0%, var(--bg2) 40%, var(--bg1) 100%),
        radial-gradient(120% 140% at -10% 110%, color-mix(in srgb, var(--p1) 10%, transparent) 0%, transparent 62%);
      box-shadow: 0 180px 380px rgba(0,0,0,.8);
    }
    #sonata556:not([data-theme="noir"]) {
      --ink: #0b1320;
      --muted: #4a5b77;
      --bg1: #f7f9ff;
      --bg2: #eaf1ff;
      --glass: color-mix(in srgb, #ffffff 84%, transparent);
      background:
        radial-gradient(140% 120% at 90% -10%, #fbfcff 0%, var(--bg2) 40%, var(--bg1) 100%),
        radial-gradient(120% 120% at -20% 120%, color-mix(in srgb, var(--p1) 14%, transparent) 0%, transparent 62%);
      box-shadow: 0 120px 260px rgba(8,12,22,.16);
    }

    /* Ambient veils */
    #sonata556::before,
    #sonata556::after {
      content: "";
      position: absolute; inset: -30% -30%;
      pointer-events: none; z-index: 0; opacity: .9;
      filter: blur(120px) saturate(130%);
      mix-blend-mode: soft-light;
      transition: transform 40s linear, opacity .5s ease;
    }
    #sonata556::before {
      background:
        conic-gradient(from 0deg at 30% 30%, color-mix(in srgb, var(--p1) 40%, transparent), transparent 70%),
        conic-gradient(from 180deg at 70% 72%, color-mix(in srgb, var(--p3) 35%, transparent), transparent 65%);
      transform: rotate(-22deg) scale(1.06);
      animation: s556-veilA 36s linear infinite;
    }
    #sonata556::after {
      background:
        radial-gradient(60% 60% at 62% 50%, color-mix(in srgb, var(--p4) 24%, transparent), transparent),
        radial-gradient(60% 60% at 30% 18%, color-mix(in srgb, var(--p2) 20%, transparent), transparent);
      transform: rotate(12deg) scale(1.04);
      animation: s556-veilB 44s linear infinite reverse;
    }
    @keyframes s556-veilA { from { transform: rotate(-22deg) scale(1.06); } to { transform: rotate(338deg) scale(1.06); } }
    @keyframes s556-veilB { from { transform: rotate(12deg) scale(1.04); } to { transform: rotate(372deg) scale(1.04); } }

    /* Frame / Poster */
    #sonata556 .wrap {
      position: relative; z-index: 1;
      width: min(1200px, 96vw);
      border-radius: 28px;
      padding: clamp(14px, 2.4vw, 26px);
      background:
        linear-gradient(180deg, var(--glass), color-mix(in srgb, #ffffff 4%, transparent)) padding-box,
        linear-gradient(120deg, color-mix(in srgb, var(--p4), transparent 56%), color-mix(in srgb, var(--p1), transparent 56%), color-mix(in srgb, var(--p3), transparent 56%)) border-box;
      border: 1px solid transparent;
      backdrop-filter: blur(14px) saturate(140%);
      -webkit-backdrop-filter: blur(14px) saturate(140%);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.08),
        0 60px 160px rgba(0,0,0,.55);
    }
    #sonata556:not([data-theme="noir"]) .wrap {
      background:
        linear-gradient(180deg, color-mix(in srgb, #ffffff 94%, transparent), color-mix(in srgb, #ffffff 36%, transparent)) padding-box,
        linear-gradient(120deg, color-mix(in srgb, var(--p4), transparent 70%), color-mix(in srgb, var(--p1), transparent 70%), color-mix(in srgb, var(--p3), transparent 70%)) border-box;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.86),
        0 34px 120px rgba(8,12,22,.12);
    }

    /* Topline */
    #sonata556 .top {
      display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 14px;
      margin-bottom: clamp(10px, 2vw, 16px);
    }
    #sonata556 .brand {
      display: inline-grid; grid-auto-flow: column; align-items: center; gap: 12px;
      font-weight: 900; font-size: 11px; letter-spacing: .18em; text-transform: uppercase;
      color: var(--ink); user-select: none;
    }
    #sonata556 .sigil {
      width: 28px; height: 28px; border-radius: 12px; position: relative; display: grid; place-items:center;
      background:
        radial-gradient(circle at 50% 50%, #fff, #fff) padding-box,
        conic-gradient(from 0deg, var(--p1), var(--p2), var(--p3), var(--p4), var(--p1)) border-box;
      border: 2px solid transparent;
      box-shadow: 0 0 0 3px rgba(0,0,0,.05), 0 0 26px color-mix(in srgb, var(--p1), transparent 58%);
    }
    #sonata556 .sigil::after {
      content: "556";
      position: absolute; font-size: 8px; font-weight: 900; letter-spacing: .08em;
      color: #000; opacity: .28;
    }
    #sonata556 .tools { display:flex; flex-wrap:wrap; align-items:center; gap:10px; }
    #sonata556 .chip {
      appearance:none; -webkit-appearance:none; cursor:pointer;
      padding:10px 16px; border-radius:999px; font-weight:800; font-size:12px;
      color: var(--ink);
      border: 1px solid rgba(255,255,255,.10);
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05)) padding-box,
        linear-gradient(90deg, var(--p4), var(--p1)) border-box;
      transition: transform .15s ease, box-shadow .15s ease, background .2s ease, opacity .2s ease;
      box-shadow: 0 18px 38px rgba(0,0,0,.45);
    }
    #sonata556 .chip:hover { transform: translateY(-1px); }
    #sonata556 .chip:active { transform: translateY(0); }
    #sonata556:not([data-theme="noir"]) .chip {
      border-color: rgba(8,12,22,.10);
      background:
        linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.28)) padding-box,
        linear-gradient(90deg, var(--p4), var(--p1)) border-box;
      box-shadow: 0 14px 30px rgba(8,12,22,.10);
    }

    /* Hero */
    #sonata556 .hero { margin-bottom: clamp(10px, 2.4vw, 16px); }
    #sonata556 h1 {
      margin: 0;
      font-size: clamp(44px, 8.8vw, 120px);
      line-height: .86; letter-spacing: -.02em; text-wrap: balance;
      background: linear-gradient(100deg,
        color-mix(in srgb, var(--p1) 70%, #fff 10%),
        color-mix(in srgb, var(--p3) 60%, #fff 10%),
        color-mix(in srgb, var(--p4) 70%, #fff 10%));
      -webkit-background-clip: text; background-clip: text; color: transparent;
      text-shadow: 0 1px 0 rgba(255,255,255,.08);
    }
    #sonata556 .lead { margin: 6px 0 0 0; color: var(--muted); font-size: clamp(14px, 2.2vw, 18px); max-width: 72ch; }

    /* Scene — prismatic weave */
    #sonata556 .scene {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 10;
      max-height: 70vh;
      border-radius: 22px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(120% 120% at 50% 50%, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.08),
        0 50px 140px rgba(0,0,0,.55);
      transform-style: preserve-3d;
      transition: transform .25s ease, box-shadow .25s ease;
    }
    #sonata556:not([data-theme="noir"]) .scene {
      background:
        radial-gradient(120% 120% at 50% 50%, rgba(255,255,255,.96), rgba(255,255,255,.36));
      border-color: rgba(8,12,22,.10);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.86),
        0 30px 100px rgba(8,12,22,.18);
    }

    #sonata556 .scene::before {
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(60% 100% at 20% 10%, color-mix(in srgb, var(--p1) 6%, transparent), transparent 60%),
        radial-gradient(60% 100% at 80% 90%, color-mix(in srgb, var(--p3) 8%, transparent), transparent 60%);
      pointer-events:none;
      mix-blend-mode: soft-light;
      opacity:.8;
      z-index:1;
    }

    /* Micro grid overlay */
    #sonata556 .grid {
      position:absolute; inset:0; pointer-events:none; z-index:2; opacity:.22;
      background:
        radial-gradient(circle at 50% 50%, rgba(255,255,255,.08), rgba(255,255,255,0) 60%),
        repeating-linear-gradient(0deg, rgba(255,255,255,.04) 0 1px, transparent 1px 20px),
        repeating-linear-gradient(90deg, rgba(255,255,255,.04) 0 1px, transparent 1px 20px);
      mix-blend-mode: soft-light;
    }

    #sonata556 canvas#weave556 {
      position:absolute; inset:0; width:100%; height:100%;
      filter:
        saturate(130%)
        drop-shadow(0 0 16px color-mix(in srgb, var(--p1), transparent 84%))
        drop-shadow(0 0 26px color-mix(in srgb, var(--p3), transparent 88%));
      will-change: transform, filter;
    }

    /* HUD */
    #sonata556 .hud {
      position: absolute; left: 12px; top: 12px; z-index: 3;
      font-size: 11px; font-weight: 800; letter-spacing: .1em; text-transform: uppercase;
      padding: 8px 10px; border-radius: 10px; color: var(--ink);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(10px) saturate(130%);
      -webkit-backdrop-filter: blur(10px) saturate(130%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08), 0 14px 30px rgba(0,0,0,.25);
    }
    #sonata556:not([data-theme="noir"]) .hud {
      background: rgba(255,255,255,.72);
      border-color: rgba(8,12,22,.08);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.75), 0 14px 30px rgba(8,12,22,.10);
    }

    /* Dock controls */
    #sonata556 .dock {
      display:flex; flex-wrap:wrap; align-items:center; gap:10px;
      margin-top: clamp(16px, 2.6vw, 24px);
    }
    #sonata556 .ctrl {
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      padding:8px 10px; border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(10px) saturate(130%);
      -webkit-backdrop-filter: blur(10px) saturate(130%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08), 0 26px 60px rgba(0,0,0,.45);
    }
    #sonata556:not([data-theme="noir"]) .ctrl {
      background: rgba(255,255,255,.72);
      border-color: rgba(8,12,22,.10);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.75), 0 14px 30px rgba(8,12,22,.10);
    }
    #sonata556 .ctrl label {
      font-size: 10px; letter-spacing: .14em; text-transform: uppercase; font-weight: 900; opacity: .72; margin-right: 4px;
    }
    #sonata556 input[type="range"] {
      -webkit-appearance: none; appearance: none;
      width: 200px; height: 26px; border-radius: 999px; padding: 0 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
    }
    #sonata556:not([data-theme="noir"]) input[type="range"] {
      background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.25));
      border-color: rgba(8,12,22,.10);
    }
    #sonata556 input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%;
      background:
        linear-gradient(#fff, #fff) padding-box,
        conic-gradient(var(--p4), var(--p1), var(--p3), var(--p4)) border-box;
      border: 2px solid transparent; box-shadow: 0 8px 18px rgba(0,0,0,.28); cursor: pointer;
    }
    #sonata556 input[type="range"]::-moz-range-thumb {
      width: 18px; height: 18px; border: none; border-radius: 50%; background: #fff; cursor: pointer;
    }

    /* Footer */
    #sonata556 .foot {
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
      margin-top: clamp(16px, 2.6vw, 24px); color: var(--muted); font-size: 12px;
    }
    #sonata556 .pulse {
      width: 10px; height: 10px; border-radius: 50%;
      background: radial-gradient(circle at 50% 50%, var(--p1), var(--p4));
      box-shadow: 0 0 0 0 rgba(71,255,209,.0);
      animation: s556-pulse 2.2s ease-in-out infinite;
    }
    @keyframes s556-pulse {
      0%{ box-shadow:0 0 0 0 rgba(71,255,209, .18); transform: scale(1);}
      70%{ box-shadow:0 0 0 14px rgba(71,255,209,0); transform: scale(1.06);}
      100%{ box-shadow:0 0 0 0 rgba(71,255,209,0); transform: scale(1);}
    }

    /* Motion preferences */
    @media (prefers-reduced-motion: reduce) {
      #sonata556::before, #sonata556::after, #sonata556 .pulse { animation: none !important; }
      #sonata556 .scene, #sonata556 canvas#weave556 { transition: none !important; }
    }
  </style>

  <div class="wrap" role="region" aria-label="Prismatic Weave — generative ribbons and controls">
    <div class="top">
      <div class="brand"><span class="sigil" aria-hidden="true"></span> SONATA · Iteration 556</div>
      <div class="tools">
        <button class="chip" id="mode556" type="button" aria-label="Toggle theme" aria-pressed="false">Mode</button>
        <button class="chip" id="palette556" type="button" aria-label="Cycle palette">Palette</button>
        <button class="chip" id="pause556" type="button" aria-label="Pause or resume">Pause</button>
        <button class="chip" id="pulse556" type="button" aria-label="Toggle pulse" aria-pressed="true">Pulse</button>
        <button class="chip" id="random556" type="button" aria-label="Randomize system">Random</button>
      </div>
    </div>

    <div class="hero">
      <h1>Prismatic Weave</h1>
      <p class="lead">Threads of color drift and braid. Your cursor is the loom.</p>
    </div>

    <figure class="scene" id="scene556" role="img" aria-label="Flowing threads weaving luminous color">
      <canvas id="weave556" aria-hidden="true"></canvas>
      <div class="grid" aria-hidden="true"></div>
      <div class="hud" aria-live="polite"><span id="hudThreads556">140 threads</span> · <span id="hudTempo556">1.00×</span></div>
    </figure>

    <div class="dock" aria-label="Controls">
      <div class="ctrl">
        <label for="threads556">Threads</label>
        <input id="threads556" type="range" min="20" max="400" step="5" value="140" />
      </div>
      <div class="ctrl">
        <label for="flux556">Flux</label>
        <input id="flux556" type="range" min="0.20" max="3.00" step="0.05" value="1.20" />
      </div>
      <div class="ctrl">
        <label for="noise556">Noise</label>
        <input id="noise556" type="range" min="0.40" max="4.00" step="0.05" value="1.60" />
      </div>
      <div class="ctrl">
        <label for="bloom556">Bloom</label>
        <input id="bloom556" type="range" min="0.10" max="1.60" step="0.05" value="0.70" />
      </div>
      <div class="ctrl">
        <label for="tempo556">Tempo</label>
        <input id="tempo556" type="range" min="0.30" max="3.00" step="0.05" value="1.00" />
      </div>
    </div>

    <div class="foot">
      <div style="display:flex; align-items:center; gap:10px;">
        <span class="pulse" aria-hidden="true"></span>
        <span>Lines remember where you touched</span>
      </div>
      <span id="last-updated">Last updated: 2025-11-10 20:22:27 EST</span>
    </div>
  </div>

  <script>
    (function () {
      const root = document.getElementById('sonata556');
      const scene = document.getElementById('scene556');
      const canvas = document.getElementById('weave556');
      const ctx = canvas.getContext('2d');

      const btnMode = document.getElementById('mode556');
      const btnPalette = document.getElementById('palette556');
      const btnPause = document.getElementById('pause556');
      const btnRandom = document.getElementById('random556');
      const btnPulse = document.getElementById('pulse556');

      const rThreads = document.getElementById('threads556');
      const rFlux    = document.getElementById('flux556');
      const rNoise   = document.getElementById('noise556');
      const rBloom   = document.getElementById('bloom556');
      const rTempo   = document.getElementById('tempo556');

      const hudThreads = document.getElementById('hudThreads556');
      const hudTempo   = document.getElementById('hudTempo556');
      const stamp = document.getElementById('last-updated');

      // Timestamp
      try {
        const now = new Date();
        const parts = new Intl.DateTimeFormat(undefined, {
          year: 'numeric', month: 'short', day: '2-digit',
          hour: '2-digit', minute: '2-digit', second: '2-digit',
          timeZoneName: 'short'
        }).format(now);
        stamp.textContent = 'Last updated: ' + parts;
      } catch {
        stamp.textContent = 'Last updated just now';
      }

      // Theme
      const hourNow = (new Date()).getHours();
      const timeTheme = (hourNow >= 7 && hourNow < 19) ? 'light' : 'noir';
      const savedTheme = localStorage.getItem('s556-theme');
      const startTheme = savedTheme || (timeTheme === 'noir' ? 'noir' : 'light');
      if (startTheme === 'noir') root.dataset.theme = 'noir';
      btnMode.setAttribute('aria-pressed', String(root.dataset.theme === 'noir'));
      btnMode.addEventListener('click', () => {
        const next = root.dataset.theme === 'noir' ? '' : 'noir';
        if (next) root.dataset.theme = next; else root.removeAttribute('data-theme');
        localStorage.setItem('s556-theme', next || 'light');
        btnMode.setAttribute('aria-pressed', String(next === 'noir'));
        if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
          scene.style.transform = 'perspective(1100px) rotateX(10deg) rotateY(-6deg) scale(1.02)';
          setTimeout(()=> scene.style.transform='', 260);
        }
      });

      // Palettes
      const palettes = [
        { name:'Aurora',   p1:'#9afff0', p2:'#a9b1ff', p3:'#ffb5c9', p4:'#ffe59a' },
        { name:'Cinderice',p1:'#9fe7ff', p2:'#8ea6ff', p3:'#ff9fb9', p4:'#ffe089' },
        { name:'Verdigris',p1:'#9bffd0', p2:'#93e1ff', p3:'#ffc3a6', p4:'#fff09a' },
        { name:'Ultrapeach',p1:'#9fe0ff', p2:'#b0a7ff', p3:'#ffb1d6', p4:'#ffd27a' },
        { name:'Glacier',  p1:'#a8fff4', p2:'#c4d1ff', p3:'#ffccf3', p4:'#fff0ae' }
      ];
      function applyPalette(p) {
        root.style.setProperty('--p1', p.p1);
        root.style.setProperty('--p2', p.p2);
        root.style.setProperty('--p3', p.p3);
        root.style.setProperty('--p4', p.p4);
        btnPalette.textContent = 'Palette · ' + p.name;
      }
      const savedPalette = localStorage.getItem('s556-palette');
      if (savedPalette) {
        try { const obj = JSON.parse(savedPalette); applyPalette(obj); } catch { applyPalette(palettes[0]); }
      } else {
        applyPalette(palettes[0]);
      }
      let paletteIndex = 0;
      btnPalette.addEventListener('click', () => {
        paletteIndex = (paletteIndex + 1) % palettes.length;
        applyPalette(palettes[paletteIndex]);
        localStorage.setItem('s556-palette', JSON.stringify(palettes[paletteIndex]));
      });

      // Utilities
      function cssColor(name) {
        const v = getComputedStyle(root).getPropertyValue(name).trim();
        const hex = v.startsWith('#') ? v.replace('#','') : null;
        if (hex) { const r=parseInt(hex.slice(0,2),16), g=parseInt(hex.slice(2,4),16), b=parseInt(hex.slice(4,6),16); return [r,g,b]; }
        const m = v.match(/rgba?\(([^)]+)\)/i);
        if (m) { const p = m[1].split(',').map(Number); return p.slice(0,3); }
        return [255,255,255];
      }
      function lerp(a,b,t){ return a + (b - a) * t; }
      function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
      function mix(c1, c2, t){ return [Math.round(lerp(c1[0],c2[0],t)), Math.round(lerp(c1[1],c2[1],t)), Math.round(lerp(c1[2],c2[2],t))]; }
      function rgba(c,a){ return `rgba(${c[0]},${c[1]},${c[2]},${a})`; }

      // State
      const state = {
        paused: false,
        pulse: true,
        threads: parseInt(rThreads.value, 10),
        flux: parseFloat(rFlux.value),
        noise: parseFloat(rNoise.value),
        bloom: parseFloat(rBloom.value),
        tempo: parseFloat(rTempo.value),
        trail: 0.90,
        time: 0
      };
      hudThreads.textContent = `${state.threads} threads`;
      hudTempo.textContent = `${state.tempo.toFixed(2)}×`;

      const savedPulse = localStorage.getItem('s556-pulse');
      if (savedPulse) { state.pulse = savedPulse === 'true'; }
      btnPulse.setAttribute('aria-pressed', String(state.pulse));
      btnPulse.textContent = state.pulse ? 'Pulse' : 'Static';

      // Pointer
      const pointer = { x: 0, y: 0, nx:0, ny:0, inside:false, down:false };
      scene.addEventListener('pointerenter', ()=>{ pointer.inside = true; });
      scene.addEventListener('pointerleave', ()=>{ pointer.inside = false; pointer.down=false; scene.style.transform=''; });
      scene.addEventListener('pointermove', (e)=>{
        const rect = scene.getBoundingClientRect();
        pointer.x = e.clientX - rect.left;
        pointer.y = e.clientY - rect.top;
        pointer.nx = pointer.x / rect.width  - 0.5;
        pointer.ny = pointer.y / rect.height - 0.5;
        scene.style.transform = `perspective(1100px) rotateX(${pointer.ny * -10}deg) rotateY(${pointer.nx * 14}deg) scale(1.01)`;
      });
      scene.addEventListener('pointerdown', (e)=>{ pointer.down = true; scene.setPointerCapture(e.pointerId); });
      scene.addEventListener('pointerup', (e)=>{ pointer.down = false; scene.releasePointerCapture(e.pointerId); });

      // Canvas sizing
      let W = 1, H = 1, DPR = Math.max(1, Math.min(2.5, window.devicePixelRatio || 1));
      function resize() {
        const rect = scene.getBoundingClientRect();
        W = Math.max(1, Math.floor(rect.width));
        H = Math.max(1, Math.floor(rect.height));
        DPR = Math.max(1, Math.min(2.5, window.devicePixelRatio || 1));
        canvas.width = Math.floor(W * DPR);
        canvas.height = Math.floor(H * DPR);
        canvas.style.width = W + 'px';
        canvas.style.height = H + 'px';
        ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
        buildThreads();
        drawOnce();
      }
      window.addEventListener('resize', resize);

      // Threads
      let threads = [];
      function newThread(i, N) {
        return {
          x: Math.random() * W,
          y: Math.random() * H,
          px: 0, py: 0,
          vx: 0, vy: 0,
          hueBias: Math.random(),
          w: 0.6 + (1 - i / N) * 1.6 * (0.6 + Math.random()*0.8)
        };
      }
      function buildThreads() {
        threads = Array.from({length: state.threads}, (_,i)=> newThread(i, state.threads));
        hudThreads.textContent = `${state.threads} threads`;
      }

      // Orbit color helper reused for ribbons
      function ribbonColor(t, bias=0) {
        const c1 = cssColor('--p1'), c2 = cssColor('--p2'), c3 = cssColor('--p3'), c4 = cssColor('--p4');
        let x = (Math.sin((t + bias) * Math.PI * 2) * 0.5 + 0.5);
        if (x < 0.33) return mix(c1, c2, x / 0.33);
        if (x < 0.66) return mix(c2, c3, (x - 0.33) / 0.33);
        return mix(c3, c4, (x - 0.66) / 0.34);
      }

      // Vector field
      function field(x, y, t) {
        const nx = (x / W - 0.5), ny = (y / H - 0.5);
        const f = state.noise;
        const a = Math.sin((nx * 3.1) * f + t*0.8) + Math.cos((ny * 4.3) * f - t*0.6) + Math.sin(((nx+ny) * 2.4) * f + t*1.2);
        const angle = a * 0.9;
        const mag = state.flux * (0.6 + 0.4*Math.sin(t*0.7 + nx*2 - ny*2));
        return { dx: Math.cos(angle)*mag, dy: Math.sin(angle)*mag };
      }

      // Controls
      rThreads.addEventListener('input', ()=>{ state.threads = parseInt(rThreads.value,10); buildThreads(); });
      rFlux.addEventListener('input', ()=>{ state.flux = parseFloat(rFlux.value); });
      rNoise.addEventListener('input', ()=>{ state.noise = parseFloat(rNoise.value); });
      rBloom.addEventListener('input', ()=>{ state.bloom = parseFloat(rBloom.value); });
      rTempo.addEventListener('input', ()=>{ state.tempo = parseFloat(rTempo.value); hudTempo.textContent = `${state.tempo.toFixed(2)}×`; });

      btnPause.setAttribute('aria-pressed','false');
      btnPause.addEventListener('click', () => {
        state.paused = !state.paused;
        btnPause.setAttribute('aria-pressed', String(state.paused));
        btnPause.textContent = state.paused ? 'Resume' : 'Pause';
        if (!state.paused && !window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
          lastTime = performance.now();
          requestAnimationFrame(loop);
        }
      });

      btnPulse.addEventListener('click', () => {
        state.pulse = !state.pulse;
        btnPulse.setAttribute('aria-pressed', String(state.pulse));
        btnPulse.textContent = state.pulse ? 'Pulse' : 'Static';
        localStorage.setItem('s556-pulse', String(state.pulse));
      });

      btnRandom.addEventListener('click', () => {
        rThreads.value = String(Math.floor(lerp(40, 360, Math.random())));
        rFlux.value = (0.25 + Math.random()*2.5).toFixed(2);
        rNoise.value = (0.4 + Math.random()*3.4).toFixed(2);
        rBloom.value = (0.15 + Math.random()*1.4).toFixed(2);
        rTempo.value = (0.30 + Math.random()*2.7).toFixed(2);
        state.threads = parseInt(rThreads.value,10);
        state.flux = parseFloat(rFlux.value);
        state.noise = parseFloat(rNoise.value);
        state.bloom = parseFloat(rBloom.value);
        state.tempo = parseFloat(rTempo.value);
        hudThreads.textContent = `${state.threads} threads`;
        hudTempo.textContent = `${state.tempo.toFixed(2)}×`;
        buildThreads();
        if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
          scene.style.transform = 'perspective(1100px) rotateX(-8deg) rotateY(8deg) scale(1.03)';
          setTimeout(()=> scene.style.transform='', 260);
        }
      });

      // Background fade
      function fadeFrame() {
        ctx.globalCompositeOperation = 'source-over';
        if (root.dataset.theme==='noir') {
          ctx.fillStyle = `rgba(7,10,18,${(1 - state.trail)})`;
        } else {
          ctx.fillStyle = `rgba(255,255,255,${(1 - state.trail)})`;
        }
        ctx.fillRect(0,0,W,H);
        // subtle color bath
        const g = ctx.createRadialGradient(W*0.5, H*0.5, 0, W*0.5, H*0.5, Math.min(W,H)*0.7);
        const a1 = cssColor('--p2'), a2 = cssColor('--p1'), a3 = cssColor('--p3');
        const alpha = root.dataset.theme==='noir' ? 0.07 : 0.12;
        g.addColorStop(0, rgba(a2, alpha * 0.9));
        g.addColorStop(0.6, rgba(a1, alpha * 0.7));
        g.addColorStop(1, rgba(a3, alpha * 0.8));
        ctx.fillStyle = g;
        ctx.globalAlpha = root.dataset.theme==='noir' ? 0.7 : 0.55;
        ctx.fillRect(0,0,W,H);
        ctx.globalAlpha = 1;
      }

      // Draw once
      function drawOnce() { ctx.clearRect(0,0,W,H); }

      // Animate
      let lastTime = performance.now();
      function loop(now) {
        const dtRaw = (now - lastTime)/1000;
        const dt = Math.min(0.05, dtRaw) * state.tempo;
        lastTime = now;
        state.time += dt;

        // Pulse modulation
        const pulseAmp = state.pulse ? (0.35 + 0.25*Math.sin(state.time*1.2)) : 0;
        const fluxMod = 1 + pulseAmp * 0.6;

        fadeFrame();

        // draw threads
        for (let i=0; i<threads.length; i++) {
          const t = threads[i];
          t.px = t.x; t.py = t.y;

          const f = field(t.x, t.y, state.time);
          let dx = f.dx * fluxMod, dy = f.dy * fluxMod;

          // Pointer attraction/repulsion
          if (pointer.inside) {
            const dxp = pointer.x - t.x;
            const dyp = pointer.y - t.y;
            const d = Math.hypot(dxp, dyp) + 0.0001;
            const pull = (pointer.down ? 1.8 : 0.9) * Math.exp(-(d / Math.min(W,H)) * 3.0);
            dx += dxp / d * pull * 12;
            dy += dyp / d * pull * 12;
          }

          // integrate velocity
          t.vx = t.vx * 0.92 + dx * 0.08;
          t.vy = t.vy * 0.92 + dy * 0.08;

          t.x += t.vx * 16 * dt;
          t.y += t.vy * 16 * dt;

          // wrap / reset
          if (t.x < -2 || t.x > W+2 || t.y < -2 || t.y > H+2) {
            t.x = (t.x + W) % W;
            t.y = (t.y + H) % H;
            t.px = t.x; t.py = t.y;
          }

          // draw segment
          const col = ribbonColor((i+1)/threads.length, t.hueBias);
          ctx.globalCompositeOperation = 'lighter';
          ctx.lineWidth = t.w * (0.7 + state.bloom*0.3);
          ctx.strokeStyle = rgba(col, root.dataset.theme==='noir' ? (0.18 + state.bloom*0.14) : (0.12 + state.bloom*0.10));
          const dxSeg = t.x - t.px, dySeg = t.y - t.py;
          if (Math.hypot(dxSeg, dySeg) < Math.min(W,H) * 0.25) {
            ctx.beginPath();
            // subtle curve: mid-point nudged by perpendicular
            const mx = (t.px + t.x)/2, my = (t.py + t.y)/2;
            const nx = -dySeg, ny = dxSeg;
            const k = 0.12;
            ctx.moveTo(t.px, t.py);
            ctx.quadraticCurveTo(mx + nx*k, my + ny*k, t.x, t.y);
            ctx.stroke();

            // bloom halo
            if (state.bloom > 0.1) {
              const halo = ctx.createRadialGradient(t.x, t.y, 0, t.x, t.y, 22 * state.bloom);
              halo.addColorStop(0, rgba(col, 0.16 * state.bloom));
              halo.addColorStop(1, 'rgba(0,0,0,0)');
              ctx.fillStyle = halo;
              ctx.fillRect(t.x-30, t.y-30, 60, 60);
            }
          }
          ctx.globalCompositeOperation = 'source-over';
        }

        if (!state.paused && !window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
          requestAnimationFrame(loop);
        }
      }

      // Init
      resize();
      buildThreads();
      drawOnce();
      if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) requestAnimationFrame(loop);

    })();
  </script>
</section>
      </section>
      <!-- END_EDITABLE -->
    <script>
      // Only show a local placeholder if the agent hasn't written a timestamp yet
      const el = document.getElementById('last-updated');
      if (el && (!el.textContent || el.textContent.includes('not yet'))) {
        const now = new Date();
        el.textContent = `Last updated: ${now.toLocaleString(undefined, { hour12: false })}`;
      }
    </script>
  </body>
  </html>


