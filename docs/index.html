<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vibing</title>
    <style>
      :root {
        --bg: #0f1221;
        --fg: #e6e8f0;
        --muted: #9aa3b2;
        --accent: #8b5cf6;
      }
      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--fg);
        background: radial-gradient(1200px 800px at 70% 10%, #1b1f3a, var(--bg));
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        width: min(720px, 92vw);
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px;
        padding: 28px 24px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        backdrop-filter: blur(6px);
      }
      h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
        letter-spacing: 0.3px;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 18px;
      }
      #content {
        font-size: 18px;
        line-height: 1.6;
        background: rgba(255,255,255,0.04);
        border: 1px dashed rgba(255,255,255,0.12);
        border-radius: 12px;
        padding: 16px;
      }
      .footer {
        margin-top: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: var(--muted);
      }
      .badge {
        display: inline-block;
        background: rgba(139, 92, 246, 0.18);
        color: #d4c2ff;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(139, 92, 246, 0.35);
        letter-spacing: 0.2px;
      }
    </style>
  </head>
  <body>
    <!-- BEGIN_EDITABLE -->
      <section id="content">
<section class="v1085" aria-label="Lumen Loom — kinetic poster">
  <style>
    .v1085 {
      --ink: #0b1220;
      --muted: #5b6a86;
      --line: rgba(11,18,32,0.15);
      --bg-a: #e8f1ff;
      --bg-b: #f7faff;
      --acc-1: #6fd6ff;
      --acc-2: #a7ffcf;
      --acc-3: #ffb8e2;
      position: relative;
      min-height: 640px;
      padding: 18px;
      color: var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
      border-radius: 32px;
      background:
        radial-gradient(1200px 700px at var(--mx,50%) var(--my,40%), rgba(111,214,255,0.22), transparent 55%),
        linear-gradient(160deg, var(--bg-a), var(--bg-b));
      box-shadow:
        0 30px 90px rgba(8,24,64,0.28),
        inset 0 0 0 1px rgba(255,255,255,0.7);
      overflow: hidden;
      transform: perspective(900px) rotateX(calc((var(--my,0.5) - .5) * -7deg)) rotateY(calc((var(--mx,0.5) - .5) * 10deg));
      transition: background .6s ease, box-shadow .4s ease, transform .2s ease;
      isolation: isolate;
    }
    .v1085.dark {
      --ink: #ecf2ff;
      --muted: #99a6c2;
      --line: rgba(255,255,255,0.18);
      --bg-a: #0a0f1c;
      --bg-b: #101a2f;
      box-shadow:
        0 40px 100px rgba(2,8,24,0.7),
        inset 0 0 0 1px rgba(255,255,255,0.06);
    }
    .v1085 * { box-sizing: border-box; }

    /* Ambient conic halo */
    .v1085 .halo {
      position: absolute; inset: -30%; z-index: 0; pointer-events: none;
      background:
        conic-gradient(from var(--spin,0deg), rgba(167,255,207,0.12), rgba(111,214,255,0.12), rgba(255,184,226,0.12), rgba(167,255,207,0.12));
      filter: blur(48px) saturate(140%);
      animation: v1085_spin 36s linear infinite;
      transform: translateZ(0);
    }
    @keyframes v1085_spin {
      0% { --spin: 0deg; }
      100% { --spin: 360deg; }
    }

    /* Subtle grain */
    .v1085::after {
      content: "";
      position: absolute; inset: 0; pointer-events: none; z-index: 1;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 80 80"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.05"/></svg>');
      mix-blend-mode: soft-light;
    }

    /* Stage */
    .v1085 .stage {
      position: relative; z-index: 2;
      height: clamp(420px, 58vh, 680px);
      border-radius: 26px;
      overflow: hidden;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.45);
      backdrop-filter: blur(10px) saturate(140%); -webkit-backdrop-filter: blur(10px) saturate(140%);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.6), 0 16px 36px rgba(12,26,58,0.18);
    }
    .v1085.dark .stage {
      background: rgba(255,255,255,0.05);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06), 0 16px 40px rgba(2,8,20,0.5);
    }

    .v1085 canvas.canvas {
      position: absolute; inset: 0; width: 100%; height: 100%;
      display: block;
    }

    /* Rotating text ring */
    .v1085 .ring {
      position: absolute; inset: 0; margin: auto; width: 64vmin; height: 64vmin; max-width: 720px; max-height: 720px;
      z-index: 3; pointer-events: none;
      filter: drop-shadow(0 8px 24px rgba(0,0,0,0.2));
      opacity: 0.85;
    }
    .v1085 .ring text {
      font-size: clamp(14px, 2.2vmin, 20px);
      letter-spacing: .28em;
      text-transform: uppercase;
      fill: none;
      stroke-width: 1;
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke: rgba(255,255,255,0.8);
    }
    .v1085.dark .ring text { stroke: rgba(255,255,255,0.45); }
    .v1085 .ring .spin { animation: v1085_orbit 28s linear infinite; transform-origin: 50% 50%; }
    @keyframes v1085_orbit {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* HUD */
    .v1085 .hud {
      position: relative; z-index: 4;
      display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: start;
      margin-top: 16px;
      padding: 14px;
      border-radius: 22px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.55);
      backdrop-filter: blur(10px) saturate(140%); -webkit-backdrop-filter: blur(10px) saturate(140%);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.6), 0 14px 30px rgba(12,26,58,0.16);
    }
    .v1085.dark .hud {
      background: rgba(255,255,255,0.06);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06), 0 14px 34px rgba(2,8,20,0.5);
    }
    .v1085 .badge {
      display: inline-flex; align-items: center; gap: 10px;
      font-size: 11px; letter-spacing: .16em; text-transform: uppercase; color: var(--muted);
      padding: 7px 11px; border-radius: 999px; border: 1px solid var(--line);
      background: rgba(255,255,255,0.7);
    }
    .v1085.dark .badge { background: rgba(255,255,255,0.06); }
    .v1085 h1 {
      margin: 6px 0 4px;
      font-size: clamp(34px, 7vw, 74px);
      letter-spacing: -0.02em; line-height: 1.02; font-weight: 900;
      background: linear-gradient(90deg, var(--acc-1), var(--acc-2), var(--acc-3));
      -webkit-background-clip: text; background-clip: text; color: transparent;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,0.18));
      animation: v1085_sheen 16s linear infinite;
    }
    @keyframes v1085_sheen { 0% { background-position: 0% 0; } 100% { background-position: 220% 0; } }
    .v1085 .tag { margin: 0; color: var(--muted); font-size: clamp(14px, 2.2vw, 18px); }

    .v1085 .tools {
      display: grid; grid-auto-flow: column; gap: 8px; align-content: start;
    }
    .v1085 .tool {
      appearance: none; cursor: pointer;
      display: inline-grid; grid-auto-flow: column; align-items: center; gap: 10px;
      padding: 10px 14px; border-radius: 14px; border: 1px solid var(--line);
      background: rgba(255,255,255,0.7); color: inherit;
      transition: transform .18s ease, background .2s ease, border-color .2s ease;
      user-select: none;
    }
    .v1085 .tool:hover { transform: translateY(-1px); }
    .v1085.dark .tool { background: rgba(255,255,255,0.06); }
    .v1085 .tool svg { width: 18px; height: 18px; }
    .v1085 .slider {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 10px; border-radius: 14px; border: 1px solid var(--line);
      background: rgba(255,255,255,0.65);
    }
    .v1085.dark .slider { background: rgba(255,255,255,0.06); }
    .v1085 .slider label {
      font-size: 11px; letter-spacing: .16em; text-transform: uppercase; color: var(--muted);
    }
    .v1085 input[type="range"] { -webkit-appearance: none; width: 140px; height: 30px; background: transparent; }
    .v1085 input[type="range"]::-webkit-slider-runnable-track {
      height: 6px; border-radius: 999px;
      background: linear-gradient(90deg, var(--acc-1), var(--acc-2), var(--acc-3));
    }
    .v1085 input[type="range"]::-moz-range-track {
      height: 6px; border-radius: 999px;
      background: linear-gradient(90deg, var(--acc-1), var(--acc-2), var(--acc-3));
    }
    .v1085 input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; margin-top: -6px; width: 18px; height: 18px; border-radius: 50%;
      background: #fff; border: 1px solid rgba(11,20,32,0.18); box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }
    .v1085.dark input[type="range"]::-webkit-slider-thumb {
      background: #0b1420; border-color: rgba(255,255,255,0.25);
    }
    .v1085 input[type="range"]::-moz-range-thumb {
      width: 18px; height: 18px; border-radius: 50%; background: #fff; border: 1px solid rgba(11,20,32,0.18);
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }
    .v1085.dark input[type="range"]::-moz-range-thumb {
      background: #0b1420; border-color: rgba(255,255,255,0.25);
    }

    /* Meta */
    .v1085 .meta {
      position: relative; z-index: 4; margin-top: 14px;
      display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap;
      padding: 12px 6px; color: var(--muted); font-size: 13px; border-top: 1px dashed var(--line);
    }
    .v1085 .stats { display: inline-flex; gap: 8px; flex-wrap: wrap; }
    .v1085 .stat {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 6px 10px; border-radius: 999px; border: 1px dashed var(--line);
      background: rgba(255,255,255,0.6);
    }
    .v1085.dark .stat { background: rgba(255,255,255,0.06); }

    /* Hints */
    .v1085 .hint {
      position: absolute; left: 12px; bottom: 10px; z-index: 3;
      padding: 8px 10px; border-radius: 12px; border: 1px dashed var(--line);
      background: rgba(255,255,255,0.6); color: var(--muted); font-size: 12px;
      backdrop-filter: blur(6px);
    }
    .v1085.dark .hint { background: rgba(255,255,255,0.06); }

    /* Responsive */
    @media (max-width: 820px) {
      .v1085 .hud { grid-template-columns: 1fr; }
      .v1085 .tools { grid-auto-flow: row; justify-items: start; }
      .v1085 input[type="range"] { width: 120px; }
      .v1085 .ring { width: 78vmin; height: 78vmin; }
    }
    @media (prefers-reduced-motion: reduce) {
      .v1085, .v1085 .ring .spin { animation: none !important; }
      .v1085 h1 { animation: none !important; }
    }
  </style>

  <div class="halo" aria-hidden="true"></div>

  <div class="stage" role="img" aria-label="Generative orbits and threads">
    <canvas class="canvas"></canvas>

    <svg class="ring" viewBox="0 0 100 100" aria-hidden="true">
      <defs>
        <path id="v1085_circ" d="M50,5 a45,45 0 1,1 0,90 a45,45 0 1,1 0,-90" />
        <linearGradient id="v1085_textg" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="var(--acc-1)"/>
          <stop offset="50%" stop-color="var(--acc-2)"/>
          <stop offset="100%" stop-color="var(--acc-3)"/>
        </linearGradient>
      </defs>
      <g class="spin">
        <text stroke="url(#v1085_textg)">
          <textPath href="#v1085_circ" startOffset="0%">
            Lumen Loom • Kinetic Poster • Press + Hold to Warp • Double‑Click to Seed •
          </textPath>
        </text>
      </g>
    </svg>

    <span class="hint">Hold: warp • Double‑click: seed node • Keys: T, M, P, Space</span>
  </div>

  <div class="hud" role="group" aria-label="Header and controls">
    <div class="lead">
      <span class="badge" aria-label="Iteration badge">Iteration 1085</span>
      <h1>Lumen Loom</h1>
      <p class="tag">Threads of light woven by your pointer. Calm, curious, alive.</p>
    </div>
    <div class="tools">
      <button class="tool t-theme" type="button" title="Switch theme">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 2a1 1 0 0 0-1 1v3a1 1 0 1 0 2 0V3a1 1 0 0 0-1-1zm0 17a1 1 0 0 0-1 1v1a1 1 0 1 0 2 0v-1a1 1 0 0 0-1-1zM4.93 4.93a1 1 0 0 0 0 1.41l2.12 2.12a1 1 0 1 0 1.41-1.41L6.34 4.93a1 1 0 0 0-1.41 0zm10.61 10.61a1 1 0 0 0 0 1.41l2.12 2.12a1 1 0 0 0 1.41-1.41l-2.12-2.12a1 1 0 0 0-1.41 0zM2 13a1 1 0 1 0 0-2H1a1 1 0 1 0 0 2h1zm21 0a1 1 0 1 0 0-2h-1a1 1 0 1 0 0 2h1zM4.93 19.07a1 1 0 0 0 1.41 0l2.12-2.12a1 1 0 1 0-1.41-1.41L4.93 17.66a1 1 0 0 0 0 1.41zM19.07 4.93a1 1 0 0 0-1.41 0l-2.12 2.12a1 1 0 1 0 1.41 1.41l2.12-2.12a1 1 0 0 0 0-1.41z"/></svg>
        <span class="label">Day</span>
      </button>
      <button class="tool t-mode" type="button" title="Toggle mode">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm-1 5h2v5h5v2h-5v5h-2v-5H6v-2h5V7z"/></svg>
        <span class="label">Orbits</span>
      </button>
      <button class="tool t-palette" type="button" title="Cycle palette">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 3a9 9 0 1 0 9 9c0-.55-.45-1-1-1h-4a1 1 0 0 1-1-1V6c0-.55-.45-1-1-1h-2z"/></svg>
        <span class="label">Solar</span>
      </button>
      <div class="slider">
        <label for="intensity">Intensity</label>
        <input id="intensity" class="t-intensity" type="range" min="0" max="2" step="0.05" value="1" aria-label="Motion intensity">
      </div>
    </div>
  </div>

  <div class="meta">
    <div class="stats">
      <span class="stat">Nodes: <strong class="nodes" style="font-variant-numeric: tabular-nums;">–</strong></span>
      <span class="stat">Mode: <strong class="mname">Orbits</strong></span>
      <span class="stat">Palette: <strong class="pname">Solar</strong></span>
    </div>
    <span id="last-updated">Last updated: 2025-12-05 07:38:46 EST</span>
  </div>

  <script>
    (function(){
      const root = document.querySelector('.v1085');
      const stage = root.querySelector('.stage');
      const canvas = root.querySelector('.canvas');
      const ctx = canvas.getContext('2d', { alpha: true });

      const ui = {
        theme: root.querySelector('.t-theme'),
        mode: root.querySelector('.t-mode'),
        palette: root.querySelector('.t-palette'),
        intensity: root.querySelector('.t-intensity'),
        nodes: root.querySelector('.nodes'),
        mname: root.querySelector('.mname'),
        pname: root.querySelector('.pname'),
        updated: root.querySelector('#last-updated'),
      };

      // Timestamp
      try {
        const fmt = new Intl.DateTimeFormat([], {
          weekday: 'short', month: 'short', day: '2-digit',
          hour: '2-digit', minute: '2-digit', second: '2-digit',
          hour12: true, timeZoneName: 'short'
        });
        ui.updated.textContent = 'Last updated: ' + fmt.format(new Date());
      } catch(_) {
        ui.updated.textContent = 'Last updated: ' + new Date().toLocaleString();
      }

      // State
      const state = {
        dpr: Math.min(2, window.devicePixelRatio || 1),
        running: true,
        t: 0,
        w: 0, h: 0,
        mx: 0.5, my: 0.4,
        pressing: false,
        mode: 0, // 0 Orbits, 1 Threads
        intensity: parseFloat(ui.intensity.value || '1'),
        palette: 0,
        points: [],
        anchors: [],
        linkDist: 140,
      };

      // Themes - default from system
      try {
        const mq = window.matchMedia('(prefers-color-scheme: dark)');
        root.classList.toggle('dark', mq.matches);
        ui.theme.querySelector('.label').textContent = mq.matches ? 'Night' : 'Day';
        mq.addEventListener?.('change', e => {
          root.classList.toggle('dark', e.matches);
          ui.theme.querySelector('.label').textContent = e.matches ? 'Night' : 'Day';
        });
      } catch(_) {}

      // Palettes
      const palettes = [
        { name: 'Solar', hues: [48, 12, 210, 160], sat: [98, 92, 86, 78], light: [62, 56, 64, 66] },
        { name: 'Nocturne', hues: [200, 260, 300, 180], sat: [80, 88, 84, 68], light: [60, 58, 62, 64] },
        { name: 'Vapor', hues: [320, 180, 250, 200], sat: [90, 75, 88, 82], light: [68, 66, 70, 64] },
        { name: 'Garden', hues: [140, 120, 90, 60], sat: [74, 72, 68, 70], light: [64, 62, 60, 58] },
      ];
      function hueAt(i, a) {
        const p = palettes[state.palette];
        const k = i % p.hues.length;
        return `hsla(${p.hues[k]}, ${p.sat[k]}%, ${p.light[k]}%, ${a})`;
      }

      // Resize/init
      function resize() {
        const r = stage.getBoundingClientRect();
        state.w = Math.max(640, Math.floor(r.width));
        state.h = Math.max(420, Math.floor(r.height));
        canvas.width = Math.floor(state.w * state.dpr);
        canvas.height = Math.floor(state.h * state.dpr);
        canvas.style.width = state.w + 'px';
        canvas.style.height = state.h + 'px';
        ctx.setTransform(state.dpr, 0, 0, state.dpr, 0, 0);
        initSystem();
      }
      new ResizeObserver(resize).observe(stage);

      function initSystem() {
        // points
        const area = state.w * state.h;
        const n = Math.max(80, Math.min(160, Math.floor(area / 16000)));
        state.points = [];
        for (let i = 0; i < n; i++) {
          const x = Math.random() * state.w;
          const y = Math.random() * state.h;
          const a = Math.random() * Math.PI * 2;
          const r = 20 + Math.random() * 90;
          const s = (Math.random() * 0.6 + 0.2) * 0.002;
          const hueIdx = i % 4;
          state.points.push({ x, y, vx: 0, vy: 0, a, r, s, hueIdx, life: Math.random() * 1000 });
        }
        // anchors for Orbits
        const m = 4;
        state.anchors = [];
        for (let i = 0; i < m; i++) {
          const ax = state.w * (0.2 + 0.6 * Math.random());
          const ay = state.h * (0.2 + 0.6 * Math.random());
          const rot = Math.random() * Math.PI * 2;
          const rad = (Math.min(state.w, state.h) * (0.12 + Math.random() * 0.18));
          const speed = (Math.random() * 0.5 + 0.2) * 0.0012;
          state.anchors.push({ ax, ay, rot, rad, speed });
        }
        ui.nodes.textContent = state.points.length;
      }

      // Pointer/tilt
      function setMouseFromClient(x, y) {
        const r = root.getBoundingClientRect();
        const nx = Math.min(1, Math.max(0, (x - r.left) / Math.max(1, r.width)));
        const ny = Math.min(1, Math.max(0, (y - r.top) / Math.max(1, r.height)));
        state.mx += (nx - state.mx) * 0.12;
        state.my += (ny - state.my) * 0.12;
        root.style.setProperty('--mx', (state.mx * 100).toFixed(2) + '%');
        root.style.setProperty('--my', (state.my * 100).toFixed(2) + '%');
      }
      root.addEventListener('pointermove', (e) => setMouseFromClient(e.clientX, e.clientY));
      stage.addEventListener('pointerdown', (e) => { state.pressing = true; seedRipple(e.clientX, e.clientY); });
      window.addEventListener('pointerup', () => state.pressing = false);
      stage.addEventListener('dblclick', (e) => { seedNode(e.clientX, e.clientY); });

      function clientToLocal(x, y) {
        const r = stage.getBoundingClientRect();
        return { x: x - r.left, y: y - r.top };
      }

      function seedNode(cx, cy) {
        const p = clientToLocal(cx, cy);
        const a = Math.random() * Math.PI * 2;
        const r = 40 + Math.random() * 80;
        const s = (Math.random() * 0.6 + 0.2) * 0.002;
        const hueIdx = (Math.random() * 4) | 0;
        state.points.push({ x: p.x, y: p.y, vx: 0, vy: 0, a, r, s, hueIdx, life: 0 });
        ui.nodes.textContent = state.points.length;
      }

      const ripples = [];
      function seedRipple(cx, cy) {
        const p = clientToLocal(cx, cy);
        ripples.push({ x: p.x, y: p.y, r: 2, a: 0.32 });
      }

      // Draw helpers
      function clearSoft() {
        const dark = root.classList.contains('dark');
        const a = dark ? 0.08 : 0.06;
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = `rgba(0,0,0,${a})`;
        ctx.fillRect(0, 0, state.w, state.h);
      }

      function drawRipples() {
        if (!ripples.length) return;
        ctx.globalCompositeOperation = 'screen';
        for (let i = ripples.length - 1; i >= 0; i--) {
          const r = ripples[i];
          r.r += 7;
          r.a *= 0.93;
          ctx.beginPath();
          ctx.strokeStyle = hueAt((i + (state.t*10|0)) % 4, r.a.toFixed(3));
          ctx.lineWidth = 1.4;
          ctx.arc(r.x, r.y, r.r, 0, Math.PI*2);
          ctx.stroke();
          if (r.a < 0.01) ripples.splice(i, 1);
        }
      }

      function stepOrbits() {
        // update anchor drift
        for (const a of state.anchors) {
          a.rot += a.speed * (0.8 + state.intensity * 0.6);
        }
        // update points relative to anchors
        for (let i = 0; i < state.points.length; i++) {
          const p = state.points[i];
          const anchor = state.anchors[i % state.anchors.length];
          const ox = anchor.ax + Math.cos(anchor.rot + i * 0.2) * anchor.rad;
          const oy = anchor.ay + Math.sin(anchor.rot + i * 0.2) * anchor.rad;

          p.a += p.s * (0.6 + state.intensity * 0.9);
          const targetX = ox + Math.cos(p.a) * p.r;
          const targetY = oy + Math.sin(p.a) * p.r;

          // pointer warp
          if (state.pressing) {
            const r = stage.getBoundingClientRect();
            const px = r.left + state.mx * r.width;
            const py = r.top + state.my * r.height;
            const local = clientToLocal(px, py);
            const dx = local.x - p.x;
            const dy = local.y - p.y;
            const d2 = dx*dx + dy*dy;
            const f = Math.min(1.2, 2000 / (d2 + 200));
            p.vx += dx * 0.0008 * f * (0.5 + state.intensity);
            p.vy += dy * 0.0008 * f * (0.5 + state.intensity);
          }

          p.vx += (targetX - p.x) * 0.018;
          p.vy += (targetY - p.y) * 0.018;
          p.vx *= 0.92;
          p.vy *= 0.92;
          p.x += p.vx;
          p.y += p.vy;
        }
      }

      function stepThreads() {
        // gentle drift
        for (let i = 0; i < state.points.length; i++) {
          const p = state.points[i];
          p.life += 0.01;
          const n1 = Math.sin(p.life * 0.9 + i * 13.1);
          const n2 = Math.cos(p.life * 1.1 + i * 7.3);
          p.vx += n1 * 0.02 * state.intensity;
          p.vy += n2 * 0.02 * state.intensity;

          // pointer warp
          if (state.pressing) {
            const r = stage.getBoundingClientRect();
            const px = r.left + state.mx * r.width;
            const py = r.top + state.my * r.height;
            const local = clientToLocal(px, py);
            const dx = local.x - p.x;
            const dy = local.y - p.y;
            const d2 = dx*dx + dy*dy;
            const f = Math.min(1.1, 1600 / (d2 + 200));
            p.vx += dx * 0.0007 * f * (0.4 + state.intensity);
            p.vy += dy * 0.0007 * f * (0.4 + state.intensity);
          }

          p.vx *= 0.96;
          p.vy *= 0.96;
          p.x = (p.x + p.vx + state.w) % state.w;
          p.y = (p.y + p.vy + state.h) % state.h;
        }
      }

      function drawOrbits() {
        ctx.save();
        ctx.globalCompositeOperation = 'lighter';
        // glow trails
        for (let i = 0; i < state.points.length; i++) {
          const p = state.points[i];
          // dot
          ctx.beginPath();
          ctx.fillStyle = hueAt(p.hueIdx + 1, root.classList.contains('dark') ? 0.85 : 0.75);
          ctx.arc(p.x, p.y, 1.2 + Math.sin(state.t*3 + i)*0.6, 0, Math.PI*2);
          ctx.fill();
          // line to anchor proxy (midpoint of local orbit)
          const anchor = state.anchors[i % state.anchors.length];
          const ax = anchor.ax + Math.cos(anchor.rot + i * 0.2) * anchor.rad;
          const ay = anchor.ay + Math.sin(anchor.rot + i * 0.2) * anchor.rad;
          ctx.beginPath();
          const alpha = 0.12 + 0.12 * Math.sin(i + state.t*2);
          ctx.strokeStyle = hueAt(p.hueIdx + 2, alpha);
          ctx.lineWidth = 1;
          ctx.moveTo(p.x, p.y);
          ctx.lineTo(ax, ay);
          ctx.stroke();
        }
        ctx.restore();
      }

      function drawThreads() {
        ctx.save();
        ctx.globalCompositeOperation = 'lighter';
        // connections
        const N = state.points.length;
        for (let i = 0; i < N; i++) {
          const p = state.points[i];
          for (let j = i + 1; j < N; j++) {
            const q = state.points[j];
            const dx = p.x - q.x;
            const dy = p.y - q.y;
            const d2 = dx*dx + dy*dy;
            if (d2 < state.linkDist * state.linkDist) {
              const d = Math.sqrt(d2);
              const a = 1 - d / state.linkDist;
              if (a > 0.02) {
                ctx.beginPath();
                ctx.strokeStyle = hueAt((p.hueIdx + j) % 4, (root.classList.contains('dark') ? 0.35 : 0.28) * (a+0.2));
                ctx.lineWidth = 0.8 + a * 1.4;
                ctx.moveTo(p.x, p.y);
                ctx.lineTo(q.x, q.y);
                ctx.stroke();
              }
            }
          }
          // node
          ctx.beginPath();
          ctx.fillStyle = hueAt(p.hueIdx, root.classList.contains('dark') ? 0.8 : 0.7);
          ctx.arc(p.x, p.y, 1.1, 0, Math.PI*2);
          ctx.fill();
        }
        ctx.restore();
      }

      // Loop
      let raf;
      function frame() {
        if (!state.running) return;
        state.t += 0.016;
        clearSoft();
        drawRipples();
        if (state.mode === 0) {
          stepOrbits();
          drawOrbits();
        } else {
          stepThreads();
          drawThreads();
        }
        raf = requestAnimationFrame(frame);
      }

      // Controls
      ui.theme.addEventListener('click', () => {
        const toDark = !root.classList.contains('dark');
        root.classList.toggle('dark', toDark);
        ui.theme.querySelector('.label').textContent = toDark ? 'Night' : 'Day';
      });

      ui.mode.addEventListener('click', () => {
        state.mode = (state.mode + 1) % 2;
        const name = state.mode === 0 ? 'Orbits' : 'Threads';
        ui.mode.querySelector('.label').textContent = name;
        ui.mname.textContent = name;
      });

      ui.palette.addEventListener('click', () => {
        state.palette = (state.palette + 1) % palettes.length;
        const name = palettes[state.palette].name;
        ui.palette.querySelector('.label').textContent = name;
        ui.pname.textContent = name;
        // map palette to accent variables for UI
        const p = palettes[state.palette];
        root.style.setProperty('--acc-1', `hsl(${p.hues[0]} ${p.sat[0]}% ${p.light[0]}%)`);
        root.style.setProperty('--acc-2', `hsl(${p.hues[1]} ${p.sat[1]}% ${p.light[1]}%)`);
        root.style.setProperty('--acc-3', `hsl(${p.hues[2]} ${p.sat[2]}% ${p.light[2]}%)`);
      });

      ui.intensity.addEventListener('input', () => {
        state.intensity = parseFloat(ui.intensity.value || '1');
        state.linkDist = 120 + state.intensity * 60;
      });

      // Keyboard shortcuts
      window.addEventListener('keydown', (e) => {
        if (e.code === 'Space') { e.preventDefault(); toggleRun(); }
        if (e.key.toLowerCase() === 't') ui.theme.click();
        if (e.key.toLowerCase() === 'm') ui.mode.click();
        if (e.key.toLowerCase() === 'p') ui.palette.click();
      });

      function toggleRun() {
        state.running = !state.running;
        if (state.running) { cancelAnimationFrame(raf); raf = requestAnimationFrame(frame); }
      }

      // Reduced motion
      try {
        const mq = window.matchMedia('(prefers-reduced-motion: reduce)');
        if (mq.matches) state.running = false;
        mq.addEventListener?.('change', (e) => {
          state.running = !e.matches;
          if (state.running) { cancelAnimationFrame(raf); raf = requestAnimationFrame(frame); }
        });
      } catch(_) {}

      // Boot
      resize();
      const r0 = root.getBoundingClientRect();
      setMouseFromClient(r0.left + r0.width * 0.5, r0.top + r0.height * 0.4);
      if (state.running) raf = requestAnimationFrame(frame);
    })();
  </script>
</section>
      </section>
      <!-- END_EDITABLE -->
    <script>
      // Only show a local placeholder if the agent hasn't written a timestamp yet
      const el = document.getElementById('last-updated');
      if (el && (!el.textContent || el.textContent.includes('not yet'))) {
        const now = new Date();
        el.textContent = `Last updated: ${now.toLocaleString(undefined, { hour12: false })}`;
      }
    </script>
  </body>
  </html>


