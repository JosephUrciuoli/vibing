<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vibing</title>
    <style>
      :root {
        --bg: #0f1221;
        --fg: #e6e8f0;
        --muted: #9aa3b2;
        --accent: #8b5cf6;
      }
      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--fg);
        background: radial-gradient(1200px 800px at 70% 10%, #1b1f3a, var(--bg));
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        width: min(720px, 92vw);
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px;
        padding: 28px 24px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        backdrop-filter: blur(6px);
      }
      h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
        letter-spacing: 0.3px;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 18px;
      }
      #content {
        font-size: 18px;
        line-height: 1.6;
        background: rgba(255,255,255,0.04);
        border: 1px dashed rgba(255,255,255,0.12);
        border-radius: 12px;
        padding: 16px;
      }
      .footer {
        margin-top: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: var(--muted);
      }
      .badge {
        display: inline-block;
        background: rgba(139, 92, 246, 0.18);
        color: #d4c2ff;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(139, 92, 246, 0.35);
        letter-spacing: 0.2px;
      }
    </style>
  </head>
  <body>
    <!-- BEGIN_EDITABLE -->
      <section id="content">
<section id="sonata560" aria-label="SONATA 560 — Watercolor Garden">
  <style>
    /* SONATA — Iteration 560 (scoped) */
    #sonata560 {
      --ink: #1b1f27;
      --muted: #5d6472;

      --paperA: #faf7f2;
      --paperB: #f3efe8;
      --paperFiber: rgba(0,0,0,.02);

      --a: #ff7a7a; /* coral */
      --b: #5ad7c2; /* mint */
      --c: #9f8bff; /* lilac */

      --ring: rgba(27,31,39,.12);
      --ring-strong: rgba(27,31,39,.18);

      --shadow: 0 30px 80px rgba(27,31,39,.18);
      --soft: blur(12px) saturate(120%);

      position: relative;
      display: grid;
      place-items: center;
      min-height: 96vh;
      padding: clamp(16px, 5vw, 56px);
      color: var(--ink);
      font-family: ui-sans-serif, -apple-system, Segoe UI, "SF Pro Display", "Helvetica Neue", Inter, system-ui, Roboto, Arial, sans-serif;
      background:
        radial-gradient(140% 160% at 50% -20%, var(--paperA), var(--paperB) 40%, #ece7de 90%),
        repeating-linear-gradient(115deg, var(--paperFiber) 0 1px, transparent 1px 9px);
      overflow: hidden;
      border-radius: 40px;
      isolation: isolate;
    }
    #sonata560[data-theme="night"] {
      --ink: #ecf1ff;
      --muted: #93a0bc;
      --ring: rgba(255,255,255,.12);
      --ring-strong: rgba(255,255,255,.18);
      background:
        radial-gradient(160% 180% at 50% -20%, #0b1020, #121a33 40%, #0b0f25 100%),
        repeating-linear-gradient(115deg, rgba(255,255,255,.02) 0 1px, transparent 1px 9px);
      --shadow: 0 40px 100px rgba(0,0,0,.55);
    }

    /* Floating petals (ambient) */
    #sonata560 .petals { position: absolute; inset: -10% -20%; pointer-events: none; z-index: 0; }
    #sonata560 .petal {
      position: absolute;
      width: clamp(12px, 1.8vw, 22px); height: clamp(12px, 1.8vw, 22px);
      border-radius: 100% 60% 100% 60% / 100% 60% 100% 60%;
      opacity: .18; filter: blur(1px);
      background: radial-gradient(circle at 30% 30%, #fff8, #fff0 60%), linear-gradient(180deg, var(--a), var(--b));
      mix-blend-mode: soft-light;
      animation: s560-drift calc(18s + var(--z) * 8s) linear infinite;
      transform: rotate(var(--r));
      left: calc(var(--x) * 100%); top: calc(var(--y) * 100%);
    }
    #sonata560[data-theme="night"] .petal { opacity: .26; mix-blend-mode: screen; }
    @keyframes s560-drift {
      0%   { transform: translate3d(0, 0, 0) rotate(var(--r)); }
      50%  { transform: translate3d(6px, -18vh, 0) rotate(calc(var(--r) + 40deg)); }
      100% { transform: translate3d(-8px, -36vh, 0) rotate(calc(var(--r) + 80deg)); }
    }

    /* Frame */
    #sonata560 .wrap {
      position: relative; z-index: 1;
      width: min(1180px, 96vw);
      background:
        linear-gradient(180deg, rgba(255,255,255,.7), rgba(255,255,255,.35)) padding-box;
      border: 1px solid var(--ring);
      border-radius: 28px;
      padding: clamp(16px, 3vw, 36px);
      box-shadow: var(--shadow);
      backdrop-filter: var(--soft);
      -webkit-backdrop-filter: var(--soft);
    }
    #sonata560[data-theme="night"] .wrap {
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04)) padding-box;
    }

    /* Masthead */
    #sonata560 .mast {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 16px;
      align-items: center;
      margin-bottom: clamp(8px, 2vw, 18px);
    }
    #sonata560 .seal {
      position: relative;
      width: 38px; height: 38px; border-radius: 50%;
      display: grid; place-items: center;
      border: 2px solid var(--ring-strong);
      background:
        conic-gradient(from 0deg, var(--a), var(--b), var(--c), var(--a));
      box-shadow: inset 0 0 0 6px rgba(255,255,255,.6), 0 8px 26px rgba(0,0,0,.12);
      animation: s560-spin 18s linear infinite;
    }
    #sonata560[data-theme="night"] .seal { box-shadow: inset 0 0 0 6px rgba(0,0,0,.3), 0 8px 26px rgba(0,0,0,.4); }
    #sonata560 .seal span {
      font-size: 11px; font-weight: 900; letter-spacing: .18em; color: var(--ink);
      mix-blend-mode: multiply;
    }
    @keyframes s560-spin { to { transform: rotate(360deg); } }

    #sonata560 .meta {
      color: var(--muted);
      font-size: 12px; letter-spacing: .18em; text-transform: uppercase; font-weight: 900;
    }

    #sonata560 .actions { display: flex; flex-wrap: wrap; gap: 10px; }
    #sonata560 .chip {
      appearance: none; -webkit-appearance: none; cursor: pointer;
      padding: 10px 14px; border-radius: 999px; font-weight: 800; font-size: 12px;
      color: var(--ink);
      border: 1px solid var(--ring);
      background:
        linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.45)) padding-box,
        linear-gradient(90deg, var(--a), var(--b), var(--c)) border-box;
      box-shadow: 0 14px 30px rgba(0,0,0,.10);
      transition: transform .15s ease, box-shadow .2s ease, opacity .2s ease;
    }
    #sonata560 .chip:hover { transform: translateY(-1px); }
    #sonata560[data-theme="night"] .chip {
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04)) padding-box,
        linear-gradient(90deg, var(--a), var(--b), var(--c)) border-box;
      box-shadow: 0 14px 30px rgba(0,0,0,.40);
      color: var(--ink);
    }

    /* Hero */
    #sonata560 .hero { margin: 6px 0 12px; }
    #sonata560 h1 {
      margin: 0;
      font-size: clamp(48px, 8vw, 112px);
      line-height: .88;
      letter-spacing: -.02em;
      text-wrap: balance;
      background: conic-gradient(from 180deg at 50% 60%, color-mix(in srgb, var(--a) 82%, #fff 0%), color-mix(in srgb, var(--b) 70%, #fff 0%), color-mix(in srgb, var(--c) 80%, #fff 0%));
      -webkit-background-clip: text; background-clip: text; color: transparent;
      filter: drop-shadow(0 2px 0 rgba(255,255,255,.24));
    }
    #sonata560 .lead {
      margin: 10px 0 0; color: var(--muted);
      font-size: clamp(14px, 2.2vw, 18px);
      max-width: 70ch;
    }

    /* Stage */
    #sonata560 .stage {
      position: relative; width: 100%;
      aspect-ratio: 16 / 9;
      max-height: 66vh;
      border-radius: 26px; overflow: hidden;
      border: 1px solid var(--ring);
      background:
        radial-gradient(120% 120% at 50% 10%, rgba(255,255,255,.70), rgba(255,255,255,.30));
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.8),
        0 50px 120px rgba(0,0,0,.15);
      transform-style: preserve-3d;
      transition: transform .25s ease, box-shadow .25s ease;
    }
    #sonata560[data-theme="night"] .stage {
      background:
        radial-gradient(120% 120% at 50% 10%, rgba(255,255,255,.10), rgba(255,255,255,.04));
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.10),
        0 42px 120px rgba(0,0,0,.55);
    }
    #sonata560 canvas#ink560 {
      position: absolute; inset: 0; width: 100%; height: 100%;
      filter:
        saturate(120%)
        drop-shadow(0 0 24px color-mix(in srgb, var(--a), transparent 85%))
        drop-shadow(0 0 24px color-mix(in srgb, var(--b), transparent 88%));
      will-change: transform, filter;
    }
    #sonata560 .paper {
      pointer-events: none; position: absolute; inset: 0; z-index: 1; opacity: .35;
      background:
        repeating-linear-gradient(0deg, rgba(0,0,0,.02) 0 1px, transparent 1px 7px),
        radial-gradient(60% 80% at 50% 20%, rgba(255,255,255,.16), rgba(255,255,255,0));
      mix-blend-mode: multiply;
    }
    #sonata560[data-theme="night"] .paper { opacity: .25; mix-blend-mode: soft-light; }

    #sonata560 .hud {
      position: absolute; right: 12px; top: 12px; z-index: 2;
      font-size: 11px; font-weight: 900; letter-spacing: .12em; text-transform: uppercase;
      padding: 8px 10px; border-radius: 10px; color: var(--ink);
      border: 1px solid var(--ring);
      background: color-mix(in srgb, #ffffff 72%, transparent);
      backdrop-filter: blur(8px) saturate(130%);
      -webkit-backdrop-filter: blur(8px) saturate(130%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.8), 0 14px 30px rgba(0,0,0,.12);
    }
    #sonata560[data-theme="night"] .hud {
      background: color-mix(in srgb, #ffffff 12%, transparent);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.12), 0 14px 30px rgba(0,0,0,.45);
    }

    /* Controls */
    #sonata560 .dock { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-top: clamp(16px, 2.6vw, 24px); }
    #sonata560 .block {
      display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
      padding: 8px 10px; border-radius: 12px;
      border: 1px solid var(--ring);
      background: color-mix(in srgb, #ffffff 70%, transparent);
      backdrop-filter: blur(8px) saturate(130%);
      -webkit-backdrop-filter: blur(8px) saturate(130%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.85), 0 22px 60px rgba(0,0,0,.10);
    }
    #sonata560[data-theme="night"] .block {
      background: color-mix(in srgb, #ffffff 10%, transparent);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10), 0 22px 60px rgba(0,0,0,.45);
    }
    #sonata560 .block label {
      font-size: 10px; letter-spacing: .14em; text-transform: uppercase; font-weight: 900; opacity: .78; margin-right: 4px;
    }
    #sonata560 input[type="range"] {
      -webkit-appearance: none; appearance: none;
      width: 220px; height: 26px; border-radius: 999px; padding: 0 10px;
      border: 1px solid var(--ring);
      background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.35));
    }
    #sonata560[data-theme="night"] input[type="range"] {
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
    }
    #sonata560 input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%;
      background:
        linear-gradient(#fff, #fff) padding-box,
        conic-gradient(var(--a), var(--b), var(--c), var(--a)) border-box;
      border: 2px solid transparent; box-shadow: 0 8px 18px rgba(0,0,0,.2); cursor: pointer;
    }
    #sonata560 input[type="range"]::-moz-range-thumb {
      width: 18px; height: 18px; border: none; border-radius: 50%; background: #fff; cursor: pointer;
    }

    /* Footer */
    #sonata560 .foot {
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
      margin-top: clamp(16px, 2.6vw, 24px); color: var(--muted); font-size: 12px;
    }
    #sonata560 .meter {
      width: 70px; height: 10px; border-radius: 999px; overflow: hidden; position: relative;
      background: linear-gradient(90deg, color-mix(in srgb, var(--a) 50%, #fff 0%), color-mix(in srgb, var(--b) 50%, #fff 0%), color-mix(in srgb, var(--c) 50%, #fff 0%));
    }
    #sonata560 .meter::after {
      content: ""; position: absolute; inset: 0;
      background: linear-gradient(90deg, #fff0, #fff8, #fff0);
      transform: translateX(-100%);
      animation: s560-sheen 2.8s ease-in-out infinite;
    }
    @keyframes s560-sheen { 50% { transform: translateX(100%); } }

    @media (prefers-reduced-motion: reduce) {
      #sonata560 .seal, #sonata560 .petal, #sonata560 .meter::after { animation: none !important; }
      #sonata560 .stage, #sonata560 canvas#ink560 { transition: none !important; }
    }
  </style>

  <!-- Ambient petals -->
  <div class="petals" aria-hidden="true">
    <span class="petal" style="--x:.05;--y:.75;--z:.2;--r:18deg;"></span>
    <span class="petal" style="--x:.18;--y:.95;--z:.6;--r:42deg;"></span>
    <span class="petal" style="--x:.32;--y:.82;--z:.1;--r:-24deg;"></span>
    <span class="petal" style="--x:.48;--y:.88;--z:.7;--r:8deg;"></span>
    <span class="petal" style="--x:.62;--y:.92;--z:.3;--r:-12deg;"></span>
    <span class="petal" style="--x:.76;--y:.86;--z:.5;--r:28deg;"></span>
    <span class="petal" style="--x:.88;--y:.94;--z:.8;--r:-36deg;"></span>
    <span class="petal" style="--x:.22;--y:.70;--z:.9;--r:64deg;"></span>
  </div>

  <div class="wrap" role="region" aria-label="Watercolor field">
    <div class="mast">
      <div class="seal"><span>560</span></div>
      <div class="meta">SONATA • Iteration 560</div>
      <div class="actions">
        <button class="chip" id="theme560" type="button" aria-label="Toggle day/night" aria-pressed="false">Day</button>
        <button class="chip" id="tone560" type="button" aria-label="Cycle palette">Palette</button>
        <button class="chip" id="pause560" type="button" aria-label="Pause or resume" aria-pressed="false">Pause</button>
        <button class="chip" id="snap560" type="button" aria-label="Export image">Save</button>
      </div>
    </div>

    <div class="hero">
      <h1>Watercolor Garden</h1>
      <p class="lead">Ink on wind. Draw with light; let it bloom.</p>
    </div>

    <figure class="stage" id="stage560" role="img" aria-label="Flowing ink ribbons blooming on paper">
      <canvas id="ink560" aria-hidden="true"></canvas>
      <div class="paper" aria-hidden="true"></div>
      <div class="hud" aria-live="polite">
        <span id="hudFlow560">Flow 1.00×</span> · <span id="hudBloom560">Bloom 1.00</span>
      </div>
    </figure>

    <div class="dock" aria-label="Controls">
      <div class="block">
        <label for="flow560">Flow</label>
        <input id="flow560" type="range" min="0.20" max="2.00" step="0.05" value="1.00" />
      </div>
      <div class="block">
        <label for="bloom560">Bloom</label>
        <input id="bloom560" type="range" min="0.20" max="2.50" step="0.05" value="1.00" />
      </div>
      <div class="block">
        <label for="grain560">Grain</label>
        <input id="grain560" type="range" min="0.00" max="0.60" step="0.02" value="0.35" />
      </div>
      <div class="block">
        <label for="density560">Density</label>
        <input id="density560" type="range" min="80" max="600" step="10" value="260" />
      </div>
    </div>

    <div class="foot">
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="meter" aria-hidden="true"></div>
        <span>Quiet ink becomes sky</span>
      </div>
      <span id="last-updated">Last updated: 2025-11-11 01:28:12 EST</span>
    </div>
  </div>

  <script>
    (function () {
      const root   = document.getElementById('sonata560');
      const stage  = document.getElementById('stage560');
      const cvs    = document.getElementById('ink560');
      const ctx    = cvs.getContext('2d');

      const bTheme = document.getElementById('theme560');
      const bTone  = document.getElementById('tone560');
      const bPause = document.getElementById('pause560');
      const bSnap  = document.getElementById('snap560');

      const rFlow   = document.getElementById('flow560');
      const rBloom  = document.getElementById('bloom560');
      const rGrain  = document.getElementById('grain560');
      const rDense  = document.getElementById('density560');

      const hudFlow  = document.getElementById('hudFlow560');
      const hudBloom = document.getElementById('hudBloom560');
      const stampEl  = document.getElementById('last-updated');

      // Timestamp
      try {
        const now = new Date();
        const parts = new Intl.DateTimeFormat(undefined, {
          year: 'numeric', month: 'short', day: '2-digit',
          hour: '2-digit', minute: '2-digit', second: '2-digit',
          timeZoneName: 'short'
        }).format(now);
        stampEl.textContent = 'Updated: ' + parts;
      } catch { stampEl.textContent = 'Updated just now'; }

      // Palettes
      const tones = [
        { name:'Garden', a:'#ff7a7a', b:'#5ad7c2', c:'#9f8bff' },
        { name:'Dawn',   a:'#ff9f6e', b:'#ffd86b', c:'#7cc9ff' },
        { name:'Lagoon', a:'#63ffd3', b:'#47bfff', c:'#b09cff' },
        { name:'Peony',  a:'#ff8bb3', b:'#ffd1a8', c:'#9ee6ff' },
        { name:'Moss',   a:'#a5ff9c', b:'#7fe3c7', c:'#ffd580' }
      ];
      function applyTone(t){
        root.style.setProperty('--a', t.a);
        root.style.setProperty('--b', t.b);
        root.style.setProperty('--c', t.c);
        bTone.textContent = 'Palette · ' + t.name;
      }
      let toneIndex = 0;
      try {
        const saved = localStorage.getItem('s560-tone');
        if (saved) { const obj = JSON.parse(saved); applyTone(obj); toneIndex = Math.max(0, tones.findIndex(x => x.name === obj.name)); }
        else applyTone(tones[0]);
      } catch { applyTone(tones[0]); }
      bTone.addEventListener('click', () => {
        toneIndex = (toneIndex + 1) % tones.length;
        applyTone(tones[toneIndex]);
        localStorage.setItem('s560-tone', JSON.stringify(tones[toneIndex]));
      });

      // Theme (day/night)
      const hourNow = (new Date()).getHours();
      const defaultTheme = (hourNow >= 7 && hourNow < 19) ? 'day' : 'night';
      const savedTheme = localStorage.getItem('s560-theme') || defaultTheme;
      if (savedTheme === 'night') {
        root.setAttribute('data-theme','night');
        bTheme.textContent = 'Night';
        bTheme.setAttribute('aria-pressed','true');
      } else {
        bTheme.textContent = 'Day';
        bTheme.setAttribute('aria-pressed','false');
      }
      bTheme.addEventListener('click', () => {
        const night = root.getAttribute('data-theme') === 'night';
        if (night) {
          root.removeAttribute('data-theme');
          bTheme.textContent = 'Day';
          bTheme.setAttribute('aria-pressed','false');
          localStorage.setItem('s560-theme','day');
        } else {
          root.setAttribute('data-theme','night');
          bTheme.textContent = 'Night';
          bTheme.setAttribute('aria-pressed','true');
          localStorage.setItem('s560-theme','night');
        }
        if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
          stage.style.transform = 'perspective(1100px) rotateX(6deg) rotateY(-5deg) scale(1.02)';
          setTimeout(()=> stage.style.transform='', 260);
        }
      });

      // Utils
      function css(name){
        const v = getComputedStyle(root).getPropertyValue(name).trim();
        if (v.startsWith('#')) { const h=v.replace('#',''); return [parseInt(h.slice(0,2),16),parseInt(h.slice(2,4),16),parseInt(h.slice(4,6),16)]; }
        const m = v.match(/rgba?\(([^)]+)\)/i);
        if (m) { const p = m[1].split(',').map(Number); return p.slice(0,3); }
        return [255,255,255];
      }
      function lerp(a,b,t){ return a + (b - a) * t; }
      function mix(c1,c2,t){ return [Math.round(lerp(c1[0],c2[0],t)), Math.round(lerp(c1[1],c2[1],t)), Math.round(lerp(c1[2],c2[2],t))]; }
      function rgba(c,a){ return `rgba(${c[0]},${c[1]},${c[2]},${a})`; }
      function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

      // Field
      const state = {
        flow: parseFloat(rFlow.value),
        bloom: parseFloat(rBloom.value),
        grain: parseFloat(rGrain.value),
        density: parseInt(rDense.value, 10),
        paused: false,
        time: 0
      };
      hudFlow.textContent = `Flow ${state.flow.toFixed(2)}×`;
      hudBloom.textContent = `Bloom ${state.bloom.toFixed(2)}`;

      // Paper grain control
      function updateGrain(){ document.querySelector('#sonata560 .paper').style.opacity = String(clamp(state.grain, 0, 0.7)); }
      updateGrain();

      rFlow.addEventListener('input', ()=> { state.flow = parseFloat(rFlow.value); hudFlow.textContent = `Flow ${state.flow.toFixed(2)}×`; });
      rBloom.addEventListener('input', ()=> { state.bloom = parseFloat(rBloom.value); hudBloom.textContent = `Bloom ${state.bloom.toFixed(2)}`; });
      rGrain.addEventListener('input', ()=> { state.grain = parseFloat(rGrain.value); updateGrain(); });
      rDense.addEventListener('input', ()=> { state.density = parseInt(rDense.value,10); seed(true); });

      bPause.addEventListener('click', () => {
        state.paused = !state.paused;
        bPause.setAttribute('aria-pressed', String(state.paused));
        bPause.textContent = state.paused ? 'Resume' : 'Pause';
        if (!state.paused && !window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
          last = performance.now(); requestAnimationFrame(loop);
        }
      });
      bSnap.addEventListener('click', () => {
        const link = document.createElement('a');
        link.download = 'watercolor-garden.png';
        link.href = cvs.toDataURL('image/png');
        link.click();
      });

      // Canvas sizing
      let W=1, H=1, DPR = Math.max(1, Math.min(2.5, window.devicePixelRatio || 1));
      function resize() {
        const rect = stage.getBoundingClientRect();
        W = Math.max(1, Math.floor(rect.width));
        H = Math.max(1, Math.floor(rect.height));
        DPR = Math.max(1, Math.min(2.5, window.devicePixelRatio || 1));
        cvs.width = Math.floor(W * DPR);
        cvs.height = Math.floor(H * DPR);
        cvs.style.width = W + 'px';
        cvs.style.height = H + 'px';
        ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
        drawBase(true);
      }
      window.addEventListener('resize', resize);

      // Particles
      let P=[];
      function seed(keep=false) {
        const target = state.density;
        if (keep && P.length) {
          // adjust length
          if (P.length > target) P.length = target;
          while (P.length < target) P.push(spawn(Math.random()*W, Math.random()*H));
          return;
        }
        P = [];
        for (let i=0;i<target;i++) {
          P.push(spawn(Math.random()*W, Math.random()*H));
        }
      }
      function spawn(x,y) {
        return {
          x, y,
          px: x, py: y,
          t: Math.random()*Math.PI*2,
          hueBias: Math.random(),
          size: 0.6 + Math.random()*1.2
        };
      }

      // Flow field (sin-based "curlish" noise)
      function field(x,y,t){
        const s = 0.0018, s2 = 0.0026;
        const a = Math.sin(y * s + t*0.6) + Math.cos((x + y) * s2 - t*0.4);
        const b = Math.cos(x * s - t*0.35) - Math.sin((x - y) * s2 + t*0.5);
        return { vx: a, vy: b };
      }

      // Palette ring
      function swirlColor(u) {
        const a = css('--a'), b = css('--b'), c = css('--c');
        if (u < .5) return mix(a, b, u/.5);
        return mix(b, c, (u-.5)/.5);
      }

      // Pointer attraction
      const pointer = { x: 0, y: 0, inside: false };
      stage.addEventListener('pointerenter', () => { pointer.inside = true; });
      stage.addEventListener('pointerleave', () => { pointer.inside = false; stage.style.transform=''; });
      stage.addEventListener('pointermove', (e) => {
        const r = stage.getBoundingClientRect();
        pointer.x = e.clientX - r.left;
        pointer.y = e.clientY - r.top;
        if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
          const nx = (pointer.x/r.width - .5), ny = (pointer.y/r.height - .5);
          stage.style.transform = `perspective(1100px) rotateX(${-ny*8}deg) rotateY(${nx*10}deg) scale(1.005)`;
        }
      });
      stage.addEventListener('click', (e) => {
        const r = stage.getBoundingClientRect();
        const x = e.clientX - r.left, y = e.clientY - r.top;
        for (let i=0;i<30;i++) P[Math.floor(Math.random()*P.length)] = spawn(x + (Math.random()-0.5)*20, y + (Math.random()-0.5)*20);
      });

      function drawBase(clear=false){
        if (clear) ctx.clearRect(0,0,W,H);
        const night = root.getAttribute('data-theme') === 'night';
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = night ? 'rgba(11,16,32,0.18)' : 'rgba(255,255,255,0.16)';
        ctx.fillRect(0,0,W,H);
      }

      let last = performance.now();
      function loop(now){
        const dt = Math.min(0.05, (now - last)/1000) * state.flow;
        last = now;
        state.time += dt;

        // subtle fade
        const night = root.getAttribute('data-theme') === 'night';
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = night ? 'rgba(10,14,28,0.095)' : 'rgba(250,247,242,0.08)';
        ctx.fillRect(0,0,W,H);

        // draw
        for (let i=0;i<P.length;i++){
          const p = P[i];
          p.px = p.x; p.py = p.y;

          const F = field(p.x, p.y, state.time);
          let vx = F.vx, vy = F.vy;

          // pointer attraction
          if (pointer.inside) {
            const dx = pointer.x - p.x;
            const dy = pointer.y - p.y;
            const d2 = Math.max(24, dx*dx + dy*dy);
            const k = 160 / d2;
            vx += dx * k; vy += dy * k;
          }

          p.x += vx * 18 * dt;
          p.y += vy * 18 * dt;

          // wrap edges for continuous flow
          if (p.x < -2) p.x = W+2; if (p.x > W+2) p.x = -2;
          if (p.y < -2) p.y = H+2; if (p.y > H+2) p.y = -2;

          // color
          const u = (Math.sin((p.x + p.y)*0.002 + p.hueBias*6.28 + state.time*0.5)*0.5 + 0.5);
          const col = swirlColor(u);

          // stroke
          ctx.globalCompositeOperation = night ? 'lighter' : 'multiply';
          ctx.lineCap = 'round';
          ctx.lineJoin = 'round';
          ctx.strokeStyle = rgba(col, night ? (0.18 * state.bloom) : (0.24 * state.bloom));
          ctx.lineWidth = 0.6 + 0.8 * p.size;
          ctx.shadowColor = rgba(col, 0.6 * state.bloom);
          ctx.shadowBlur = 10 * state.bloom;

          ctx.beginPath();
          ctx.moveTo(p.px, p.py);
          ctx.lineTo(p.x, p.y);
          ctx.stroke();

          // occasional bloom dots
          if ((i + (now|0)) % 260 === 0) {
            ctx.globalCompositeOperation = 'lighter';
            ctx.fillStyle = rgba(col, 0.12 * state.bloom);
            ctx.beginPath();
            ctx.arc(p.x, p.y, 4 + 10 * Math.random(), 0, Math.PI*2);
            ctx.fill();
          }
        }

        if (!state.paused && !window.matchMedia('(prefers-reduced-motion: reduce)').matches) requestAnimationFrame(loop);
      }

      // Init
      resize();
      seed(false);
      drawBase(true);

      if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) requestAnimationFrame(loop);
    })();
  </script>
</section>
      </section>
      <!-- END_EDITABLE -->
    <script>
      // Only show a local placeholder if the agent hasn't written a timestamp yet
      const el = document.getElementById('last-updated');
      if (el && (!el.textContent || el.textContent.includes('not yet'))) {
        const now = new Date();
        el.textContent = `Last updated: ${now.toLocaleString(undefined, { hour12: false })}`;
      }
    </script>
  </body>
  </html>


