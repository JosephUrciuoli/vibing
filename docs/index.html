<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vibing</title>
    <style>
      :root {
        --bg: #0f1221;
        --fg: #e6e8f0;
        --muted: #9aa3b2;
        --accent: #8b5cf6;
      }
      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--fg);
        background: radial-gradient(1200px 800px at 70% 10%, #1b1f3a, var(--bg));
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        width: min(720px, 92vw);
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px;
        padding: 28px 24px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        backdrop-filter: blur(6px);
      }
      h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
        letter-spacing: 0.3px;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 18px;
      }
      #content {
        font-size: 18px;
        line-height: 1.6;
        background: rgba(255,255,255,0.04);
        border: 1px dashed rgba(255,255,255,0.12);
        border-radius: 12px;
        padding: 16px;
      }
      .footer {
        margin-top: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: var(--muted);
      }
      .badge {
        display: inline-block;
        background: rgba(139, 92, 246, 0.18);
        color: #d4c2ff;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(139, 92, 246, 0.35);
        letter-spacing: 0.2px;
      }
    </style>
  </head>
  <body>
    <!-- BEGIN_EDITABLE -->
      <section id="content">
<section class="v1398-atelier" aria-label="Kaleidoscope Atelier • 1398">
  <style>
    .v1398-atelier {
      --ink: #0c1221;
      --muted: color-mix(in oklab, var(--ink), transparent 45%);
      --bg-1: #f7fafc;
      --bg-2: #ecf1ff;
      --ac-1: #6b9bff;
      --ac-2: #a97bff;
      --ac-3: #55f0d2;
      --glass: rgba(255,255,255,0.68);
      --ring: color-mix(in oklab, var(--ink), transparent 80%);
      --shadow: 0 50px 140px rgba(12,18,33,0.18);
      position: relative;
      min-height: 760px;
      padding: clamp(22px, 4vw, 48px);
      border-radius: 28px;
      color: var(--ink);
      background:
        radial-gradient(180% 130% at var(--mx,68%) var(--my,28%), color-mix(in oklab, var(--ac-3), transparent 90%), transparent 60%),
        radial-gradient(140% 150% at 10% 100%, color-mix(in oklab, var(--ac-1), transparent 92%), transparent 62%),
        linear-gradient(180deg, var(--bg-1), var(--bg-2));
      box-shadow: var(--shadow), inset 0 1px 0 rgba(255,255,255,0.85);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, Helvetica, Arial;
      isolation: isolate;
      overflow: hidden;
    }
    .v1398-atelier.noir {
      --ink: #e7efff;
      --muted: color-mix(in oklab, var(--ink), transparent 38%);
      --bg-1: #070c1d;
      --bg-2: #0a0f26;
      --glass: rgba(14,18,36,0.55);
      --ring: rgba(255,255,255,0.12);
      --shadow: 0 60px 180px rgba(0,0,0,0.6);
      background:
        radial-gradient(180% 140% at var(--mx,64%) var(--my,32%), color-mix(in oklab, var(--ac-2), transparent 88%), transparent 60%),
        radial-gradient(160% 160% at 10% 100%, color-mix(in oklab, var(--ac-1), transparent 90%), transparent 62%),
        linear-gradient(180deg, #050815, #0a0f26);
      box-shadow: var(--shadow), inset 0 1px 0 rgba(255,255,255,0.06);
    }

    .v1398-atelier::before {
      content: "";
      position: absolute; inset: -40%;
      background:
        radial-gradient(120% 120% at 50% 50%, rgba(255,255,255,0.14), transparent 60%),
        repeating-linear-gradient(140deg, rgba(0,0,0,0.03) 0 1px, transparent 1px 28px);
      mix-blend-mode: overlay;
      opacity: .34;
      animation: v1398-drift 40s linear infinite;
      pointer-events: none;
      z-index: 0;
    }
    .v1398-atelier.noir::before { opacity: .18; }
    @keyframes v1398-drift { to { transform: translate3d(5%, -5%, 0) rotate(0.3deg); } }

    .v1398-shell {
      position: relative; z-index: 2;
      display: grid; gap: clamp(12px, 2.6vw, 28px);
      grid-template-rows: auto auto 1fr auto;
    }

    .v1398-mast {
      display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 14px;
    }
    .v1398-brand {
      display: grid; grid-template-columns: auto 1fr; align-items: center; gap: 12px;
    }
    .v1398-glyph {
      width: 52px; height: 52px; border-radius: 16px; position: relative; overflow: hidden;
      background:
        radial-gradient(100% 90% at 60% 25%, #ffffff 0%, rgba(255,255,255,0.55) 30%, transparent 42%),
        conic-gradient(from 180deg, var(--ac-1), var(--ac-2), var(--ac-3), var(--ac-1));
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.85), 0 12px 26px rgba(15,23,42,0.22);
      -webkit-mask: radial-gradient(30px 30px at 60% 40%, transparent 52%, #000 53%) exclude, linear-gradient(#000,#000);
              mask: radial-gradient(30px 30px at 60% 40%, transparent 52%, #000 53%) exclude, linear-gradient(#000,#000);
      animation: v1398-spin 18s linear infinite;
    }
    @keyframes v1398-spin { to { transform: rotate(360deg); } }

    .v1398-pill {
      font-size: 11px; letter-spacing: .12em; text-transform: uppercase;
      padding: 7px 11px; border-radius: 999px; width: fit-content;
      background: var(--glass);
      border: 1px solid color-mix(in oklab, var(--ink), transparent 86%);
      color: var(--ink);
      box-shadow: 0 8px 22px rgba(15,23,42,0.12), inset 0 1px 0 rgba(255,255,255,0.86);
    }
    .v1398-atelier.noir .v1398-pill {
      background: rgba(255,255,255,0.06);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), 0 10px 24px rgba(0,0,0,0.42);
    }

    .v1398-atelier h1 {
      margin: 4px 0 0;
      font-family: ui-serif, Georgia, "Times New Roman", serif;
      font-size: clamp(44px, 8.8vw, 132px);
      line-height: .9; font-weight: 800; letter-spacing: -0.02em;
      background: linear-gradient(90deg, var(--ink), var(--ac-1));
      -webkit-background-clip: text; background-clip: text; color: transparent;
      text-wrap: balance;
    }
    .v1398-atelier .lede {
      margin: 6px 0 2px; max-width: 70ch;
      font-size: clamp(14px, 2.1vw, 20px);
      color: var(--muted);
    }

    .v1398-stage {
      position: relative;
      aspect-ratio: 1 / 1; width: min(920px, 100%);
      place-self: center;
      border-radius: 28px;
      background: linear-gradient(180deg, rgba(255,255,255,0.65), rgba(255,255,255,0.38));
      border: 1px solid color-mix(in oklab, var(--ink), transparent 86%);
      box-shadow: 0 24px 70px rgba(15,23,42,0.18), inset 0 1px 0 rgba(255,255,255,0.62);
      overflow: hidden;
      transform-style: preserve-3d;
      transition: box-shadow .3s ease, transform .2s ease;
    }
    .v1398-atelier.noir .v1398-stage {
      background: linear-gradient(180deg, rgba(18,24,48,0.92), rgba(16,20,40,0.92));
      box-shadow: 0 30px 110px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.06);
    }
    .v1398-kaleido {
      position: absolute; inset: 0;
      filter: drop-shadow(0 30px 80px color-mix(in oklab, var(--ac-1), transparent 65%));
      will-change: transform;
    }
    .v1398-rim {
      position: absolute; inset: 10px;
      border-radius: 24px;
      outline: 1px solid var(--ring);
      pointer-events: none;
    }

    .v1398-deck {
      display: grid; grid-auto-flow: column; grid-auto-columns: max-content;
      gap: 10px; align-items: center; width: fit-content;
      background: linear-gradient(180deg, var(--glass), color-mix(in oklab, var(--glass), transparent 22%));
      border: 1px solid color-mix(in oklab, var(--ink), transparent 86%);
      border-radius: 18px; padding: 12px;
      backdrop-filter: blur(10px) saturate(1.06);
      box-shadow: 0 18px 42px rgba(15,23,42,0.18), inset 0 1px 0 rgba(255,255,255,0.28);
      width: 100%; overflow-x: auto;
    }
    .v1398-btn {
      appearance: none; border: 1px solid color-mix(in oklab, var(--ink), transparent 82%);
      background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.78));
      color: var(--ink); border-radius: 12px; padding: 8px 12px; font-weight: 800; font-size: 13px; letter-spacing: .02em;
      cursor: pointer; user-select: none; white-space: nowrap;
      box-shadow: 0 6px 18px rgba(15,23,42,0.12), inset 0 1px 0 rgba(255,255,255,0.85);
      transition: transform .12s ease, background .2s ease, box-shadow .2s ease, color .2s ease;
    }
    .v1398-btn:hover { transform: translateY(-1px); }
    .v1398-btn[aria-pressed="true"] {
      background: linear-gradient(180deg, color-mix(in oklab, var(--ac-1), white 30%), var(--ac-1));
      color: #0b1324;
      border-color: color-mix(in oklab, var(--ac-1), black 16%);
      box-shadow: 0 16px 34px color-mix(in oklab, var(--ac-1), transparent 55%), inset 0 1px 0 rgba(255,255,255,0.85);
    }
    .v1398-atelier.noir .v1398-btn {
      background: linear-gradient(180deg, rgba(24,32,60,0.9), rgba(20,28,52,0.9));
      color: var(--ink);
      box-shadow: 0 6px 18px rgba(0,0,0,0.38), inset 0 1px 0 rgba(255,255,255,0.08);
    }

    .v1398-chip {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 7px 10px; border-radius: 999px;
      border: 1px solid color-mix(in oklab, var(--ink), transparent 86%);
      background: linear-gradient(180deg, rgba(255,255,255,0.86), rgba(255,255,255,0.72));
      font-size: 12px; letter-spacing: .06em; text-transform: uppercase; color: var(--ink);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.85);
      white-space: nowrap;
    }
    .v1398-atelier.noir .v1398-chip {
      background: linear-gradient(180deg, rgba(24,32,60,0.9), rgba(20,28,52,0.9));
      color: var(--ink); box-shadow: inset 0 1px 0 rgba(255,255,255,0.1);
    }
    .v1398-atelier input[type="range"] {
      -webkit-appearance: none; appearance: none; height: 6px; width: 160px; border-radius: 999px;
      background: linear-gradient(90deg, var(--ac-1), color-mix(in oklab, var(--ac-2), white 20%));
      outline: none;
    }
    .v1398-atelier input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none; height: 16px; width: 16px; border-radius: 50%;
      background: #fff; border: 2px solid color-mix(in oklab, var(--ac-1), black 12%);
      box-shadow: 0 2px 8px rgba(15,23,42,0.25); cursor: pointer;
    }
    .v1398-atelier input[type="range"]::-moz-range-thumb {
      height: 16px; width: 16px; border-radius: 50%;
      background: #fff; border: 2px solid color-mix(in oklab, var(--ac-1), black 12%);
      box-shadow: 0 2px 8px rgba(15,23,42,0.25); cursor: pointer;
    }

    .v1398-meta {
      display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
      margin-top: 10px; font-size: 12px; color: var(--muted);
    }
    .v1398-status {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 6px 10px; border-radius: 999px;
      border: 1px solid color-mix(in oklab, var(--ink), transparent 86%);
      background: linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255,255,255,0.5));
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.7);
    }
    .v1398-atelier.noir .v1398-status {
      background: linear-gradient(180deg, rgba(24,32,60,0.85), rgba(20,28,52,0.85));
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08);
    }

    @media (max-width: 980px) {
      .v1398-deck { grid-auto-flow: row; grid-template-columns: 1fr 1fr; width: 100%; }
      .v1398-atelier input[type="range"] { width: 100%; }
      .v1398-stage { aspect-ratio: 1/1; }
    }

    @media (prefers-reduced-motion: reduce) {
      .v1398-atelier::before { animation: none; }
      .v1398-glyph { animation: none; }
      .v1398-kaleido { filter: none; }
    }
  </style>

  <div class="v1398-shell">
    <div class="v1398-mast">
      <div class="v1398-brand">
        <div class="v1398-glyph" aria-hidden="true"></div>
        <span class="v1398-pill">Kaleidoscope Atelier • Iteration 1398</span>
      </div>
      <div class="v1398-actions">
        <button class="v1398-btn" id="v1398-night" aria-pressed="false" title="Toggle Night">Night</button>
      </div>
    </div>

    <h1>Cut. Reflect. Bloom.</h1>
    <p class="lede">A living poster. Set the facets, tilt the canvas, and let the colors find their symmetry.</p>

    <div class="v1398-stage" id="v1398-stage">
      <svg id="v1398-svg" class="v1398-kaleido" viewBox="0 0 800 800" preserveAspectRatio="xMidYMid meet" aria-hidden="true"></svg>
      <div class="v1398-rim" aria-hidden="true"></div>
    </div>

    <div class="v1398-deck" role="group" aria-label="Kaleidoscope controls">
      <button class="v1398-btn" id="v1398-play" aria-pressed="true" title="Pause/Play">Pause</button>
      <button class="v1398-btn" id="v1398-palette" title="Cycle Palette">Palette</button>
      <button class="v1398-btn" id="v1398-random" title="Randomize Motif">Random</button>

      <label class="v1398-chip" for="v1398-speed">
        <span>Rotation</span>
        <input id="v1398-speed" type="range" min="0" max="2.5" step="0.01" value="0.9" />
      </label>

      <label class="v1398-chip" for="v1398-facets">
        <span>Facets</span>
        <input id="v1398-facets" type="range" min="6" max="36" step="1" value="16" />
      </label>

      <label class="v1398-chip" for="v1398-bloom">
        <span>Bloom</span>
        <input id="v1398-bloom" type="range" min="0.3" max="1.4" step="0.01" value="0.9" />
      </label>
    </div>

    <div class="v1398-meta">
      <span class="v1398-status" id="v1398-status">Live • facets 16</span>
      <span id="last-updated">Last updated: 2025-12-19 17:18:41 EST</span>
    </div>
  </div>

  <script>
    (function () {
      const root = document.currentScript.closest('.v1398-atelier');
      const stage = root.querySelector('#v1398-stage');
      const svg = root.querySelector('#v1398-svg');
      const playBtn = root.querySelector('#v1398-play');
      const nightBtn = root.querySelector('#v1398-night');
      const paletteBtn = root.querySelector('#v1398-palette');
      const randomBtn = root.querySelector('#v1398-random');
      const speedEl = root.querySelector('#v1398-speed');
      const facetEl = root.querySelector('#v1398-facets');
      const bloomEl = root.querySelector('#v1398-bloom');
      const statusEl = root.querySelector('#v1398-status');
      const updated = root.querySelector('#last-updated');

      // Last updated
      try {
        const now = new Date();
        const fmt = new Intl.DateTimeFormat(navigator.language || 'en-US', {
          weekday: 'short', month: 'short', day: '2-digit', year: 'numeric',
          hour: '2-digit', minute: '2-digit'
        }).format(now);
        updated.textContent = 'Last updated • ' + fmt;
      } catch { updated.textContent = 'Last updated'; }

      // Palettes
      const palettes = [
        { name: 'Borealis', a:'#6b9bff', b:'#a97bff', c:'#55f0d2' },
        { name: 'Solstice', a:'#ffb86b', b:'#ff7eb3', c:'#8be9fd' },
        { name: 'Midnight', a:'#5ad2ff', b:'#8ea6ff', c:'#c0a2ff' },
        { name: 'Moss', a:'#86efac', b:'#60a5fa', c:'#c4b5fd' },
        { name: 'Sundrop', a:'#ffd166', b:'#ff8fab', c:'#6ef9e3' },
        { name: 'Firefly', a:'#ffd38a', b:'#a2ff86', c:'#7cc5ff' }
      ];
      let paletteIndex = 0;
      function setPalette(i) {
        const p = palettes[i % palettes.length];
        root.style.setProperty('--ac-1', p.a);
        root.style.setProperty('--ac-2', p.b);
        root.style.setProperty('--ac-3', p.c);
        // update motif fills on the fly
        recolorMotif();
      }

      // Geometry
      const size = 800, cx = 400, cy = 400, R = 360;
      let running = !window.matchMedia?.('(prefers-reduced-motion: reduce)').matches;
      let tick = 0;
      let facets = parseInt(facetEl.value, 10);

      function wedgePath(angleStart, angleEnd) {
        const a0 = angleStart, a1 = angleEnd;
        const x0 = cx + Math.cos(a0) * R;
        const y0 = cy + Math.sin(a0) * R;
        const x1 = cx + Math.cos(a1) * R;
        const y1 = cy + Math.sin(a1) * R;
        const large = (a1 - a0) % (Math.PI * 2) > Math.PI ? 1 : 0;
        return `M ${cx} ${cy} L ${x0} ${y0} A ${R} ${R} 0 ${large} 1 ${x1} ${y1} Z`;
      }

      // Create a set of base "motif" shapes in a canonical wedge (around 0 rad).
      let motif = [];
      function randomMotif(seed) {
        motif = [];
        const thetaBase = (Math.PI * 2) / facets;
        // circles
        for (let i = 0; i < 40; i++) {
          const rr = (0.12 + Math.random() * 0.8) * R;
          const ang = (Math.random() - 0.5) * thetaBase * 0.75;
          const x = cx + Math.cos(ang) * rr;
          const y = cy + Math.sin(ang) * rr;
          const rad = 6 + Math.pow(1 - rr / R, 0.4) * 26 * (0.6 + Math.random()*0.8);
          motif.push({ type: 'circle', x, y, r: rad, hue: Math.random() });
        }
        // petals (rotated rounded rectangles)
        for (let i = 0; i < 14; i++) {
          const rr = (0.2 + Math.random() * 0.72) * R;
          const ang = (Math.random() - 0.5) * thetaBase * 0.6;
          const x = cx + Math.cos(ang) * rr;
          const y = cy + Math.sin(ang) * rr;
          const w = 6 + Math.random() * 20;
          const h = 26 + Math.random() * 80;
          const rot = (ang + (Math.random() - 0.5) * 0.6);
          motif.push({ type: 'petal', x, y, w, h, rot, hue: Math.random() });
        }
        // rings
        for (let i = 0; i < 6; i++) {
          const rr = 40 + Math.random() * (R - 60);
          motif.push({ type: 'ring', r: rr, stroke: 0.5 + Math.random() * 2.2, hue: Math.random() });
        }
      }

      function clearSVG() { while (svg.firstChild) svg.removeChild(svg.firstChild); }

      function recolorMotif() {
        const accents = [getComputedStyle(root).getPropertyValue('--ac-1').trim(),
                         getComputedStyle(root).getPropertyValue('--ac-2').trim(),
                         getComputedStyle(root).getPropertyValue('--ac-3').trim()];
        svg.querySelectorAll('[data-ac]').forEach(el => {
          const h = parseFloat(el.getAttribute('data-h'));
          const pick = accents[Math.floor(h * accents.length)];
          const opacity = parseFloat(el.getAttribute('data-o') || '0.8');
          if (el.tagName === 'circle' || el.tagName === 'rect' || el.tagName === 'path') {
            if (el.hasAttribute('stroke-only')) {
              el.setAttribute('stroke', pick);
              el.setAttribute('fill', 'none');
            } else {
              el.setAttribute('fill', pick);
              el.setAttribute('fill-opacity', opacity.toFixed(3));
              el.setAttribute('stroke', 'none');
            }
          }
        });
      }

      function build() {
        clearSVG();
        facets = parseInt(facetEl.value, 10);
        const theta = (Math.PI * 2) / facets;
        // background soft radial
        const bg = document.createElementNS('http://www.w3.org/2000/svg','defs');
        const grad = document.createElementNS('http://www.w3.org/2000/svg','radialGradient');
        grad.setAttribute('id','v1398-rad');
        grad.setAttribute('cx','50%'); grad.setAttribute('cy','50%');
        grad.setAttribute('r','50%');
        const s1 = document.createElementNS('http://www.w3.org/2000/svg','stop');
        s1.setAttribute('offset','0%'); s1.setAttribute('stop-color','rgba(255,255,255,0.35)');
        const s2 = document.createElementNS('http://www.w3.org/2000/svg','stop');
        s2.setAttribute('offset','100%'); s2.setAttribute('stop-color','rgba(255,255,255,0)');
        grad.appendChild(s1); grad.appendChild(s2); bg.appendChild(grad);
        svg.appendChild(bg);

        const base = document.createElementNS('http://www.w3.org/2000/svg','g');
        base.setAttribute('id','v1398-spin');
        base.setAttribute('transform', `translate(0,0)`);
        svg.appendChild(base);

        // soft background circle
        const back = document.createElementNS('http://www.w3.org/2000/svg','circle');
        back.setAttribute('cx', cx); back.setAttribute('cy', cy); back.setAttribute('r', R);
        back.setAttribute('fill','url(#v1398-rad)');
        base.appendChild(back);

        // create each facet (with its own clip)
        for (let i = 0; i < facets; i++) {
          const mid = i * theta;
          const a0 = mid - theta/2, a1 = mid + theta/2;
          const clipId = `v1398-clip-${i}`;
          const clip = document.createElementNS('http://www.w3.org/2000/svg','clipPath');
          clip.setAttribute('id', clipId);
          const clipPathEl = document.createElementNS('http://www.w3.org/2000/svg','path');
          clipPathEl.setAttribute('d', wedgePath(a0, a1));
          clip.appendChild(clipPathEl);
          svg.appendChild(clip);

          const g = document.createElementNS('http://www.w3.org/2000/svg','g');
          g.setAttribute('clip-path', `url(#${clipId})`);
          // mirror every other facet for a true kaleidoscope feel
          const mirror = (i % 2 === 1);
          const rot = mid * 180/Math.PI;
          g.setAttribute('transform', mirror
            ? `rotate(${rot} ${cx} ${cy}) translate(${cx} ${cy}) scale(-1,1) translate(${-cx} ${-cy})`
            : `rotate(${rot} ${cx} ${cy})`);
          base.appendChild(g);

          // draw motif elements into this facet
          for (let m of motif) {
            if (m.type === 'circle') {
              const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
              c.setAttribute('cx', m.x); c.setAttribute('cy', m.y); c.setAttribute('r', m.r);
              c.setAttribute('data-ac',''); c.setAttribute('data-h', m.hue.toFixed(3));
              c.setAttribute('data-o', (0.6 + Math.random()*0.35).toFixed(3));
              g.appendChild(c);
            } else if (m.type === 'petal') {
              const r = document.createElementNS('http://www.w3.org/2000/svg','rect');
              r.setAttribute('x', m.x - m.w/2); r.setAttribute('y', m.y - m.h/2);
              r.setAttribute('width', m.w); r.setAttribute('height', m.h);
              r.setAttribute('rx', Math.min(m.w, m.h)/2);
              r.setAttribute('transform', `rotate(${(m.rot*180/Math.PI).toFixed(3)} ${m.x} ${m.y})`);
              r.setAttribute('data-ac',''); r.setAttribute('data-h', m.hue.toFixed(3));
              r.setAttribute('data-o', (0.55 + Math.random()*0.35).toFixed(3));
              g.appendChild(r);
            } else if (m.type === 'ring') {
              const rr = document.createElementNS('http://www.w3.org/2000/svg','circle');
              rr.setAttribute('cx', cx); rr.setAttribute('cy', cy); rr.setAttribute('r', m.r);
              rr.setAttribute('stroke-only','');
              rr.setAttribute('fill','none');
              rr.setAttribute('stroke-width', m.stroke);
              rr.setAttribute('data-ac',''); rr.setAttribute('data-h', m.hue.toFixed(3));
              rr.setAttribute('data-o', '0.9');
              g.appendChild(rr);
            }
          }
        }

        recolorMotif();
      }

      // Pointer parallax
      function onPointer(e) {
        const r = stage.getBoundingClientRect();
        const rx = ((e.clientX - r.left) / r.width - 0.5) * 10;
        const ry = ((e.clientY - r.top) / r.height - 0.5) * -10;
        root.style.setProperty('--mx', Math.round(((e.clientX - r.left) / r.width) * 100) + '%');
        root.style.setProperty('--my', Math.round(((e.clientY - r.top) / r.height) * 100) + '%');
        stage.style.transform = `perspective(1000px) rotateX(${ry}deg) rotateY(${rx}deg)`;
      }
      function clearPointer() { stage.style.transform = 'none'; }
      stage.addEventListener('pointermove', onPointer, { passive: true });
      stage.addEventListener('pointerleave', clearPointer, { passive: true });

      // Animation loop
      let last = performance.now();
      function frame(now) {
        if (!running) { requestAnimationFrame(frame); return; }
        const dt = Math.min(0.05, (now - last) / 1000); last = now;
        const vel = parseFloat(speedEl.value);
        tick += dt * vel;
        const base = svg.querySelector('#v1398-spin');
        if (base) base.setAttribute('transform', `rotate(${(tick*60).toFixed(3)} ${cx} ${cy})`);
        const info = `Live • facets ${facets} • speed ${vel.toFixed(2)}`;
        statusEl.textContent = info;
        requestAnimationFrame(frame);
      }

      // UI wires
      playBtn.addEventListener('click', () => {
        running = !running;
        playBtn.setAttribute('aria-pressed', String(running));
        playBtn.textContent = running ? 'Pause' : 'Play';
      });

      nightBtn.addEventListener('click', () => {
        const noir = !root.classList.contains('noir');
        root.classList.toggle('noir', noir);
        nightBtn.setAttribute('aria-pressed', String(noir));
        nightBtn.textContent = noir ? 'Day' : 'Night';
      });

      paletteBtn.addEventListener('click', () => {
        paletteIndex = (paletteIndex + 1) % palettes.length;
        setPalette(paletteIndex);
      });

      randomBtn.addEventListener('click', () => {
        randomMotif(Math.random());
        build();
      });

      facetEl.addEventListener('input', () => {
        randomMotif(Math.random());
        build();
      });

      speedEl.addEventListener('input', () => {
        // live update status through frame loop; nothing extra here
      });

      bloomEl.addEventListener('input', () => {
        const k = parseFloat(bloomEl.value);
        svg.querySelectorAll('[data-ac]').forEach(el => {
          const baseO = parseFloat(el.getAttribute('data-o') || '0.8');
          const o = Math.max(0.08, Math.min(1, baseO * k));
          if (!el.hasAttribute('stroke-only')) el.setAttribute('fill-opacity', o.toFixed(3));
          else el.setAttribute('stroke-opacity', o.toFixed(3));
        });
      });

      // Build initial scene
      randomMotif(Math.random());
      build();
      setPalette(paletteIndex);
      requestAnimationFrame(frame);

      // Resize handling for crispness (SVG scales automatically; update drop shadow intensity subtly)
      const ro = new ResizeObserver(() => {
        // subtle reactive shadow scaling
        const w = stage.getBoundingClientRect().width;
        const amt = Math.max(0.12, Math.min(0.35, 0.2 + (w/1000)*0.12));
        svg.style.filter = `drop-shadow(0 30px 80px color-mix(in oklab, var(--ac-1), transparent ${Math.round(100 - amt*100)}%))`;
      });
      ro.observe(stage);

      // Click bloom pulse (brief scale)
      stage.addEventListener('click', () => {
        stage.animate([{ transform: stage.style.transform + ' scale(1)' }, { transform: stage.style.transform + ' scale(1.02)' }, { transform: stage.style.transform + ' scale(1)' }], { duration: 320, easing: 'cubic-bezier(.2,.6,.2,1)' });
      });
    })();
  </script>
</section>
      </section>
      <!-- END_EDITABLE -->
    <script>
      // Only show a local placeholder if the agent hasn't written a timestamp yet
      const el = document.getElementById('last-updated');
      if (el && (!el.textContent || el.textContent.includes('not yet'))) {
        const now = new Date();
        el.textContent = `Last updated: ${now.toLocaleString(undefined, { hour12: false })}`;
      }
    </script>
  </body>
  </html>


