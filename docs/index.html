<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vibing</title>
    <style>
      :root {
        --bg: #0f1221;
        --fg: #e6e8f0;
        --muted: #9aa3b2;
        --accent: #8b5cf6;
      }
      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--fg);
        background: radial-gradient(1200px 800px at 70% 10%, #1b1f3a, var(--bg));
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        width: min(720px, 92vw);
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px;
        padding: 28px 24px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        backdrop-filter: blur(6px);
      }
      h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
        letter-spacing: 0.3px;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 18px;
      }
      #content {
        font-size: 18px;
        line-height: 1.6;
        background: rgba(255,255,255,0.04);
        border: 1px dashed rgba(255,255,255,0.12);
        border-radius: 12px;
        padding: 16px;
      }
      .footer {
        margin-top: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: var(--muted);
      }
      .badge {
        display: inline-block;
        background: rgba(139, 92, 246, 0.18);
        color: #d4c2ff;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(139, 92, 246, 0.35);
        letter-spacing: 0.2px;
      }
    </style>
  </head>
  <body>
    <!-- BEGIN_EDITABLE -->
      <section id="content">
<section id="atelier807" aria-label="Membrane 807 — A Gooey Garden">
  <style>
    /* Membrane — Iteration 807 (aggressive shift: from orbital canvas to living gooey SVG) */
    #atelier807 {
      --ink: #0f1220;
      --muted: #5c6b82;
      --line: rgba(0,0,0,0.12);
      --glass: rgba(255,255,255,0.6);
      --bg1: #f9fbff;
      --bg2: #eef5ff;
      --a: 196; /* cyan */
      --b: 304; /* orchid */
      --c: 24;  /* ember */
      position: relative;
      border-radius: 36px;
      padding: clamp(18px, 3.6vw, 44px);
      min-height: 920px;
      color: var(--ink);
      font-family: ui-rounded, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Inter, Roboto, "Helvetica Neue", Arial, "Noto Sans";
      background:
        radial-gradient(1200px 800px at 10% 8%, hsla(var(--a), 80%, 72%, 0.14), transparent 60%),
        radial-gradient(1200px 800px at 90% 94%, hsla(var(--b), 80%, 72%, 0.14), transparent 58%),
        linear-gradient(170deg, var(--bg1), var(--bg2));
      box-shadow: 0 60px 160px rgba(12,20,40,0.14), inset 0 0 0 1px rgba(0,0,0,0.04);
      overflow: hidden;
      isolation: isolate;
    }

    /* Header */
    #atelier807 .top {
      display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 14px;
      margin-bottom: 12px; position: relative; z-index: 5;
    }
    #atelier807 .brand {
      display: inline-flex; align-items: center; gap: 12px;
      padding: 10px 14px; border-radius: 999px; user-select: none;
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,0.86), rgba(255,255,255,0.5));
      -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.95);
      font-weight: 900; letter-spacing: 0.2px;
    }
    #atelier807 .drop {
      --s: 34px; width: var(--s); height: var(--s);
      border-radius: 50% 60% 70% 50% / 60% 50% 60% 50%;
      background:
        radial-gradient(60% 60% at 30% 30%, rgba(255,255,255,0.95), transparent 60%),
        conic-gradient(from 0deg, hsl(var(--a),90%,60%), hsl(var(--b),90%,62%), hsl(var(--c),90%,58%), hsl(var(--a),90%,60%));
      box-shadow: 0 10px 24px rgba(0,0,0,0.16), 0 0 0 8px rgba(0,0,0,0.03);
      position: relative; transform: rotate(12deg);
    }
    #atelier807 .drop::after {
      content: ""; position: absolute; inset: 6px; border-radius: inherit;
      border: 1px solid rgba(255,255,255,0.9); box-shadow: inset 0 0 0 1px rgba(0,0,0,0.06);
    }
    #atelier807 .actions { justify-self: end; display: inline-flex; gap: 10px; flex-wrap: wrap; }
    #atelier807 .btn {
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,0.82), rgba(255,255,255,0.5));
      color: var(--ink);
      padding: 9px 12px;
      border-radius: 14px;
      font-weight: 800; letter-spacing: 0.2px;
      display: inline-flex; align-items: center; gap: 8px;
      cursor: pointer;
      transition: transform 160ms ease, box-shadow 160ms ease, opacity 160ms ease, background 160ms ease;
      -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.92);
      will-change: transform;
    }
    #atelier807 .btn:hover { transform: translateY(-2px); box-shadow: 0 16px 32px rgba(0,0,0,0.18); }
    #atelier807 .btn.on { box-shadow: 0 18px 36px rgba(0,0,0,0.2), inset 0 0 0 1px rgba(255,255,255,1); transform: translateY(-2px); }
    #atelier807 .badge { width: 10px; height: 10px; border-radius: 50%; background: hsl(calc(var(--b) + 12), 85%, 58%); box-shadow: 0 0 10px hsl(calc(var(--b) + 12), 80%, 58%); }

    /* Hero */
    #atelier807 .hero { position: relative; z-index: 4; display: grid; gap: 8px; margin: 6px 0 12px; }
    #atelier807 h1 {
      margin: 0; line-height: 0.92; letter-spacing: -0.02em;
      font-size: clamp(48px, 10.4vw, 132px);
      background: linear-gradient(90deg, hsl(var(--a), 24%, 24%), hsl(var(--b), 26%, 28%));
      -webkit-background-clip: text; background-clip: text; color: transparent;
      text-wrap: balance;
    }
    #atelier807 .sub { margin: 0; color: var(--muted); font-size: 14px; max-width: 78ch; }

    /* Stage */
    #atelier807 .stage { position: relative; z-index: 2; display: grid; place-items: center; margin: 10px 0 16px; perspective: 1100px; }
    #atelier807 .frame {
      width: min(92vw, 1120px);
      aspect-ratio: 21 / 10;
      border-radius: 28px;
      position: relative; overflow: hidden;
      border: 1px solid var(--line);
      background:
        radial-gradient(60% 60% at 30% 30%, rgba(255,255,255,0.6), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.05), transparent 30%);
      box-shadow: 0 46px 140px rgba(0,0,0,0.22), inset 0 0 0 1px rgba(255,255,255,0.46);
      transform-style: preserve-3d;
    }
    #atelier807 svg#pool { position: absolute; inset: 0; width: 100%; height: 100%; display: block; }
    #atelier807 .grain {
      pointer-events: none; position: absolute; inset: -20%;
      background:
        radial-gradient(520px 520px at 22% 28%, hsla(var(--a), 95%, 70%, 0.16), transparent 65%),
        radial-gradient(560px 560px at 78% 72%, hsla(var(--b), 95%, 70%, 0.16), transparent 65%),
        radial-gradient(500px 500px at 54% 12%, hsla(var(--c), 95%, 60%, 0.14), transparent 65%);
      filter: blur(60px);
      z-index: 0;
      animation: a807-halo 26s ease-in-out infinite alternate;
    }
    @keyframes a807-halo {
      0% { transform: scale(1) translateY(-1.2%); opacity: 0.9; }
      100% { transform: scale(1.08) translateY(2%); opacity: 1; }
    }

    /* Gooey look enhancements */
    #atelier807 .goo { mix-blend-mode: screen; }
    #atelier807 .threads { mix-blend-mode: soft-light; }
    #atelier807 .spark { mix-blend-mode: overlay; opacity: 0.6; }

    /* Console */
    #atelier807 .console {
      display: grid; grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px; padding: 10px; border-radius: 16px; border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,0.68), rgba(255,255,255,0.44));
      -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.92);
      color: var(--muted); font-size: 12px; position: relative; z-index: 4;
    }
    #atelier807 .chip {
      border: 1px solid var(--line);
      border-radius: 14px; padding: 10px 12px;
      display: grid; gap: 6px;
      background: linear-gradient(180deg, rgba(255,255,255,0.82), rgba(255,255,255,0.5));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.92);
      min-width: 140px;
    }
    #atelier807 .k { font-weight: 900; letter-spacing: -0.02em; color: var(--ink); font-size: 18px; display: inline-flex; align-items: center; gap: 8px; }
    #atelier807 .swatch { width: 16px; height: 8px; border-radius: 999px; background: linear-gradient(90deg, hsl(var(--a),85%,58%), hsl(var(--b),85%,58%), hsl(var(--c),85%,58%)); box-shadow: 0 0 0 1px rgba(0,0,0,0.08) inset; }
    #atelier807 .range { appearance: none; width: 100%; height: 6px; border-radius: 999px; background: rgba(0,0,0,0.08); outline: none; }
    #atelier807 .range::-webkit-slider-thumb { appearance: none; width: 16px; height: 16px; border-radius: 50%; background: hsl(var(--a), 90%, 55%); box-shadow: 0 0 0 3px rgba(0,0,0,0.08); border: 1px solid var(--line); }
    #atelier807 .range::-moz-range-thumb { width: 16px; height: 16px; border-radius: 50%; background: hsl(var(--a), 90%, 55%); border: 1px solid var(--line); }

    /* Footer */
    #atelier807 .foot {
      position: relative; z-index: 4; margin-top: 16px;
      display: grid; grid-template-columns: auto 1fr auto; gap: 12px; align-items: center;
      border: 1px solid var(--line); border-radius: 16px; padding: 10px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.68), rgba(255,255,255,0.44));
      color: var(--muted); font-size: 12px;
      -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.92);
    }
    #atelier807 .pulse {
      --p: 0deg;
      width: 38px; height: 38px; border-radius: 50%; border: 1px solid var(--line);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.92);
      background: conic-gradient(from 0deg, hsl(var(--a),90%,60%) var(--p,0deg), rgba(0,0,0,0.12) var(--p,0deg));
    }

    /* Modes */
    #atelier807[data-tone="dark"] {
      --ink: #eef3ff;
      --muted: #9eb0c6;
      --glass: rgba(255,255,255,0.16);
      --line: rgba(255,255,255,0.18);
      box-shadow: 0 38px 120px rgba(12,20,40,0.34), inset 0 0 0 1px rgba(255,255,255,0.06);
      --bg1: #0c101a; --bg2: #11182a;
    }
    #atelier807[data-tone="dark"] h1 {
      background: linear-gradient(90deg, rgba(255,255,255,0.98), rgba(255,255,255,0.78));
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    #atelier807[data-bloom="on"] .frame { box-shadow: 0 68px 180px rgba(0,0,0,0.26), inset 0 0 0 1px rgba(255,255,255,0.76), 0 0 0 10px rgba(255,255,255,0.06); }
    #atelier807[data-bloom="on"] .goo { filter: saturate(1.12) contrast(1.06); }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      #atelier807 .grain { animation: none; }
      #atelier807 .btn:hover { transform: none; box-shadow: none; }
    }

    @media (max-width: 980px) { #atelier807 .console { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 640px) { #atelier807 .console { grid-template-columns: 1fr; } }
  </style>

  <div class="top">
    <div class="brand" aria-label="Membrane 807">
      <span class="drop" aria-hidden="true"></span>
      <span>Membrane</span>
    </div>
    <div></div>
    <div class="actions">
      <button type="button" class="btn theme" aria-label="Switch palette">
        <span class="badge" aria-hidden="true"></span> Theme
      </button>
      <button type="button" class="btn bloom" aria-label="Toggle bloom">
        <span class="badge" aria-hidden="true" style="background:hsl(calc(var(--a) + 20), 90%, 60%); box-shadow:0 0 10px hsl(calc(var(--a) + 20), 80%, 60%)"></span> Bloom
      </button>
      <button type="button" class="btn pause" aria-label="Pause motion">
        <span class="badge" aria-hidden="true" style="background:#9aa3b2; box-shadow:0 0 10px rgba(0,0,0,0.2)"></span> Pause
      </button>
      <button type="button" class="btn snap" aria-label="Download snapshot">
        <span class="badge" aria-hidden="true" style="background:#4ad6a7; box-shadow:0 0 10px rgba(74,214,167,0.8)"></span> Snapshot
      </button>
    </div>
  </div>

  <div class="hero">
    <h1>Blobs breathe. Threads whisper.</h1>
    <p class="sub">A living, gooey garden of color. Drag to stir, tap to spawn. The liquid remembers your touch.</p>
  </div>

  <div class="stage" role="region" aria-label="Interactive gooey garden">
    <div class="frame">
      <div class="grain" aria-hidden="true"></div>
      <svg id="pool" viewBox="0 0 1200 700" preserveAspectRatio="none" aria-hidden="false" role="img" aria-label="Morphing colored blobs connected by silky threads">
        <defs>
          <filter id="goo" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur in="SourceGraphic" stdDeviation="12" result="blur"></feGaussianBlur>
            <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0
                                                           0 1 0 0 0
                                                           0 0 1 0 0
                                                           0 0 0 24 -14" result="goo"></feColorMatrix>
            <feBlend in="SourceGraphic" in2="goo"></feBlend>
          </filter>
          <linearGradient id="threadGrad" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="hsla(var(--a),90%,60%,0.5)"/>
            <stop offset="100%" stop-color="hsla(var(--b),90%,60%,0.5)"/>
          </linearGradient>
        </defs>
        <rect x="0" y="0" width="1200" height="700" fill="transparent"></rect>
        <g class="threads" id="threads" stroke="url(#threadGrad)" stroke-width="2" fill="none" opacity="0.6" vector-effect="non-scaling-stroke"></g>
        <g class="goo" id="blobs" filter="url(#goo)"></g>
        <g id="sparkles"></g>
      </svg>
    </div>
  </div>

  <div class="console" aria-live="polite" aria-atomic="true">
    <div class="chip">
      <span>Population</span>
      <span class="k"><span id="pop-count">—</span></span>
    </div>
    <div class="chip">
      <span>Palette</span>
      <span class="k"><i class="swatch" aria-hidden="true"></i><span id="theme-name" style="margin-left:6px">—</span></span>
    </div>
    <div class="chip">
      <span>Speed</span>
      <input class="range" id="speed" type="range" min="0" max="100" value="55" aria-label="Flow speed">
    </div>
    <div class="chip">
      <span>Population</span>
      <input class="range" id="population" type="range" min="8" max="120" value="42" aria-label="Blob count">
    </div>
  </div>

  <div class="foot">
    <div style="display:inline-flex; align-items:center; gap:10px;">
      <span class="pulse" id="pulse" aria-hidden="true"></span>
      <span>Cycle</span>
    </div>
    <div></div>
    <span id="last-updated" aria-live="polite"></span>
  </div>

  <script>
    (function () {
      const root = document.getElementById('atelier807');
      const pool = root.querySelector('#pool');
      const gBlobs = root.querySelector('#blobs');
      const gThreads = root.querySelector('#threads');
      const gSpark = root.querySelector('#sparkles');
      const goo = pool.querySelector('#goo feGaussianBlur');
      const threadMatrix = pool.querySelector('#goo feColorMatrix');

      const btnTheme = root.querySelector('.btn.theme');
      const btnBloom = root.querySelector('.btn.bloom');
      const btnPause = root.querySelector('.btn.pause');
      const btnSnap = root.querySelector('.btn.snap');

      const speedInput = root.querySelector('#speed');
      const popInput = root.querySelector('#population');

      const statCount = root.querySelector('#pop-count');
      const statTheme = root.querySelector('#theme-name');
      const pulse = root.querySelector('#pulse');
      const lastEl = root.querySelector('#last-updated');

      let running = true;
      let bloom = false;
      let mx = 0.5, my = 0.5;
      let speed = Number(speedInput.value) / 100; // 0..1
      const reduceMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      // Palettes
      const palettes = [
        { name: 'Lumen',   tone: 'light', bg1: '#f9fbff', bg2: '#eef5ff', a:196, b:304, c:24  },
        { name: 'Noir',    tone: 'dark',  bg1: '#0c101a', bg2: '#11182a', a:204, b:272, c:336 },
        { name: 'Sorbet',  tone: 'light', bg1: '#fff8f2', bg2: '#f2f8ff', a:18,  b:320, c:204 },
        { name: 'Glacier', tone: 'dark',  bg1: '#0b1319', bg2: '#10202b', a:196, b:166, c:48  },
        { name: 'Aurora',  tone: 'light', bg1: '#f4fffb', bg2: '#eef3ff', a:162, b:206, c:296 }
      ];
      let palIndex = 0;

      function applyPalette(p) {
        root.style.setProperty('--bg1', p.bg1);
        root.style.setProperty('--bg2', p.bg2);
        root.style.setProperty('--a', p.a);
        root.style.setProperty('--b', p.b);
        root.style.setProperty('--c', p.c);
        root.setAttribute('data-tone', p.tone);
        statTheme.textContent = p.name;
      }
      applyPalette(palettes[palIndex]);

      btnTheme.addEventListener('click', () => {
        palIndex = (palIndex + 1) % palettes.length;
        applyPalette(palettes[palIndex]);
      });

      btnBloom.addEventListener('click', () => {
        bloom = !bloom;
        btnBloom.classList.toggle('on', bloom);
        root.setAttribute('data-bloom', bloom ? 'on' : 'off');
        const blur = bloom ? 16 : 12;
        goo.setAttribute('stdDeviation', blur);
        const v = bloom ? "1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 28 -18" : "1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 24 -14";
        threadMatrix.setAttribute('values', v);
      });

      btnPause.addEventListener('click', () => {
        running = !running;
        btnPause.classList.toggle('on', running);
        if (running && !reduceMotion) requestAnimationFrame(tick);
      });

      btnSnap.addEventListener('click', () => {
        try {
          const xml = new XMLSerializer().serializeToString(pool);
          const blob = new Blob([xml], {type: 'image/svg+xml'});
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.download = 'membrane-807.svg';
          link.href = url;
          link.click();
          setTimeout(() => URL.revokeObjectURL(url), 1000);
        } catch (e) {}
      });

      root.addEventListener('pointermove', (e) => {
        const rect = root.getBoundingClientRect();
        mx = (e.clientX - rect.left) / rect.width;
        my = (e.clientY - rect.top) / rect.height;
      }, { passive: true });

      // Touch to spawn
      root.addEventListener('pointerdown', (e) => {
        if (!e.isPrimary) return;
        const rect = pool.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width * 1200;
        const y = (e.clientY - rect.top) / rect.height * 700;
        addBlob(x, y, true);
      });

      // Stage tilt
      function tiltStage() {
        const tx = (mx - 0.5) * 12;
        const ty = (my - 0.5) * -12;
        pool.parentElement.style.transform = `rotateX(${ty}deg) rotateY(${tx}deg)`;
      }

      // Blobs
      const blobs = [];
      const grads = new Map(); // id -> gradient element

      function makeGrad(id, hue) {
        const defs = pool.querySelector('defs');
        const g = document.createElementNS('http://www.w3.org/2000/svg', 'radialGradient');
        g.setAttribute('id', id);
        g.setAttribute('gradientUnits', 'userSpaceOnUse');
        g.innerHTML = `
          <stop offset="0%" stop-color="hsla(${hue.toFixed(1)}, 90%, 62%, 0.85)"/>
          <stop offset="100%" stop-color="hsla(${hue.toFixed(1)}, 90%, 52%, 0)"/>
        `;
        defs.appendChild(g);
        grads.set(id, g);
      }

      function huePool() {
        const styles = getComputedStyle(root);
        const a = Number(styles.getPropertyValue('--a')) || 196;
        const b = Number(styles.getPropertyValue('--b')) || 304;
        const c = Number(styles.getPropertyValue('--c')) || 24;
        const pool = [a, b, c];
        return pool[Math.floor(Math.random()*pool.length)] + (Math.random()*20 - 10);
      }

      function addBlob(x = Math.random()*1200, y = Math.random()*700, pop = false) {
        const hue = huePool();
        const r = 24 + Math.random() * 60;
        const id = 'g' + Math.random().toString(36).slice(2, 8);
        makeGrad(id, hue);

        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', x.toFixed(2));
        circle.setAttribute('cy', y.toFixed(2));
        circle.setAttribute('r', r.toFixed(2));
        circle.setAttribute('fill', `url(#${id})`);
        gBlobs.appendChild(circle);

        const blob = {
          el: circle,
          grad: grads.get(id),
          hue,
          x, y, r,
          vx: (Math.random()*2 - 1) * (1.2 + Math.random()*1.2),
          vy: (Math.random()*2 - 1) * (1.2 + Math.random()*1.2),
          t: Math.random()*Math.PI*2,
          wob: 0.4 + Math.random()*0.9,
          popLife: pop ? 1.0 : 0.0 // for spawn pulse
        };
        blobs.push(blob);
        statCount.textContent = blobs.length;
        updatePopulationSlider();
        return blob;
      }

      function removeExtraBlobs(target) {
        while (blobs.length > target) {
          const b = blobs.pop();
          if (b && b.el && b.el.parentNode) b.el.parentNode.removeChild(b.el);
        }
        statCount.textContent = blobs.length;
      }

      function updateGrad(b) {
        if (!b.grad) return;
        b.grad.setAttribute('cx', b.x.toFixed(2));
        b.grad.setAttribute('cy', b.y.toFixed(2));
        b.grad.setAttribute('r', (b.r*1.8).toFixed(2));
      }

      // Threads (connect blobs around centroid)
      function updateThreads() {
        if (blobs.length < 3) { gThreads.innerHTML = ''; return; }
        const cx = blobs.reduce((s,b)=>s+b.x,0)/blobs.length;
        const cy = blobs.reduce((s,b)=>s+b.y,0)/blobs.length;
        const ordered = blobs.slice().sort((p,q) => Math.atan2(p.y - cy, p.x - cx) - Math.atan2(q.y - cy, q.x - cx));
        let d = '';
        for (let i=0;i<ordered.length;i+=Math.ceil(ordered.length/6)) {
          const chain = ordered.slice(i, i + Math.ceil(ordered.length/6));
          if (chain.length < 2) continue;
          d += 'M ' + chain[0].x.toFixed(1) + ' ' + chain[0].y.toFixed(1) + ' ';
          for (let k=1;k<chain.length;k++) {
            const p = chain[k-1], q = chain[k];
            const mx = (p.x+q.x)/2, my = (p.y+q.y)/2;
            d += 'Q ' + p.x.toFixed(1) + ' ' + p.y.toFixed(1) + ' ' + mx.toFixed(1) + ' ' + my.toFixed(1) + ' ';
          }
        }
        gThreads.innerHTML = '<path d="'+d.trim()+'"></path>';
      }

      // Sparkles
      function seedSparkles(n=48) {
        gSpark.innerHTML = '';
        for (let i=0;i<n;i++) {
          const c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          c.setAttribute('class','spark');
          c.setAttribute('cx', (Math.random()*1200).toFixed(1));
          c.setAttribute('cy', (Math.random()*700).toFixed(1));
          c.setAttribute('r', (Math.random()*1.8 + 0.6).toFixed(2));
          c.setAttribute('fill', `hsla(${huePool().toFixed(1)}, 90%, 70%, 0.5)`);
          gSpark.appendChild(c);
        }
      }

      // Populate
      function seed(n=42) {
        gBlobs.innerHTML = '';
        blobs.length = 0;
        for (let i=0;i<n;i++) addBlob();
        seedSparkles();
      }

      // Controls
      speedInput.addEventListener('input', () => { speed = Number(speedInput.value)/100; });
      popInput.addEventListener('input', () => {
        const target = Number(popInput.value);
        const diff = target - blobs.length;
        if (diff > 0) { for (let i=0;i<diff;i++) addBlob(); }
        else if (diff < 0) removeExtraBlobs(target);
        statCount.textContent = blobs.length;
      });

      function updatePopulationSlider() {
        const v = Number(popInput.value);
        if (blobs.length !== v) {
          popInput.value = Math.min(Math.max(blobs.length, Number(popInput.min)), Number(popInput.max));
        }
      }

      // Tick
      function draw(now) {
        // tilt
        tiltStage();
        // animate blobs
        const attX = (mx - 0.5) * 1200 * 0.06;
        const attY = (my - 0.5) * 700 * 0.06;

        for (let i=0;i<blobs.length;i++) {
          const b = blobs[i];
          b.t += 0.004 + speed*0.02;
          // flow
          b.vx += Math.cos(b.t + b.x*0.002) * 0.02 * (0.6 + speed);
          b.vy += Math.sin(b.t + b.y*0.002) * 0.02 * (0.6 + speed);
          // pointer attraction
          b.vx += attX * 0.00004 * (1 + speed);
          b.vy += attY * 0.00004 * (1 + speed);
          // damping
          b.vx *= 0.985; b.vy *= 0.985;
          b.x += b.vx; b.y += b.vy;

          // walls
          if (b.x < -60) { b.x = 1260; } else if (b.x > 1260) { b.x = -60; }
          if (b.y < -60) { b.y = 760; } else if (b.y > 760) { b.y = -60; }

          // wobble + spawn pulse
          const pulse = Math.sin(b.t*2.0) * b.wob * 2;
          if (b.popLife > 0) {
            b.r += 1.6; b.popLife -= 0.05;
          } else {
            b.r += pulse * 0.1;
          }

          b.el.setAttribute('cx', b.x.toFixed(2));
          b.el.setAttribute('cy', b.y.toFixed(2));
          b.el.setAttribute('r', Math.max(12, Math.min(120, b.r)).toFixed(2));
          updateGrad(b);
        }

        // threads
        updateThreads();

        // sparkles drift
        const sparks = gSpark.querySelectorAll('circle.spark');
        for (let i=0;i<sparks.length;i++){
          const s = sparks[i];
          const x = parseFloat(s.getAttribute('cx')) + Math.cos(now*0.0004 + i)*0.2;
          const y = parseFloat(s.getAttribute('cy')) + Math.sin(now*0.00036 + i)*0.2;
          s.setAttribute('cx', (x>1200?0:(x<0?1200:x)).toFixed(1));
          s.setAttribute('cy', (y>700?0:(y<0?700:y)).toFixed(1));
        }
      }

      function tick(now) {
        if (!running) return;
        const d = new Date();
        const pace = 7.4; // seconds per cycle
        const pct = ((now / 1000) % pace) / pace;
        pulse.style.setProperty('--p', (pct * 360).toFixed(2) + 'deg');
        lastEl.textContent = 'Last updated: ' + d.toLocaleString([], { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' });
        draw(now || performance.now());
        if (!reduceMotion) requestAnimationFrame(tick);
      }

      // Init
      seed(Number(popInput.value));
      statCount.textContent = blobs.length;
      running = true;
      tick(performance.now());
      if (reduceMotion) setInterval(() => tick(performance.now()), 1000);

      // Auto-ornament: add one every 10s up to cap
      let lastSec = -1;
      setInterval(() => {
        const s = new Date().getSeconds();
        if (s !== lastSec) {
          lastSec = s;
          if (!reduceMotion && s % 10 === 0 && blobs.length < 160) addBlob();
        }
      }, 500);

      // Cleanup
      const obs = new MutationObserver(() => {
        if (!document.body.contains(root)) { running = false; obs.disconnect(); }
      });
      obs.observe(document.body, { childList: true, subtree: true });
    })();
  </script>
</section>
      </section>
      <!-- END_EDITABLE -->
    <script>
      // Only show a local placeholder if the agent hasn't written a timestamp yet
      const el = document.getElementById('last-updated');
      if (el && (!el.textContent || el.textContent.includes('not yet'))) {
        const now = new Date();
        el.textContent = `Last updated: ${now.toLocaleString(undefined, { hour12: false })}`;
      }
    </script>
  </body>
  </html>


