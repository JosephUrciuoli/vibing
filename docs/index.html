<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vibing</title>
    <style>
      :root {
        --bg: #0f1221;
        --fg: #e6e8f0;
        --muted: #9aa3b2;
        --accent: #8b5cf6;
      }
      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--fg);
        background: radial-gradient(1200px 800px at 70% 10%, #1b1f3a, var(--bg));
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        width: min(720px, 92vw);
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px;
        padding: 28px 24px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        backdrop-filter: blur(6px);
      }
      h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
        letter-spacing: 0.3px;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 18px;
      }
      #content {
        font-size: 18px;
        line-height: 1.6;
        background: rgba(255,255,255,0.04);
        border: 1px dashed rgba(255,255,255,0.12);
        border-radius: 12px;
        padding: 16px;
      }
      .footer {
        margin-top: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: var(--muted);
      }
      .badge {
        display: inline-block;
        background: rgba(139, 92, 246, 0.18);
        color: #d4c2ff;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(139, 92, 246, 0.35);
        letter-spacing: 0.2px;
      }
    </style>
  </head>
  <body>
    <!-- BEGIN_EDITABLE -->
      <section id="content">
<section id="prismarium" data-theme="pearl" aria-label="Prismarium • Iteration 697">
  <style>
    /* ---------- Tokens ---------- */
    #prismarium {
      --ink:#10131b;
      --muted:#6a768e;
      --ring:rgba(16,19,27,0.16);
      --bg-1:#f8fbff;
      --bg-2:#eef3ff;
      --c1:#7ad8ff; --c2:#7affb8; --c3:#ffd27a; --c4:#b07aff;

      position:relative; isolation:isolate; overflow:clip;
      border-radius:34px; padding: clamp(16px, 4vw, 44px);
      border:1px solid var(--ring);
      color:var(--ink);
      min-height: 760px;
      background:
        radial-gradient(180% 140% at 110% -20%, rgba(255,255,255,0.6), transparent 60%),
        radial-gradient(160% 140% at -10% 120%, rgba(255,255,255,0.5), transparent 60%),
        linear-gradient(180deg, var(--bg-1), var(--bg-2));
      box-shadow:
        0 90px 180px rgba(0,0,0,0.18),
        inset 0 0 0 1px rgba(255,255,255,0.35);
      font: 500 15px/1.6 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
      --rx: 0deg; --ry: 0deg;
    }

    /* Themes */
    #prismarium[data-theme="pearl"] {
      --ink:#11131b; --muted:#66718b; --ring:rgba(16,19,27,0.16);
      --bg-1:#fbfdff; --bg-2:#eef3ff;
      --c1:#7ad8ff; --c2:#7affb8; --c3:#ffd27a; --c4:#b07aff;
    }
    #prismarium[data-theme="ink"] {
      --ink:#e9f2ff; --muted:#b6c3e1; --ring:rgba(232,238,255,0.22);
      --bg-1:#0b1024; --bg-2:#0d1432;
      --c1:#6ed2ff; --c2:#8bff9a; --c3:#a7c1ff; --c4:#ffd179;
    }
    #prismarium[data-theme="ultraviolet"] {
      --ink:#0f1022; --muted:#7f8be0; --ring:rgba(21,22,48,0.2);
      --bg-1:#efe9ff; --bg-2:#e7f6ff;
      --c1:#7a7aff; --c2:#ff76e1; --c3:#76ffe8; --c4:#ffd66e;
    }
    #prismarium[data-theme="citrus"] {
      --ink:#121318; --muted:#7b7f98; --ring:rgba(18,19,24,0.16);
      --bg-1:#fff7ea; --bg-2:#fff1ff;
      --c1:#ffb36e; --c2:#ffe36e; --c3:#7cffc1; --c4:#7aa6ff;
    }

    /* Ambient fog + grain */
    #prismarium .spectra {
      position:absolute; inset:-24%;
      background:
        radial-gradient(40% 30% at 22% 28%, color-mix(in lab, var(--c3), transparent 72%), transparent 60%),
        radial-gradient(36% 30% at 84% 20%, color-mix(in lab, var(--c4), transparent 70%), transparent 60%),
        radial-gradient(80% 70% at 58% 94%, color-mix(in lab, var(--c1), transparent 80%), transparent 70%);
      filter: blur(70px) saturate(115%);
      mix-blend-mode: soft-light; opacity:.85; z-index:0;
      animation: spectra-move 60s ease-in-out infinite alternate;
    }
    @keyframes spectra-move {
      0% { transform: translate(0%,0%) scale(1.02) rotate(0.3deg); }
      50% { transform: translate(-1.6%,1.4%) scale(1.05) rotate(-0.4deg); }
      100% { transform: translate(1.4%,-1.2%) scale(1.03) rotate(0deg); }
    }
    #prismarium .grain {
      position:absolute; inset:-6%;
      background:
        repeating-conic-gradient(from 0deg, rgba(0,0,0,0.06) 0 10deg, transparent 10deg 20deg),
        repeating-linear-gradient(0deg, rgba(255,255,255,0.035) 0 2px, transparent 2px 6px);
      mix-blend-mode: soft-light; opacity:.06; pointer-events:none; z-index:0;
      animation: gra 8s steps(6) infinite;
    }
    @keyframes gra { 50% { transform: translate(2px,-2px) } }

    /* Top bar */
    #prismarium .top {
      position:relative; z-index:2;
      display:flex; justify-content:space-between; align-items:center; gap:14px;
      margin-bottom: clamp(8px, 2.8vw, 22px);
    }
    #prismarium .brand { display:inline-flex; align-items:center; gap:12px; color:var(--muted); font-weight:900; letter-spacing:.2px; }
    #prismarium .glyph {
      width:40px; height:40px; border-radius:12px; position:relative; overflow:hidden;
      border:1px solid var(--ring);
      background: linear-gradient(180deg, rgba(255,255,255,0.75), rgba(255,255,255,0.35));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.6), 0 16px 36px rgba(0,0,0,0.16);
    }
    #prismarium .glyph::before {
      content:""; position:absolute; inset:7px; border-radius:6px; transform: rotate(45deg) skewX(-6deg);
      background: conic-gradient(from .2turn, var(--c1), var(--c2), var(--c3), var(--c4), var(--c1));
      -webkit-mask: radial-gradient(55% 55% at 50% 50%, #000 50%, transparent 51%);
              mask: radial-gradient(55% 55% at 50% 50%, #000 50%, transparent 51%);
      animation: spin 18s linear infinite;
    }
    @keyframes spin { to { transform: rotate(405deg) skewX(-6deg) } }

    /* Dock controls */
    #prismarium .dock { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    #prismarium .chip, #prismarium .swatch {
      appearance:none; -webkit-tap-highlight-color:transparent; user-select:none; cursor:pointer;
      border:1px solid var(--ring);
      background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.55));
      color:var(--ink); border-radius:14px;
      box-shadow: 0 16px 32px rgba(0,0,0,0.12), inset 0 0 0 1px rgba(255,255,255,0.28);
      transition: transform .14s ease, box-shadow .25s ease, background .2s ease, opacity .2s ease;
    }
    #prismarium .chip { padding:10px 14px; font-weight:800; letter-spacing:.2px; font-size:12px; }
    #prismarium .chip:hover { transform: translateY(-1px); box-shadow: 0 24px 48px rgba(0,0,0,0.18), 0 0 0 6px rgba(0,0,0,0.04); }
    #prismarium .chip.primary {
      background:
        linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.62)),
        linear-gradient(90deg, var(--c1), var(--c3));
      background-blend-mode: overlay, normal; color:#0e1220; border-color: rgba(0,0,0,0.1);
    }
    #prismarium .swatch {
      width:26px; height:26px; border-radius:999px; padding:0; position:relative;
      background: conic-gradient(from .2turn, var(--c1), var(--c2), var(--c3), var(--c4));
    }
    #prismarium .swatch[data-theme="pearl"]       { background: conic-gradient(from .2turn, #7ad8ff,#7affb8,#ffd27a,#b07aff); }
    #prismarium .swatch[data-theme="ink"]         { background: conic-gradient(from .2turn, #6ed2ff,#8bff9a,#a7c1ff,#ffd179); }
    #prismarium .swatch[data-theme="ultraviolet"] { background: conic-gradient(from .2turn, #7a7aff,#ff76e1,#76ffe8,#ffd66e); }
    #prismarium .swatch[data-theme="citrus"]      { background: conic-gradient(from .2turn, #ffb36e,#ffe36e,#7cffc1,#7aa6ff); }
    #prismarium .swatch.active::after { content:""; position:absolute; inset:4px; border:2px solid rgba(255,255,255,0.95); border-radius:999px; }

    /* Hero */
    #prismarium .hero { position:relative; z-index:2; display:grid; gap: clamp(6px, 1.6vw, 14px); margin: clamp(8px, 3.2vw, 26px) 0; }
    #prismarium .kicker { color:var(--muted); text-transform:uppercase; letter-spacing:.28em; font-weight:900; font-size: clamp(11px, 1.4vw, 13px); }
    #prismarium .title {
      font-weight: 950; letter-spacing:-0.02em; line-height:.88;
      font-size: clamp(48px, 8.6vw, 116px);
      background: linear-gradient(90deg, var(--ink), var(--c4) 38%, var(--c1) 64%, var(--c3));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow: 0 1px 0 rgba(255,255,255,0.15);
    }
    #prismarium .sub { color: var(--muted); max-width: 72ch; font-size: clamp(13px, 1.8vw, 18px); }

    /* Stage */
    #prismarium .stage { position:relative; z-index:1; display:grid; place-items:center; margin: clamp(14px, 4.2vw, 38px) 0; }
    #prismarium .frame {
      position:relative; width:min(94vw, 1180px); aspect-ratio: 21/10; border-radius:26px; overflow:hidden;
      border: 1px solid var(--ring);
      transform-style:preserve-3d; transform: rotateX(var(--rx)) rotateY(var(--ry));
      background:
        radial-gradient(60% 90% at 50% 50%, rgba(255,255,255,0.45), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,0.35), rgba(255,255,255,0.18));
      box-shadow: 0 40px 120px rgba(0,0,0,0.14), inset 0 0 0 1px rgba(255,255,255,0.4);
      backdrop-filter: blur(8px) saturate(120%); -webkit-backdrop-filter: blur(8px) saturate(120%);
    }
    #prismarium canvas { position:absolute; inset:0; width:100%; height:100%; display:block; }
    #prismarium .pointer-ring { pointer-events:none; position:absolute; width:160px; height:160px; border-radius:50%;
      border: 1px dashed rgba(0,0,0,0.12); transform: translate(-50%, -50%) scale(1);
      opacity: .0; transition: opacity .25s ease; }
    #prismarium .frame:hover .pointer-ring { opacity: .6; }
    #prismarium .pointer-ring::after {
      content:""; position:absolute; inset:-10px; border-radius:inherit;
      background: conic-gradient(from .08turn, transparent 0 12%, rgba(0,0,0,0.08) 12% 14%, transparent 14% 44%, rgba(0,0,0,0.08) 44% 46%, transparent 46% 100%);
      mask: radial-gradient(circle, transparent 70%, #000 73%);
      animation: spin 24s linear infinite;
    }

    /* Hints */
    #prismarium .hints { position:relative; z-index:2; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center; }
    #prismarium .pill {
      font-size:12px; color:var(--muted); display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--ring); border-radius:999px; padding:6px 10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255,255,255,0.4));
      box-shadow: 0 8px 18px rgba(0,0,0,0.12);
    }
    #prismarium kbd {
      font:700 11px/1 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      color:#0e1222; background: linear-gradient(90deg, var(--c4), var(--c1));
      padding:6px 8px; border-radius:8px; border:1px solid rgba(0,0,0,0.18);
      box-shadow: 0 2px 10px rgba(0,0,0,0.18); letter-spacing:.15px;
    }

    /* Footer */
    #prismarium .foot { position:relative; z-index:2; margin-top:22px; display:flex; flex-direction:column; gap:10px; align-items:center; color:var(--muted); }
    #prismarium .rule { height:1px; width:100%; border-radius:1px; background: linear-gradient(90deg, transparent, rgba(0,0,0,0.5), transparent); opacity:.12; }
    #prismarium .meta {
      display:inline-flex; gap:10px; align-items:center; font-size:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255,255,255,0.4));
      border: 1px solid var(--ring); padding: 6px 10px; border-radius: 999px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.12);
    }
    #prismarium .tag {
      padding: 4px 8px; border-radius: 999px; font-size: 11px; color: #0e1222;
      background: linear-gradient(90deg, var(--c2), var(--c4));
      box-shadow: 0 2px 12px rgba(0,0,0,0.18); font-weight: 800; letter-spacing: .3px;
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      #prismarium, #prismarium * { animation: none !important; transition: none !important; }
      #prismarium .spectra, #prismarium .pointer-ring { display:none !important; }
    }
  </style>

  <div class="spectra" aria-hidden="true"></div>
  <div class="grain" aria-hidden="true"></div>

  <div class="top">
    <div class="brand" aria-label="Brand">
      <span class="glyph" aria-hidden="true"></span>
      <span>Prismarium • Iteration 697</span>
    </div>
    <div class="dock" role="group" aria-label="Controls">
      <button class="swatch active" data-theme="pearl" title="Pearl"></button>
      <button class="swatch" data-theme="ink" title="Ink"></button>
      <button class="swatch" data-theme="ultraviolet" title="Ultraviolet"></button>
      <button class="swatch" data-theme="citrus" title="Citrus"></button>
      <button class="chip primary" id="play-prism" title="Play or pause">Pause</button>
      <button class="chip" id="trail-prism" title="Toggle afterglow">Afterglow: On</button>
      <button class="chip" id="dispersion-prism" title="Cycle dispersion">Dispersion: 1.0×</button>
      <button class="chip" id="density-prism" title="Change shard count">Shards: 72</button>
      <button class="chip" id="capture-prism" title="Save an image">Capture</button>
    </div>
  </div>

  <div class="hero">
    <div class="kicker">Light behaves beautifully</div>
    <h1 class="title">Prismatic Field</h1>
    <p class="sub">Glide your pointer to tilt the glass. Click to cast splinters. Wheel to bend light. A quiet study of refraction and rhythm.</p>
  </div>

  <div class="stage">
    <div class="frame" id="glass-pane" aria-label="Interactive prism field">
      <canvas id="glass" aria-hidden="true"></canvas>
      <div class="pointer-ring" id="glass-ring" aria-hidden="true"></div>
    </div>
  </div>

  <div class="hints" aria-label="Shortcuts">
    <span class="pill"><kbd>Click</kbd> splinters</span>
    <span class="pill"><kbd>Wheel</kbd> bend</span>
    <span class="pill"><kbd>Space</kbd> pause</span>
    <span class="pill"><kbd>T</kbd> theme</span>
    <span class="pill"><kbd>+</kbd>/<kbd>-</kbd> shards</span>
    <span class="pill"><kbd>S</kbd> save</span>
  </div>

  <div class="foot">
    <div class="rule" aria-hidden="true"></div>
    <small class="meta">
      <span class="tag">Refreshed</span>
      <span id="last-updated">Last updated: 2025-11-17 08:30:35 EST</span>
    </small>
  </div>

  <script>
    (function(){
      const root = document.getElementById('prismarium');
      const canvas = document.getElementById('glass');
      const ctx = canvas.getContext('2d', { alpha: true });
      const pane = document.getElementById('glass-pane');
      const ring = document.getElementById('glass-ring');

      const swatches = [...root.querySelectorAll('.swatch')];
      const playBtn = document.getElementById('play-prism');
      const trailBtn = document.getElementById('trail-prism');
      const dispBtn  = document.getElementById('dispersion-prism');
      const densBtn  = document.getElementById('density-prism');
      const capBtn   = document.getElementById('capture-prism');
      const updated  = document.getElementById('last-updated');

      // Last updated
      try {
        const fmt = new Intl.DateTimeFormat([], { dateStyle: 'medium', timeStyle: 'medium' });
        updated.textContent = 'Last updated: ' + fmt.format(new Date());
      } catch {
        updated.textContent = 'Last updated: ' + new Date().toLocaleString();
      }

      // Fit to DPI
      let W=0, H=0, DPR=Math.min(2, window.devicePixelRatio||1);
      function fit(){
        const r = pane.getBoundingClientRect();
        W = Math.max(420, Math.floor(r.width));
        H = Math.max(300, Math.floor(r.height));
        canvas.width = Math.floor(W * DPR);
        canvas.height = Math.floor(H * DPR);
        canvas.style.width = W + 'px';
        canvas.style.height = H + 'px';
        ctx.setTransform(DPR,0,0,DPR,0,0);
        drawImmediate();
      }
      new ResizeObserver(fit).observe(pane);
      fit();

      // Palette
      function palette(){
        const cs = getComputedStyle(root);
        return ['--c1','--c2','--c3','--c4'].map(k=>cs.getPropertyValue(k).trim());
      }
      let colors = palette();

      // State
      let paused = false;
      let afterglow = true;
      let dispersion = 1.0;
      let shardCount = 72;
      let time = 0;

      const aim = { x: W*0.5, y: H*0.5, nx: 0.5, ny: 0.5 };

      // Geometry helpers
      function rand(a,b){ return a + Math.random()*(b-a); }
      function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
      const TAU = Math.PI*2;

      // Shards
      let shards = [];
      function seedShards(count=shardCount){
        shards = [];
        colors = palette();
        for (let i=0;i<count;i++){
          const hue = colors[i % colors.length];
          shards.push({
            x: rand(W*0.06, W*0.94),
            y: rand(H*0.10, H*0.90),
            r: rand(24, Math.min(W,H)*0.12),
            a: rand(0, TAU),
            spin: rand(-0.5, 0.5),
            wob: rand(0.2, 0.9),
            jiggle: rand(0.5, 1.5),
            hue
          });
        }
        densBtn.textContent = 'Shards: ' + count;
        drawImmediate();
      }

      // Splinters (click)
      let splinters = [];
      function burst(x,y){
        const n = 14;
        for (let i=0;i<n;i++){
          const a = (i/n)*TAU + Math.random()*0.25;
          const v = rand(120, 320);
          splinters.push({
            x, y, vx: Math.cos(a)*v, vy: Math.sin(a)*v,
            life: 1, size: rand(1,3), hue: colors[i%colors.length]
          });
        }
      }

      seedShards(shardCount);

      // Pointer + tilt
      pane.addEventListener('pointermove', (e)=>{
        const r = pane.getBoundingClientRect();
        aim.x = e.clientX - r.left;
        aim.y = e.clientY - r.top;
        aim.nx = aim.x / r.width;
        aim.ny = aim.y / r.height;
        ring.style.left = aim.x + 'px';
        ring.style.top = aim.y + 'px';
        root.style.setProperty('--ry', ((aim.nx - 0.5) * 12).toFixed(2) + 'deg');
        root.style.setProperty('--rx', (-(aim.ny - 0.5) * 7).toFixed(2) + 'deg');
      }, { passive:true });
      pane.addEventListener('pointerleave', ()=>{
        aim.x=W*0.5; aim.y=H*0.5; aim.nx=0.5; aim.ny=0.5;
        root.style.setProperty('--rx','0deg'); root.style.setProperty('--ry','0deg');
      }, { passive:true });
      pane.addEventListener('wheel', (e)=>{
        e.preventDefault();
        const s = Math.sign(e.deltaY);
        dispersion = clamp(dispersion + (s>0?-0.1:0.1), 0.5, 2.4);
        dispBtn.textContent = 'Dispersion: ' + dispersion.toFixed(1) + '×';
      }, { passive:false });
      pane.addEventListener('click', (e)=>{
        const r = pane.getBoundingClientRect();
        burst(e.clientX - r.left, e.clientY - r.top);
      }, { passive:true });

      // Controls
      playBtn.addEventListener('click', ()=>{
        paused = !paused;
        playBtn.textContent = paused ? 'Resume' : 'Pause';
      });
      trailBtn.addEventListener('click', ()=>{
        afterglow = !afterglow;
        trailBtn.textContent = 'Afterglow: ' + (afterglow ? 'On' : 'Off');
        if (!afterglow) drawImmediate();
      });
      dispBtn.addEventListener('click', ()=>{
        const steps = [0.8, 1.0, 1.4, 1.8, 2.2];
        const idx = steps.reduce((acc,v,i)=> Math.abs(v-dispersion)<Math.abs(steps[acc]-dispersion)?i:acc, 0);
        dispersion = steps[(idx+1)%steps.length];
        dispBtn.textContent = 'Dispersion: ' + dispersion.toFixed(1) + '×';
      });
      densBtn.addEventListener('click', ()=>{
        shardCount = shardCount >= 144 ? 40 : shardCount + 16;
        seedShards(shardCount);
      });
      capBtn.addEventListener('click', ()=>{
        try {
          const tmp = document.createElement('canvas');
          tmp.width = Math.floor(W*DPR); tmp.height = Math.floor(H*DPR);
          const tg = tmp.getContext('2d'); tg.drawImage(canvas, 0, 0, tmp.width, tmp.height);
          const a = document.createElement('a');
          a.download = 'prismarium-' + Date.now() + '.png';
          a.href = tmp.toDataURL('image/png'); document.body.appendChild(a); a.click(); a.remove();
        } catch {}
      });

      // Keyboard
      window.addEventListener('keydown', (e)=>{
        if (e.key === ' ') { e.preventDefault(); playBtn.click(); }
        if (e.key === 's' || e.key === 'S') { capBtn.click(); }
        if (e.key === 't' || e.key === 'T') { cycleTheme(); }
        if (e.key === '+') { shardCount = Math.min(200, shardCount + 8); seedShards(shardCount); }
        if (e.key === '-') { shardCount = Math.max(24, shardCount - 8); seedShards(shardCount); }
      }, { passive:false });

      // Themes
      function setTheme(name){
        root.dataset.theme = name;
        swatches.forEach(d=>d.classList.toggle('active', d.dataset.theme === name));
        colors = palette(); drawImmediate();
      }
      function cycleTheme(){
        const order = ['pearl','ultraviolet','citrus','ink'];
        const i = order.indexOf(root.dataset.theme);
        setTheme(order[(i+1)%order.length]);
      }
      swatches.forEach(d=>d.addEventListener('click', ()=> setTheme(d.dataset.theme)));
      try {
        const h = new Date().getHours();
        if (h >= 7 && h < 12) setTheme('pearl');
        if (h >= 12 && h < 17) setTheme('citrus');
        if (h >= 17 && h < 21) setTheme('ultraviolet');
        if (h >= 21 || h < 7) setTheme('ink');
      } catch {}

      // Render
      function drawImmediate(){
        ctx.clearRect(0,0,W,H);
        backdrop();
      }
      function backdrop(){
        const cx=W*0.5, cy=H*0.5, r=Math.max(W,H)*0.72;
        const g = ctx.createRadialGradient(cx, cy, r*0.04, cx, cy, r);
        g.addColorStop(0, 'rgba(255,255,255,0.55)');
        g.addColorStop(1, 'rgba(0,0,0,0.08)');
        ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
        const vg = ctx.createRadialGradient(cx, cy, Math.min(W,H)*0.25, cx, cy, Math.max(W,H)*0.95);
        vg.addColorStop(0, 'rgba(255,255,255,0.03)');
        vg.addColorStop(1, 'rgba(0,0,0,0.12)');
        ctx.fillStyle = vg; ctx.fillRect(0,0,W,H);
      }

      function drawShards(dt){
        ctx.save();
        ctx.globalCompositeOperation = 'screen';
        for (let i=0;i<shards.length;i++){
          const s = shards[i];
          s.a += s.spin * dt * 0.6;
          const wobA = Math.sin((time*0.6 + i)*s.jiggle)*0.5 + 0.5;
          const r1 = s.r * (0.72 + wobA*0.18);
          const r2 = s.r * (0.98 + wobA*0.12);
          const r3 = s.r * (0.58 + wobA*0.22);

          // gentle lens pull toward aim
          const dx = (aim.x - s.x), dy = (aim.y - s.y);
          const d  = Math.hypot(dx,dy) + 0.001;
          const pull = Math.exp(-(d*d)/(2*Math.pow(Math.min(W,H)*0.38,2))) * dispersion * 6.0;
          const px = s.x + dx * pull * 0.02;
          const py = s.y + dy * pull * 0.02;

          const a1 = s.a;
          const a2 = s.a + TAU/3;
          const a3 = s.a + 2*TAU/3;

          const p1 = { x: px + Math.cos(a1)*r1, y: py + Math.sin(a1)*r2 };
          const p2 = { x: px + Math.cos(a2)*r2, y: py + Math.sin(a2)*r3 };
          const p3 = { x: px + Math.cos(a3)*r3, y: py + Math.sin(a3)*r1 };

          // Fill with soft glass
          const g = ctx.createLinearGradient(p1.x, p1.y, p2.x, p2.y);
          g.addColorStop(0, s.hue);
          g.addColorStop(1, 'rgba(255,255,255,0)');
          ctx.beginPath();
          ctx.moveTo(p1.x, p1.y);
          ctx.lineTo(p2.x, p2.y);
          ctx.lineTo(p3.x, p3.y);
          ctx.closePath();
          ctx.globalAlpha = 0.18 * (0.8 + 0.2*Math.sin(time*0.7 + i));
          ctx.fillStyle = g;
          ctx.fill();

          // Edge light
          ctx.globalAlpha = 0.38;
          ctx.lineWidth = 1.4;
          ctx.strokeStyle = s.hue;
          ctx.beginPath();
          ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.lineTo(p3.x, p3.y); ctx.closePath();
          ctx.stroke();

          // Caustic spark
          ctx.globalAlpha = 0.22;
          const cg = ctx.createRadialGradient(px, py, 0, px, py, Math.max(r1,r2,r3)*0.9);
          cg.addColorStop(0, s.hue);
          cg.addColorStop(1, 'rgba(255,255,255,0)');
          ctx.fillStyle = cg;
          ctx.beginPath(); ctx.arc(px, py, Math.max(r1,r2,r3)*0.9, 0, TAU); ctx.fill();
        }
        ctx.restore();
      }

      function drawSplinters(dt){
        for (let i=splinters.length-1; i>=0; i--){
          const sp = splinters[i];
          sp.life -= dt*0.7;
          if (sp.life <= 0) { splinters.splice(i,1); continue; }
          sp.vx *= 0.985; sp.vy *= 0.985;
          sp.x += sp.vx * dt; sp.y += sp.vy * dt;

          ctx.save();
          ctx.globalCompositeOperation = 'screen';
          ctx.globalAlpha = 0.6 * sp.life;
          ctx.strokeStyle = sp.hue;
          ctx.lineWidth = sp.size;
          ctx.lineCap = 'round';
          ctx.beginPath();
          ctx.moveTo(sp.x, sp.y);
          ctx.lineTo(sp.x - sp.vx*0.05, sp.y - sp.vy*0.05);
          ctx.stroke();

          ctx.globalAlpha = 0.45 * sp.life;
          ctx.fillStyle = sp.hue;
          ctx.shadowColor = sp.hue; ctx.shadowBlur = 12;
          ctx.beginPath(); ctx.arc(sp.x, sp.y, sp.size*0.9, 0, TAU); ctx.fill();
          ctx.restore();
        }
      }

      function step(dt){
        // afterglow background
        ctx.save();
        ctx.globalCompositeOperation = 'source-over';
        const fade = afterglow ? (root.dataset.theme==='ink' ? 0.06 : 0.08) : 1.0;
        ctx.fillStyle = 'rgba(255,255,255,' + fade + ')';
        ctx.fillRect(0,0,W,H);
        ctx.restore();

        drawShards(dt);
        drawSplinters(dt);
      }

      // Loop
      let last = performance.now();
      const reduce = matchMedia('(prefers-reduced-motion: reduce)').matches;
      function loop(ts){
        const dt = Math.min(0.033, (ts - last)/1000);
        last = ts;
        if (!paused && !reduce){
          time += dt;
          step(dt);
        }
        raf = requestAnimationFrame(loop);
      }
      let raf = requestAnimationFrame(loop);
      window.addEventListener('beforeunload', ()=> cancelAnimationFrame(raf));

      // Re-seed on resize for balance
      let resizeT;
      window.addEventListener('resize', ()=>{
        clearTimeout(resizeT);
        resizeT = setTimeout(()=> seedShards(shardCount), 120);
      }, { passive:true });

      // keep palette in sync if swatch clicked
      swatches.forEach(d=>d.addEventListener('click', ()=> { colors = palette(); }));
    })();
  </script>
</section>
      </section>
      <!-- END_EDITABLE -->
    <script>
      // Only show a local placeholder if the agent hasn't written a timestamp yet
      const el = document.getElementById('last-updated');
      if (el && (!el.textContent || el.textContent.includes('not yet'))) {
        const now = new Date();
        el.textContent = `Last updated: ${now.toLocaleString(undefined, { hour12: false })}`;
      }
    </script>
  </body>
  </html>


