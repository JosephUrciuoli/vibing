<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vibing</title>
    <style>
      :root {
        --bg: #0f1221;
        --fg: #e6e8f0;
        --muted: #9aa3b2;
        --accent: #8b5cf6;
      }
      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--fg);
        background: radial-gradient(1200px 800px at 70% 10%, #1b1f3a, var(--bg));
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        width: min(720px, 92vw);
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px;
        padding: 28px 24px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        backdrop-filter: blur(6px);
      }
      h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
        letter-spacing: 0.3px;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 18px;
      }
      #content {
        font-size: 18px;
        line-height: 1.6;
        background: rgba(255,255,255,0.04);
        border: 1px dashed rgba(255,255,255,0.12);
        border-radius: 12px;
        padding: 16px;
      }
      .footer {
        margin-top: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: var(--muted);
      }
      .badge {
        display: inline-block;
        background: rgba(139, 92, 246, 0.18);
        color: #d4c2ff;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(139, 92, 246, 0.35);
        letter-spacing: 0.2px;
      }
    </style>
  </head>
  <body>
    <!-- BEGIN_EDITABLE -->
      <section id="content">
<section class="vx602" data-paused="false" aria-label="Vellum Poster Engine">
  <style>
    .vx602{
      --paper:#f7f9ff;
      --ink:#0a0f1f;
      --muted:#5b667f;
      --edge:rgba(0,0,0,0.10);
      --glass:rgba(255,255,255,0.60);
      --a1:#6b8cff;
      --a2:#ff7ab6;
      --a3:#20d6c6;
      --a4:#ffd06e;
      --halo: 32, 40, 74;
      --grain: 0.12;
      --noise: none;
      position:relative;
      overflow:hidden;
      border-radius:28px;
      padding:20px;
      color:var(--ink);
      font-family: ui-sans-serif, -apple-system, "SF Pro Display", Inter, "Segoe UI", Roboto, Arial;
      background:
        radial-gradient(140% 120% at 100% 0%, rgba(140,160,255,0.25), transparent 52%),
        radial-gradient(120% 120% at -10% 110%, rgba(255,190,220,0.25), transparent 58%),
        linear-gradient(180deg, #ffffff, var(--paper));
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.7),
        0 50px 140px rgba(20,30,60,0.20);
      isolation:isolate;
    }
    .vx602::before{
      content:"";
      position:absolute; inset:-30%;
      background:
        conic-gradient(from 0deg at 60% 40%,
        rgba(107,140,255,0.18), rgba(255,122,182,0.12), rgba(32,214,198,0.16), transparent 60%, rgba(255,208,110,0.16));
      filter: blur(40px) saturate(120%);
      animation: swirl 28s linear infinite;
      pointer-events:none;
      mix-blend-mode: color-dodge;
    }
    @keyframes swirl{ to{ transform: rotate(360deg) } }

    /* Paper grain */
    .vx602 .film{
      position:absolute; inset:0; pointer-events:none; z-index:1;
      background-image: var(--noise);
      opacity: var(--grain);
      mix-blend-mode: multiply;
    }

    /* Masthead */
    .vx602 .mast{
      position:relative; z-index:3;
      display:flex; align-items:center; gap:14px; flex-wrap:wrap;
      background: var(--glass);
      border: 1px solid var(--edge);
      border-radius: 20px;
      padding: 12px;
      backdrop-filter: blur(14px) saturate(180%);
      -webkit-backdrop-filter: blur(14px) saturate(180%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.8), 0 18px 40px rgba(0,0,0,0.12);
    }
    .vx602 .mark{
      width:30px; height:30px; border-radius:8px; position:relative;
      background: conic-gradient(from 45deg, var(--a1), var(--a2), var(--a3), var(--a4), var(--a1));
      transform: rotate(45deg);
      box-shadow: 0 10px 28px rgba(120,140,255,0.35), inset 0 1px 0 rgba(255,255,255,0.9);
      animation: float 6s ease-in-out infinite;
    }
    .vx602 .mark::after{
      content:""; position:absolute; inset:6px; border-radius:6px; background:#fff; mix-blend-mode: screen; opacity:.7;
    }
    @keyframes float{ 0%,100%{ transform: rotate(45deg) translateY(0) } 50%{ transform: rotate(45deg) translateY(-4px) } }

    .vx602 .title .kicker{
      display:block; font-size:10px; letter-spacing:.18em; text-transform:uppercase; color: var(--muted);
      font-weight:800; margin-bottom:2px;
    }
    .vx602 h2{
      margin:0; line-height:1; font-weight:900; letter-spacing:-.02em;
      font-size: clamp(18px, 3.6vw, 28px);
      background: linear-gradient(90deg, var(--a1), var(--a2), var(--a3));
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .vx602 .right{ margin-left:auto; display:flex; align-items:center; gap:10px; }
    .vx602 .chip{
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
      font-size:11px; letter-spacing:.16em; text-transform:uppercase; font-weight:800;
      background:
        linear-gradient(#ffffff,#ffffff) padding-box,
        linear-gradient(135deg, var(--a1), var(--a2), var(--a3)) border-box;
      border:1px solid transparent;
      color: var(--ink);
      box-shadow: 0 12px 28px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.9);
    }
    .vx602 .themes{ display:flex; gap:8px; }
    .vx602 .sw{
      width:28px; height:28px; border-radius:9px; cursor:pointer; border:1px solid var(--edge);
      background: var(--bg);
      box-shadow: 0 8px 18px rgba(0,0,0,0.12), inset 0 1px 0 rgba(255,255,255,0.8);
      transition: transform 160ms ease, filter 240ms ease;
    }
    .vx602 .sw:hover{ transform: translateY(-2px) scale(1.04); filter: saturate(120%) }

    /* Hero */
    .vx602 .hero{
      position:relative; z-index:2; margin: 20px 12px 10px;
    }
    .vx602 .hero h1{
      margin:0;
      font-size: clamp(46px, 9.6vw, 116px);
      line-height:.86; letter-spacing:-.02em;
      color: var(--ink);
    }
    .vx602 .hero h1 .slide{
      background: linear-gradient(90deg, var(--ink), var(--a1), var(--a2), var(--a3), var(--ink));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      background-size: 200% 100%;
      animation: sweep 10s ease-in-out infinite;
    }
    @keyframes sweep{
      0%{ background-position: 0% 50% }
      50%{ background-position: 100% 50% }
      100%{ background-position: 0% 50% }
    }
    .vx602 .hero .sub{
      margin:12px 0 0; color: var(--muted); font-size: clamp(14px, 1.6vw, 18px);
    }

    /* Poster Stage */
    .vx602 .stage{
      position:relative; z-index:1; margin-top:18px; border-radius:22px; overflow:hidden;
      border:1px solid var(--edge);
      min-height: 540px;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255,255,255,0.9));
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.9), 0 24px 70px rgba(0,0,0,0.10);
    }
    .vx602 .stage::before{
      content:"";
      position:absolute; inset:-2px; border-radius:24px;
      background: radial-gradient(120% 100% at 70% -20%, rgba(var(--halo),0.08), transparent 60%),
                  radial-gradient(120% 120% at -10% 120%, rgba(255,190,220,0.12), transparent 60%);
      pointer-events:none;
    }
    .vx602 canvas{ display:block; width:100%; height:62vh; min-height:500px; }

    /* Dock */
    .vx602 .dock{
      position:relative; z-index:3; display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      margin: 18px 10px 8px;
    }
    .vx602 .knob{
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px; border-radius: 14px;
      background: var(--glass); border:1px solid var(--edge);
      color: var(--muted); font-size: 12px; font-weight: 800; letter-spacing:.08em; text-transform: uppercase;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.9), 0 12px 24px rgba(0,0,0,0.10);
    }
    .vx602 input[type="range"]{
      -webkit-appearance:none; appearance:none;
      width: 190px; height: 8px; border-radius: 999px; outline:none;
      background:
        linear-gradient(90deg, var(--a1), var(--a3)) no-repeat;
      border:1px solid var(--edge);
    }
    .vx602 input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none; appearance:none;
      width:18px; height:18px; border-radius:50%;
      background:#ffffff; border:2px solid var(--a1);
      box-shadow: 0 3px 10px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.9);
      cursor:pointer;
    }
    .vx602 input[type="range"]::-moz-range-thumb{
      width:18px; height:18px; border-radius:50%;
      background:#ffffff; border:2px solid var(--a1);
      box-shadow: 0 3px 10px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.9);
      cursor:pointer;
    }
    .vx602 .select{
      appearance:none; border:1px solid var(--edge); background: var(--glass);
      color: var(--ink); border-radius: 14px; padding: 10px 38px 10px 12px;
      font-weight:800; letter-spacing:.06em; text-transform:uppercase; font-size:12px;
      background-image: linear-gradient(135deg, var(--a1), var(--a2));
      background-clip: text; -webkit-text-fill-color: transparent;
    }
    .vx602 .btn{
      appearance:none; border:0; cursor:pointer; border-radius:999px;
      padding:10px 16px; font-weight:900; font-size:14px; letter-spacing:.04em; text-transform:uppercase;
      background: linear-gradient(90deg, var(--a2), var(--a3));
      color:#061225;
      box-shadow: 0 10px 24px rgba(0,0,0,0.10), inset 0 1px 0 rgba(255,255,255,0.95);
      transition: transform 160ms ease, filter 240ms ease, opacity 200ms ease;
    }
    .vx602 .btn:hover{ transform: translateY(-1px); filter: brightness(1.06) }
    .vx602 .btn.ghost{
      background: linear-gradient(#ffffff,#ffffff) padding-box,
                  linear-gradient(135deg, var(--a1), var(--a2)) border-box;
      border:1px solid transparent; color: var(--ink);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.9), 0 8px 22px rgba(0,0,0,0.08);
    }

    /* Meta */
    .vx602 .meta{
      margin-top: 12px; color: var(--muted); font-size: 12px;
      display:flex; align-items:center; gap:10px;
    }
    .vx602 .meta::before, .vx602 .meta::after{
      content:""; flex:1; height:1px;
      background: linear-gradient(to right, transparent, rgba(0,0,0,0.18), transparent);
    }

    @media (max-width: 560px){
      .vx602{ padding:16px }
      .vx602 canvas{ height:56vh; min-height:420px }
      .vx602 input[type="range"]{ width: 140px }
      .vx602 .select{ width: 140px }
      .vx602 .hero h1{ font-size: clamp(38px, 10vw, 92px) }
    }

    @media (prefers-color-scheme: dark){
      .vx602{
        --paper:#0e1224; --ink:#eaf0ff; --muted:#9eabc9; --glass: rgba(20,26,48,0.6);
        --edge: rgba(255,255,255,0.10);
        background:
          radial-gradient(140% 120% at 100% 0%, rgba(107,140,255,0.16), transparent 52%),
          radial-gradient(120% 120% at -10% 110%, rgba(255,160,200,0.16), transparent 58%),
          linear-gradient(180deg, #0c0f21, var(--paper));
      }
      .vx602 .btn.ghost{ background: linear-gradient(#0f1430,#0f1430) padding-box, linear-gradient(135deg, var(--a1), var(--a2)) border-box; -webkit-text-fill-color: initial; color: var(--ink); }
      .vx602 .chip{ background: linear-gradient(#0f1430,#0f1430) padding-box, linear-gradient(135deg, var(--a1), var(--a2), var(--a3)) border-box; color: var(--ink); }
    }
  </style>

  <div class="film" aria-hidden="true"></div>

  <div class="mast" role="toolbar" aria-label="Poster controls">
    <div class="brand" style="display:flex; align-items:center; gap:12px;">
      <div class="mark" aria-hidden="true"></div>
      <div class="title">
        <span class="kicker">Living Poster</span>
        <h2>Vellum Foundry</h2>
      </div>
    </div>
    <div class="right">
      <div class="themes" role="group" aria-label="Themes">
        <button class="sw theme" data-theme="day" aria-label="Day" style="--bg: linear-gradient(135deg,#ffffff,#eef3ff)"></button>
        <button class="sw theme" data-theme="dawn" aria-label="Dawn" style="--bg: linear-gradient(135deg,#fff1f5,#f0f7ff)"></button>
        <button class="sw theme" data-theme="noir" aria-label="Noir" style="--bg: linear-gradient(135deg,#0e1224,#0e1224)"></button>
        <button class="sw theme" data-theme="citrus" aria-label="Citrus" style="--bg: radial-gradient(circle at 30% 30%, #ffd06e, #20d6c6)"></button>
      </div>
      <span class="chip">Iteration 602</span>
    </div>
  </div>

  <div class="hero">
    <h1><span class="slide">Make motion feel like paper.</span></h1>
    <p class="sub">Drag to steer ink. Tap to bloom color. Press Space to pause.</p>
  </div>

  <div class="stage" aria-hidden="true">
    <canvas id="vx602-canvas"></canvas>
  </div>

  <div class="dock">
    <label class="knob" for="vx602-density">
      Density
      <input id="vx602-density" type="range" min="200" max="2400" step="50" value="1200" aria-label="Particle density">
    </label>
    <label class="knob" for="vx602-flow">
      Flow
      <input id="vx602-flow" type="range" min="0.2" max="2.2" step="0.01" value="1.1" aria-label="Flow speed">
    </label>
    <label class="knob" for="vx602-bloom">
      Bloom
      <input id="vx602-bloom" type="range" min="0" max="1" step="0.01" value="0.6" aria-label="Glow strength">
    </label>
    <label class="knob" for="vx602-grain">
      Grain
      <input id="vx602-grain" type="range" min="0" max="0.3" step="0.01" value="0.12" aria-label="Paper grain">
    </label>

    <select id="vx602-mode" class="select" aria-label="Pattern mode">
      <option value="ribbons" selected>Ribbons</option>
      <option value="halo">Halo</option>
      <option value="grid">Grid</option>
    </select>

    <button class="btn" id="vx602-toggle" aria-pressed="false" aria-label="Pause motion">Pause</button>
    <button class="btn ghost" id="vx602-shuffle" aria-label="Shuffle seeds">Shuffle</button>
  </div>

  <div class="meta">
    <span>Updated • <span id="last-updated">Last updated: 2025-11-13 00:18:18 EST</span> • Vellum breathes</span>
  </div>

  <script>
    (function(){
      const root = document.querySelector('.vx602');
      const canvas = root.querySelector('#vx602-canvas');
      const ctx = canvas.getContext('2d', { alpha: true });

      const densityEl = root.querySelector('#vx602-density');
      const flowEl = root.querySelector('#vx602-flow');
      const bloomEl = root.querySelector('#vx602-bloom');
      const grainEl = root.querySelector('#vx602-grain');
      const modeEl = root.querySelector('#vx602-mode');
      const toggleBtn = root.querySelector('#vx602-toggle');
      const shuffleBtn = root.querySelector('#vx602-shuffle');
      const themeBtns = [...root.querySelectorAll('.theme')];
      const film = root.querySelector('.film');
      const stamp = root.querySelector('#last-updated');

      function fmt(d){
        try{
          return d.toLocaleString(undefined,{year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'});
        }catch(e){ return d.toISOString(); }
      }
      stamp.textContent = fmt(new Date());

      // Themes
      const themes = {
        day:   { ink:'#0a0f1f', muted:'#5b667f', a1:'#6b8cff', a2:'#ff7ab6', a3:'#20d6c6', a4:'#ffd06e', paper:'#f7f9ff', halo:[32,40,74] },
        dawn:  { ink:'#0b1224', muted:'#5f6b87', a1:'#7b8cff', a2:'#ff7aa8', a3:'#29d0c0', a4:'#ffbe7a', paper:'#fbfdff', halo:[80,52,84] },
        noir:  { ink:'#eaf0ff', muted:'#aab3d8', a1:'#cfd8ff', a2:'#cfd8ff', a3:'#cfd8ff', a4:'#ffffff', paper:'#0e1224', halo:[180,190,230] },
        citrus:{ ink:'#0b1224', muted:'#51606a', a1:'#20d6c6', a2:'#ffd06e', a3:'#6b8cff', a4:'#ff7ab6', paper:'#fefdf7', halo:[210,180,60] }
      };
      function applyTheme(key){
        const t = themes[key] || themes.day;
        root.style.setProperty('--ink', t.ink);
        root.style.setProperty('--muted', t.muted);
        root.style.setProperty('--a1', t.a1);
        root.style.setProperty('--a2', t.a2);
        root.style.setProperty('--a3', t.a3);
        root.style.setProperty('--a4', t.a4);
        root.style.setProperty('--paper', t.paper);
        root.style.setProperty('--halo', t.halo.join(','));
        palette = [t.a1, t.a2, t.a3, t.a4];
      }
      // Seed theme by time
      const hr = new Date().getHours();
      applyTheme(hr >= 7 && hr < 18 ? 'day' : 'noir');
      themeBtns.forEach(b => b.addEventListener('click', ()=>{ applyTheme(b.dataset.theme); pulse(b); }));

      // Noise texture
      function makeNoiseURL(size=80){
        const n = document.createElement('canvas');
        n.width = n.height = size;
        const cx = n.getContext('2d');
        const id = cx.createImageData(size,size);
        for(let i=0;i<id.data.length;i+=4){
          const v = Math.floor(Math.random()*255);
          id.data[i]=id.data[i+1]=id.data[i+2]=v;
          id.data[i+3]=50;
        }
        cx.putImageData(id,0,0);
        return `url(${n.toDataURL()})`;
      }
      root.style.setProperty('--noise', makeNoiseURL());
      root.style.setProperty('--grain', grainEl.value);

      // Canvas sizing
      function resize(){
        const dpr = Math.max(1, window.devicePixelRatio || 1);
        const rect = canvas.getBoundingClientRect();
        const w = Math.max(640, rect.width);
        const h = Math.max(480, rect.height);
        canvas.width = Math.floor(w * dpr);
        canvas.height = Math.floor(h * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        W = w; H = h;
      }
      let W = 0, H = 0;
      resize();
      window.addEventListener('resize', resize);

      // State
      let t = 0;
      let seeds = newSeeds();
      let palette = [css('--a1'), css('--a2'), css('--a3'), css('--a4')];
      let P = [];
      let pointer = { x: 0, y: 0, active: false };

      function css(name){ return getComputedStyle(root).getPropertyValue(name).trim(); }
      function paused(){ return root.dataset.paused === 'true'; }
      function setPaused(v){
        root.dataset.paused = v ? 'true' : 'false';
        toggleBtn.textContent = v ? 'Resume' : 'Pause';
        toggleBtn.setAttribute('aria-pressed', String(v));
      }
      toggleBtn.addEventListener('click', ()=> setPaused(!paused()));
      shuffleBtn.addEventListener('click', ()=>{ seeds = newSeeds(); resetParticles(); pulse(shuffleBtn); });

      // Pointer interactions
      function toLocal(e){
        const r = canvas.getBoundingClientRect();
        return { x: e.clientX - r.left, y: e.clientY - r.top };
      }
      root.addEventListener('pointermove', (e)=>{
        const p = toLocal(e);
        pointer = { x: p.x, y: p.y, active: true };
      });
      root.addEventListener('pointerleave', ()=>{ pointer.active = false; });
      root.addEventListener('pointerdown', (e)=>{
        const p = toLocal(e);
        burst(p.x, p.y);
        pulse(canvas);
      });
      window.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); setPaused(!paused()); } });

      if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) setPaused(true);

      // Particles
      function newSeeds(){
        const s = [];
        for(let i=0;i<6;i++) s.push(Math.random()*1000);
        return s;
      }
      function resetParticles(){
        const N = clamp(parseInt(densityEl.value,10), 200, 4000);
        P = [];
        for(let i=0;i<N;i++){
          P.push({
            x: Math.random()*W,
            y: Math.random()*H,
            px: null, py: null,
            hue: palette[i % palette.length],
            life: 0.2 + Math.random()*0.8,
            speed: 0.4 + Math.random()*0.8
          });
        }
      }
      function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
      resetParticles();

      // Utilities
      const lerp = (a,b,u)=> a + (b-a)*u;
      function colorA(hex, a){
        const h = hex.replace('#','');
        const full = h.length===3 ? h.split('').map(c=>c+c).join('') : h;
        const r = parseInt(full.slice(0,2),16);
        const g = parseInt(full.slice(2,4),16);
        const b = parseInt(full.slice(4,6),16);
        return `rgba(${r},${g},${b},${a})`;
      }

      // Field
      function field(x,y,time, mode){
        const s0 = seeds[0], s1 = seeds[1], s2 = seeds[2], s3 = seeds[3];
        const nx = (x/W - 0.5), ny = (y/H - 0.5);
        const sp = parseFloat(flowEl.value||'1.0');

        if(mode === 'halo'){
          const cx = W*0.5 + Math.sin(time*0.0005+s2)*W*0.08;
          const cy = H*0.5 + Math.cos(time*0.0006+s3)*H*0.08;
          const dx = x - cx, dy = y - cy;
          const ang = Math.atan2(dy, dx) + Math.sin(s0 + (dx*dy)*0.000004 + time*0.0008)*0.8;
          return [Math.cos(ang)*sp, Math.sin(ang)*sp];
        }
        if(mode === 'grid'){
          const ang = Math.sin(s0 + x*0.012 + time*0.002) + Math.cos(s1 + y*0.012 - time*0.002);
          return [Math.cos(ang)*sp, Math.sin(ang)*sp];
        }
        // ribbons
        const ang = Math.sin(nx*6 + time*0.0016 + s0) + Math.cos(ny*8 - time*0.0012 + s1) + Math.sin((nx+ny)*4 + s2);
        return [Math.cos(ang)*sp, Math.sin(ang)*sp];
      }

      function burst(x,y){
        for(let i=0;i<80;i++){
          const p = P[(Math.random()*P.length)|0];
          p.x = x + (Math.random()-0.5)*40;
          p.y = y + (Math.random()-0.5)*40;
          p.px = null; p.py = null;
          p.life = 1.0;
        }
      }

      // Draw
      function draw(){
        const mode = modeEl.value;
        const bloom = parseFloat(bloomEl.value||'0.6');
        // paper fade
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = `rgba(255,255,255,${lerp(0.04, 0.12, 1-bloom)})`;
        if(getComputedStyle(root).getPropertyValue('--paper').trim().startsWith('#0')){ // dark mode-like paper
          ctx.fillStyle = `rgba(15,18,36,${lerp(0.06, 0.18, 1-bloom)})`;
        }
        ctx.fillRect(0,0,W,H);

        if(!paused()) t += 16;

        ctx.globalCompositeOperation = 'lighter';
        ctx.lineCap = 'round';

        for(let i=0;i<P.length;i++){
          const p = P[i];
          const oldx = p.x, oldy = p.y;

          const v = field(p.x, p.y, t, mode);
          let dx = v[0]* (0.6 + p.speed);
          let dy = v[1]* (0.6 + p.speed);

          if(pointer.active){
            const ax = pointer.x - p.x;
            const ay = pointer.y - p.y;
            const d2 = ax*ax + ay*ay + 1e-6;
            const att = Math.min(2.0, 60.0 / Math.sqrt(d2));
            dx += ax * 0.0009 * att;
            dy += ay * 0.0009 * att;
          }

          p.x += dx; p.y += dy;
          if(p.x<0||p.x>W||p.y<0||p.y>H){
            p.x = (p.x+W)%W; p.y=(p.y+H)%H; p.px=null; p.py=null;
          }

          const lw = 0.4 + bloom*1.6;
          ctx.lineWidth = lw;
          ctx.shadowColor = p.hue;
          ctx.shadowBlur = 10 + bloom*36;
          ctx.strokeStyle = colorA(p.hue, 0.18 + bloom*0.32);

          if(p.px!=null){
            ctx.beginPath();
            ctx.moveTo(p.px, p.py);
            ctx.lineTo(p.x, p.y);
            ctx.stroke();

            // highlight pass
            ctx.shadowBlur = 0;
            ctx.globalAlpha = 0.08 + bloom*0.08;
            ctx.strokeStyle = colorA('#ffffff', 0.9);
            ctx.stroke();
            ctx.globalAlpha = 1;
          }
          p.px = p.x; p.py = p.y;
        }

        requestAnimationFrame(draw);
      }
      requestAnimationFrame(draw);

      // UI bindings
      densityEl.addEventListener('change', ()=>{ resetParticles(); pulse(densityEl); });
      flowEl.addEventListener('input', ()=>{});
      bloomEl.addEventListener('input', ()=>{});
      grainEl.addEventListener('input', ()=>{ root.style.setProperty('--grain', grainEl.value); });

      function pulse(el){
        el.style.transform += ' scale(0.97)';
        el.style.opacity = '0.95';
        setTimeout(()=>{ el.style.transform = el.style.transform.replace(' scale(0.97)',''); el.style.opacity=''; }, 140);
      }
    })();
  </script>
</section>
      </section>
      <!-- END_EDITABLE -->
    <script>
      // Only show a local placeholder if the agent hasn't written a timestamp yet
      const el = document.getElementById('last-updated');
      if (el && (!el.textContent || el.textContent.includes('not yet'))) {
        const now = new Date();
        el.textContent = `Last updated: ${now.toLocaleString(undefined, { hour12: false })}`;
      }
    </script>
  </body>
  </html>


