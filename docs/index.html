<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vibing</title>
    <style>
      :root {
        --bg: #0f1221;
        --fg: #e6e8f0;
        --muted: #9aa3b2;
        --accent: #8b5cf6;
      }
      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--fg);
        background: radial-gradient(1200px 800px at 70% 10%, #1b1f3a, var(--bg));
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        width: min(720px, 92vw);
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px;
        padding: 28px 24px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        backdrop-filter: blur(6px);
      }
      h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
        letter-spacing: 0.3px;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 18px;
      }
      #content {
        font-size: 18px;
        line-height: 1.6;
        background: rgba(255,255,255,0.04);
        border: 1px dashed rgba(255,255,255,0.12);
        border-radius: 12px;
        padding: 16px;
      }
      .footer {
        margin-top: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: var(--muted);
      }
      .badge {
        display: inline-block;
        background: rgba(139, 92, 246, 0.18);
        color: #d4c2ff;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(139, 92, 246, 0.35);
        letter-spacing: 0.2px;
      }
    </style>
  </head>
  <body>
    <!-- BEGIN_EDITABLE -->
      <section id="content">
<section id="loom2261" data-theme="light" aria-label="Orbital Sketch â€” Edition 2261">
  <style>
    /* Design tokens */
    #loom2261{
      --r: 28px;
      --pad: clamp(18px, 5vw, 56px);
      --ink: #0f1424;
      --muted: color-mix(in hsl, var(--ink) 58%, transparent);
      --bg-1: #f7fafc;
      --bg-2: #eef5ff;
      --edge: rgba(0,0,0,0.12);
      --glass: 255,255,255;
      --a1: 28 92% 56%;
      --a2: 212 92% 60%;
      --a3: 266 84% 62%;
      --shadow: 0 40px 120px rgba(0,0,0,.18);
      position: relative; isolation: isolate;
      border-radius: var(--r);
      padding: var(--pad);
      color: var(--ink);
      background:
        radial-gradient(140% 100% at 10% 0%, hsl(var(--a1) / .14), transparent 50%),
        radial-gradient(140% 100% at 90% 100%, hsl(var(--a2) / .18), transparent 55%),
        linear-gradient(180deg, var(--bg-1), var(--bg-2));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.85), var(--shadow);
      font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, system-ui;
      color-scheme: light;
      overflow: clip;
    }
    #loom2261[data-theme="dark"]{
      --ink: #eaf2ff;
      --muted: color-mix(in hsl, var(--ink) 62%, transparent);
      --bg-1: #0a0e16;
      --bg-2: #0e1624;
      --edge: rgba(255,255,255,0.14);
      color-scheme: dark;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06), var(--shadow);
      background:
        radial-gradient(140% 100% at 10% 0%, hsl(var(--a1) / .18), transparent 50%),
        radial-gradient(140% 100% at 90% 100%, hsl(var(--a2) / .22), transparent 55%),
        linear-gradient(180deg, var(--bg-1), var(--bg-2));
    }

    /* Ambient sweep */
    #loom2261::before{
      content:""; position:absolute; inset:-20%;
      background:
        conic-gradient(from 0deg at 20% 30%, hsl(var(--a1) / .24), transparent 30% 55%, hsl(var(--a3) / .22), transparent 80%),
        conic-gradient(from 180deg at 80% 70%, hsl(var(--a2) / .20), transparent 45% 70%, hsl(var(--a1) / .16));
      filter: blur(42px) saturate(120%);
      mix-blend-mode: overlay; pointer-events:none;
      animation: sweep2261 70s linear infinite;
      opacity:.38;
    }
    @keyframes sweep2261 { to{ transform: rotate(360deg); } }

    /* Header */
    #loom2261 .top{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      margin-bottom: clamp(12px, 3vw, 24px); position:relative; z-index:2;
    }
    #loom2261 .crest{
      display:flex; align-items:center; gap:14px;
      padding:12px 16px; border-radius:999px; font-weight:900; letter-spacing:.01em;
      background: rgba(var(--glass), .70);
      backdrop-filter: blur(8px) saturate(160%);
      box-shadow: inset 0 0 0 1px var(--edge), 0 14px 36px rgba(0,0,0,.10);
    }
    #loom2261 .mark{
      width:28px; height:28px; border-radius:50%; position:relative; overflow:hidden; display:grid; place-items:center;
      background: radial-gradient(18px 18px at 30% 30%, hsl(var(--a1)), transparent 60%);
      box-shadow: 0 0 0 10px color-mix(in hsl, hsl(var(--a2) / 26%), transparent);
      isolation:isolate;
    }
    #loom2261 .mark::after{
      content:""; width:70%; height:70%; border-radius:50%;
      background: conic-gradient(from 0deg, hsl(var(--a1)), hsl(var(--a2)), hsl(var(--a3)), hsl(var(--a1)));
      filter: blur(2px); mix-blend-mode: screen; animation: orb2261 4s ease-in-out infinite;
    }
    @keyframes orb2261 { 50%{ transform: scale(1.08) rotate(20deg); } }
    #loom2261 .ed{ opacity:.6; font-weight:800; font-size:12px; letter-spacing:.16em; text-transform:uppercase; margin-left:6px; }

    #loom2261 .actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    #loom2261 .chip, #loom2261 .btn{
      appearance:none; border:0; cursor:pointer;
      font-weight:850; font-size:14px; letter-spacing:.02em;
      padding:11px 15px; border-radius:14px;
      background: rgba(var(--glass), .70); color: var(--ink);
      box-shadow: inset 0 0 0 1px var(--edge), 0 12px 28px rgba(0,0,0,.08);
      backdrop-filter: blur(8px) saturate(160%);
      transition: transform .14s ease, background .25s ease;
    }
    #loom2261 .chip:hover, #loom2261 .btn:hover{ transform: translateY(-1px); }

    /* Hero */
    #loom2261 .hero{ position:relative; z-index:2; display:grid; gap:10px; margin-bottom: clamp(8px, 3.6vw, 20px); }
    #loom2261 h1{
      margin:0; line-height:.9; letter-spacing:-0.02em; font-weight:1000;
      font-size: clamp(52px, 9.2vw, 132px);
      color: transparent;
      background: linear-gradient(120deg, hsl(var(--a1)), hsl(var(--a2)), hsl(var(--a3)));
      background-size: 220% 220%;
      -webkit-background-clip:text; background-clip:text;
      animation: hue2261 18s ease-in-out infinite;
      filter: drop-shadow(0 8px 24px rgba(0,0,0,.18));
      text-wrap: balance;
    }
    #loom2261 .lede{ margin:0; color: var(--muted); font-size: clamp(14px, 2.1vw, 18px); text-wrap: pretty; }
    @keyframes hue2261 { 50%{ background-position: 100% 0%; } }

    /* Stage */
    #loom2261 .stage{
      --w: min(96vw, 1180px);
      width: var(--w); aspect-ratio: 21/9; margin: clamp(10px, 3vw, 22px) auto;
      border-radius: 36px; position:relative; z-index:2; overflow:hidden;
      display:grid; place-items:center; cursor: crosshair;
      background:
        radial-gradient(100% 80% at 50% 0%, rgba(255,255,255,.9), transparent 70%),
        linear-gradient(180deg, color-mix(in hsl, hsl(var(--a1) / 8%), transparent), transparent 60%);
      box-shadow:
        inset 0 0 0 1px var(--edge),
        inset 0 0 160px rgba(255,255,255,0.24),
        0 40px 120px rgba(0,0,0,.18);
      transform-style: preserve-3d; transition: transform 160ms ease;
    }
    #loom2261 canvas{ width:100%; height:100%; display:block; }
    #loom2261 .rim{
      position:absolute; inset:-1px; border-radius:inherit; pointer-events:none;
      background:
        radial-gradient(100% 100% at 50% 0%, hsl(var(--a1) / .35), transparent 60%),
        radial-gradient(100% 100% at 0% 100%, hsl(var(--a2) / .35), transparent 60%),
        radial-gradient(100% 100% at 100% 100%, hsl(var(--a3) / .35), transparent 60%);
      mask: radial-gradient(90% 80% at 50% 50%, #000 60%, transparent);
      opacity:.55;
    }
    #loom2261 .texture{
      position:absolute; inset:0; pointer-events:none;
      background:
        repeating-linear-gradient(0deg, rgba(0,0,0,.06) 0 1px, transparent 1px 3px),
        radial-gradient(120% 80% at 50% 50%, transparent 65%, rgba(0,0,0,.12));
      mix-blend-mode: soft-light; opacity:.10;
      animation: tex2261 22s linear infinite;
    }
    @keyframes tex2261 { to{ background-position: 0 240px, 0 0; } }

    /* Dock */
    #loom2261 .dock{
      display:flex; flex-wrap:wrap; align-items:center; justify-content:center;
      gap: 12px 14px; margin: clamp(16px, 3.2vw, 28px) auto 0; position:relative; z-index:2;
    }
    #loom2261 .seg{ display:inline-flex; padding:4px; border-radius:14px; background: rgba(var(--glass), .70);
      box-shadow: inset 0 0 0 1px var(--edge); backdrop-filter: blur(8px) saturate(160%); }
    #loom2261 .sw{
      border:0; background:transparent; color: var(--ink); font-weight:900; font-size:13px; padding:8px 12px; border-radius:12px; cursor:pointer;
      display:inline-flex; align-items:center; gap:8px; transition: background .2s ease, transform .16s ease;
    }
    #loom2261 .sw[aria-pressed="true"]{ background: color-mix(in hsl, hsl(var(--a2) / 18%), transparent); box-shadow: inset 0 0 0 1px var(--edge); }
    #loom2261 .dot{ width:12px; height:12px; border-radius:50%;
      background: conic-gradient(from 0deg, hsl(var(--a1)), hsl(var(--a2)), hsl(var(--a3)), hsl(var(--a1)));
      box-shadow: 0 0 0 3px color-mix(in hsl, hsl(var(--a1) / 30%), transparent);
    }

    #loom2261 .group{
      display:inline-flex; align-items:center; gap:10px;
      padding: 8px 10px; border-radius:14px; font-weight:800; font-size:14px;
      color: var(--muted); background: rgba(var(--glass), .70);
      box-shadow: inset 0 0 0 1px var(--edge); backdrop-filter: blur(8px) saturate(160%);
    }
    #loom2261 input[type="range"]{
      -webkit-appearance:none; appearance:none; width:min(44vw, 300px); height:24px; background:transparent; cursor:pointer;
    }
    #loom2261 input[type="range"]::-webkit-slider-runnable-track,
    #loom2261 input[type="range"]::-moz-range-track{
      height:6px; border-radius:999px;
      background: linear-gradient(90deg, hsl(var(--a1)), hsl(var(--a2)), hsl(var(--a3)));
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.18);
    }
    #loom2261 input[type="range"]::-webkit-slider-thumb,
    #loom2261 input[type="range"]::-moz-range-thumb{
      width:18px; height:18px; border-radius:50%;
      background: #fff; border:2px solid hsl(var(--a2));
      box-shadow: 0 4px 12px rgba(0,0,0,0.22);
      -webkit-appearance:none; appearance:none; margin-top:-6px;
    }

    /* Footer meta */
    #loom2261 .meta{
      display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:12px;
      margin-top: clamp(18px, 3.6vw, 26px);
      padding-top: 14px; border-top: 1px solid var(--edge);
      color: var(--muted); font-size:12.5px; position:relative; z-index:2;
    }
    #loom2261 .live{ display:inline-flex; align-items:center; gap:8px; }
    #loom2261 .pulse{
      width:9px; height:9px; border-radius:50%;
      background: hsl(var(--a1));
      box-shadow: 0 0 0 0 color-mix(in hsl, hsl(var(--a1) / 55%), transparent);
      animation: pulse2261 2s ease-out infinite;
    }
    @keyframes pulse2261{ 0%{ box-shadow: 0 0 0 0 color-mix(in hsl, hsl(var(--a1) / 55%), transparent);} 100%{ box-shadow: 0 0 0 14px transparent;} }

    /* Motion safety */
    @media (prefers-reduced-motion: reduce){
      #loom2261 *{ animation: none !important; transition: none !important; }
    }
  </style>

  <div class="top">
    <div class="crest">
      <span class="mark" aria-hidden="true"></span>
      Orbital Sketch
      <span class="ed">Edition 2261</span>
    </div>
    <div class="actions">
      <button id="theme2261" class="chip" aria-pressed="false" title="Toggle light/dark">Light</button>
      <button id="shot2261" class="chip" title="Save snapshot">Capture</button>
      <button id="auto2261" class="chip" aria-pressed="true" title="Auto choreography">Auto</button>
      <button id="clear2261" class="chip" title="Clear orbits">Clear</button>
      <button id="pause2261" class="btn" aria-pressed="false">Pause</button>
    </div>
  </div>

  <div class="hero">
    <h1>Trace gravity with light</h1>
    <p class="lede">Click to launch. Drag to sling. Orbits weave into luminous calligraphy.</p>
  </div>

  <div class="stage" id="stage2261" aria-label="Interactive orbital sketchpad">
    <canvas id="sky2261" role="img" aria-label="Glowing orbital trails on a celestial field"></canvas>
    <div class="rim" aria-hidden="true"></div>
    <div class="texture" aria-hidden="true"></div>
  </div>

  <div class="dock" aria-label="Controls">
    <div class="seg" role="tablist" aria-label="Palette">
      <button class="sw" id="dawn2261" role="tab" aria-pressed="true"><span class="dot" aria-hidden="true" style="background: conic-gradient(from 0deg, hsl(28 92% 56%), hsl(10 86% 58%), hsl(46 92% 60%), hsl(28 92% 56%)); box-shadow: 0 0 0 3px color-mix(in hsl, hsl(28 92% 56% / 30%), transparent);"></span>Dawn</button>
      <button class="sw" id="dusk2261" role="tab" aria-pressed="false"><span class="dot" aria-hidden="true" style="background: conic-gradient(from 0deg, hsl(268 82% 64%), hsl(228 88% 64%), hsl(198 88% 60%), hsl(268 82% 64%)); box-shadow: 0 0 0 3px color-mix(in hsl, hsl(268 82% 64% / 30%), transparent);"></span>Dusk</button>
      <button class="sw" id="flora2261" role="tab" aria-pressed="false"><span class="dot" aria-hidden="true" style="background: conic-gradient(from 0deg, hsl(144 72% 56%), hsl(176 72% 58%), hsl(92 72% 58%), hsl(144 72% 56%)); box-shadow: 0 0 0 3px color-mix(in hsl, hsl(144 72% 56% / 30%), transparent);"></span>Flora</button>
      <button class="sw" id="mono2261" role="tab" aria-pressed="false"><span class="dot" aria-hidden="true" style="background: conic-gradient(from 0deg, hsl(0 0% 98%), hsl(0 0% 70%), hsl(0 0% 40%), hsl(0 0% 98%)); box-shadow: 0 0 0 3px color-mix(in hsl, hsl(0 0% 70% / 30%), transparent);"></span>Mono</button>
    </div>

    <div class="group" aria-label="Gravity">
      Gravity
      <input id="grav2261" type="range" min="10" max="140" value="70" aria-valuemin="10" aria-valuemax="140" aria-valuenow="70" aria-label="Gravity strength">
    </div>
    <div class="group" aria-label="Bodies">
      Bodies
      <input id="bodies2261" type="range" min="2" max="24" value="9" aria-valuemin="2" aria-valuemax="24" aria-valuenow="9" aria-label="Body count">
    </div>
    <div class="group" aria-label="Trails">
      Trails
      <input id="trail2261" type="range" min="20" max="220" value="120" aria-valuemin="20" aria-valuemax="220" aria-valuenow="120" aria-label="Trail length">
    </div>
  </div>

  <div class="meta">
    <div class="live"><span class="pulse" aria-hidden="true"></span> Planetarium is live</div>
    <span id="last-updated">Last updated: 2026-01-28 20:53:28 EST</span>
  </div>

  <script>
    (function(){
      const root = document.getElementById('loom2261');
      const stage = document.getElementById('stage2261');
      const canvas = document.getElementById('sky2261');
      const ctx = canvas.getContext('2d', { alpha: true });

      const themeBtn = document.getElementById('theme2261');
      const shotBtn = document.getElementById('shot2261');
      const autoBtn = document.getElementById('auto2261');
      const clearBtn = document.getElementById('clear2261');
      const pauseBtn = document.getElementById('pause2261');

      const palDawn = document.getElementById('dawn2261');
      const palDusk = document.getElementById('dusk2261');
      const palFlora = document.getElementById('flora2261');
      const palMono = document.getElementById('mono2261');

      const gravEl = document.getElementById('grav2261');
      const bodiesEl = document.getElementById('bodies2261');
      const trailEl = document.getElementById('trail2261');

      // Last updated
      const updated = document.getElementById('last-updated');
      try{
        const now = new Date();
        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'local';
        const fmt = { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' };
        updated.textContent = `Updated ${now.toLocaleString(undefined, fmt)} (${tz})`;
      }catch(_){ updated.textContent = 'Updated just now'; }

      // Palettes
      const palettes = {
        dawn:  { accents: [[28,92,56],[10,86,58],[46,92,60]], hues:[28,10,46], glow:[28,86,60] },
        dusk:  { accents: [[268,82,64],[228,88,64],[198,88,60]], hues:[268,228,198], glow:[236,86,66] },
        flora: { accents: [[144,72,56],[176,72,58],[92,72,58]],  hues:[144,176,92], glow:[156,80,62] },
        mono:  { accents: [[0,0,90],[0,0,70],[0,0,40]],         hues:[0,0,0],       glow:[220,6,76] }
      };
      let current = palettes.dawn;

      function setAccents(a){
        root.style.setProperty('--a1', `${a[0][0]} ${a[0][1]}% ${a[0][2]}%`);
        root.style.setProperty('--a2', `${a[1][0]} ${a[1][1]}% ${a[1][2]}%`);
        root.style.setProperty('--a3', `${a[2][0]} ${a[2][1]}% ${a[2][2]}%`);
      }
      function applyPalette(p){
        current = p; setAccents(p.accents);
        [palDawn,palDusk,palFlora,palMono].forEach(b=>b.setAttribute('aria-pressed','false'));
        const map = new Map([[palDawn,palettes.dawn],[palDusk,palettes.dusk],[palFlora,palettes.flora],[palMono,palettes.mono]]);
        for(const [btn, pal] of map){ if(p===pal) btn.setAttribute('aria-pressed','true'); }
        seed = Math.random()*10000; recolorBodies();
      }
      palDawn.addEventListener('click', ()=>applyPalette(palettes.dawn));
      palDusk.addEventListener('click', ()=>applyPalette(palettes.dusk));
      palFlora.addEventListener('click', ()=>applyPalette(palettes.flora));
      palMono.addEventListener('click', ()=>applyPalette(palettes.mono));

      // State
      let G = (parseInt(gravEl.value,10)||70) / 10000; // gravity constant (small)
      let targetBodies = parseInt(bodiesEl.value,10)||9;
      let trailLen = parseInt(trailEl.value,10)||120;

      gravEl.addEventListener('input', e=>{ const v = parseInt(e.target.value,10)||70; G = v/10000; gravEl.setAttribute('aria-valuenow', String(v)); });
      bodiesEl.addEventListener('input', e=>{ targetBodies = Math.max(2, Math.min(24, parseInt(e.target.value,10)||9)); bodiesEl.setAttribute('aria-valuenow', String(targetBodies)); balanceBodies(); });
      trailEl.addEventListener('input', e=>{ trailLen = Math.max(20, Math.min(220, parseInt(e.target.value,10)||120)); trailEl.setAttribute('aria-valuenow', String(trailLen)); });

      // Resize & DPR
      let dpr = Math.min(2, window.devicePixelRatio || 1);
      function resize(){
        const r = stage.getBoundingClientRect();
        canvas.width = Math.max(2, Math.floor(r.width * dpr));
        canvas.height = Math.max(2, Math.floor(r.height * dpr));
        canvas.style.width = r.width + 'px';
        canvas.style.height = r.height + 'px';
        ctx.setTransform(1,0,0,1,0,0);
        ctx.scale(dpr, dpr);
        clear();
      }
      function clear(){
        const r = stage.getBoundingClientRect();
        const isLight = root.getAttribute('data-theme')==='light';
        ctx.globalCompositeOperation = 'source-over';
        ctx.globalAlpha = 1;
        ctx.fillStyle = isLight ? '#f7fafc' : '#0a0e16';
        ctx.fillRect(0,0,r.width,r.height);
      }
      resize();
      addEventListener('resize', ()=>{ dpr = Math.min(2, window.devicePixelRatio || 1); resize(); });

      // Theme
      themeBtn.addEventListener('click', ()=>{
        const next = root.getAttribute('data-theme')==='light' ? 'dark' : 'light';
        root.setAttribute('data-theme', next);
        themeBtn.textContent = next.charAt(0).toUpperCase() + next.slice(1);
        themeBtn.setAttribute('aria-pressed', next==='dark' ? 'true' : 'false');
        clear();
      });

      // Tilt and pointer
      let px=.5, py=.5, dragging=false;
      stage.addEventListener('pointermove', (e)=>{
        const r = stage.getBoundingClientRect();
        px = Math.min(1, Math.max(0, (e.clientX - r.left)/r.width));
        py = Math.min(1, Math.max(0, (e.clientY - r.top)/r.height));
        stage.style.transform = `rotateX(${-(py - 0.5)*6}deg) rotateY(${(px - 0.5)*8}deg)`;
        if(dragging){ launchPreview.x = (e.clientX - r.left); launchPreview.y = (e.clientY - r.top); }
      }, {passive:true});
      stage.addEventListener('pointerleave', ()=>{ stage.style.transform = 'rotateX(0deg) rotateY(0deg)'; dragging=false; launchPreview.active=false; });
      stage.addEventListener('pointerdown', (e)=>{
        dragging = true;
        const r = stage.getBoundingClientRect();
        launchPreview.active = true;
        launchPreview.x = (e.clientX - r.left);
        launchPreview.y = (e.clientY - r.top);
        launchPreview.vx = 0; launchPreview.vy = 0;
      });
      stage.addEventListener('pointerup', (e)=>{
        if(!dragging) return;
        const r = stage.getBoundingClientRect();
        const x = e.clientX - r.left, y = e.clientY - r.top;
        const cx = r.width/2, cy = r.height/2;
        // tangential launch relative to center
        const dx = x - cx, dy = y - cy;
        const dist = Math.hypot(dx,dy) || 1;
        const dirx = -dy / dist, diry = dx / dist; // tangential
        const speed = Math.min(3.6, 1.2 + dist*0.0022);
        addBody(x, y, dirx*speed, diry*speed);
        dragging = false;
        launchPreview.active=false;
      });

      // Bodies
      const bodies = [];
      const TWO = Math.PI*2;
      let seed = Math.random()*10000;
      function rnd(){ const x = Math.sin(seed+=0.12345)*43758.5453; return x-Math.floor(x); }
      function hsla(h,s,l,a){ return `hsla(${h}, ${s}%, ${l}%, ${a})`; }

      function paletteColor(i){
        const hues = current.hues.length ? current.hues : [0,0,0];
        const h = hues[i % hues.length];
        const s = current===palettes.mono ? 0 : 86;
        const l = 62 + (i%3)*6;
        return {h, s, l};
      }

      function recolorBodies(){
        for(let i=0;i<bodies.length;i++){
          const c = paletteColor(i);
          bodies[i].h = c.h; bodies[i].s = c.s; bodies[i].l = c.l;
        }
      }

      function addBody(x, y, vx, vy){
        const c = paletteColor(bodies.length);
        const r = 2 + Math.floor(rnd()*4);
        const m = r*r*0.6;
        bodies.push({ x, y, vx, vy, ax:0, ay:0, r, m, trail:[], h:c.h, s:c.s, l:c.l, glow: 14 + Math.floor(rnd()*28) });
      }

      function balanceBodies(){
        // add/remove to match targetBodies
        const r = stage.getBoundingClientRect();
        while(bodies.length < targetBodies){
          const ang = rnd()*TWO;
          const rad = (Math.min(r.width, r.height)*0.18) + rnd()*Math.min(r.width, r.height)*0.32;
          const x = r.width/2 + Math.cos(ang)*rad;
          const y = r.height/2 + Math.sin(ang)*rad;
          const tangX = -Math.sin(ang), tangY = Math.cos(ang);
          const speed = 1.2 + rnd()*2.2;
          addBody(x, y, tangX*speed, tangY*speed);
        }
        while(bodies.length > targetBodies){ bodies.shift(); }
        recolorBodies();
      }

      // Initialize a constellation
      balanceBodies();

      // Launch preview guide
      const launchPreview = { active:false, x:0, y:0, vx:0, vy:0 };

      // Simulation
      let paused = false;
      let auto = true;
      let t0 = performance.now();
      let autoTimer = 0;

      function step(now){
        if(paused) return;

        const w = canvas.clientWidth, h = canvas.clientHeight;
        ctx.globalCompositeOperation = 'source-over';
        const isLight = root.getAttribute('data-theme')==='light';
        ctx.fillStyle = isLight ? '#f7fafc' : '#0a0e16';
        ctx.fillRect(0,0,w,h);

        // subtle center glow
        const cg = ctx.createRadialGradient(w/2, h/2, Math.min(w,h)*0.08, w/2, h/2, Math.max(w,h)*0.7);
        if(isLight){
          cg.addColorStop(0, 'rgba(255,255,255,0.55)');
          cg.addColorStop(1, 'rgba(255,255,255,0)');
        }else{
          cg.addColorStop(0, 'rgba(255,255,255,0.12)');
          cg.addColorStop(1, 'rgba(0,0,0,0)');
        }
        ctx.fillStyle = cg; ctx.fillRect(0,0,w,h);

        const dt = Math.min(32, now - t0) * 0.016; // normalize to ~60fps
        const cx = w*0.5, cy = h*0.5;

        // auto choreography
        if(auto){
          autoTimer += dt;
          if(autoTimer > 1.6){
            autoTimer = 0;
            if(bodies.length < targetBodies) {
              const ang = rnd()*TWO;
              const rad = (Math.min(w,h)*0.2) + rnd()*Math.min(w,h)*0.32;
              const x = cx + Math.cos(ang)*rad, y = cy + Math.sin(ang)*rad;
              const tangX = -Math.sin(ang), tangY = Math.cos(ang);
              const speed = 1.2 + rnd()*2.0;
              addBody(x, y, tangX*speed, tangY*speed);
            } else if(Math.random()<0.25){
              // drift palette occasionally
              const keys = Object.keys(palettes);
              const next = palettes[keys[Math.floor(Math.random()*keys.length)]];
              applyPalette(next);
            }
          }
          // gentle G breathing
          const base = (parseInt(gravEl.value,10)||70)/10000;
          const mod = (Math.sin(now*0.0006)+1)/2 * 0.0006;
          G = base + mod;
        }

        // integrate
        for(let i=0;i<bodies.length;i++){
          const b = bodies[i];

          // center gravity
          const dx = cx - b.x, dy = cy - b.y;
          const dist2 = dx*dx + dy*dy + 50;
          const inv = 1/Math.sqrt(dist2);
          const ax = dx * G * inv;
          const ay = dy * G * inv;

          // mild drag
          b.vx += ax * dt;
          b.vy += ay * dt;
          b.vx *= 0.999;
          b.vy *= 0.999;

          b.x += b.vx;
          b.y += b.vy;

          // wrap edges
          if(b.x < -20) b.x = w+20; if(b.x > w+20) b.x = -20;
          if(b.y < -20) b.y = h+20; if(b.y > h+20) b.y = -20;

          // trail
          b.trail.push({x:b.x, y:b.y});
          if(b.trail.length > trailLen) b.trail.shift();
        }

        // draw trails
        ctx.globalCompositeOperation = 'lighter';
        for(let i=0;i<bodies.length;i++){
          const b = bodies[i];
          if(b.trail.length < 2) continue;

          const grad = ctx.createLinearGradient(b.trail[0].x, b.trail[0].y, b.x, b.y);
          const l1 = b.l, l2 = Math.min(90, b.l+18);
          grad.addColorStop(0, hsla(b.h, b.s, l1, 0.06));
          grad.addColorStop(1, hsla((b.h+36)%360, b.s, l2, 0.28));

          ctx.strokeStyle = grad;
          ctx.lineCap = 'round'; ctx.lineJoin = 'round';
          ctx.shadowColor = hsla(b.h, 90, 70, 0.35);
          ctx.shadowBlur = b.glow;
          ctx.lineWidth = 1.4 + (b.r*0.6);

          ctx.beginPath();
          ctx.moveTo(b.trail[0].x, b.trail[0].y);
          for(let k=1;k<b.trail.length-2;k++){
            const p = b.trail[k], n = b.trail[k+1];
            const xc = (p.x + n.x)/2, yc = (p.y + n.y)/2;
            ctx.quadraticCurveTo(p.x, p.y, xc, yc);
          }
          const p2 = b.trail[b.trail.length-2], p3 = b.trail[b.trail.length-1];
          ctx.quadraticCurveTo(p2.x, p2.y, p3.x, p3.y);
          ctx.stroke();

          // bodies
          ctx.shadowBlur = 0;
          ctx.fillStyle = hsla(b.h, b.s, Math.min(90, b.l+8), 0.95);
          ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, TWO); ctx.fill();
        }
        ctx.globalCompositeOperation = 'source-over';

        // launch guide
        if(launchPreview.active){
          ctx.setLineDash([6,6]);
          ctx.lineDashOffset = (now*0.06)%12;
          ctx.lineWidth = 1.5;
          ctx.strokeStyle = hsla(current.glow[0], current.glow[1], current.glow[2], 0.6);
          ctx.beginPath();
          ctx.moveTo(cx, cy); ctx.lineTo(launchPreview.x, launchPreview.y); ctx.stroke();
          ctx.setLineDash([]);
        }

        requestAnimationFrame(step);
        t0 = now;
      }

      function snapshotName(){
        return `orbital-sketch-2261.png`;
      }

      function rebuildAll(){
        clear();
        recolorBodies();
      }

      // Snapshot
      shotBtn.addEventListener('click', ()=>{
        try{
          const rect = stage.getBoundingClientRect();
          const tmp = document.createElement('canvas');
          const tctx = tmp.getContext('2d');
          const scale = Math.min(2, window.devicePixelRatio || 1);
          tmp.width = Math.floor(rect.width * scale);
          tmp.height = Math.floor(rect.height * scale);
          tctx.scale(scale, scale);

          // background
          const isLight = root.getAttribute('data-theme')==='light';
          tctx.fillStyle = isLight ? '#f7fafc' : '#0a0e16';
          tctx.fillRect(0,0,rect.width,rect.height);
          // draw current frame
          tctx.drawImage(canvas, 0, 0, rect.width, rect.height);
          const a = document.createElement('a');
          a.href = tmp.toDataURL('image/png');
          a.download = snapshotName();
          document.body.appendChild(a); a.click(); a.remove();
        }catch(_){}
      });

      // Pause/Resume
      pauseBtn.addEventListener('click', ()=>{
        paused = !paused;
        pauseBtn.textContent = paused ? 'Resume' : 'Pause';
        pauseBtn.setAttribute('aria-pressed', paused?'true':'false');
        if(!paused){ t0 = performance.now(); requestAnimationFrame(step); }
      });

      // Auto toggle
      autoBtn.addEventListener('click', ()=>{
        auto = !auto;
        autoBtn.setAttribute('aria-pressed', auto?'true':'false');
        autoBtn.textContent = auto ? 'Auto' : 'Manual';
      });

      // Clear
      clearBtn.addEventListener('click', ()=>{
        bodies.length = 0;
        clear();
      });

      // Keyboard
      window.addEventListener('keydown', (e)=>{
        const k = e.key.toLowerCase();
        if(e.code==='Space'){ e.preventDefault(); pauseBtn.click(); }
        if(k==='t') themeBtn.click();
        if(k==='s') shotBtn.click();
        if(k==='a') autoBtn.click();
        if(k==='c') clearBtn.click();
        if(k==='1') palDawn.click();
        if(k==='2') palDusk.click();
        if(k==='3') palFlora.click();
        if(k==='4') palMono.click();
      });

      // Start
      setAccents(current.accents);
      rebuildAll();
      requestAnimationFrame(step);

      // Respect reduced motion
      const prefersReduce = matchMedia('(prefers-reduced-motion: reduce)').matches;
      if(prefersReduce){
        for(let i=0;i<60;i++){ step(performance.now()+i*16); }
        paused = true; pauseBtn.textContent = 'Resume'; pauseBtn.setAttribute('aria-pressed','true');
        auto = false; autoBtn.setAttribute('aria-pressed','false'); autoBtn.textContent = 'Manual';
      }
    })();
  </script>
</section>
      </section>
      <!-- END_EDITABLE -->
    <script>
      // Only show a local placeholder if the agent hasn't written a timestamp yet
      const el = document.getElementById('last-updated');
      if (el && (!el.textContent || el.textContent.includes('not yet'))) {
        const now = new Date();
        el.textContent = `Last updated: ${now.toLocaleString(undefined, { hour12: false })}`;
      }
    </script>
  </body>
  </html>


