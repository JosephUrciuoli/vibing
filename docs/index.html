<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vibing</title>
    <style>
      :root {
        --bg: #0f1221;
        --fg: #e6e8f0;
        --muted: #9aa3b2;
        --accent: #8b5cf6;
      }
      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--fg);
        background: radial-gradient(1200px 800px at 70% 10%, #1b1f3a, var(--bg));
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        width: min(720px, 92vw);
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px;
        padding: 28px 24px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        backdrop-filter: blur(6px);
      }
      h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
        letter-spacing: 0.3px;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 18px;
      }
      #content {
        font-size: 18px;
        line-height: 1.6;
        background: rgba(255,255,255,0.04);
        border: 1px dashed rgba(255,255,255,0.12);
        border-radius: 12px;
        padding: 16px;
      }
      .footer {
        margin-top: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: var(--muted);
      }
      .badge {
        display: inline-block;
        background: rgba(139, 92, 246, 0.18);
        color: #d4c2ff;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(139, 92, 246, 0.35);
        letter-spacing: 0.2px;
      }
    </style>
  </head>
  <body>
    <!-- BEGIN_EDITABLE -->
      <section id="content">
<section id="prism805" aria-label="Prism Sails — Reactive Light Loom">
  <style>
    /* Prism Sails — Iteration 805 (aggressive shift: from kinetic garden to light loom) */
    #prism805 {
      --ink: #0e1220;
      --muted: #5d6b80;
      --line: rgba(0,0,0,0.12);
      --glass: rgba(255,255,255,0.55);
      --bg1: #f9fbff;
      --bg2: #f4f7ff;
      --h1: 208; /* azure */
      --h2: 296; /* violet */
      --h3: 24;  /* tangerine */
      position: relative;
      border-radius: 36px;
      padding: clamp(18px, 3.2vw, 36px);
      min-height: 900px;
      color: var(--ink);
      font-family: ui-rounded, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Inter, Roboto, "Helvetica Neue", Arial, "Noto Sans";
      background:
        radial-gradient(1200px 900px at 10% 0%, hsla(var(--h1), 85%, 70%, 0.12), transparent 60%),
        radial-gradient(1400px 1000px at 90% 100%, hsla(var(--h2), 85%, 70%, 0.14), transparent 60%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      box-shadow: 0 50px 160px rgba(12,20,40,0.16), inset 0 0 0 1px rgba(0,0,0,0.04);
      overflow: hidden;
      isolation: isolate;
    }

    /* Top: brand + actions */
    #prism805 .top {
      display: grid; grid-template-columns: auto 1fr auto; gap: 14px; align-items: center;
      margin-bottom: 6px; position: relative; z-index: 3;
    }
    #prism805 .brand {
      display: inline-flex; align-items: center; gap: 12px;
      padding: 10px 14px; border-radius: 999px;
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,0.75), rgba(255,255,255,0.45));
      -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.9);
      font-weight: 900; letter-spacing: 0.2px;
    }
    #prism805 .orb {
      --s: 34px; width: var(--s); height: var(--s); border-radius: 50%;
      background:
        radial-gradient(60% 60% at 30% 30%, rgba(255,255,255,0.95), transparent 60%),
        conic-gradient(from 0deg, hsl(var(--h1), 95%, 62%), hsl(var(--h2), 95%, 64%), hsl(var(--h3), 95%, 58%), hsl(var(--h1), 95%, 62%));
      box-shadow: 0 12px 24px rgba(0,0,0,0.16), 0 0 0 8px rgba(0,0,0,0.03);
      animation: prism805-orb 18s ease-in-out infinite alternate;
    }
    @keyframes prism805-orb { 
      0% { transform: rotate(0) scale(1); } 
      100% { transform: rotate(24deg) scale(1.06); }
    }

    #prism805 .actions { justify-self: end; display: inline-flex; gap: 10px; flex-wrap: wrap; }
    #prism805 .btn {
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,0.75), rgba(255,255,255,0.45));
      color: var(--ink);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 800; letter-spacing: 0.2px;
      display: inline-flex; align-items: center; gap: 10px;
      cursor: pointer;
      transition: transform 160ms ease, box-shadow 160ms ease, opacity 160ms ease, background 160ms ease;
      -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.9);
      will-change: transform;
    }
    #prism805 .btn:hover { transform: translateY(-2px); box-shadow: 0 16px 34px rgba(0,0,0,0.16); }
    #prism805 .btn.on { box-shadow: 0 14px 28px rgba(0,0,0,0.16), inset 0 0 0 1px rgba(255,255,255,1); transform: translateY(-2px); }
    #prism805 .dot { width: 10px; height: 10px; border-radius: 50%; background: hsl(calc(var(--h2) + 20), 85%, 58%); box-shadow: 0 0 10px hsl(calc(var(--h2) + 20), 80%, 58%); }

    /* Hero */
    #prism805 .hero { position: relative; z-index: 3; display: grid; gap: 6px; margin-bottom: 12px; }
    #prism805 h1 {
      margin: 0; line-height: 0.92; letter-spacing: -0.02em;
      font-size: clamp(42px, 10.8vw, 128px);
      background: linear-gradient(90deg, hsl(var(--h1), 18%, 20%), hsl(var(--h2), 22%, 26%));
      -webkit-background-clip: text; background-clip: text; color: transparent;
      text-wrap: balance;
    }
    #prism805 .sub { margin: 0; color: var(--muted); font-size: 14px; max-width: 80ch; }

    /* Stage */
    #prism805 .stage { position: relative; z-index: 2; display: grid; place-items: center; margin: 10px 0 16px; perspective: 1100px; }
    #prism805 .frame {
      width: min(92vw, 1100px);
      aspect-ratio: 16 / 9;
      border-radius: 26px;
      position: relative; overflow: hidden;
      border: 1px solid var(--line);
      background:
        radial-gradient(60% 60% at 30% 30%, rgba(255,255,255,0.6), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.05), transparent 30%);
      box-shadow: 0 40px 120px rgba(0,0,0,0.20), inset 0 0 0 1px rgba(255,255,255,0.45);
      transform-style: preserve-3d;
    }
    #prism805 canvas#sails805 {
      position: absolute; inset: 0; width: 100%; height: 100%; display: block; transform: translateZ(0);
      will-change: transform, filter; filter: saturate(1.06);
    }
    #prism805 .veil {
      pointer-events: none; position: absolute; inset: -10%;
      background:
        radial-gradient(420px 420px at 18% 24%, hsla(var(--h1), 95%, 70%, 0.16), transparent 65%),
        radial-gradient(440px 440px at 82% 72%, hsla(var(--h2), 95%, 70%, 0.16), transparent 65%),
        radial-gradient(380px 380px at 55% 10%, hsla(var(--h3), 95%, 60%, 0.14), transparent 65%);
      filter: blur(52px);
      z-index: 0;
      animation: prism805-veil 24s ease-in-out infinite alternate;
    }
    @keyframes prism805-veil {
      0% { transform: scale(1) translateY(-2%); opacity: 0.9; }
      100% { transform: scale(1.06) translateY(1.6%); opacity: 1; }
    }

    /* Console */
    #prism805 .console {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      padding: 10px;
      border-radius: 16px; border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,0.65), rgba(255,255,255,0.4));
      -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.9);
      color: var(--muted); font-size: 12px;
      position: relative; z-index: 3;
    }
    #prism805 .chip {
      border: 1px solid var(--line);
      border-radius: 14px; padding: 9px 12px;
      display: grid; gap: 6px;
      background: linear-gradient(180deg, rgba(255,255,255,0.8), rgba(255,255,255,0.5));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.9);
      min-width: 140px;
    }
    #prism805 .k { font-weight: 900; letter-spacing: -0.02em; color: var(--ink); font-size: 18px; display: inline-flex; align-items: center; gap: 8px; }
    #prism805 .swatch { width: 16px; height: 8px; border-radius: 999px; background: linear-gradient(90deg, hsl(var(--h1),85%,58%), hsl(var(--h2),85%,58%), hsl(var(--h3),85%,58%)); box-shadow: 0 0 0 1px rgba(0,0,0,0.08) inset; }
    #prism805 .range { appearance: none; width: 100%; height: 6px; border-radius: 999px; background: rgba(0,0,0,0.08); outline: none; }
    #prism805 .range::-webkit-slider-thumb { appearance: none; width: 16px; height: 16px; border-radius: 50%; background: hsl(var(--h1), 90%, 55%); box-shadow: 0 0 0 3px rgba(0,0,0,0.08); border: 1px solid var(--line); }
    #prism805 .range::-moz-range-thumb { width: 16px; height: 16px; border-radius: 50%; background: hsl(var(--h1), 90%, 55%); border: 1px solid var(--line); }

    /* Foot */
    #prism805 .foot {
      position: relative; z-index: 3;
      margin-top: 16px;
      display: grid; grid-template-columns: auto 1fr auto; gap: 12px; align-items: center;
      border: 1px solid var(--line); border-radius: 16px; padding: 10px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.65), rgba(255,255,255,0.4));
      color: var(--muted); font-size: 12px;
      -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.9);
    }

    /* Grain overlay */
    #prism805 .grain { position: absolute; inset: 0; opacity: 0.08; mix-blend-mode: soft-light; pointer-events: none; z-index: 1; }

    /* Modes */
    #prism805[data-tone="dark"] {
      --ink: #eef3ff;
      --muted: #9eb0c6;
      --glass: rgba(255,255,255,0.14);
      --line: rgba(255,255,255,0.16);
      box-shadow: 0 36px 110px rgba(12,20,40,0.34), inset 0 0 0 1px rgba(255,255,255,0.06);
    }
    #prism805[data-tone="dark"] h1 { background: linear-gradient(90deg, rgba(255,255,255,0.98), rgba(255,255,255,0.78)); -webkit-background-clip: text; background-clip: text; color: transparent; }
    #prism805[data-glow="on"] .frame { box-shadow: 0 60px 160px rgba(0,0,0,0.24), inset 0 0 0 1px rgba(255,255,255,0.7), 0 0 0 10px rgba(255,255,255,0.06); }
    #prism805[data-glow="on"] canvas#sails805 { filter: saturate(1.15) contrast(1.05); }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      #prism805 .orb { animation: none; }
      #prism805 .veil { animation: none; }
      #prism805 .btn:hover { transform: none; box-shadow: none; }
      #prism805 canvas#sails805 { transition: none !important; }
    }

    @media (max-width: 960px) {
      #prism805 .console { grid-template-columns: 1fr 1fr; }
      #prism805 .actions { gap: 8px; }
    }
    @media (max-width: 640px) {
      #prism805 .console { grid-template-columns: 1fr; }
    }
  </style>

  <div class="top">
    <div class="brand" aria-label="Prism Sails">
      <span class="orb" aria-hidden="true"></span>
      <span>Prism Sails</span>
    </div>
    <div></div>
    <div class="actions">
      <button type="button" class="btn theme" aria-label="Switch palette">
        <span class="dot" aria-hidden="true"></span> Theme
      </button>
      <button type="button" class="btn glow" aria-label="Toggle glow">
        <span class="dot" aria-hidden="true" style="background:hsl(calc(var(--h1) + 20), 90%, 60%); box-shadow:0 0 10px hsl(calc(var(--h1) + 20), 80%, 60%)"></span> Glow
      </button>
      <button type="button" class="btn add" aria-label="Add sail">
        <span class="dot" aria-hidden="true" style="background:hsl(calc(var(--h3) + 10), 90%, 55%); box-shadow:0 0 10px hsl(calc(var(--h3) + 10), 80%, 55%)"></span> + Sail
      </button>
      <button type="button" class="btn pause" aria-label="Pause motion">
        <span class="dot" aria-hidden="true" style="background:#9aa3b2; box-shadow:0 0 10px rgba(0,0,0,0.2)"></span> Pause
      </button>
      <button type="button" class="btn snap" aria-label="Download snapshot">
        <span class="dot" aria-hidden="true" style="background:#4ad6a7; box-shadow:0 0 10px rgba(74,214,167,0.8)"></span> Snapshot
      </button>
    </div>
  </div>

  <div class="hero">
    <h1>Weave the light.</h1>
    <p class="sub">A reactive loom of prisms and sails—drag your pointer to tilt the stage, change the palette, and let ribbons of color braid through space.</p>
  </div>

  <div class="stage" role="region" aria-label="Reactive light loom">
    <div class="frame">
      <div class="veil" aria-hidden="true"></div>
      <canvas id="sails805" aria-hidden="true"></canvas>
    </div>
  </div>

  <div class="console" aria-live="polite" aria-atomic="true">
    <div class="chip">
      <span>Sails</span>
      <span class="k"><span id="ps805-count">0</span></span>
    </div>
    <div class="chip">
      <span>Palette</span>
      <span class="k"><i class="swatch" aria-hidden="true"></i><span id="ps805-theme" style="margin-left:6px">—</span></span>
    </div>
    <div class="chip">
      <span>Wind</span>
      <input class="range" id="ps805-wind" type="range" min="0" max="100" value="60" aria-label="Wind strength">
    </div>
    <div class="chip">
      <span>Density</span>
      <input class="range" id="ps805-density" type="range" min="10" max="260" value="120" aria-label="Sail density">
    </div>
  </div>

  <div class="foot">
    <div style="display:inline-flex; align-items:center; gap:10px;">
      <span style="width:36px;height:36px;border-radius:50%;border:1px solid var(--line);box-shadow:inset 0 0 0 1px rgba(255,255,255,0.9);background:
        conic-gradient(from 0deg, hsl(var(--h1),90%,60%) var(--pct,0deg), rgba(0,0,0,0.12) var(--pct,0deg)); display:inline-block;" id="ps805-meter" aria-hidden="true"></span>
      <span>Pulse</span>
    </div>
    <div></div>
    <span id="last-updated" aria-live="polite"></span>
  </div>

  <!-- Grain overlay -->
  <svg class="grain" preserveAspectRatio="none" viewBox="0 0 100 100" aria-hidden="true">
    <filter id="pg805">
      <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" seed="37"></feTurbulence>
      <feColorMatrix type="saturate" values="0"></feColorMatrix>
    </filter>
    <rect width="100" height="100" filter="url(#pg805)"></rect>
  </svg>

  <script>
    (function () {
      const root = document.getElementById('prism805');
      const canvas = root.querySelector('#sails805');
      const ctx = canvas.getContext('2d');

      const btnTheme = root.querySelector('.btn.theme');
      const btnGlow = root.querySelector('.btn.glow');
      const btnAdd = root.querySelector('.btn.add');
      const btnPause = root.querySelector('.btn.pause');
      const btnSnap = root.querySelector('.btn.snap');

      const statCount = root.querySelector('#ps805-count');
      const statTheme = root.querySelector('#ps805-theme');
      const windInput = root.querySelector('#ps805-wind');
      const densityInput = root.querySelector('#ps805-density');
      const meter = root.querySelector('#ps805-meter');
      const lastEl = root.querySelector('#last-updated');

      let running = true;
      let glow = false;
      let mx = 0.5, my = 0.5;
      const reduceMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      // Palettes
      const palettes = [
        { name: 'Halo',     tone: 'light', bg1: '#f9fbff', bg2: '#f4f7ff', hues: [208, 296, 24]  },
        { name: 'Noir',     tone: 'dark',  bg1: '#0c0f1a', bg2: '#121829', hues: [205, 272, 338] },
        { name: 'Canyon',   tone: 'light', bg1: '#fff7f0', bg2: '#f5fbff', hues: [18, 340, 204]  },
        { name: 'Nebula',   tone: 'dark',  bg1: '#120d16', bg2: '#1a1f34', hues: [266, 196, 12]  },
        { name: 'Sea Glass',tone: 'light', bg1: '#f3fffb', bg2: '#ecf4ff', hues: [162, 196, 48]  }
      ];
      let palIndex = 0;

      function applyPalette(p) {
        root.style.setProperty('--bg1', p.bg1);
        root.style.setProperty('--bg2', p.bg2);
        root.style.setProperty('--h1', p.hues[0]);
        root.style.setProperty('--h2', p.hues[1]);
        root.style.setProperty('--h3', p.hues[2]);
        root.setAttribute('data-tone', p.tone);
        statTheme.textContent = p.name;
      }
      applyPalette(palettes[palIndex]);

      btnTheme.addEventListener('click', () => {
        palIndex = (palIndex + 1) % palettes.length;
        applyPalette(palettes[palIndex]);
      });

      btnGlow.addEventListener('click', () => {
        glow = !glow;
        btnGlow.classList.toggle('on', glow);
        root.setAttribute('data-glow', glow ? 'on' : 'off');
      });

      btnPause.addEventListener('click', () => {
        running = !running;
        btnPause.classList.toggle('on', running);
        if (running && !reduceMotion) requestAnimationFrame(tick);
      });

      btnSnap.addEventListener('click', () => {
        try {
          const link = document.createElement('a');
          link.download = 'prism-snapshot.png';
          link.href = canvas.toDataURL('image/png');
          link.click();
        } catch (e) {}
      });

      root.addEventListener('pointermove', (e) => {
        const rect = root.getBoundingClientRect();
        mx = (e.clientX - rect.left) / rect.width;
        my = (e.clientY - rect.top) / rect.height;
      }, { passive: true });

      // Sizing
      function resize() {
        const rect = canvas.getBoundingClientRect();
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        canvas.width = Math.floor(rect.width * dpr);
        canvas.height = Math.floor(rect.height * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }
      let rto;
      window.addEventListener('resize', () => {
        clearTimeout(rto);
        rto = setTimeout(() => { resize(); seedSails(sails.length || 120); }, 140);
      });

      // Field + sails
      const sails = [];
      let wind = Number(windInput.value) / 100; // 0..1
      windInput.addEventListener('input', () => { wind = Number(windInput.value) / 100; });

      densityInput.addEventListener('input', () => {
        const target = Number(densityInput.value);
        const diff = target - sails.length;
        if (diff > 0) { for (let i=0;i<diff;i++) addSail(); }
        else if (diff < 0) { sails.splice(target); }
        statCount.textContent = sails.length;
      });

      function pickHue() {
        const p = getComputedStyle(root);
        const a = Number(p.getPropertyValue('--h1')) || 208;
        const b = Number(p.getPropertyValue('--h2')) || 296;
        const c = Number(p.getPropertyValue('--h3')) || 24;
        const pool = [a, b, c];
        return pool[Math.floor(Math.random() * pool.length)] + (Math.random() * 22 - 11);
      }

      function addSail() {
        const rect = canvas.getBoundingClientRect();
        const w = rect.width, h = rect.height;
        const cx = Math.random() * w;
        const cy = Math.random() * h;
        const r = 30 + Math.random() * Math.min(w, h) * 0.08;
        sails.push({
          cx, cy, r,
          a: Math.random() * Math.PI * 2,
          b: Math.random() * Math.PI * 2,
          c: Math.random() * Math.PI * 2,
          va: (0.005 + Math.random() * 0.01) * (Math.random() > 0.5 ? 1 : -1),
          vb: (0.006 + Math.random() * 0.012) * (Math.random() > 0.5 ? 1 : -1),
          vc: (0.004 + Math.random() * 0.01) * (Math.random() > 0.5 ? 1 : -1),
          hue: pickHue(),
          sat: 88 + Math.random() * 8,
          light: 50 + Math.random() * 12,
          alpha: 0.35 + Math.random() * 0.25
        });
        statCount.textContent = sails.length;
      }

      function seedSails(n = 120) {
        sails.length = 0;
        for (let i=0;i<n;i++) addSail();
      }

      btnAdd.addEventListener('click', addSail);

      function field(x, y, t) {
        // Smooth rotational drift with subtle curl
        const f1 = 0.0019, f2 = 0.0014;
        const v =
          Math.sin(y * f1 + t * 0.8) +
          Math.cos(x * f2 - t * 0.6) * 0.9;
        return v;
      }

      function drawSail(s, t, toneDark) {
        // Lissajous-style triangle points
        const wob = 1 + Math.sin(t * 0.7 + s.c) * 0.15;
        const r1 = s.r * wob, r2 = s.r * 0.82 * wob, r3 = s.r * 0.64 * wob;

        const x1 = s.cx + Math.cos(s.a) * r1;
        const y1 = s.cy + Math.sin(s.a * 1.1) * r1 * 0.8;
        const x2 = s.cx + Math.cos(s.b * 0.9) * r2 * -0.7 + Math.sin(s.a) * 8;
        const y2 = s.cy + Math.sin(s.b) * r2 * 0.9 + Math.cos(s.c) * 6;
        const x3 = s.cx + Math.cos(s.c * 1.2) * r3 * 0.9;
        const y3 = s.cy + Math.sin(s.c) * r3 * -0.7;

        // Gradient along an edge
        const grad = ctx.createLinearGradient(x1, y1, x2, y2);
        const L = s.light + (toneDark ? 18 : 0);
        grad.addColorStop(0, `hsla(${s.hue}, ${s.sat}%, ${L}%, ${0.0})`);
        grad.addColorStop(0.5, `hsla(${s.hue}, ${s.sat}%, ${L}%, ${s.alpha})`);
        grad.addColorStop(1, `hsla(${s.hue}, ${s.sat}%, ${L}%, ${0.0})`);

        ctx.fillStyle = grad;
        ctx.strokeStyle = `hsla(${s.hue}, 40%, ${toneDark ? 80 : 34}%, 0.35)`;
        ctx.lineWidth = 0.8;

        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.lineTo(x3, y3);
        ctx.closePath();
        ctx.fill();

        // spine
        ctx.beginPath();
        ctx.moveTo((x1+x2)/2, (y1+y2)/2);
        ctx.lineTo(x3, y3);
        ctx.stroke();
      }

      function draw(now) {
        const rect = canvas.getBoundingClientRect();
        const w = rect.width, h = rect.height;

        // tilt
        const tx = (mx - 0.5) * 12;
        const ty = (my - 0.5) * -12;
        canvas.parentElement.style.transform = `rotateX(${ty}deg) rotateY(${tx}deg)`;

        // clear/trail
        const toneDark = root.getAttribute('data-tone') === 'dark';
        if (!glow) {
          ctx.clearRect(0, 0, w, h);
        } else {
          ctx.fillStyle = toneDark ? 'rgba(0,0,0,0.06)' : 'rgba(255,255,255,0.06)';
          ctx.fillRect(0, 0, w, h);
        }

        const t = now * 0.001;
        ctx.save();
        ctx.globalCompositeOperation = glow ? 'lighter' : 'source-over';

        for (let i=0;i<sails.length;i++) {
          const s = sails[i];

          // flow + pointer magnetism
          const ang = field(s.cx, s.cy, t);
          const speed = (0.4 + wind * 2.1);
          s.a += s.va * speed;
          s.b += s.vb * speed;
          s.c += s.vc * speed;

          // drift in the field
          s.cx += Math.cos(ang) * 0.6 * speed;
          s.cy += Math.sin(ang) * 0.5 * speed;

          // pointer attraction
          const dx = (mx * w - s.cx) * 0.0004 * (0.4 + wind);
          const dy = (my * h - s.cy) * 0.0004 * (0.4 + wind);
          s.cx += dx; s.cy += dy;

          // wrap
          if (s.cx < -20) s.cx = w + 20;
          if (s.cx > w + 20) s.cx = -20;
          if (s.cy < -20) s.cy = h + 20;
          if (s.cy > h + 20) s.cy = -20;

          drawSail(s, t, toneDark);
        }
        ctx.restore();

        // subtle guide lines
        ctx.save();
        ctx.strokeStyle = toneDark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)';
        ctx.lineWidth = 1;
        const cols = 3;
        for (let c = 1; c <= cols; c++) {
          const x = (w / (cols + 1)) * c;
          ctx.beginPath(); ctx.moveTo(x, 16); ctx.lineTo(x, h - 16); ctx.stroke();
        }
        ctx.restore();
      }

      function tick(now) {
        if (!running) return;
        const d = new Date();
        // meter
        const pace = 6.2; // seconds per cycle
        const pct = ((now / 1000) % pace) / pace;
        meter.style.setProperty('--pct', (pct * 360).toFixed(2) + 'deg');

        lastEl.textContent = 'Last updated: ' + d.toLocaleString([], { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' });
        draw(now || performance.now());
        if (!reduceMotion) requestAnimationFrame(tick);
      }

      // Init
      resize();
      seedSails(Number(densityInput.value));
      statCount.textContent = sails.length;
      running = true;
      tick(performance.now());
      if (reduceMotion) setInterval(() => tick(performance.now()), 1000);

      // Auto-add occasionally
      let lastSec = -1;
      setInterval(() => {
        const s = new Date().getSeconds();
        if (s !== lastSec) {
          lastSec = s;
          if (!reduceMotion && s % 6 === 0 && sails.length < 300) addSail();
        }
      }, 500);

      // Cleanup
      const obs = new MutationObserver(() => {
        if (!document.body.contains(root)) { running = false; obs.disconnect(); }
      });
      obs.observe(document.body, { childList: true, subtree: true });
    })();
  </script>
</section>
      </section>
      <!-- END_EDITABLE -->
    <script>
      // Only show a local placeholder if the agent hasn't written a timestamp yet
      const el = document.getElementById('last-updated');
      if (el && (!el.textContent || el.textContent.includes('not yet'))) {
        const now = new Date();
        el.textContent = `Last updated: ${now.toLocaleString(undefined, { hour12: false })}`;
      }
    </script>
  </body>
  </html>


