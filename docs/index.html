<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vibing</title>
    <style>
      :root {
        --bg: #0f1221;
        --fg: #e6e8f0;
        --muted: #9aa3b2;
        --accent: #8b5cf6;
      }
      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--fg);
        background: radial-gradient(1200px 800px at 70% 10%, #1b1f3a, var(--bg));
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        width: min(720px, 92vw);
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px;
        padding: 28px 24px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        backdrop-filter: blur(6px);
      }
      h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
        letter-spacing: 0.3px;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 18px;
      }
      #content {
        font-size: 18px;
        line-height: 1.6;
        background: rgba(255,255,255,0.04);
        border: 1px dashed rgba(255,255,255,0.12);
        border-radius: 12px;
        padding: 16px;
      }
      .footer {
        margin-top: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: var(--muted);
      }
      .badge {
        display: inline-block;
        background: rgba(139, 92, 246, 0.18);
        color: #d4c2ff;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(139, 92, 246, 0.35);
        letter-spacing: 0.2px;
      }
    </style>
  </head>
  <body>
    <!-- BEGIN_EDITABLE -->
      <section id="content">
<section id="sonata561" aria-label="SONATA 561 — Prism Loom">
  <style>
    /* SONATA — Iteration 561 (scoped) */
    #sonata561 {
      --ink: #0b1320;
      --muted: #596781;
      --ring: rgba(12,18,30,.18);
      --ring-strong: rgba(12,18,30,.28);

      --a: #6ee7ff;
      --b: #a78bfa;
      --c: #ffb86e;

      --bgA: #f7fbff;
      --bgB: #eef1f8;

      --glass: blur(14px) saturate(140%);
      --shadow: 0 40px 120px rgba(10,15,25,.18);

      position: relative;
      display: grid;
      place-items: center;
      min-height: 96vh;
      padding: clamp(18px, 5vw, 56px);
      color: var(--ink);
      font-family: ui-sans-serif, -apple-system, Segoe UI, "SF Pro Display", "Helvetica Neue", Inter, system-ui, Roboto, Arial, sans-serif;
      background:
        radial-gradient(140% 160% at 30% -10%, var(--bgA), var(--bgB) 50%, #e9edf6 100%),
        radial-gradient(120% 120% at 120% 10%, #ffffff, #f0f3fa 55%, #e8ecf6 100%);
      overflow: hidden;
      border-radius: 44px;
      isolation: isolate;
    }
    #sonata561::before {
      content:"";
      position: absolute; inset: -20% -10% -30% -10%;
      background:
        conic-gradient(from 0deg at 70% 20%, color-mix(in srgb, var(--a) 45%, transparent) 0 30deg, transparent 30deg 120deg, color-mix(in srgb, var(--c) 35%, transparent) 120deg 210deg, transparent 210deg 360deg);
      filter: blur(60px) saturate(120%);
      opacity: .35;
      animation: s561-aurora 22s linear infinite;
      pointer-events: none;
      z-index: 0;
    }
    #sonata561::after {
      content:"";
      position: absolute; inset: 0;
      background:
        repeating-linear-gradient(115deg, rgba(0,0,0,.018) 0 1px, transparent 1px 10px);
      mix-blend-mode: multiply;
      opacity: .6;
      pointer-events: none;
    }
    @keyframes s561-aurora { to { transform: rotate(360deg); } }

    #sonata561[data-theme="night"] {
      --ink: #e9f1ff;
      --muted: #95a5c6;
      --ring: rgba(255,255,255,.16);
      --ring-strong: rgba(255,255,255,.24);
      --bgA: #0a0f1e;
      --bgB: #101a32;
      background:
        radial-gradient(160% 180% at 60% -20%, #0a0f1e, #0f172a 55%, #0a1022 100%),
        radial-gradient(120% 120% at -10% 10%, #0a0f1e, #0b1222 70%, #0a0f1e 100%);
    }
    #sonata561[data-theme="night"]::before { opacity: .5; filter: blur(80px) saturate(160%); }
    #sonata561[data-theme="night"]::after { opacity: .25; mix-blend-mode: soft-light; }

    /* Frame */
    #sonata561 .frame {
      position: relative; z-index: 1;
      width: min(1200px, 96vw);
      border-radius: 32px;
      padding: clamp(18px, 3vw, 36px);
      border: 1px solid var(--ring);
      background:
        linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.38)) padding-box;
      backdrop-filter: var(--glass);
      -webkit-backdrop-filter: var(--glass);
      box-shadow: var(--shadow);
    }
    #sonata561[data-theme="night"] .frame {
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04)) padding-box;
      box-shadow: 0 50px 140px rgba(0,0,0,.55);
    }

    /* Masthead */
    #sonata561 .mast {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 16px;
      margin-bottom: clamp(10px, 2vw, 18px);
    }
    #sonata561 .seal {
      position: relative; width: 42px; height: 42px; border-radius: 50%;
      display: grid; place-items: center;
      border: 2px solid var(--ring-strong);
      background:
        conic-gradient(from 0deg, var(--a), var(--b), var(--c), var(--a));
      box-shadow: inset 0 0 0 7px rgba(255,255,255,.6), 0 10px 26px rgba(0,0,0,.12);
      animation: s561-spin 14s linear infinite;
    }
    #sonata561[data-theme="night"] .seal { box-shadow: inset 0 0 0 7px rgba(0,0,0,.35), 0 10px 26px rgba(0,0,0,.45); }
    #sonata561 .seal span { font-size: 11px; font-weight: 900; letter-spacing: .18em; color: var(--ink); mix-blend-mode: multiply; }
    @keyframes s561-spin { to { transform: rotate(360deg); } }

    #sonata561 .meta { color: var(--muted); font-size: 12px; letter-spacing: .18em; text-transform: uppercase; font-weight: 900; }
    #sonata561 .actions { display: flex; flex-wrap: wrap; gap: 10px; }

    #sonata561 .chip {
      appearance: none; -webkit-appearance: none; cursor: pointer;
      padding: 10px 14px; border-radius: 999px; font-weight: 800; font-size: 12px; color: var(--ink);
      border: 1px solid var(--ring);
      background:
        linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.45)) padding-box,
        linear-gradient(90deg, var(--a), var(--b), var(--c)) border-box;
      box-shadow: 0 16px 34px rgba(0,0,0,.10);
      transition: transform .15s ease, box-shadow .2s ease, opacity .2s ease;
    }
    #sonata561 .chip:hover { transform: translateY(-1px); }
    #sonata561[data-theme="night"] .chip {
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04)) padding-box,
        linear-gradient(90deg, var(--a), var(--b), var(--c)) border-box;
      box-shadow: 0 16px 34px rgba(0,0,0,.45);
    }

    /* Hero */
    #sonata561 .hero { margin: 6px 0 12px; }
    #sonata561 h1 {
      margin: 0;
      font-size: clamp(52px, 9vw, 120px);
      line-height: .88;
      letter-spacing: -.02em;
      text-wrap: balance;
      background: conic-gradient(from 180deg at 50% 60%, color-mix(in srgb, var(--a) 80%, #fff 0%), color-mix(in srgb, var(--b) 78%, #fff 0%), color-mix(in srgb, var(--c) 78%, #fff 0%));
      -webkit-background-clip: text; background-clip: text; color: transparent;
      filter: drop-shadow(0 2px 0 rgba(255,255,255,.22));
    }
    #sonata561 .lead {
      margin: 10px 0 0; color: var(--muted);
      font-size: clamp(14px, 2.1vw, 18px); max-width: 70ch;
    }

    /* Portal stage */
    #sonata561 .portal {
      position: relative; width: 100%;
      aspect-ratio: 16 / 9; max-height: 66vh;
      border-radius: 28px; overflow: hidden;
      border: 1px solid var(--ring);
      background:
        radial-gradient(120% 120% at 50% 10%, rgba(255,255,255,.75), rgba(255,255,255,.35));
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.8),
        0 50px 120px rgba(0,0,0,.15);
      transform-style: preserve-3d;
      transition: transform .25s ease, box-shadow .25s ease;
    }
    #sonata561[data-theme="night"] .portal {
      background:
        radial-gradient(120% 120% at 50% 10%, rgba(255,255,255,.10), rgba(255,255,255,.04));
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.10),
        0 42px 120px rgba(0,0,0,.55);
    }
    #sonata561 canvas#loom561 {
      position: absolute; inset: 0; width: 100%; height: 100%;
      filter:
        saturate(120%)
        drop-shadow(0 0 28px color-mix(in srgb, var(--a), transparent 85%))
        drop-shadow(0 0 28px color-mix(in srgb, var(--b), transparent 88%));
      will-change: transform, filter;
    }

    #sonata561 .ring {
      pointer-events: none; position: absolute; inset: -30% -10% -30% -10%; z-index: 1;
      background:
        conic-gradient(from 0deg at 50% 50%, color-mix(in srgb, var(--a) 28%, transparent) 0 120deg, color-mix(in srgb, var(--b) 28%, transparent) 120deg 240deg, color-mix(in srgb, var(--c) 28%, transparent) 240deg 360deg);
      mask: radial-gradient(60% 60% at 50% 50%, #0000 58%, #000 60%);
      opacity: .4;
      animation: s561-orbit 24s linear infinite;
      filter: blur(8px);
    }
    @keyframes s561-orbit { to { transform: rotate(360deg); } }

    #sonata561 .hud {
      position: absolute; right: 12px; top: 12px; z-index: 2;
      font-size: 11px; font-weight: 900; letter-spacing: .12em; text-transform: uppercase;
      padding: 8px 10px; border-radius: 10px; color: var(--ink);
      border: 1px solid var(--ring);
      background: color-mix(in srgb, #ffffff 70%, transparent);
      backdrop-filter: blur(8px) saturate(130%);
      -webkit-backdrop-filter: blur(8px) saturate(130%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.8), 0 14px 30px rgba(0,0,0,.12);
    }
    #sonata561[data-theme="night"] .hud {
      background: color-mix(in srgb, #ffffff 12%, transparent);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.12), 0 14px 30px rgba(0,0,0,.45);
    }

    /* Controls */
    #sonata561 .dock { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-top: clamp(16px, 2.6vw, 24px); }
    #sonata561 .block {
      display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
      padding: 8px 10px; border-radius: 12px;
      border: 1px solid var(--ring);
      background: color-mix(in srgb, #ffffff 70%, transparent);
      backdrop-filter: blur(8px) saturate(130%);
      -webkit-backdrop-filter: blur(8px) saturate(130%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.85), 0 22px 60px rgba(0,0,0,.10);
    }
    #sonata561[data-theme="night"] .block {
      background: color-mix(in srgb, #ffffff 10%, transparent);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10), 0 22px 60px rgba(0,0,0,.45);
    }
    #sonata561 .block label {
      font-size: 10px; letter-spacing: .14em; text-transform: uppercase; font-weight: 900; opacity: .78; margin-right: 4px;
    }
    #sonata561 input[type="range"] {
      -webkit-appearance: none; appearance: none;
      width: 220px; height: 26px; border-radius: 999px; padding: 0 10px;
      border: 1px solid var(--ring);
      background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.45));
    }
    #sonata561[data-theme="night"] input[type="range"] {
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
    }
    #sonata561 input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%;
      background:
        linear-gradient(#fff, #fff) padding-box,
        conic-gradient(var(--a), var(--b), var(--c), var(--a)) border-box;
      border: 2px solid transparent; box-shadow: 0 8px 18px rgba(0,0,0,.2); cursor: pointer;
    }
    #sonata561 input[type="range"]::-moz-range-thumb {
      width: 18px; height: 18px; border: none; border-radius: 50%; background: #fff; cursor: pointer;
    }

    /* Footer */
    #sonata561 .foot {
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
      margin-top: clamp(16px, 2.6vw, 24px); color: var(--muted); font-size: 12px;
    }
    #sonata561 .meter {
      width: 80px; height: 10px; border-radius: 999px; overflow: hidden; position: relative;
      background: linear-gradient(90deg, color-mix(in srgb, var(--a) 50%, #fff 0%), color-mix(in srgb, var(--b) 50%, #fff 0%), color-mix(in srgb, var(--c) 50%, #fff 0%));
    }
    #sonata561 .meter::after {
      content: ""; position: absolute; inset: 0;
      background: linear-gradient(90deg, #fff0, #fff8, #fff0);
      transform: translateX(-100%);
      animation: s561-sheen 2.6s ease-in-out infinite;
    }
    @keyframes s561-sheen { 50% { transform: translateX(100%); } }

    @media (prefers-reduced-motion: reduce) {
      #sonata561 .seal, #sonata561 .ring, #sonata561::before, #sonata561 .meter::after { animation: none !important; }
      #sonata561 .portal, #sonata561 canvas#loom561 { transition: none !important; }
    }
  </style>

  <div class="frame" role="region" aria-label="Prismatic loom">
    <div class="mast">
      <div class="seal"><span>561</span></div>
      <div class="meta">SONATA • Iteration 561</div>
      <div class="actions">
        <button class="chip" id="theme561" type="button" aria-label="Toggle day/night" aria-pressed="false">Day</button>
        <button class="chip" id="tone561" type="button" aria-label="Cycle palette">Palette</button>
        <button class="chip" id="pause561" type="button" aria-label="Pause or resume" aria-pressed="false">Pause</button>
        <button class="chip" id="snap561" type="button" aria-label="Export image">Save</button>
      </div>
    </div>

    <div class="hero">
      <h1>Prism Loom</h1>
      <p class="lead">Threads of light weave a living tapestry. Tilt, touch, and let color find its path.</p>
    </div>

    <figure class="portal" id="portal561" role="img" aria-label="Additive color threads orbiting and weaving into luminous patterns">
      <canvas id="loom561" aria-hidden="true"></canvas>
      <div class="ring" aria-hidden="true"></div>
      <div class="hud" aria-live="polite">
        <span id="hudSpeed561">Speed 1.00×</span> · <span id="hudGlow561">Glow 1.00</span> · <span id="hudStrands561">Strands 120</span>
      </div>
    </figure>

    <div class="dock" aria-label="Controls">
      <div class="block">
        <label for="speed561">Speed</label>
        <input id="speed561" type="range" min="0.20" max="2.00" step="0.05" value="1.00" />
      </div>
      <div class="block">
        <label for="glow561">Glow</label>
        <input id="glow561" type="range" min="0.50" max="3.00" step="0.05" value="1.00" />
      </div>
      <div class="block">
        <label for="trails561">Trails</label>
        <input id="trails561" type="range" min="0.02" max="0.30" step="0.01" value="0.10" />
      </div>
      <div class="block">
        <label for="strands561">Strands</label>
        <input id="strands561" type="range" min="40" max="300" step="10" value="120" />
      </div>
    </div>

    <div class="foot">
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="meter" aria-hidden="true"></div>
        <span>Harmonics become hush</span>
      </div>
      <span id="last-updated">Last updated: 2025-11-11 02:18:14 EST</span>
    </div>
  </div>

  <script>
    (function () {
      const root   = document.getElementById('sonata561');
      const portal = document.getElementById('portal561');
      const cvs    = document.getElementById('loom561');
      const ctx    = cvs.getContext('2d');

      const bTheme = document.getElementById('theme561');
      const bTone  = document.getElementById('tone561');
      const bPause = document.getElementById('pause561');
      const bSnap  = document.getElementById('snap561');

      const rSpeed   = document.getElementById('speed561');
      const rGlow    = document.getElementById('glow561');
      const rTrails  = document.getElementById('trails561');
      const rStrands = document.getElementById('strands561');

      const hudSpeed   = document.getElementById('hudSpeed561');
      const hudGlow    = document.getElementById('hudGlow561');
      const hudStrands = document.getElementById('hudStrands561');
      const stampEl    = document.getElementById('last-updated');

      // Timestamp
      try {
        const now = new Date();
        const parts = new Intl.DateTimeFormat(undefined, {
          year: 'numeric', month: 'short', day: '2-digit',
          hour: '2-digit', minute: '2-digit', second: '2-digit',
          timeZoneName: 'short'
        }).format(now);
        stampEl.textContent = 'Updated: ' + parts;
      } catch { stampEl.textContent = 'Updated just now'; }

      // Palettes
      const tones = [
        { name:'Prism', a:'#6ee7ff', b:'#a78bfa', c:'#ffb86e' },
        { name:'Aurora', a:'#7ee787', b:'#79c0ff', c:'#e2b6ff' },
        { name:'Dawn', a:'#ff9f6e', b:'#ffd86b', c:'#7cc9ff' },
        { name:'Lagoon', a:'#63ffd3', b:'#47bfff', c:'#b09cff' },
        { name:'Peony', a:'#ff8bb3', b:'#ffd1a8', c:'#9ee6ff' }
      ];
      function applyTone(t){
        root.style.setProperty('--a', t.a);
        root.style.setProperty('--b', t.b);
        root.style.setProperty('--c', t.c);
        bTone.textContent = 'Palette · ' + t.name;
      }
      let toneIndex = 0;
      try {
        const saved = localStorage.getItem('s561-tone');
        if (saved) { const obj = JSON.parse(saved); applyTone(obj); toneIndex = Math.max(0, tones.findIndex(x => x.name === obj.name)); }
        else applyTone(tones[0]);
      } catch { applyTone(tones[0]); }
      bTone.addEventListener('click', () => {
        toneIndex = (toneIndex + 1) % tones.length;
        applyTone(tones[toneIndex]);
        localStorage.setItem('s561-tone', JSON.stringify(tones[toneIndex]));
      });

      // Theme (day/night)
      const hourNow = (new Date()).getHours();
      const defaultTheme = (hourNow >= 7 && hourNow < 19) ? 'day' : 'night';
      const savedTheme = localStorage.getItem('s561-theme') || defaultTheme;
      if (savedTheme === 'night') {
        root.setAttribute('data-theme','night');
        bTheme.textContent = 'Night';
        bTheme.setAttribute('aria-pressed','true');
      } else {
        bTheme.textContent = 'Day';
        bTheme.setAttribute('aria-pressed','false');
      }
      bTheme.addEventListener('click', () => {
        const night = root.getAttribute('data-theme') === 'night';
        if (night) {
          root.removeAttribute('data-theme');
          bTheme.textContent = 'Day';
          bTheme.setAttribute('aria-pressed','false');
          localStorage.setItem('s561-theme','day');
        } else {
          root.setAttribute('data-theme','night');
          bTheme.textContent = 'Night';
          bTheme.setAttribute('aria-pressed','true');
          localStorage.setItem('s561-theme','night');
        }
        if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
          portal.style.transform = 'perspective(1100px) rotateX(6deg) rotateY(-5deg) scale(1.02)';
          setTimeout(()=> portal.style.transform='', 260);
        }
      });

      // Utils
      function css(name){
        const v = getComputedStyle(root).getPropertyValue(name).trim();
        if (v.startsWith('#')) { const h=v.replace('#',''); return [parseInt(h.slice(0,2),16),parseInt(h.slice(2,4),16),parseInt(h.slice(4,6),16)]; }
        const m = v.match(/rgba?\(([^)]+)\)/i);
        if (m) { const p = m[1].split(',').map(Number); return p.slice(0,3); }
        return [255,255,255];
      }
      function lerp(a,b,t){ return a + (b - a) * t; }
      function mix(c1,c2,t){ return [Math.round(lerp(c1[0],c2[0],t)), Math.round(lerp(c1[1],c2[1],t)), Math.round(lerp(c1[2],c2[2],t))]; }
      function rgba(c,a){ return `rgba(${c[0]},${c[1]},${c[2]},${a})`; }
      function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

      // State
      const state = {
        speed: parseFloat(rSpeed.value),
        glow: parseFloat(rGlow.value),
        trails: parseFloat(rTrails.value),
        strands: parseInt(rStrands.value, 10),
        paused: false,
        time: 0
      };
      hudSpeed.textContent = `Speed ${state.speed.toFixed(2)}×`;
      hudGlow.textContent  = `Glow ${state.glow.toFixed(2)}`;
      hudStrands.textContent = `Strands ${state.strands}`;

      rSpeed.addEventListener('input', ()=> { state.speed = parseFloat(rSpeed.value); hudSpeed.textContent = `Speed ${state.speed.toFixed(2)}×`; });
      rGlow.addEventListener('input', ()=> { state.glow = parseFloat(rGlow.value); hudGlow.textContent = `Glow ${state.glow.toFixed(2)}`; });
      rTrails.addEventListener('input', ()=> { state.trails = parseFloat(rTrails.value); });
      rStrands.addEventListener('input', ()=> { state.strands = parseInt(rStrands.value,10); seed(true); hudStrands.textContent = `Strands ${state.strands}`; });

      bPause.addEventListener('click', () => {
        state.paused = !state.paused;
        bPause.setAttribute('aria-pressed', String(state.paused));
        bPause.textContent = state.paused ? 'Resume' : 'Pause';
        if (!state.paused && !window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
          last = performance.now(); requestAnimationFrame(loop);
        }
      });
      bSnap.addEventListener('click', () => {
        const link = document.createElement('a');
        link.download = 'prism-loom.png';
        link.href = cvs.toDataURL('image/png');
        link.click();
      });

      // Canvas sizing
      let W=1, H=1, DPR = Math.max(1, Math.min(2.5, window.devicePixelRatio || 1));
      function resize() {
        const rect = portal.getBoundingClientRect();
        W = Math.max(1, Math.floor(rect.width));
        H = Math.max(1, Math.floor(rect.height));
        DPR = Math.max(1, Math.min(2.5, window.devicePixelRatio || 1));
        cvs.width = Math.floor(W * DPR);
        cvs.height = Math.floor(H * DPR);
        cvs.style.width = W + 'px';
        cvs.style.height = H + 'px';
        ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
        drawBase(true);
      }
      window.addEventListener('resize', resize);

      // Strands
      let S=[];
      const center = { x: 0, y: 0 };
      function seed(keep=false) {
        const target = state.strands;
        if (keep && S.length) {
          if (S.length > target) S.length = target;
          while (S.length < target) S.push(spawn());
          return;
        }
        S = [];
        for (let i=0;i<target;i++) S.push(spawn());
      }
      function spawn() {
        const rBase = Math.min(W,H) * (0.28 + Math.random()*0.14);
        const r2 = rBase * (0.28 + Math.random()*0.22);
        const a = 1 + (Math.random()*5|0);
        const b = 1 + (Math.random()*5|0);
        const p1 = Math.random()*Math.PI*2;
        const p2 = Math.random()*Math.PI*2;
        const hueBias = Math.random();
        const wt = 0.6 + Math.random()*1.4;
        return { r1:rBase, r2:r2, a, b, p1, p2, t: Math.random()*Math.PI*2, x: 0, y: 0, px: 0, py: 0, hb: hueBias, w: wt };
      }

      // Palette ring
      function swirlColor(u) {
        const A = css('--a'), B = css('--b'), C = css('--c');
        if (u < .5) return mix(A, B, u/.5);
        return mix(B, C, (u-.5)/.5);
      }

      // Pointer tilt + center attraction
      const pointer = { x: 0, y: 0, inside: false };
      portal.addEventListener('pointerenter', () => { pointer.inside = true; });
      portal.addEventListener('pointerleave', () => { pointer.inside = false; portal.style.transform=''; });
      portal.addEventListener('pointermove', (e) => {
        const r = portal.getBoundingClientRect();
        pointer.x = e.clientX - r.left;
        pointer.y = e.clientY - r.top;
        if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
          const nx = (pointer.x/r.width - .5), ny = (pointer.y/r.height - .5);
          portal.style.transform = `perspective(1100px) rotateX(${-ny*8}deg) rotateY(${nx*10}deg) scale(1.005)`;
        }
      });
      portal.addEventListener('click', () => {
        // re-phase a handful for a sparkle reset
        for (let i=0;i<12;i++){
          const k = (Math.random()*S.length)|0;
          S[k].p1 = Math.random()*Math.PI*2;
          S[k].p2 = Math.random()*Math.PI*2;
        }
      });

      function drawBase(clear=false){
        ctx.globalCompositeOperation = 'source-over';
        if (clear) ctx.clearRect(0,0,W,H);
        const night = root.getAttribute('data-theme') === 'night';
        ctx.fillStyle = night ? 'rgba(8,12,24,0.18)' : 'rgba(255,255,255,0.16)';
        ctx.fillRect(0,0,W,H);
      }

      // Loop
      let last = performance.now();
      function loop(now){
        const dt = Math.min(0.05, (now - last)/1000) * state.speed;
        last = now;
        state.time += dt;

        // gentle fade for trails
        const night = root.getAttribute('data-theme') === 'night';
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = night ? `rgba(10,14,28,${state.trails})` : `rgba(247,250,255,${state.trails})`;
        ctx.fillRect(0,0,W,H);

        // center follows pointer slightly
        const cx = W*0.5, cy = H*0.5;
        if (pointer.inside) {
          center.x = lerp(center.x || cx, lerp(cx, pointer.x, 0.10), 0.12);
          center.y = lerp(center.y || cy, lerp(cy, pointer.y, 0.10), 0.12);
        } else {
          center.x = lerp(center.x || cx, cx, 0.08);
          center.y = lerp(center.y || cy, cy, 0.08);
        }

        // draw
        for (let i=0;i<S.length;i++){
          const s = S[i];
          s.px = s.x; s.py = s.y;

          s.t += dt;
          const t = s.t;

          // compound harmonic orbit
          const x = center.x + s.r1 * Math.cos(s.a * t + s.p1) + s.r2 * Math.cos(s.b * t + s.p2);
          const y = center.y + s.r1 * Math.sin(s.a * t + s.p1) + s.r2 * Math.sin(s.b * t + s.p2);

          s.x = x; s.y = y;

          // color along a slow ring
          const u = (Math.sin((i*0.07) + t*0.9 + s.hb*6.28)*0.5 + 0.5);
          const col = swirlColor(u);

          ctx.globalCompositeOperation = night ? 'lighter' : 'multiply';
          ctx.lineCap = 'round';
          ctx.lineJoin = 'round';
          ctx.strokeStyle = rgba(col, night ? (0.20 * state.glow) : (0.26 * state.glow));
          ctx.lineWidth = 0.5 + 0.9 * s.w;
          ctx.shadowColor = rgba(col, 0.65 * state.glow);
          ctx.shadowBlur = 14 * state.glow;

          ctx.beginPath();
          ctx.moveTo(s.px || s.x, s.py || s.y);
          ctx.lineTo(s.x, s.y);
          ctx.stroke();

          // sparkle nodes
          if ((i + (now|0)) % 280 === 0) {
            ctx.globalCompositeOperation = 'lighter';
            ctx.fillStyle = rgba(col, 0.14 * state.glow);
            ctx.beginPath();
            ctx.arc(s.x, s.y, 3 + 8 * Math.random(), 0, Math.PI*2);
            ctx.fill();
          }
        }

        if (!state.paused && !window.matchMedia('(prefers-reduced-motion: reduce)').matches) requestAnimationFrame(loop);
      }

      // Init
      function init() {
        resize();
        seed(false);
        drawBase(true);
        center.x = W*0.5; center.y = H*0.5;
        if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) requestAnimationFrame(loop);
      }
      init();
    })();
  </script>
</section>
      </section>
      <!-- END_EDITABLE -->
    <script>
      // Only show a local placeholder if the agent hasn't written a timestamp yet
      const el = document.getElementById('last-updated');
      if (el && (!el.textContent || el.textContent.includes('not yet'))) {
        const now = new Date();
        el.textContent = `Last updated: ${now.toLocaleString(undefined, { hour12: false })}`;
      }
    </script>
  </body>
  </html>


