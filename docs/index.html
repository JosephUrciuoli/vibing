<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vibing</title>
    <style>
      :root {
        --bg: #0f1221;
        --fg: #e6e8f0;
        --muted: #9aa3b2;
        --accent: #8b5cf6;
      }
      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--fg);
        background: radial-gradient(1200px 800px at 70% 10%, #1b1f3a, var(--bg));
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        width: min(720px, 92vw);
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px;
        padding: 28px 24px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        backdrop-filter: blur(6px);
      }
      h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
        letter-spacing: 0.3px;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 18px;
      }
      #content {
        font-size: 18px;
        line-height: 1.6;
        background: rgba(255,255,255,0.04);
        border: 1px dashed rgba(255,255,255,0.12);
        border-radius: 12px;
        padding: 16px;
      }
      .footer {
        margin-top: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: var(--muted);
      }
      .badge {
        display: inline-block;
        background: rgba(139, 92, 246, 0.18);
        color: #d4c2ff;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(139, 92, 246, 0.35);
        letter-spacing: 0.2px;
      }
    </style>
  </head>
  <body>
    <!-- BEGIN_EDITABLE -->
      <section id="content">
<section class="v1352-silk" data-theme="dawn" data-paused="false" data-mode="flow" aria-label="Silk Ribbons Studio">
  <style>
    .v1352-silk{
      --bg-0: #f9fbff;
      --bg-1: #f6f0ff;
      --ink: #0e1320;
      --muted: rgba(14,19,32,0.64);
      --a1: #5eb0ff; /* azure */
      --a2: #ff7aa2; /* rose */
      --a3: #9a7bff; /* violet */
      --glass: rgba(255,255,255,0.65);
      --glass-brd: rgba(14,19,32,0.12);
      --ring: rgba(14,19,32,0.08);

      position: relative;
      padding: clamp(22px, 4vw, 56px);
      border-radius: 40px;
      color: var(--ink);
      background: radial-gradient(120% 140% at 100% 0%, var(--bg-1), var(--bg-0) 60%);
      box-shadow:
        0 50px 120px rgba(10,18,30,0.14),
        inset 0 0 0 1px rgba(10,18,30,0.06);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      overflow: hidden;
      isolation: isolate;
    }
    .v1352-silk[data-theme="noir"]{
      --bg-0: #0a0d14;
      --bg-1: #111625;
      --ink: #f7f9ff;
      --muted: rgba(247,249,255,0.72);
      --a1: #7dd3fc;
      --a2: #fda4af;
      --a3: #c7b3ff;
      --glass: rgba(255,255,255,0.08);
      --glass-brd: rgba(255,255,255,0.16);
      --ring: rgba(255,255,255,0.09);
      background: radial-gradient(120% 140% at 0% 0%, var(--bg-1), var(--bg-0) 65%);
      box-shadow:
        0 60px 160px rgba(0,0,0,0.65),
        inset 0 0 0 1px rgba(255,255,255,0.06);
    }
    .v1352-silk::before{
      content:"";
      position:absolute; inset:-2px; border-radius:40px; padding:2px;
      background:
        conic-gradient(from 0.25turn,
          color-mix(in oklab, var(--a1), transparent 35%) 0%,
          color-mix(in oklab, var(--a2), transparent 35%) 30%,
          transparent 44%,
          color-mix(in oklab, var(--a3), transparent 35%) 62%,
          color-mix(in oklab, var(--a1), transparent 35%) 100%);
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
              mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
              mask-composite: exclude;
      animation: v1352-spin 24s linear infinite;
      opacity: 0.85;
      pointer-events:none; z-index:-1;
    }
    @keyframes v1352-spin { to{ transform: rotate(360deg);} }

    /* Grain + rings */
    .v1352-silk::after{
      content:"";
      position:absolute; inset:-10%;
      background:
        radial-gradient(circle at 60% -20%, color-mix(in oklab, var(--a2), transparent 92%) 0%, transparent 40%) no-repeat,
        radial-gradient(circle at -10% 120%, color-mix(in oklab, var(--a1), transparent 90%) 0%, transparent 40%) no-repeat,
        repeating-conic-gradient(from 0deg, rgba(0,0,0,0.02) 0 12deg, transparent 12deg 24deg);
      mix-blend-mode: soft-light;
      transform: rotate(10deg) scale(1.08);
      pointer-events:none; z-index:-2; opacity: 0.5;
    }

    .v1352-silk .mast{
      display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:14px;
    }
    .v1352-silk .pin{
      width: 54px; height:54px; border-radius:18px; display:grid; place-items:center; position:relative; overflow:hidden;
      background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.6));
      border: 1px solid var(--glass-brd);
      box-shadow:
        inset 0 0 0 1px var(--glass-brd),
        0 16px 34px rgba(0,0,0,0.18);
    }
    .v1352-silk[data-theme="noir"] .pin{
      background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
      box-shadow:
        inset 0 0 0 1px var(--glass-brd),
        0 16px 44px rgba(0,0,0,0.5);
    }
    .v1352-silk .pin svg{ width:28px; height:28px; }
    .v1352-silk .pin .rotor{ transform-origin: 50% 50%; animation: v1352-rotor 10s linear infinite; }
    @keyframes v1352-rotor{ to{ transform: rotate(360deg);} }

    .v1352-silk .brand h2{ margin:0; font-weight:900; letter-spacing:-0.02em; font-size: clamp(16px, 2vw, 20px); }
    .v1352-silk .brand .tag{ margin-top:2px; font-size:12px; letter-spacing:0.22em; text-transform:uppercase; color: var(--muted); }

    .v1352-silk .chip{
      display:inline-flex; align-items:center; gap:10px; padding:8px 12px; border-radius:999px;
      background: var(--glass); border: 1px solid var(--glass-brd); color: var(--muted); backdrop-filter: blur(8px);
      white-space: nowrap;
    }
    .v1352-silk .dot{ width:9px; height:9px; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, var(--a1), var(--a3));
      box-shadow: 0 0 0 2px rgba(255,255,255,0.18), 0 0 16px var(--a1);
    }
    .v1352-silk[data-paused="true"] .dot{ filter: grayscale(80%) brightness(0.85); box-shadow: 0 0 0 2px rgba(255,255,255,0.12); }

    .v1352-silk .hero{ margin-top: clamp(10px, 2vw, 24px); }
    .v1352-silk h1{
      margin:0; font-size: clamp(42px, 8.5vw, 108px); line-height:1.02; letter-spacing:-0.02em;
      background: linear-gradient(90deg, var(--ink), color-mix(in oklab, var(--a1), var(--ink) 50%), var(--ink));
      -webkit-background-clip:text; background-clip:text; color:transparent; text-wrap: balance;
    }
    .v1352-silk .lede{ margin:10px 0 0; color:var(--muted); font-size: clamp(14px, 2vw, 18px); max-width: 74ch; }

    .v1352-silk .stage{
      position: relative; margin-top: clamp(18px, 3vw, 38px);
      border-radius: 28px; overflow: hidden; min-height: 320px; aspect-ratio: 3 / 2;
      background:
        radial-gradient(60% 80% at 50% 50%, rgba(255,255,255,0.55), transparent 60%),
        radial-gradient(100% 100% at 50% 120%, var(--ring), transparent 70%);
      box-shadow:
        inset 0 0 0 1px var(--glass-brd),
        0 28px 80px rgba(0,0,0,0.22);
    }
    .v1352-silk[data-theme="noir"] .stage{
      background:
        radial-gradient(50% 60% at 50% 50%, rgba(255,255,255,0.05), transparent 60%),
        radial-gradient(100% 100% at 50% 120%, rgba(0,0,0,0.35), transparent 70%);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,0.06),
        0 28px 90px rgba(0,0,0,0.55);
    }
    .v1352-silk canvas{ position:absolute; inset:0; width:100%; height:100%; display:block; filter: saturate(112%) contrast(106%); }

    .v1352-silk .overlay{
      position:absolute; inset:0; pointer-events:none; opacity:0.4; mix-blend-mode:overlay;
      background:
        radial-gradient(circle at 50% 50%, transparent 22%, var(--ring) 22.25%, transparent 23%),
        radial-gradient(circle at 50% 50%, transparent 42%, var(--ring) 42.25%, transparent 43%),
        radial-gradient(circle at 50% 50%, transparent 64%, var(--ring) 64.25%, transparent 65%);
      animation: v1352-breathe 12s ease-in-out infinite alternate;
    }
    @keyframes v1352-breathe{ 0%{ opacity:0.32; transform: scale(1);} 100%{ opacity:0.62; transform: scale(1.02);} }

    .v1352-silk .controls{
      position:absolute; left:12px; right:12px; bottom:12px; z-index:3;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .v1352-silk .pill{
      padding:8px 12px; border-radius:999px; border:1px dashed var(--glass-brd);
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.6));
      color: var(--muted); font-size:12px; display:inline-flex; align-items:center; gap:8px; backdrop-filter: blur(6px);
    }
    .v1352-silk[data-theme="noir"] .pill{ background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06)); }

    .v1352-silk .segmented{
      display:inline-flex; background: var(--glass); border:1px solid var(--glass-brd); border-radius:999px; overflow:hidden;
      backdrop-filter: blur(8px);
    }
    .v1352-silk .segmented button{
      appearance:none; background:transparent; border:0; padding:9px 12px; font-weight:800; font-size:12px; letter-spacing:0.02em; color:var(--muted);
      transition: background 180ms ease, color 180ms ease;
      cursor:pointer;
    }
    .v1352-silk .segmented button[aria-pressed="true"]{
      background: color-mix(in oklab, var(--a1), transparent 80%);
      color: var(--ink);
    }

    .v1352-silk .btn{
      appearance:none; border:1px solid var(--glass-brd); border-radius:999px;
      padding:10px 14px; font-weight:800; font-size:13px; letter-spacing:0.02em;
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.7));
      color: var(--ink); cursor:pointer;
      transition: transform 160ms ease, box-shadow 220ms ease, background 240ms ease;
      box-shadow: 0 14px 28px rgba(0,0,0,0.18);
    }
    .v1352-silk .btn:hover{ transform: translateY(-1px); box-shadow: 0 18px 34px rgba(0,0,0,0.25); }
    .v1352-silk[data-theme="noir"] .btn{
      background: linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.08));
      color: var(--muted); box-shadow: 0 14px 28px rgba(0,0,0,0.45);
    }

    .v1352-silk .slider{
      -webkit-appearance:none; appearance:none; height: 10px; border-radius:999px; outline:none; width: min(260px, 40vw);
      background: linear-gradient(90deg, var(--a1), var(--a3));
      border: 1px solid var(--glass-brd);
      box-shadow: inset 0 0 0 3px rgba(255,255,255,0.5);
    }
    .v1352-silk[data-theme="noir"] .slider{ box-shadow: inset 0 0 0 2px rgba(255,255,255,0.12); }
    .v1352-silk .slider::-webkit-slider-thumb{
      -webkit-appearance:none; appearance:none; width:22px; height:22px; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, #ddd); border:1px solid var(--glass-brd); box-shadow: 0 6px 14px rgba(0,0,0,0.2);
      cursor: grab;
    }
    .v1352-silk[data-theme="noir"] .slider::-webkit-slider-thumb{ background: radial-gradient(circle at 30% 30%, #f8fbff, #cfd8e3); }
    .v1352-silk .slider::-moz-range-thumb{
      width:22px; height:22px; border-radius:50%; background: radial-gradient(circle at 30% 30%, #fff, #ddd);
      border:1px solid var(--glass-brd); box-shadow: 0 6px 14px rgba(0,0,0,0.2); cursor: grab;
    }

    @media (prefers-reduced-motion: reduce){
      .v1352-silk::before, .v1352-silk .overlay{ animation: none !important; }
      .v1352-silk .btn, .v1352-silk .segmented button{ transition: none !important; }
    }
    @media (max-width: 760px){
      .v1352-silk .controls{ left:10px; right:10px; bottom:10px; gap:8px; }
      .v1352-silk .segmented button{ padding:8px 10px; }
    }
  </style>

  <div class="mast">
    <div class="pin" aria-hidden="true">
      <svg viewBox="0 0 32 32" fill="none" aria-hidden="true">
        <g class="rotor">
          <path d="M16 4c1.1 0 2 .9 2 2 0 3.87-3.13 7-7 7-1.1 0-2-.9-2-2 0-3.87 3.13-7 7-7Z" fill="url(#g1)"/>
          <path d="M28 16c0 1.1-.9 2-2 2-3.87 0-7-3.13-7-7 0-1.1.9-2 2-2 3.87 0 7 3.13 7 7Z" fill="url(#g2)"/>
          <path d="M16 28c-1.1 0-2-.9-2-2 0-3.87 3.13-7 7-7 1.1 0 2 .9 2 2 0 3.87-3.13 7-7 7Z" fill="url(#g3)"/>
          <path d="M4 16c0-1.1.9-2 2-2 3.87 0 7 3.13 7 7 0 1.1-.9 2-2 2-3.87 0-7-3.13-7-7Z" fill="url(#g4)"/>
        </g>
        <defs>
          <linearGradient id="g1" x1="9" y1="4" x2="18" y2="13" gradientUnits="userSpaceOnUse">
            <stop stop-color="var(--a1)"/><stop offset="1" stop-color="var(--a3)"/>
          </linearGradient>
          <linearGradient id="g2" x1="19" y1="7" x2="28" y2="16" gradientUnits="userSpaceOnUse">
            <stop stop-color="var(--a2)"/><stop offset="1" stop-color="var(--a1)"/>
          </linearGradient>
          <linearGradient id="g3" x1="23" y1="19" x2="14" y2="28" gradientUnits="userSpaceOnUse">
            <stop stop-color="var(--a3)"/><stop offset="1" stop-color="var(--a2)"/>
          </linearGradient>
          <linearGradient id="g4" x1="4" y1="14" x2="13" y2="23" gradientUnits="userSpaceOnUse">
            <stop stop-color="var(--a1)"/><stop offset="1" stop-color="var(--a2)"/>
          </linearGradient>
        </defs>
      </svg>
    </div>
    <div class="brand">
      <h2>Ribbon Lab</h2>
      <div class="tag">Motion as material</div>
    </div>
    <div class="chip" aria-live="polite">
      <span class="dot" aria-hidden="true"></span>
      <span id="last-updated">Last updated: 2025-12-17 14:18:13 EST</span>
    </div>
  </div>

  <div class="hero">
    <h1>Silk Ribbons</h1>
    <p class="lede">Threads of color that breathe with your touch. Change the mode, set the tempo, and let the canvas weave.</p>
  </div>

  <div class="stage" aria-label="Generative Ribbon Canvas">
    <canvas id="ribbons"></canvas>
    <div class="overlay" aria-hidden="true"></div>

    <div class="controls">
      <div class="pill">State <strong id="state" style="font-variant-numeric: tabular-nums;">Running</strong></div>

      <div class="segmented" role="group" aria-label="Mode selector">
        <button class="mode" data-mode="flow" aria-pressed="true">Flow</button>
        <button class="mode" data-mode="orbit" aria-pressed="false">Orbit</button>
        <button class="mode" data-mode="dart" aria-pressed="false">Dart</button>
      </div>

      <button class="btn" id="pause" aria-pressed="false">Pause</button>
      <button class="btn" id="theme" aria-pressed="false">Noir</button>

      <label class="pill" for="speed" style="gap:12px;">
        Speed
        <input id="speed" class="slider" type="range" min="0" max="200" value="100" aria-label="Speed control">
        <strong id="speed-label" style="font-variant-numeric: tabular-nums;">1.00×</strong>
      </label>

      <label class="pill" for="density" style="gap:12px;">
        Density
        <input id="density" class="slider" type="range" min="1" max="18" value="9" aria-label="Ribbon density">
        <strong id="density-label" style="font-variant-numeric: tabular-nums;">9</strong>
      </label>
    </div>
  </div>

  <script>
    (function(){
      const root = document.currentScript.closest('.v1352-silk');
      const canvas = root.querySelector('#ribbons');
      const ctx = canvas.getContext('2d');
      const pauseBtn = root.querySelector('#pause');
      const themeBtn = root.querySelector('#theme');
      const stateEl = root.querySelector('#state');
      const updated = root.querySelector('#last-updated');
      const speedEl = root.querySelector('#speed');
      const speedLabel = root.querySelector('#speed-label');
      const densityEl = root.querySelector('#density');
      const densityLabel = root.querySelector('#density-label');
      const modeButtons = Array.from(root.querySelectorAll('.mode'));

      // timestamp
      try {
        const now = new Date();
        updated.textContent = now.toLocaleString(undefined, {
          year: 'numeric', month: 'short', day: '2-digit',
          hour: '2-digit', minute: '2-digit', second: '2-digit',
          timeZoneName: 'short'
        });
      } catch { updated.textContent = new Date().toString(); }

      // size & DPR
      let w=0,h=0,dpr=Math.max(1, Math.min(2, window.devicePixelRatio||1));
      function resize(){
        const r = canvas.getBoundingClientRect();
        w = Math.max(1, Math.floor(r.width));
        h = Math.max(1, Math.floor(r.height));
        canvas.width = Math.floor(w*dpr);
        canvas.height = Math.floor(h*dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }
      resize();
      window.addEventListener('resize', resize, {passive:true});

      const reduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const tau = Math.PI*2;

      function themeKey(){ return root.getAttribute('data-theme')==='noir' ? 'noir' : 'dawn'; }
      const PALETTE = {
        dawn: [
          {h:204,s:92,l:60},
          {h:334,s:86,l:64},
          {h:266,s:86,l:64},
          {h:160,s:64,l:50}
        ],
        noir: [
          {h:204,s:100,l:68},
          {h:334,s:96,l:66},
          {h:266,s:92,l:70},
          {h:160,s:72,l:58}
        ]
      };
      function hsla(h,s,l,a){ return `hsla(${h},${s}%,${l}%,${a})`; }

      // Ribbons
      let speedMul = 1;
      let density = Number(densityEl.value);
      let mode = root.getAttribute('data-mode');
      let t0 = 0, raf = null;

      const pointer = {x:0,y:0, nx:0, ny:0, active:false};
      root.addEventListener('pointermove', (e)=>{
        const r = canvas.getBoundingClientRect();
        pointer.x = e.clientX - r.left;
        pointer.y = e.clientY - r.top;
        pointer.nx = pointer.x / Math.max(1,r.width);
        pointer.ny = pointer.y / Math.max(1,r.height);
        pointer.active = true;
      }, {passive:true});
      root.addEventListener('pointerleave', ()=>{ pointer.active=false; });

      let ribbons = [];
      function seedRibbons(){
        ribbons = [];
        const pal = PALETTE[themeKey()];
        for (let i=0;i<density;i++){
          const p = pal[i % pal.length];
          ribbons.push({
            hue: p.h + (Math.random()*18 - 9),
            sat: p.s,
            lit: p.l,
            w: 10 + Math.random()*24,
            amp: 22 + Math.random()*40,
            speed: (0.15 + Math.random()*0.7) * (Math.random()<0.5?1:-1),
            phase: Math.random()*tau,
            yBase: (i+0.5)/(density) * h
          });
        }
      }

      function clearSoft(){
        ctx.globalCompositeOperation = 'source-over';
        if (themeKey()==='noir'){
          ctx.fillStyle = 'rgba(0,0,0,0.16)';
        } else {
          ctx.fillStyle = 'rgba(255,255,255,0.16)';
        }
        ctx.fillRect(0,0,w,h);
      }

      function drawRibbon(rb, time){
        const steps = 90;
        const g = ctx.createLinearGradient(0,0,w,0);
        const c1 = hsla(rb.hue, rb.sat, rb.lit, themeKey()==='noir'?0.35:0.28);
        const c2 = hsla(rb.hue+20, rb.sat, Math.min(90, rb.lit+10), themeKey()==='noir'?0.6:0.5);
        g.addColorStop(0, c1);
        g.addColorStop(0.5, c2);
        g.addColorStop(1, c1);

        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.shadowColor = hsla(rb.hue, rb.sat, Math.min(96, rb.lit+12), themeKey()==='noir'?0.18:0.12);
        ctx.shadowBlur = rb.w*0.6;

        ctx.beginPath();

        const modeLocal = mode;
        for (let i=0;i<=steps;i++){
          const t = i/steps;
          let x,y;
          if (modeLocal==='flow'){
            const px = t*w;
            const tt = time*0.001*rb.speed*speedMul + rb.phase;
            const wave = Math.sin(tau*t*1.5 + tt) + Math.sin(tau*t*0.6 - tt*0.8)*0.5;
            const touch = pointer.active ? (Math.exp(-((px-pointer.x)**2)/(w*0.18)) * (pointer.ny-0.5) * 180) : 0;
            x = px;
            y = rb.yBase + wave*rb.amp + touch;
          } else if (modeLocal==='orbit'){
            const cx = w*0.5, cy = h*0.5;
            const ang = tau*t + time*0.00035*rb.speed*speedMul + rb.phase;
            const rad = Math.min(w,h)*0.28 + Math.sin(ang*2+rb.phase)*rb.amp*0.25 + (i%2?4:-4);
            const tiltX = (pointer.active ? (pointer.nx-0.5)*0.2 : 0);
            const tiltY = (pointer.active ? (pointer.ny-0.5)*0.2 : 0);
            x = cx + rad*Math.cos(ang+tiltX);
            y = cy + rad*Math.sin(ang+tiltY) * (0.72 + tiltY);
          } else { // dart
            const diag = t*w + time*0.25*rb.speed*speedMul;
            const j = (diag % (w+h));
            const px = j < w ? j : w - (j - w);
            const baseY = (i/density)*h*0.12 + (rb.yBase*0.5);
            const shake = Math.sin((t*8 + time*0.008 + rb.phase))*rb.amp*0.2;
            x = px;
            y = baseY + px*0.35 + shake - (pointer.active? (pointer.ny-0.5)*40 : 0);
          }
          if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }

        ctx.globalCompositeOperation = 'lighter';
        ctx.strokeStyle = g;
        ctx.lineWidth = rb.w;
        ctx.stroke();

        // highlight thread
        ctx.shadowBlur = 0;
        ctx.lineWidth = rb.w*0.35;
        ctx.strokeStyle = hsla(rb.hue+10, rb.sat, Math.min(95, rb.lit+18), themeKey()==='noir'?0.22:0.16);
        ctx.stroke();
      }

      function render(ts){
        clearSoft();
        for (let i=0;i<ribbons.length;i++){
          drawRibbon(ribbons[i], ts);
        }
      }

      function loop(ts){
        if (!t0) t0 = ts;
        render(ts);
        raf = requestAnimationFrame(loop);
      }

      function setSpeed(v){
        speedMul = Math.max(0, Math.min(2, v/100*2));
        speedLabel.textContent = speedMul.toFixed(2)+'×';
      }
      function setDensity(v){
        density = Math.max(1, Math.min(18, v|0));
        densityLabel.textContent = String(density);
        seedRibbons();
      }

      // Init values
      setSpeed(Number(speedEl.value));
      setDensity(Number(densityEl.value));
      seedRibbons();

      // Events
      speedEl.addEventListener('input', (e)=> setSpeed(Number(e.target.value)));
      densityEl.addEventListener('input', (e)=> setDensity(Number(e.target.value)));

      pauseBtn.addEventListener('click', ()=>{
        const paused = root.getAttribute('data-paused')==='true';
        if (paused){
          root.setAttribute('data-paused','false');
          pauseBtn.textContent = 'Pause';
          pauseBtn.setAttribute('aria-pressed','false');
          stateEl.textContent = 'Running';
          if (!raf && !reduced) raf = requestAnimationFrame(loop);
        } else {
          root.setAttribute('data-paused','true');
          pauseBtn.textContent = 'Resume';
          pauseBtn.setAttribute('aria-pressed','true');
          stateEl.textContent = 'Paused';
          if (raf){ cancelAnimationFrame(raf); raf=null; }
        }
      });

      themeBtn.addEventListener('click', ()=>{
        const isNoir = themeKey()==='noir';
        root.setAttribute('data-theme', isNoir ? 'dawn' : 'noir');
        themeBtn.textContent = isNoir ? 'Noir' : 'Dawn';
        themeBtn.setAttribute('aria-pressed', String(!isNoir));
        seedRibbons();
      });

      modeButtons.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          modeButtons.forEach(b=> b.setAttribute('aria-pressed','false'));
          btn.setAttribute('aria-pressed','true');
          mode = btn.dataset.mode;
          root.setAttribute('data-mode', mode);
          // subtle visual feedback
          btn.style.transform = 'translateY(-1px)';
          setTimeout(()=> btn.style.transform='', 120);
          seedRibbons();
        });
      });

      // Keyboard shortcuts
      root.tabIndex = 0;
      root.addEventListener('keydown', (e)=>{
        const k = e.key.toLowerCase();
        if (k===' ') { e.preventDefault(); pauseBtn.click(); }
        if (k==='t'){ themeBtn.click(); }
        if (k==='1'){ modeButtons[0].click(); }
        if (k==='2'){ modeButtons[1].click(); }
        if (k==='3'){ modeButtons[2].click(); }
        if (k==='['){ speedEl.value = Math.max(0, Number(speedEl.value)-10); speedEl.dispatchEvent(new Event('input')); }
        if (k===']'){ speedEl.value = Math.min(200, Number(speedEl.value)+10); speedEl.dispatchEvent(new Event('input')); }
        if (k==='-'){ densityEl.value = Math.max(1, Number(densityEl.value)-1); densityEl.dispatchEvent(new Event('input')); }
        if (k==='='){ densityEl.value = Math.min(18, Number(densityEl.value)+1); densityEl.dispatchEvent(new Event('input')); }
      });

      // Prime background
      ctx.fillStyle = themeKey()==='noir' ? 'rgba(0,0,0,0.85)' : 'rgba(255,255,255,0.9)';
      ctx.fillRect(0,0,w,h);

      // Animate
      if (!reduced){
        raf = requestAnimationFrame(loop);
      } else {
        root.setAttribute('data-paused','true');
        pauseBtn.textContent = 'Resume';
        pauseBtn.setAttribute('aria-pressed','true');
        stateEl.textContent = 'Paused';
        render(performance.now());
      }

      window.addEventListener('resize', ()=>{
        const prev = {w,h};
        resize();
        // update base Y positions proportionally
        ribbons.forEach((rb, i)=> rb.yBase = (i+0.5)/(density)*h);
      }, {passive:true});

      document.addEventListener('visibilitychange', ()=>{
        if (document.hidden){
          if (raf){ cancelAnimationFrame(raf); raf=null; }
        } else if (root.getAttribute('data-paused')!=='true'){
          if (!reduced && !raf) raf = requestAnimationFrame(loop);
        }
      });
    })();
  </script>
</section>
      </section>
      <!-- END_EDITABLE -->
    <script>
      // Only show a local placeholder if the agent hasn't written a timestamp yet
      const el = document.getElementById('last-updated');
      if (el && (!el.textContent || el.textContent.includes('not yet'))) {
        const now = new Date();
        el.textContent = `Last updated: ${now.toLocaleString(undefined, { hour12: false })}`;
      }
    </script>
  </body>
  </html>


