<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vibing</title>
    <style>
      :root {
        --bg: #0f1221;
        --fg: #e6e8f0;
        --muted: #9aa3b2;
        --accent: #8b5cf6;
      }
      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--fg);
        background: radial-gradient(1200px 800px at 70% 10%, #1b1f3a, var(--bg));
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        width: min(720px, 92vw);
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px;
        padding: 28px 24px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        backdrop-filter: blur(6px);
      }
      h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
        letter-spacing: 0.3px;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 18px;
      }
      #content {
        font-size: 18px;
        line-height: 1.6;
        background: rgba(255,255,255,0.04);
        border: 1px dashed rgba(255,255,255,0.12);
        border-radius: 12px;
        padding: 16px;
      }
      .footer {
        margin-top: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: var(--muted);
      }
      .badge {
        display: inline-block;
        background: rgba(139, 92, 246, 0.18);
        color: #d4c2ff;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(139, 92, 246, 0.35);
        letter-spacing: 0.2px;
      }
    </style>
  </head>
  <body>
    <!-- BEGIN_EDITABLE -->
      <section id="content">
<section class="orrery" data-theme="dawn" aria-label="Orrery — A Generative Light Clock">
  <style>
    .orrery {
      --r: 26px;
      --ink: #0e1222;
      --muted: #5b6a86;
      --line: rgba(10,16,30,0.14);
      --bg1: #fffdf8;
      --bg2: #f6fbff;

      --a1: #ffb986;
      --a2: #79e7ff;
      --a3: #9dffe0;
      --a4: #ffd875;

      position: relative;
      border-radius: var(--r);
      border: 1px solid var(--line);
      padding: clamp(16px, 3.8vw, 52px);
      color: var(--ink);
      background:
        radial-gradient(180% 140% at 0% 0%, color-mix(in srgb, var(--a1) 28%, transparent), transparent 60%),
        radial-gradient(160% 140% at 100% 100%, color-mix(in srgb, var(--a2) 28%, transparent), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.85),
        0 42px 120px rgba(20,25,40,0.18),
        0 16px 36px rgba(20,25,40,0.12);
      overflow: hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      isolation: isolate;
    }

    /* THEMES */
    .orrery[data-theme="dawn"]  { --bg1:#fffdf9; --bg2:#f6fbff; --ink:#0e1222; --muted:#5b6a86; --line:rgba(10,16,30,0.14); --a1:#ffb986; --a2:#79e7ff; --a3:#a6ffd6; --a4:#ffd875; }
    .orrery[data-theme="dusk"]  { --bg1:#0a0f1e; --bg2:#121730; --ink:#e9f1ff; --muted:#9eb0d8; --line:rgba(255,255,255,0.16); --a1:#8ea2ff; --a2:#ff9cb0; --a3:#79ffd8; --a4:#ffd77f; }
    .orrery[data-theme="abyss"] { --bg1:#05070f; --bg2:#0a0c18; --ink:#eef3ff; --muted:#a8b2cc; --line:rgba(255,255,255,0.18); --a1:#7fb5ff; --a2:#6dffde; --a3:#caa7ff; --a4:#9ad1ff; }
    .orrery[data-theme="bloom"] { --bg1:#fff8fb; --bg2:#fffcf6; --ink:#161018; --muted:#6a5c77; --line:rgba(16,10,24,0.14); --a1:#ff9bd0; --a2:#ffa98a; --a3:#ffd97a; --a4:#a8ffcf; }
    .orrery[data-theme="paper"] { --bg1:#f7f9fb; --bg2:#eef2f6; --ink:#101418; --muted:#5d6a76; --line:rgba(16,20,24,0.16); --a1:#88aaff; --a2:#9bd6ff; --a3:#bfe7ff; --a4:#9ad1ff; }

    .orrery::before {
      content:"";
      position:absolute; inset:-25% -10% auto -10%; height:60%;
      background:
        radial-gradient(80% 80% at 18% 30%, var(--a1), transparent 60%),
        radial-gradient(70% 70% at 82% 24%, var(--a2), transparent 60%),
        radial-gradient(90% 90% at 50% 86%, var(--a3), transparent 65%);
      opacity:.2; filter: blur(28px); mix-blend-mode: screen; pointer-events:none;
      animation: veil 22s ease-in-out infinite alternate;
    }
    @keyframes veil { to { transform: translate3d(0, 18px, 0) scale(1.06); } }

    .top {
      display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom: 16px;
    }
    .sig {
      display:inline-grid; grid-auto-flow:column; gap:10px; align-items:center;
      letter-spacing:.22em; text-transform:uppercase; font-weight:900; font-size:11px; color:var(--muted);
    }
    .seal {
      --s:28px; width:var(--s); height:var(--s); border-radius:8px; display:grid; place-items:center;
      background:linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.35));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.8), 0 8px 20px rgba(20,25,40,0.18);
      position:relative; overflow:hidden;
    }
    .seal::after {
      content:""; position:absolute; inset:6px; border-radius:6px;
      border:2px solid rgba(16,21,36,0.14);
    }

    .hero { margin: 6px 0 18px; }
    .kicker { color:var(--muted); text-transform:uppercase; letter-spacing:.28em; font-size:10px; font-weight:800; margin:0 0 8px; }
    .title {
      margin:0;
      font-size: clamp(42px, 9.2vw, 120px);
      line-height:.86; font-weight:1000; letter-spacing:-0.03em;
      background: conic-gradient(from 120deg, var(--a2), var(--a1), var(--a4), var(--a3), var(--a2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      filter: drop-shadow(0 14px 28px rgba(20,25,40,0.20));
    }
    .sub { margin:10px 0 0; max-width:72ch; font-size:clamp(14px, 2.1vw, 18px); color:var(--muted); }

    .stage {
      position:relative;
      min-height: clamp(560px, 66vh, 980px);
      border-radius: 24px;
      border:1px solid var(--line);
      overflow:hidden;
      transform-style: preserve-3d;
      transition: transform 220ms ease, box-shadow 220ms ease;
      background:
        radial-gradient(120% 100% at 50% -10%, rgba(255,255,255,0.55), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,0.45), rgba(255,255,255,0.22));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.78), 0 26px 70px rgba(20,25,40,0.18);
    }
    .orrery[data-theme="dusk"] .stage,
    .orrery[data-theme="abyss"] .stage,
    .orrery[data-theme="paper"] .stage {
      background:
        radial-gradient(120% 100% at 50% -10%, rgba(255,255,255,0.12), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.25), 0 28px 80px rgba(0,0,0,0.45);
    }

    canvas.field { position:absolute; inset:0; width:100%; height:100%; display:block; }
    .grain {
      position:absolute; inset:0; pointer-events:none; opacity:.12; mix-blend-mode: overlay;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="140" height="140" viewBox="0 0 140 140"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.35"/></svg>');
      background-size: 280px 280px;
      animation: gr 12s steps(2) infinite;
    }
    @keyframes gr { to { transform: translate3d(12px, -8px, 0); } }

    .lens {
      position:absolute; width: 220px; height: 220px; border-radius:50%;
      left:0; top:0; transform: translate(-200px,-200px);
      background: radial-gradient(circle at 35% 35%, rgba(255,255,255,0.9), rgba(255,255,255,0.0) 60%);
      mix-blend-mode: soft-light; pointer-events:none; opacity:0;
      transition: opacity 220ms ease, transform 90ms ease;
      filter: blur(4px);
    }

    .dock {
      margin-top: 16px;
      display:flex; flex-wrap:wrap; align-items:center; gap:10px;
      padding:10px; border-radius:16px; border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.60));
      backdrop-filter: blur(10px) saturate(1.05);
      box-shadow:0 16px 40px rgba(20,25,40,0.16);
    }
    .orrery[data-theme="dusk"] .dock,
    .orrery[data-theme="abyss"] .dock,
    .orrery[data-theme="paper"] .dock {
      background:linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));
    }

    .btn, .pill {
      appearance:none; cursor:pointer; user-select:none;
      border:1px solid var(--line); border-radius: 999px; color:var(--ink);
      background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.55));
      padding:8px 12px; font-size:13px; white-space:nowrap;
      transition: transform 140ms ease, background 140ms ease, color 140ms ease, box-shadow 140ms ease;
      box-shadow:0 10px 22px rgba(20,25,40,0.14);
    }
    .btn:hover, .pill:hover { transform: translateY(-2px); background:linear-gradient(180deg, #fff, rgba(255,255,255,0.65)); }
    .btn:focus-visible, .pill:focus-visible { outline:2px solid var(--a2); outline-offset:2px; }

    .slider {
      appearance:none; width: clamp(140px, 24vw, 260px); height:28px; border-radius:999px;
      border:1px solid var(--line);
      background:linear-gradient(90deg, rgba(10,18,40,0.08), rgba(10,18,40,0.02));
      box-shadow: inset 0 0 0 2px rgba(255,255,255,0.65);
    }
    .slider::-webkit-slider-thumb {
      appearance:none; width:20px; height:20px; border-radius:50%;
      background:linear-gradient(180deg, #fff, #e9eef3); border:2px solid rgba(10,18,40,0.18); box-shadow:0 2px 12px rgba(20,25,40,0.18); cursor:pointer;
    }
    .slider::-moz-range-thumb {
      width:20px; height:20px; border-radius:50%;
      background:linear-gradient(180deg, #fff, #e9eef3); border:2px solid rgba(10,18,40,0.18); box-shadow:0 2px 12px rgba(20,25,40,0.18); cursor:pointer;
    }

    .themes { display:inline-flex; gap:8px; margin-left:auto; }
    .swatch {
      width:28px; height:28px; border-radius:50%; border:1px solid var(--line);
      box-shadow:0 10px 22px rgba(20,25,40,0.18); cursor:pointer; transition: transform 140ms ease;
    }
    .swatch:hover { transform: translateY(-2px) rotate(-4deg); }
    .swatch[data-theme="dawn"]  { background: conic-gradient(var(--a2), var(--a1), var(--a4), var(--a3), var(--a2)); }
    .swatch[data-theme="dusk"]  { background: conic-gradient(#8ea2ff, #ff9cb0, #ffd77f, #79ffd8, #8ea2ff); }
    .swatch[data-theme="abyss"] { background: conic-gradient(#7fb5ff, #6dffde, #caa7ff, #9ad1ff, #7fb5ff); }
    .swatch[data-theme="bloom"] { background: conic-gradient(#ff9bd0, #ffa98a, #ffd97a, #a8ffcf, #ff9bd0); }
    .swatch[data-theme="paper"] { background: conic-gradient(#88aaff, #9bd6ff, #bfe7ff, #9ad1ff, #88aaff); }

    .meta { display:flex; flex-wrap:wrap; align-items:center; gap:12px; margin-top:10px; font-size:12px; color:var(--muted); }
    .meta .sep { opacity:.5; }
  </style>

  <div class="top">
    <div class="sig">
      <div class="seal" aria-hidden="true"></div>
      Prism Foundry
    </div>
    <div class="sig" aria-hidden="true">Edition 396</div>
  </div>

  <div class="hero">
    <p class="kicker">HARMONIC GEOMETRY</p>
    <h1 class="title">ORRERY</h1>
    <p class="sub">A living light clock: orbits breathe, chords weave, and gravity bends toward your cursor. Click to send a comet. Space toggles time.</p>
  </div>

  <div class="stage" aria-label="Celestial Field">
    <canvas class="field" aria-hidden="true"></canvas>
    <div class="grain" aria-hidden="true"></div>
    <div class="lens" aria-hidden="true"></div>
  </div>

  <div class="dock" role="group" aria-label="Controls">
    <button type="button" class="btn play" aria-pressed="false" title="Pause/Resume">Pause</button>

    <label class="pill" style="padding:0 10px; display:inline-flex; align-items:center; gap:8px;">
      <span style="opacity:.8; font-size:12px;">Time</span>
      <input class="slider speed" type="range" min="0.2" max="2.5" step="0.1" value="1.0" aria-label="Time speed">
    </label>

    <label class="pill" style="padding:0 10px; display:inline-flex; align-items:center; gap:8px;">
      <span style="opacity:.8; font-size:12px;">Density</span>
      <input class="slider density" type="range" min="3" max="14" step="1" value="8" aria-label="Ring density">
    </label>

    <label class="pill" style="padding:0 10px; display:inline-flex; align-items:center; gap:8px;">
      <span style="opacity:.8; font-size:12px;">Trail</span>
      <input class="slider trail" type="range" min="0" max="0.2" step="0.005" value="0.04" aria-label="Trail persistence">
    </label>

    <button type="button" class="btn pulse" title="Send comet">Comet</button>
    <button type="button" class="btn shuffle" title="Reseed motion">Reseed</button>
    <button type="button" class="btn snap" title="Save image">Capture</button>

    <div class="themes" role="group" aria-label="Theme">
      <button class="swatch" type="button" data-theme="dawn" title="Dawn"></button>
      <button class="swatch" type="button" data-theme="dusk" title="Dusk"></button>
      <button class="swatch" type="button" data-theme="abyss" title="Abyss"></button>
      <button class="swatch" type="button" data-theme="bloom" title="Bloom"></button>
      <button class="swatch" type="button" data-theme="paper" title="Paper"></button>
    </div>
  </div>

  <div class="meta" aria-label="Meta">
    <span id="last-updated">Last updated: 2025-11-03 11:21:15 EST</span>
    <span class="sep">•</span>
    <span class="hint">Move: tilt • Click: comet • Space: pause • S: snapshot • 1–5: theme</span>
  </div>

  <script>
    (function(){
      const root = document.currentScript.closest('.orrery');
      const stage = root.querySelector('.stage');
      const canvas = root.querySelector('canvas.field');
      const ctx = canvas.getContext('2d', { alpha: true });
      const playBtn = root.querySelector('.play');
      const speedInput = root.querySelector('.speed');
      const densityInput = root.querySelector('.density');
      const trailInput = root.querySelector('.trail');
      const pulseBtn = root.querySelector('.pulse');
      const shuffleBtn = root.querySelector('.shuffle');
      const snapBtn = root.querySelector('.snap');
      const themeBtns = root.querySelectorAll('.swatch');
      const lens = root.querySelector('.lens');

      // Last updated
      const stamp = root.querySelector('#last-updated');
      try {
        const now = new Date();
        const fmt = new Intl.DateTimeFormat([], {
          year:'numeric', month:'short', day:'2-digit',
          hour:'2-digit', minute:'2-digit', second:'2-digit',
          hour12:true, timeZoneName:'short'
        });
        stamp.textContent = 'Updated ' + fmt.format(now);
      } catch { stamp.textContent = 'Updated ' + new Date().toLocaleString(); }

      // Theme persistence
      const savedTheme = localStorage.getItem('orrery-theme');
      if (savedTheme) root.setAttribute('data-theme', savedTheme);
      themeBtns.forEach(b => b.addEventListener('click', ()=>{
        const t = b.getAttribute('data-theme');
        root.setAttribute('data-theme', t);
        localStorage.setItem('orrery-theme', t);
        resize(true);
        seed();
      }));

      // Palettes
      function palette(){
        const t = root.getAttribute('data-theme') || 'dawn';
        if (t === 'dusk')  return ['#8ea2ff','#ff9cb0','#ffd77f','#79ffd8','#b1c0ff'];
        if (t === 'abyss') return ['#7fb5ff','#6dffde','#caa7ff','#9ad1ff','#8dc6ff'];
        if (t === 'bloom') return ['#ff9bd0','#ffa98a','#ffd97a','#a8ffcf','#ffc4e7'];
        if (t === 'paper') return ['#88aaff','#9bd6ff','#bfe7ff','#9ad1ff','#88aaff'];
        return ['#79e7ff','#ffb986','#a6ffd6','#ffd875','#a7ebff'];
      }

      // DPI & sizing
      const DPR = Math.min(2, window.devicePixelRatio || 1);
      let W=0, H=0, CX=0, CY=0, R=0;
      function resize(clearHard){
        const r = stage.getBoundingClientRect();
        W = Math.max(1, Math.floor(r.width));
        H = Math.max(1, Math.floor(r.height));
        CX = W/2; CY = H/2; R = Math.min(W,H)*0.42;
        canvas.width = Math.floor(W * DPR);
        canvas.height = Math.floor(H * DPR);
        canvas.style.width = W + 'px';
        canvas.style.height = H + 'px';
        ctx.setTransform(DPR,0,0,DPR,0,0);
        if (clearHard){ ctx.clearRect(0,0,W,H); drawStaticBackdrop(); }
      }
      const ro = new ResizeObserver(()=> resize(true));
      ro.observe(stage);
      window.addEventListener('orientationchange', ()=> setTimeout(()=>resize(true), 120));

      // State
      let speed = parseFloat(localStorage.getItem('orrery-speed') ?? '1.0');
      let density = parseInt(localStorage.getItem('orrery-density') ?? '8', 10); // rings
      let trail = parseFloat(localStorage.getItem('orrery-trail') ?? '0.04');

      speedInput.value = String(speed);
      densityInput.value = String(density);
      trailInput.value = String(trail);

      speedInput.addEventListener('input', e => {
        speed = parseFloat(e.target.value || '1');
        localStorage.setItem('orrery-speed', String(speed));
      });
      densityInput.addEventListener('input', e => {
        density = parseInt(e.target.value || '8', 10);
        localStorage.setItem('orrery-density', String(density));
        seed();
      });
      trailInput.addEventListener('input', e => {
        trail = parseFloat(e.target.value || '0.04');
        localStorage.setItem('orrery-trail', String(trail));
      });

      // Pseudo-random
      let SEED = Math.random()*10000;
      const rand = (n=1)=> {
        // xorshift-like
        let x = Math.sin(SEED++)*10000;
        return (x - Math.floor(x)) * n;
      };
      function seed(){
        SEED = Math.random()*10000;
        buildStars();
      }
      shuffleBtn.addEventListener('click', seed);

      // Stars
      let stars = [];
      function buildStars(){
        const count = Math.floor(80 + rand(120));
        stars = new Array(count).fill(0).map(()=> ({
          x: rand(W), y: rand(H), r: 0.5 + rand(1.5),
          a: 0.2 + rand(0.5)
        }));
      }

      function drawStaticBackdrop(){
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = (getThemeName() === 'paper')
          ? 'rgba(245,248,252,1)'
          : (getThemeName() === 'dawn' ? 'rgba(255,255,255,1)' : 'rgba(10,12,24,1)');
        ctx.fillRect(0,0,W,H);
        drawStars(1.0);
      }

      function drawStars(alpha=1){
        ctx.save();
        ctx.globalCompositeOperation = 'screen';
        for (const s of stars){
          ctx.fillStyle = `rgba(255,255,255,${s.a * alpha})`;
          ctx.beginPath();
          ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
          ctx.fill();
        }
        ctx.restore();
      }

      // Entities
      function getThemeName(){ return root.getAttribute('data-theme') || 'dawn'; }
      function hexToRGBA(hex, a){
        let h = hex.replace('#','');
        if (h.length === 3) h = h.split('').map(c=>c+c).join('');
        const r = parseInt(h.slice(0,2),16);
        const g = parseInt(h.slice(2,4),16);
        const b = parseInt(h.slice(4,6),16);
        return `rgba(${r},${g},${b},${a})`;
      }

      // Lens / pointer
      const pointer = { x:0.5, y:0.5, inside:false, px:CX, py:CY };
      function setPointer(eX, eY){
        const r = stage.getBoundingClientRect();
        const x = eX - r.left, y = eY - r.top;
        pointer.x = x / r.width;
        pointer.y = y / r.height;
        pointer.px = x; pointer.py = y;
        pointer.inside = true;
        lens.style.transform = `translate(${x - 110}px, ${y - 110}px)`;
      }
      stage.addEventListener('mousemove', e => setPointer(e.clientX, e.clientY));
      stage.addEventListener('mouseenter', e => { setPointer(e.clientX, e.clientY); lens.style.opacity='0.9'; });
      stage.addEventListener('mouseleave', ()=> { pointer.inside = false; lens.style.opacity='0'; });

      // Comets
      let comets = [];
      function addComet(x, y){
        const angle = Math.atan2(y - CY, x - CX);
        const speedC = 120 + rand(80);
        comets.push({
          x, y,
          vx: Math.cos(angle)*speedC,
          vy: Math.sin(angle)*speedC,
          life: 1.0,
          hue: palette()[Math.floor(rand(palette().length))],
        });
      }
      stage.addEventListener('click', e => {
        const r = stage.getBoundingClientRect();
        addComet(e.clientX - r.left, e.clientY - r.top);
      });
      pulseBtn.addEventListener('click', ()=> addComet(CX, CY));

      // Controls
      let paused = matchMedia('(prefers-reduced-motion: reduce)').matches;
      function setPaused(p){
        paused = p;
        playBtn.setAttribute('aria-pressed', String(p));
        playBtn.textContent = p ? 'Resume' : 'Pause';
      }
      playBtn.addEventListener('click', ()=> setPaused(!paused));
      setPaused(paused);

      function snapshot(){
        try {
          const link = document.createElement('a');
          link.download = 'orrery.png';
          link.href = canvas.toDataURL('image/png');
          link.click();
        } catch {}
      }
      snapBtn.addEventListener('click', snapshot);

      // Keyboard
      root.tabIndex = 0;
      root.addEventListener('keydown', (e)=>{
        const k = e.key.toLowerCase();
        if (e.code === 'Space'){ e.preventDefault(); setPaused(!paused); }
        if (k === 's'){ snapshot(); }
        if (k === '1'){ themeBtns[0].click(); }
        if (k === '2'){ themeBtns[1].click(); }
        if (k === '3'){ themeBtns[2].click(); }
        if (k === '4'){ themeBtns[3].click(); }
        if (k === '5'){ themeBtns[4].click(); }
      });

      // Animation
      let t0 = performance.now();
      function tick(now){
        const dt = Math.min(0.05, (now - t0)/1000);
        t0 = now;

        // Tilt
        const nx = (pointer.inside ? (pointer.x - 0.5) : 0) * 2;
        const ny = (pointer.inside ? (pointer.y - 0.5) : 0) * 2;
        stage.style.transform = `perspective(1000px) rotateX(${ny * -6}deg) rotateY(${nx * 10}deg) translateZ(0)`;

        if (!paused){
          // Trail fade
          ctx.globalCompositeOperation = 'source-over';
          const fade = Math.max(0, Math.min(1, trail));
          const back = getThemeName() === 'dawn' ? '255,255,255' : '10,12,24';
          ctx.fillStyle = `rgba(${back}, ${fade})`;
          ctx.fillRect(0,0,W,H);

          // Stars (twinkle)
          drawStars(0.4);

          const P = palette();
          const rings = Math.max(3, density);
          const maxR = R * 0.98;
          const minR = R * 0.18;

          // Central glow
          const cg = ctx.createRadialGradient(CX, CY, 0, CX, CY, maxR*0.6);
          cg.addColorStop(0, hexToRGBA('#ffffff', 0.14));
          cg.addColorStop(1, hexToRGBA('#ffffff', 0.0));
          ctx.globalCompositeOperation = 'lighter';
          ctx.fillStyle = cg; ctx.beginPath(); ctx.arc(CX, CY, maxR*0.6, 0, Math.PI*2); ctx.fill();

          // Orbits & nodes
          const t = now * 0.00025 * speed;
          for (let j = 0; j < rings; j++){
            const frac = j/(rings-1 || 1);
            const r = minR + (maxR - minR) * (0.08 + frac * 0.92);
            const hue = P[j % P.length];
            const wobble = Math.sin(t*8 + j)*0.6 + Math.cos(t*5 + j*0.7)*0.4;
            const nodes = 5 + ((j*2) % 9); // varied node count per ring

            // Orbit ring
            ctx.globalCompositeOperation = 'screen';
            ctx.lineWidth = 1.25;
            ctx.strokeStyle = hexToRGBA(hue, 0.14 + 0.12*frac);
            ctx.beginPath(); ctx.arc(CX, CY, r + wobble, 0, Math.PI*2); ctx.stroke();

            // Nodes & chords
            for (let k = 0; k < nodes; k++){
              const baseA = (k/nodes) * Math.PI*2;
              const a = baseA + Math.sin(t* (1.2 + j*0.18) + k*0.3 + SEED*0.01) * (0.4 - frac*0.28);
              const x = CX + Math.cos(a) * (r + wobble);
              const y = CY + Math.sin(a) * (r + wobble);

              // Node
              const ng = ctx.createRadialGradient(x, y, 0, x, y, 18);
              ng.addColorStop(0, hexToRGBA(hue, 0.9));
              ng.addColorStop(1, hexToRGBA(hue, 0.0));
              ctx.fillStyle = ng;
              ctx.beginPath(); ctx.arc(x, y, 18, 0, Math.PI*2); ctx.fill();
              ctx.fillStyle = 'rgba(255,255,255,0.95)';
              ctx.beginPath(); ctx.arc(x, y, 1.8 + (k%3===0 ? 0.6 : 0), 0, Math.PI*2); ctx.fill();

              // Chord to pointer gravity
              if (pointer.inside && k % 2 === j % 2){
                ctx.lineWidth = 1.0;
                ctx.strokeStyle = hexToRGBA(hue, 0.12);
                ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(pointer.px, pointer.py); ctx.stroke();
              }

              // Lazy chords to inner ring (visual weave)
              if (j > 0 && k % 3 === 0){
                const jj = j-1;
                const r2 = minR + (maxR - minR) * (0.08 + (jj/(rings-1 || 1))*0.92);
                const a2 = baseA * 1.3 + Math.cos(t* (1.4 + j*0.2) + k*0.5) * 0.25;
                const x2 = CX + Math.cos(a2) * r2;
                const y2 = CY + Math.sin(a2) * r2;
                ctx.lineWidth = 0.9;
                ctx.strokeStyle = hexToRGBA(P[jj % P.length], 0.10);
                ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x2, y2); ctx.stroke();
              }
            }
          }

          // Comets
          for (let i=comets.length-1; i>=0; i--){
            const c = comets[i];
            const g = ctx.createRadialGradient(c.x, c.y, 0, c.x, c.y, 44);
            g.addColorStop(0, hexToRGBA(c.hue, 0.9*c.life));
            g.addColorStop(1, hexToRGBA(c.hue, 0.0));
            ctx.fillStyle = g;
            ctx.globalCompositeOperation = 'lighter';
            ctx.beginPath(); ctx.arc(c.x, c.y, 44, 0, Math.PI*2); ctx.fill();

            // Trail streak
            ctx.lineWidth = 2;
            ctx.strokeStyle = hexToRGBA(c.hue, 0.28*c.life);
            ctx.beginPath(); ctx.moveTo(c.x, c.y);
            ctx.lineTo(c.x - c.vx*0.06, c.y - c.vy*0.06);
            ctx.stroke();

            c.x += c.vx * dt;
            c.y += c.vy * dt;
            c.vx *= (0.992 - 0.002*speed);
            c.vy *= (0.992 - 0.002*speed);
            c.life -= dt*0.35;
            if (c.life <= 0 || c.x < -60 || c.x > W+60 || c.y < -60 || c.y > H+60) comets.splice(i,1);
          }
        }

        requestAnimationFrame(tick);
      }

      // Init
      resize(true);
      seed();
      requestAnimationFrame(tick);

      // Reduced motion: still composition
      if (matchMedia('(prefers-reduced-motion: reduce)').matches){
        setPaused(true);
        drawStaticBackdrop();
        const P = palette();
        const rings = Math.max(3, density);
        const maxR = R * 0.98;
        const minR = R * 0.18;
        for (let j = 0; j < rings; j++){
          const r = minR + (maxR - minR) * (0.08 + (j/(rings-1 || 1)) * 0.92);
          ctx.lineWidth = 1.2;
          ctx.strokeStyle = hexToRGBA(P[j % P.length], 0.22);
          ctx.beginPath(); ctx.arc(CX, CY, r, 0, Math.PI*2); ctx.stroke();
        }
      }
    })();
  </script>
</section>
      </section>
      <!-- END_EDITABLE -->
    <script>
      // Only show a local placeholder if the agent hasn't written a timestamp yet
      const el = document.getElementById('last-updated');
      if (el && (!el.textContent || el.textContent.includes('not yet'))) {
        const now = new Date();
        el.textContent = `Last updated: ${now.toLocaleString(undefined, { hour12: false })}`;
      }
    </script>
  </body>
  </html>


