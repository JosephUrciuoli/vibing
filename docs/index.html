<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vibing</title>
    <style>
      :root {
        --bg: #0f1221;
        --fg: #e6e8f0;
        --muted: #9aa3b2;
        --accent: #8b5cf6;
      }
      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--fg);
        background: radial-gradient(1200px 800px at 70% 10%, #1b1f3a, var(--bg));
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        width: min(720px, 92vw);
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px;
        padding: 28px 24px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        backdrop-filter: blur(6px);
      }
      h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
        letter-spacing: 0.3px;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 18px;
      }
      #content {
        font-size: 18px;
        line-height: 1.6;
        background: rgba(255,255,255,0.04);
        border: 1px dashed rgba(255,255,255,0.12);
        border-radius: 12px;
        padding: 16px;
      }
      .footer {
        margin-top: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: var(--muted);
      }
      .badge {
        display: inline-block;
        background: rgba(139, 92, 246, 0.18);
        color: #d4c2ff;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(139, 92, 246, 0.35);
        letter-spacing: 0.2px;
      }
    </style>
  </head>
  <body>
    <!-- BEGIN_EDITABLE -->
      <section id="content">
<div id="vibe1584" data-theme="ivory" aria-live="polite">
  <style>
    /* Core tokens */
    #vibe1584{
      --paper:#fcfcff;
      --ink:#11131a;
      --muted:#5e667a;
      --edge:rgba(17,19,26,.14);
      --a1:#3a78ff; /* cobalt */
      --a2:#10d2b8; /* mint */
      --a3:#ff7aa2; /* bloom */
      --a4:#ffc14d; /* honey */
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--ink);
      border-radius:28px;
      padding:clamp(14px,3.6vw,42px);
      background:
        radial-gradient(120% 140% at 0% 0%, color-mix(in oklab, var(--a2) 14%, transparent), transparent 38%),
        radial-gradient(140% 160% at 100% 120%, color-mix(in oklab, var(--a3) 12%, transparent), transparent 46%),
        linear-gradient(180deg, #fff, var(--paper));
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.85),
        0 28px 80px rgba(17,19,26,.12);
      position:relative;
      overflow:hidden;
      isolation:isolate;
    }

    /* Subtle print texture */
    #vibe1584::before{
      content:""; position:absolute; inset:0; pointer-events:none; z-index:0;
      background:
        repeating-linear-gradient(0deg, rgba(0,0,0,.015), rgba(0,0,0,.015) 1px, transparent 1px, transparent 3px),
        linear-gradient(180deg, transparent 0%, rgba(255,255,255,.3) 50%, transparent 100%);
      mix-blend-mode:multiply; opacity:.6;
    }

    /* Top bar */
    #vibe1584 .bar{
      display:grid; grid-template-columns:auto 1fr auto; gap:14px; align-items:center; position:relative; z-index:2;
    }
    #vibe1584 .mark{
      display:inline-flex; align-items:center; gap:10px; padding:10px 14px; border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.6));
      border:1px solid var(--edge);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.95), 0 10px 24px rgba(17,19,26,.10);
      font-weight:900; letter-spacing:.16em; text-transform:uppercase; font-size:11px;
    }
    #vibe1584 .glyph{
      width:16px; height:16px; border-radius:4px; transform: rotate(45deg);
      background:conic-gradient(from 0deg, var(--a1), var(--a3), var(--a4), var(--a2), var(--a1));
      box-shadow: 0 0 0 6px rgba(58,120,255,.12), 0 16px 30px rgba(17,19,26,.16);
    }
    #vibe1584 .badge{ color:var(--muted); font-weight:700; font-size:12px; opacity:.95; }

    /* Theme chips */
    #vibe1584 .themes{ display:flex; gap:8px; }
    #vibe1584 .chip{
      appearance:none; border:1px solid var(--edge);
      background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.6));
      color:var(--ink);
      padding:8px 12px; border-radius:999px; font-weight:900; font-size:11px; letter-spacing:.08em; text-transform:uppercase; cursor:pointer;
      box-shadow: inset 0 1px 0 rgba(255,255,255,1), 0 10px 22px rgba(17,19,26,.08);
      transition: transform 120ms ease, box-shadow 200ms ease, background 200ms ease, color 200ms ease, opacity 200ms ease;
      will-change: transform;
    }
    #vibe1584 .chip:hover{ transform: translateY(-1px); box-shadow: inset 0 1px 0 rgba(255,255,255,1), 0 18px 36px rgba(17,19,26,.16); }
    #vibe1584 .chip[aria-checked="true"]{
      background: linear-gradient(180deg, color-mix(in oklab, var(--a2) 80%, white), white);
      color:#0d141f;
    }

    /* Hero */
    #vibe1584 .hero{ margin: clamp(10px,3.2vw,28px) 0 6px; position:relative; z-index:2; }
    #vibe1584 .title{
      margin:0; line-height:.86; letter-spacing:-0.02em; font-weight:1000;
      font-size: clamp(46px, 9.8vw, 128px);
      background:
        linear-gradient(90deg, var(--ink), color-mix(in oklab, var(--a1) 60%, var(--ink)) 45%, color-mix(in oklab, var(--a3) 55%, var(--ink)));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-wrap:balance;
    }
    #vibe1584 .sub{ margin:.55rem 0 0; color:var(--muted); font-size: clamp(14px,2.1vw,18px); }

    /* Stage */
    #vibe1584 .stage{
      position:relative; margin-top: clamp(18px,3.4vw,34px);
      height: clamp(380px, 56vw, 720px); border-radius:22px; overflow:hidden;
      background:
        radial-gradient(140% 120% at 50% 50%, rgba(255,255,255,.9), rgba(255,255,255,.55) 60%, rgba(255,255,255,.28) 100%);
      border:1px solid var(--edge);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.85),
        inset 0 -1px 0 rgba(255,255,255,.55),
        0 28px 76px rgba(17,19,26,.18);
    }
    #vibe1584 canvas#field{ position:absolute; inset:0; width:100%; height:100%; display:block; z-index:1; }
    #vibe1584 .rulers{
      position:absolute; inset:0; z-index:2; pointer-events:none; opacity:.32; mix-blend-mode: overlay;
      background-image:
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='180' height='180' viewBox='0 0 180 180'><g fill='none' stroke='rgba(17,19,26,0.08)' stroke-width='1'><path d='M0 90h180M90 0v180'/><circle cx='90' cy='90' r='88' stroke-dasharray='4 6'/></g></svg>");
      background-size: 180px 180px;
    }

    /* HUD */
    #vibe1584 .hud{
      position:absolute; left:12px; right:12px; bottom:12px; z-index:3;
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
      background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.65));
      backdrop-filter: blur(10px);
      border:1px solid var(--edge);
      border-radius:14px; padding:10px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.95);
    }
    #vibe1584 .group{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    #vibe1584 .btn{
      appearance:none; border:1px solid var(--edge);
      background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.7)); color:var(--ink);
      padding:8px 12px; border-radius:10px; font-weight:900; cursor:pointer; font-size:12px;
      box-shadow: 0 12px 24px rgba(17,19,26,.12), inset 0 1px 0 rgba(255,255,255,1);
      transition: transform 120ms ease, box-shadow 180ms ease, background 220ms ease, color 200ms ease;
    }
    #vibe1584 .btn:hover{ transform: translateY(-1px); box-shadow: 0 18px 38px rgba(17,19,26,.18), inset 0 1px 0 rgba(255,255,255,1); }
    #vibe1584 .range{
      display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:10px; border:1px solid var(--edge);
      background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.65));
      box-shadow: inset 0 1px 0 rgba(255,255,255,1);
      font-weight:800; font-size:12px; color:var(--muted);
    }
    #vibe1584 input[type="range"]{
      appearance:none; height:6px; width:140px; background:linear-gradient(90deg, var(--a1), var(--a3)); border-radius:999px; outline:none;
    }
    #vibe1584 input[type="range"]::-webkit-slider-thumb{
      appearance:none; width:16px; height:16px; border-radius:50%; background: white; border:1px solid var(--edge); box-shadow:0 2px 6px rgba(17,19,26,.2);
    }
    #vibe1584 .val{ font-variant-numeric: tabular-nums; color:var(--ink); }

    /* Footer */
    #vibe1584 .foot{ margin-top:16px; display:flex; align-items:center; justify-content:space-between; gap:10px; color:var(--muted); font-size:12px; z-index:2; position:relative; }
    #vibe1584 #last-updated{
      font-variant-numeric: tabular-nums; font-weight:900; color:var(--ink);
      background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.7));
      border:1px solid var(--edge);
      padding:6px 10px; border-radius:10px; box-shadow: inset 0 1px 0 rgba(255,255,255,1);
    }

    /* Themes */
    #vibe1584[data-theme="ivory"]{
      --paper:#fcfcff; --ink:#11131a; --muted:#5e667a; --edge:rgba(17,19,26,.14);
      --a1:#3a78ff; --a2:#10d2b8; --a3:#ff7aa2; --a4:#ffc14d;
    }
    #vibe1584[data-theme="graphite"]{
      --paper:#0c0f14; --ink:#e8f0ff; --muted:#9fb3d4; --edge:rgba(255,255,255,.16);
      --a1:#79a7ff; --a2:#6ef3cd; --a3:#ff8bbd; --a4:#ffd06e;
      background:
        radial-gradient(160% 140% at 10% -10%, color-mix(in oklab, var(--a2) 18%, transparent), transparent 40%),
        radial-gradient(180% 160% at 120% 120%, color-mix(in oklab, var(--a3) 18%, transparent), transparent 50%),
        linear-gradient(180deg, #0d121a, #0c0f14);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.08),
        0 28px 80px rgba(0,0,0,.5);
    }
    #vibe1584[data-theme="vapor"]{
      --paper:#eef7ff; --ink:#0e1220; --muted:#596987; --edge:rgba(14,18,32,.14);
      --a1:#6b9bff; --a2:#8af3da; --a3:#bd89ff; --a4:#ffd78a;
    }
    #vibe1584[data-theme="citrus"]{
      --paper:#fff8ed; --ink:#17130f; --muted:#6e5f51; --edge:rgba(23,19,15,.14);
      --a1:#ff7a3a; --a2:#26d69a; --a3:#ffb36d; --a4:#2f6df6;
    }

    /* Responsive */
    @media (max-width:760px){
      #vibe1584 .bar{ grid-template-columns:1fr; }
      #vibe1584 .badge{ display:none; }
      #vibe1584 .title{ font-size: clamp(40px, 12vw, 110px); }
      #vibe1584 input[type="range"]{ width:100px; }
    }
    @media (prefers-reduced-motion: reduce){
      #vibe1584 .title{ transition:none; }
    }
  </style>

  <div class="bar">
    <span class="mark"><span class="glyph" aria-hidden="true"></span>FIELD</span>
    <div class="badge" aria-hidden="true">v1584 — Kinetic Print Lab</div>
    <div class="themes" role="radiogroup" aria-label="Theme">
      <button type="button" class="chip theme" data-theme="ivory" aria-checked="true">Ivory</button>
      <button type="button" class="chip theme" data-theme="graphite" aria-checked="false">Graphite</button>
      <button type="button" class="chip theme" data-theme="vapor" aria-checked="false">Vapor</button>
      <button type="button" class="chip theme" data-theme="citrus" aria-checked="false">Citrus</button>
    </div>
  </div>

  <div class="hero">
    <h1 class="title" role="heading" aria-level="1">FLOWFIELD POSTER ENGINE</h1>
    <p class="sub">A living print: steer the wind, then save the moment.</p>
  </div>

  <div class="stage" role="img" aria-label="Flowing vector field composing colorful strokes">
    <canvas id="field"></canvas>
    <div class="rulers" aria-hidden="true"></div>
    <div class="hud" role="group" aria-label="Controls">
      <div class="group" role="radiogroup" aria-label="Style">
        <button type="button" class="chip mode" data-mode="ribbon" aria-checked="true">Ribbon</button>
        <button type="button" class="chip mode" data-mode="dots" aria-checked="false">Dots</button>
        <button type="button" class="chip mode" data-mode="spray" aria-checked="false">Spray</button>
      </div>
      <div class="group">
        <label class="range" for="density">Density <span class="val" id="densityVal">900</span>
          <input id="density" type="range" min="300" max="2400" step="100" value="900" aria-label="Particle density">
        </label>
        <label class="range" for="flow">Flow <span class="val" id="flowVal">1.0</span>
          <input id="flow" type="range" min="0.6" max="3" step="0.1" value="1.0" aria-label="Flow speed">
        </label>
        <label class="range" for="tail">Tail <span class="val" id="tailVal">0.06</span>
          <input id="tail" type="range" min="0" max="0.18" step="0.01" value="0.06" aria-label="Trail persistence">
        </label>
      </div>
      <div class="group">
        <button type="button" class="btn" id="shuffle">Shuffle</button>
        <button type="button" class="btn" id="toggle">Pause</button>
        <button type="button" class="btn" id="save">Save Poster</button>
        <button type="button" class="btn" id="record">Record 5s</button>
      </div>
    </div>
  </div>

  <div class="foot">
    <span>“Order emerges from motion.”</span>
    <span id="last-updated">Last updated: 2025-12-28 12:16:17 EST</span>
  </div>

  <script>
    (function(){
      const root = document.getElementById('vibe1584');

      // Last updated
      const lu = root.querySelector('#last-updated');
      try{
        const now = new Date();
        const opts = { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' };
        lu.textContent = 'Updated ' + now.toLocaleString([], opts);
      }catch(e){}

      // Elements
      const canvas = root.querySelector('#field');
      const ctx = canvas.getContext('2d', { alpha:true });
      const stage = root.querySelector('.stage');
      let dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));

      function fit(){
        const r = stage.getBoundingClientRect();
        canvas.width = Math.floor(r.width * dpr);
        canvas.height = Math.floor(r.height * dpr);
        canvas.style.width = r.width + 'px';
        canvas.style.height = r.height + 'px';
        ctx.setTransform(1,0,0,1,0,0);
      }
      fit();
      window.addEventListener('resize', ()=>{ dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1)); fit(); resetParticles(true); });

      // Utilities
      const lerp = (a,b,t)=>a+(b-a)*t;
      function cssVar(name){ return getComputedStyle(root).getPropertyValue(name).trim() || '#ffffff'; }
      function hexToRgb(hex){ let h = hex.replace('#','').trim(); if(h.length===3){ h=h.split('').map(x=>x+x).join(''); } const n=parseInt(h,16); return [(n>>16)&255,(n>>8)&255,n&255]; }
      function rgba(c,a){ return `rgba(${c[0]},${c[1]},${c[2]},${a})`; }
      function flash(el){ try{ el.animate([{ filter:'saturate(160%) brightness(1.05)' }, { filter:'saturate(115%) brightness(1)' }], { duration:420, easing:'cubic-bezier(.2,.8,.2,1)' }); }catch(_){ } }

      // Palette
      function readPalette(){ return ['--a1','--a2','--a3','--a4'].map(k=>hexToRgb(cssVar(k))); }
      let palette = readPalette();

      // Theme switching
      const themeBtns = Array.from(root.querySelectorAll('.theme'));
      function setTheme(btn){
        themeBtns.forEach(b=>b.setAttribute('aria-checked', String(b===btn)));
        root.setAttribute('data-theme', btn.dataset.theme);
        palette = readPalette();
        resetParticles();
        flash(btn);
      }
      themeBtns.forEach(b=>{
        b.addEventListener('click', ()=> setTheme(b));
        b.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); setTheme(b); }});
      });

      // Modes
      const modeBtns = Array.from(root.querySelectorAll('.mode'));
      let mode = 'ribbon';
      function setMode(btn){
        modeBtns.forEach(b=>b.setAttribute('aria-checked', String(b===btn)));
        mode = btn.dataset.mode;
        resetParticles();
        flash(btn);
      }
      modeBtns.forEach(b=>{
        b.addEventListener('click', ()=> setMode(b));
        b.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); setMode(b); }});
      });

      // Controls
      const densityEl = root.querySelector('#density');
      const flowEl = root.querySelector('#flow');
      const tailEl = root.querySelector('#tail');
      const densVal = root.querySelector('#densityVal');
      const flowVal = root.querySelector('#flowVal');
      const tailVal = root.querySelector('#tailVal');
      function syncVals(){
        densVal.textContent = densityEl.value;
        flowVal.textContent = parseFloat(flowEl.value).toFixed(1);
        tailVal.textContent = parseFloat(tailEl.value).toFixed(2);
      }
      syncVals();
      ['input','change'].forEach(ev=>{
        densityEl.addEventListener(ev, ()=>{ syncVals(); resetParticles(); });
        flowEl.addEventListener(ev, ()=>{ syncVals(); });
        tailEl.addEventListener(ev, ()=>{ syncVals(); });
      });

      // Random seed
      let seed = Math.floor(Math.random()*1e9);
      function mulberry32(a){ return function(){ let t = a += 0x6D2B79F5; t = Math.imul(t ^ t>>>15, t | 1); t ^= t + Math.imul(t ^ t>>>7, t | 61); return ((t ^ t>>>14) >>> 0) / 4294967296; } }
      let rng = mulberry32(seed);
      function reseed(){
        seed = Math.floor(Math.random()*1e9);
        rng = mulberry32(seed);
      }

      // Value noise (seeded)
      function hash2(ix, iy){
        // Thomas Wang-ish integer hash
        let n = ix * 374761393 + iy * 668265263 + seed;
        n = (n ^ (n >> 13)) >>> 0;
        n = Math.imul(n, 1274126177) >>> 0;
        return (n & 0x7fffffff) / 0x7fffffff;
      }
      function smooth(t){ return t*t*(3-2*t); }
      function noise2(x, y){
        const xi = Math.floor(x), yi = Math.floor(y);
        const xf = x - xi, yf = y - yi;
        const v00 = hash2(xi, yi);
        const v10 = hash2(xi+1, yi);
        const v01 = hash2(xi, yi+1);
        const v11 = hash2(xi+1, yi+1);
        const u = smooth(xf), v = smooth(yf);
        const a = lerp(v00, v10, u);
        const b = lerp(v01, v11, u);
        return lerp(a, b, v);
      }

      // Particles
      let particles = [];
      let t = 0;
      const pointer = { x:0.5, y:0.5, active:false };
      function resetParticles(keep=false){
        const w = canvas.width, h = canvas.height;
        const count = parseInt(densityEl.value, 10);
        if(!keep){ particles = []; }
        const pal = palette;
        if(particles.length !== count){
          particles = new Array(count).fill(0).map((_,i)=>{
            const px = (rng()) * w, py = (rng()) * h;
            return {
              x:px, y:py, px:px, py:py,
              col: pal[i % pal.length],
              size: (mode==='dots'? 1.6 : 1.2) * dpr + rng()*0.8*dpr,
            };
          });
        }else{
          // lightly shuffle colors on theme change
          for(let i=0;i<particles.length;i++){ particles[i].col = pal[i % pal.length]; }
        }
        ctx.clearRect(0,0,w,h);
      }
      resetParticles();

      // Pointer influence
      function onPoint(e){
        const r = stage.getBoundingClientRect();
        const pt = e.touches ? e.touches[0] : e;
        pointer.x = Math.max(0, Math.min(1, (pt.clientX - r.left) / r.width));
        pointer.y = Math.max(0, Math.min(1, (pt.clientY - r.top) / r.height));
        pointer.active = true;
      }
      function offPoint(){ pointer.active = false; }
      stage.addEventListener('pointermove', onPoint, { passive:true });
      stage.addEventListener('pointerleave', offPoint, { passive:true });
      stage.addEventListener('touchmove', onPoint, { passive:true });
      stage.addEventListener('touchend', offPoint, { passive:true });

      // Buttons
      const shuffleBtn = root.querySelector('#shuffle');
      const toggleBtn = root.querySelector('#toggle');
      const saveBtn = root.querySelector('#save');
      const recordBtn = root.querySelector('#record');

      shuffleBtn.addEventListener('click', ()=>{
        reseed(); palette = readPalette(); resetParticles();
        flash(shuffleBtn);
      });

      let running = true;
      toggleBtn.addEventListener('click', ()=>{
        running = !running;
        toggleBtn.textContent = running ? 'Pause' : 'Play';
        if(running) requestAnimationFrame(loop);
      });

      saveBtn.addEventListener('click', ()=>{
        try{
          const rect = canvas.getBoundingClientRect();
          const scale = 2;
          const off = document.createElement('canvas');
          off.width = Math.floor(rect.width*scale);
          off.height = Math.floor(rect.height*scale);
          const octx = off.getContext('2d');
          // fill poster background to theme paper
          octx.fillStyle = getComputedStyle(root).getPropertyValue('--paper').trim() || '#ffffff';
          octx.fillRect(0,0,off.width,off.height);
          octx.drawImage(canvas, 0, 0, off.width, off.height);
          off.toBlob((blob)=>{
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'flowfield-1584.png';
            document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
          });
          flash(saveBtn);
        }catch(e){}
      });

      // Recording (5s webm)
      let recording = false;
      recordBtn.addEventListener('click', ()=>{
        if(recording) return;
        try{
          const stream = canvas.captureStream(60);
          const rec = new MediaRecorder(stream, { mimeType:'video/webm;codecs=vp9' });
          const chunks = [];
          rec.ondataavailable = e=>{ if(e.data.size) chunks.push(e.data); };
          rec.onstop = ()=>{
            const blob = new Blob(chunks, { type:'video/webm' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'flowfield-1584.webm';
            document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
            recording = false; recordBtn.textContent = 'Record 5s';
          };
          rec.start();
          recording = true; recordBtn.textContent = 'Recording…';
          setTimeout(()=> rec.stop(), 5000);
          flash(recordBtn);
        }catch(e){}
      });

      // Draw loop
      function step(){
        const w = canvas.width, h = canvas.height;
        const flow = parseFloat(flowEl.value);
        const tail = parseFloat(tailEl.value);
        const light = root.getAttribute('data-theme')!=='graphite';
        const fade = Math.min(0.4, Math.max(0, tail));
        if(fade>0){
          ctx.fillStyle = light ? `rgba(255,255,255,${fade})` : `rgba(12,15,20,${fade})`;
          ctx.fillRect(0,0,w,h);
        }else{
          ctx.clearRect(0,0,w,h);
        }

        ctx.globalCompositeOperation = light ? 'multiply' : 'screen';

        // parameters for noise space
        const freq = 0.0012 * (w+h) * 0.001;
        const timeFlow = t * 0.2;

        const cx = w * pointer.x;
        const cy = h * pointer.y;

        for(let i=0;i<particles.length;i++){
          const p = particles[i];
          p.px = p.x; p.py = p.y;

          // field angle from value noise
          const nx = p.x * freq, ny = p.y * freq;
          let angle = noise2(nx + timeFlow, ny - timeFlow) * Math.PI * 4;

          // pointer influence
          if(pointer.active){
            const dx = (cx - p.x), dy = (cy - p.y);
            const dist = Math.hypot(dx, dy) + 1e-5;
            const pull = Math.min(1, 120 * dpr / dist);
            angle = angle * (1 - pull*0.35) + Math.atan2(dy, dx) * (pull*0.35);
          }

          // move
          const speed = (0.7 + (i%7)/12) * 0.6 * dpr * flow;
          p.x += Math.cos(angle) * speed;
          p.y += Math.sin(angle) * speed;

          // wrap
          if(p.x < -2) p.x = w+2; else if(p.x > w+2) p.x = -2;
          if(p.y < -2) p.y = h+2; else if(p.y > h+2) p.y = -2;

          // draw
          if(mode==='ribbon'){
            ctx.lineWidth = Math.max(0.8*dpr, p.size*0.85);
            const col = p.col;
            const grad = ctx.createLinearGradient(p.px, p.py, p.x, p.y);
            grad.addColorStop(0, rgba(col, light ? 0.20 : 0.55));
            grad.addColorStop(1, rgba(col, light ? 0.35 : 0.8));
            ctx.strokeStyle = grad;
            ctx.beginPath();
            ctx.moveTo(p.px, p.py);
            ctx.lineTo(p.x, p.y);
            ctx.stroke();
          }else if(mode==='dots'){
            ctx.fillStyle = rgba(p.col, light ? 0.30 : 0.75);
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size*0.9, 0, Math.PI*2);
            ctx.fill();
          }else{ // spray
            ctx.strokeStyle = rgba(p.col, light ? 0.25 : 0.7);
            ctx.lineWidth = p.size*0.7;
            ctx.beginPath();
            const vx = p.x - p.px, vy = p.y - p.py;
            ctx.moveTo(p.x, p.y);
            ctx.lineTo(p.x - vx*2.2, p.y - vy*2.2);
            ctx.stroke();
          }
        }

        // center halo for composition anchor
        ctx.globalCompositeOperation = light ? 'multiply' : 'screen';
        const iris = hexToRgb(cssVar('--a2'));
        ctx.beginPath();
        ctx.arc(w*0.5, h*0.5, Math.min(w,h)*0.34, 0, Math.PI*2);
        ctx.strokeStyle = rgba(iris, light ? 0.06 : 0.14);
        ctx.lineWidth = 2*dpr;
        ctx.stroke();

        t += 0.006;
      }

      function loop(){
        if(!running) return;
        step();
        requestAnimationFrame(loop);
      }
      requestAnimationFrame(loop);
    }());
  </script>
</div>
      </section>
      <!-- END_EDITABLE -->
    <script>
      // Only show a local placeholder if the agent hasn't written a timestamp yet
      const el = document.getElementById('last-updated');
      if (el && (!el.textContent || el.textContent.includes('not yet'))) {
        const now = new Date();
        el.textContent = `Last updated: ${now.toLocaleString(undefined, { hour12: false })}`;
      }
    </script>
  </body>
  </html>


