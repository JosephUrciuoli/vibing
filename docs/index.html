<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vibing</title>
    <style>
      :root {
        --bg: #0f1221;
        --fg: #e6e8f0;
        --muted: #9aa3b2;
        --accent: #8b5cf6;
      }
      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--fg);
        background: radial-gradient(1200px 800px at 70% 10%, #1b1f3a, var(--bg));
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        width: min(720px, 92vw);
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px;
        padding: 28px 24px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        backdrop-filter: blur(6px);
      }
      h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
        letter-spacing: 0.3px;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 18px;
      }
      #content {
        font-size: 18px;
        line-height: 1.6;
        background: rgba(255,255,255,0.04);
        border: 1px dashed rgba(255,255,255,0.12);
        border-radius: 12px;
        padding: 16px;
      }
      .footer {
        margin-top: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: var(--muted);
      }
      .badge {
        display: inline-block;
        background: rgba(139, 92, 246, 0.18);
        color: #d4c2ff;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(139, 92, 246, 0.35);
        letter-spacing: 0.2px;
      }
    </style>
  </head>
  <body>
    <!-- BEGIN_EDITABLE -->
      <section id="content">
<div id="vibe-1294" class="halo" aria-label="HALO Studio — living kaleidoscope">
  <style>
    /* HALO Studio — scoped to #vibe-1294 */
    #vibe-1294 {
      --ink: #e8f0ff;
      --muted: #a8b4cd;
      --bg-0: #060911;
      --bg-1: #0a1224;
      --p1: 130, 215, 255; /* ice */
      --p2: 255, 121, 170; /* bloom */
      --p3: 116, 255, 202; /* mint */
      color: var(--ink);
      position: relative;
      min-height: 960px;
      border-radius: 40px;
      overflow: hidden;
      isolation: isolate;
      background:
        radial-gradient(1400px 1000px at -10% -20%, rgba(var(--p2),0.12), transparent 60%),
        radial-gradient(1200px 1000px at 110% 120%, rgba(var(--p3),0.12), transparent 55%),
        linear-gradient(180deg, var(--bg-0), var(--bg-1));
      box-shadow:
        0 60px 180px rgba(2, 6, 20, 0.6),
        inset 0 0 0 1px rgba(255,255,255,0.05);
    }
    #vibe-1294::before {
      /* aurora veil */
      content: ""; position: absolute; inset: -20%; z-index: 0; pointer-events: none;
      background:
        conic-gradient(from 0deg at 30% 30%, rgba(var(--p1),0.22), rgba(var(--p2),0.18), rgba(var(--p3),0.22), rgba(var(--p1),0.22));
      filter: blur(80px) saturate(140%);
      animation: spin-1294 38s linear infinite;
      opacity: 0.6;
    }
    @keyframes spin-1294 { to { transform: rotate(360deg); } }
    #vibe-1294::after {
      /* ultra-fine grain */
      content: ""; position: absolute; inset: 0; z-index: 1; pointer-events: none;
      mix-blend-mode: soft-light; opacity: 0.16;
      background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 160 160'><filter id='g'><feTurbulence baseFrequency='0.9' numOctaves='2' seed='9'/><feColorMatrix type='saturate' values='0'/><feComponentTransfer><feFuncA type='table' tableValues='0 0.22'/></feComponentTransfer></filter><rect width='100%' height='100%' filter='url(%23g)'/></svg>") repeat;
      background-size: 220px 220px;
      transition: opacity 220ms ease;
    }
    #vibe-1294.grain-off::after { opacity: 0; }

    /* Top chrome */
    #vibe-1294 .chrome {
      position: relative; z-index: 3;
      display: flex; align-items: center; justify-content: space-between; gap: 16px;
      padding: clamp(16px, 4vw, 28px);
    }
    #vibe-1294 .brand {
      display: inline-flex; align-items: center; gap: 10px;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Inter, Roboto, Arial;
      font-weight: 900; letter-spacing: 0.18em; text-transform: uppercase; font-size: 12px;
      padding: 10px 14px; border-radius: 999px;
      color: #071022;
      background: rgba(255,255,255,0.78);
      border: 1px solid rgba(255,255,255,0.55);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.85), 0 8px 24px rgba(0,0,0,0.2);
      backdrop-filter: blur(8px) saturate(140%);
    }
    #vibe-1294 .pals {
      display: inline-flex; gap: 10px; padding: 8px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 999px;
      backdrop-filter: blur(12px) saturate(140%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.12);
    }
    #vibe-1294 .swatch {
      width: 36px; height: 24px; border-radius: 999px; border: 0; cursor: pointer; outline: none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.25), 0 8px 20px rgba(0,0,0,0.25);
      transition: transform 140ms ease, filter 160ms ease, box-shadow 180ms ease;
    }
    #vibe-1294 .swatch:hover { transform: translateY(-1px) scale(1.04); filter: saturate(112%); }
    #vibe-1294 .swatch[aria-pressed="true"] { box-shadow: inset 0 0 0 2px rgba(255,255,255,0.9), 0 12px 28px rgba(0,0,0,0.35); }

    /* Hero */
    #vibe-1294 .hero { position: relative; z-index: 2; display: grid; place-items: center; gap: 8px; padding: 0 20px; }
    #vibe-1294 h1 {
      margin: 10px 0 0;
      text-align: center;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Inter, Roboto, Arial;
      font-weight: 1000; letter-spacing: -0.02em;
      font-size: clamp(48px, 9vw, 128px); line-height: 0.9;
      background: conic-gradient(from 90deg,
        rgba(var(--p1),1),
        rgba(var(--p2),1),
        rgba(var(--p3),1),
        rgba(var(--p1),1));
      -webkit-background-clip: text; background-clip: text; color: transparent;
      filter: drop-shadow(0 24px 80px rgba(0,0,0,0.6));
    }
    #vibe-1294 .lead {
      text-align: center; max-width: 70ch; color: var(--muted);
      font-size: clamp(16px, 2.2vw, 20px); text-wrap: balance; transition: opacity 180ms ease;
    }

    /* Portal */
    #vibe-1294 .portal {
      position: relative; z-index: 2; margin: 24px auto 10px;
      width: min(82vmin, 980px); aspect-ratio: 1/1; border-radius: 50%;
      background: radial-gradient(120% 120% at 50% 50%, rgba(255,255,255,0.06), rgba(255,255,255,0.02) 60%, rgba(0,0,0,0.05));
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow:
        0 60px 180px rgba(2, 6, 20, 0.6),
        inset 0 1px 0 rgba(255,255,255,0.35),
        inset 0 0 160px rgba(255,255,255,0.06);
      overflow: hidden;
      transform-style: preserve-3d;
      transition: transform 220ms ease;
    }
    #vibe-1294 .portal::before {
      /* ring highlight */
      content: ""; position: absolute; inset: -4%;
      border-radius: 50%;
      background:
        radial-gradient(90% 90% at 50% 50%, rgba(255,255,255,0.08), transparent 60%),
        conic-gradient(from 0deg, rgba(var(--p1),0.35), rgba(var(--p2),0.35), rgba(var(--p3),0.35), rgba(var(--p1),0.35));
      mix-blend-mode: screen; filter: blur(20px);
      animation: ring-1294 28s linear infinite;
      pointer-events: none;
    }
    @keyframes ring-1294 { to { transform: rotate(360deg); } }
    #vibe-1294 canvas.scope { position: absolute; inset: 0; width: 100%; height: 100%; display: block; }

    /* HUD */
    #vibe-1294 .hud {
      position: relative; z-index: 3; display: grid; gap: 12px;
      width: min(980px, 94%); margin: 16px auto 0; padding: 16px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 18px;
      backdrop-filter: blur(12px) saturate(140%);
      box-shadow: 0 30px 90px rgba(2, 6, 20, 0.6), inset 0 1px 0 rgba(255,255,255,0.18);
    }
    #vibe-1294 .cta { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    #vibe-1294 .btn {
      appearance: none; border: 0; cursor: pointer;
      padding: 12px 16px; border-radius: 14px;
      font-weight: 900; letter-spacing: 0.02em; color: #071022;
      background: linear-gradient(135deg, rgba(var(--p1),1), rgba(var(--p3),1));
      box-shadow: 0 14px 34px rgba(0,0,0,0.45);
      transition: transform 120ms ease, filter 160ms ease, box-shadow 220ms ease;
    }
    #vibe-1294 .btn:hover { transform: translateY(-1px); filter: saturate(110%); }
    #vibe-1294 .btn:active { transform: translateY(1px); }

    #vibe-1294 .chip {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 12px; border-radius: 999px; cursor: pointer; user-select: none;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.18);
      color: var(--ink);
      font-size: 12px; font-weight: 800; letter-spacing: 0.02em;
      transition: transform 120ms ease, background 200ms ease, color 200ms ease, border 200ms ease;
    }
    #vibe-1294 .chip[aria-pressed="true"] {
      background: linear-gradient(135deg, rgba(var(--p2),0.25), rgba(var(--p1),0.25));
      border-color: rgba(255,255,255,0.28);
    }
    #vibe-1294 .chip:active { transform: translateY(1px); }

    #vibe-1294 .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px 14px; }
    @media (max-width: 900px) { #vibe-1294 .controls { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 560px) { #vibe-1294 .controls { grid-template-columns: 1fr; } }

    #vibe-1294 .control {
      display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center;
      color: var(--muted); font-size: 12px;
      padding: 8px 10px; border-radius: 12px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
    }
    #vibe-1294 .val { color: var(--ink); font-weight: 900; min-width: 52px; text-align: right; }

    #vibe-1294 .knob {
      appearance: none; width: 100%; height: 8px; border-radius: 999px; outline: none;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.18);
    }
    #vibe-1294 .knob::-webkit-slider-thumb,
    #vibe-1294 .knob::-moz-range-thumb {
      -webkit-appearance: none; appearance: none;
      width: 22px; height: 22px; border-radius: 50%;
      background: linear-gradient(135deg, rgba(var(--p1),1), rgba(var(--p2),1));
      border: 1px solid rgba(255,255,255,0.28);
      box-shadow: 0 10px 24px rgba(0,0,0,0.45);
      cursor: pointer;
    }

    /* Meta */
    #vibe-1294 .meta {
      position: relative; z-index: 2;
      display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: center;
      margin: 16px auto 26px; padding: 0 16px;
      color: var(--muted); font-size: 12px;
    }
    #vibe-1294 .meta .tag {
      padding: 8px 12px; border-radius: 999px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(6px);
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      #vibe-1294 .btn, #vibe-1294 .swatch, #vibe-1294 .chip { transition: none !important; }
      #vibe-1294 .portal::before { animation: none !important; }
      #vibe-1294::before { animation: none !important; }
    }
  </style>

  <div class="chrome" role="group" aria-label="Palette switcher and brand">
    <span class="brand">Edition 1294 • HALO Studio</span>
    <div class="pals" role="group" aria-label="Palettes">
      <button class="swatch" type="button" aria-label="Ice Bloom Mint" data-pal="#82d7ff|#ff79aa|#74ffca" style="background: linear-gradient(90deg,#82d7ff,#ff79aa,#74ffca)" aria-pressed="true"></button>
      <button class="swatch" type="button" aria-label="Nocturne Blue" data-pal="#9eb2ff|#5c7cff|#0b1220" style="background: linear-gradient(90deg,#9eb2ff,#5c7cff,#0b1220)" aria-pressed="false"></button>
      <button class="swatch" type="button" aria-label="Citrus Dawn" data-pal="#ffd36b|#ff6aa2|#7aa7ff" style="background: linear-gradient(90deg,#ffd36b,#ff6aa2,#7aa7ff)" aria-pressed="false"></button>
      <button class="swatch" type="button" aria-label="Jade Night" data-pal="#00d1a0|#4b6cff|#0b1220" style="background: linear-gradient(90deg,#00d1a0,#4b6cff,#0b1220)" aria-pressed="false"></button>
      <button class="swatch" type="button" aria-label="Aurora Whisper" data-pal="#54c0ff|#7affc6|#e8f9ff" style="background: linear-gradient(90deg,#54c0ff,#7affc6,#e8f9ff)" aria-pressed="false"></button>
    </div>
  </div>

  <section class="hero">
    <h1>HALO</h1>
    <p class="lead" aria-live="polite">A living kaleidoscope. Turn light into lace.</p>
  </section>

  <figure class="portal" role="region" aria-label="Kaleidoscopic portal">
    <canvas class="scope" aria-hidden="true"></canvas>
  </figure>

  <div class="hud" role="group" aria-label="Controls">
    <div class="cta">
      <button class="btn play" type="button" aria-label="Pause or Play">Pause</button>
      <button class="chip toggle trails" type="button" aria-pressed="true" aria-label="Toggle trails">Trails</button>
      <button class="chip toggle glow" type="button" aria-pressed="true" aria-label="Toggle glow">Glow</button>
      <button class="chip toggle mirror" type="button" aria-pressed="true" aria-label="Toggle mirror">Mirror</button>
      <button class="chip toggle spin" type="button" aria-pressed="true" aria-label="Toggle auto spin">Auto‑Spin</button>
      <button class="chip toggle noise" type="button" aria-pressed="true" aria-label="Toggle grain">Noise</button>
      <button class="chip save" type="button" aria-label="Save PNG">Save PNG</button>
    </div>

    <div class="controls">
      <div class="control">
        <span>Sectors</span>
        <input class="knob sectors" type="range" min="4" max="24" value="12" step="1" aria-label="Sector count">
        <span class="val val-sectors">12</span>
      </div>
      <div class="control">
        <span>Speed</span>
        <input class="knob speed" type="range" min="0" max="2.0" value="1.0" step="0.01" aria-label="Speed">
        <span class="val val-speed">1.00</span>
      </div>
      <div class="control">
        <span>Trail</span>
        <input class="knob trail" type="range" min="0" max="0.25" value="0.06" step="0.01" aria-label="Trail fade">
        <span class="val val-trail">0.06</span>
      </div>
    </div>
  </div>

  <div class="meta">
    <span class="tag">Circular portal</span>
    <span class="tag">Kaleidoscopic symmetry</span>
    <span id="last-updated" class="tag" aria-live="polite"></span>
  </div>

  <script>
    (function () {
      const root = document.getElementById('vibe-1294');
      const canvas = root.querySelector('canvas.scope');
      const ctx = canvas.getContext('2d');

      const portal = root.querySelector('.portal');
      const lead = root.querySelector('.lead');
      const updated = root.querySelector('#last-updated');

      const playBtn = root.querySelector('.btn.play');
      const trailsBtn = root.querySelector('.chip.trails');
      const glowBtn = root.querySelector('.chip.glow');
      const mirrorBtn = root.querySelector('.chip.mirror');
      const spinBtn = root.querySelector('.chip.spin');
      const noiseBtn = root.querySelector('.chip.noise');
      const saveBtn = root.querySelector('.chip.save');
      const swatches = Array.from(root.querySelectorAll('.swatch'));

      const sectorsKnob = root.querySelector('.knob.sectors');
      const speedKnob = root.querySelector('.knob.speed');
      const trailKnob = root.querySelector('.knob.trail');

      const valSectors = root.querySelector('.val-sectors');
      const valSpeed = root.querySelector('.val-speed');
      const valTrail = root.querySelector('.val-trail');

      // Timestamp
      try {
        const now = new Date();
        const opts = { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' };
        updated.textContent = `Updated ${now.toLocaleString([], opts)}`;
      } catch { updated.textContent = 'Updated just now'; }

      // Copy rotation
      const lines = [
        'A living kaleidoscope. Turn light into lace.',
        'Spin softly. Let color find its symmetry.',
        'Touch the halo. Patterns bloom and fold.',
        'Glass-bright echoes, forever rearranging.'
      ];
      let lineIdx = 0;
      const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      function cycleLead() {
        lineIdx = (lineIdx + 1) % lines.length;
        lead.style.opacity = '0';
        setTimeout(() => { lead.textContent = lines[lineIdx]; lead.style.opacity = '1'; }, 180);
      }
      if (!reduce) setInterval(cycleLead, 3600);

      // Palette helpers
      function hexToRgb(hex) {
        const s = hex.replace('#', '').trim();
        const n = s.length === 3 ? s.split('').map(h => h + h).join('') : s;
        const m = n.match(/.{1,2}/g) || ['00','00','00'];
        return m.map(v => parseInt(v, 16));
      }
      function lerp(a, b, t) { return a + (b - a) * t; }
      function mix(c1, c2, t) {
        return [Math.round(lerp(c1[0], c2[0], t)), Math.round(lerp(c1[1], c2[1], t)), Math.round(lerp(c1[2], c2[2], t))];
      }
      function rgbStr(c, a = 1) { return `rgba(${c[0]},${c[1]},${c[2]},${a})`; }
      function paletteColor(t, a = 1) {
        if (t <= 0.5) return rgbStr(mix(colors[0], colors[1], t / 0.5), a);
        return rgbStr(mix(colors[1], colors[2], (t - 0.5) / 0.5), a);
      }

      const PAL_KEY = 'vibe1294-pal';
      const defaultPal = swatches[0].dataset.pal;
      const savedPal = localStorage.getItem(PAL_KEY) || defaultPal;
      let colors = savedPal.split('|').map(hexToRgb);
      function applyPalette(p) {
        colors = p.split('|').map(hexToRgb);
        const [c1, c2, c3] = colors;
        root.style.setProperty('--p1', `${c1[0]},${c1[1]},${c1[2]}`);
        root.style.setProperty('--p2', `${c2[0]},${c2[1]},${c2[2]}`);
        root.style.setProperty('--p3', `${c3[0]},${c3[1]},${c3[2]}`);
        swatches.forEach(s => s.setAttribute('aria-pressed', s.dataset.pal === p ? 'true' : 'false'));
        localStorage.setItem(PAL_KEY, p);
      }
      applyPalette(savedPal);
      swatches.forEach(s => s.addEventListener('click', () => applyPalette(s.dataset.pal)));

      // State
      const state = {
        running: !reduce,
        trails: true,
        glow: true,
        mirror: true,
        spin: true,
        pointer: { x: 0.5, y: 0.5 },
        t: 0,
        rot: 0,
        dpr: 1, W: 1, H: 1, R: 1,
        sectors: parseInt(sectorsKnob.value, 10),
        speed: parseFloat(speedKnob.value),
        trail: parseFloat(trailKnob.value),
        agents: []
      };

      // Build agents
      function seedAgents() {
        const count = 9;
        state.agents = [];
        for (let i = 0; i < count; i++) {
          const phase = Math.random() * Math.PI * 2;
          const baseA = Math.random() * Math.PI * 2;
          const baseR = lerp(0.14, 0.48, Math.random()) * state.R;
          state.agents.push({
            phase, baseA, baseR,
            freq: lerp(0.4, 1.2, Math.random()),
            wob: lerp(0.08, 0.22, Math.random()),
            w: lerp(1.2, 3.6, Math.random()),
            tint: Math.random(),
            prev: { x: 0, y: 0 },
            cur: { x: 0, y: 0 }
          });
        }
      }

      // Size/resize
      function resize() {
        const r = canvas.getBoundingClientRect();
        state.dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        state.W = Math.max(1, Math.floor(r.width));
        state.H = Math.max(1, Math.floor(r.height));
        state.R = Math.min(state.W, state.H) * 0.48;
        canvas.width = state.W * state.dpr; canvas.height = state.H * state.dpr;
        ctx.setTransform(state.dpr, 0, 0, state.dpr, 0, 0);
        // prime background
        ctx.clearRect(0,0,state.W,state.H);
        ctx.save();
        ctx.beginPath();
        ctx.arc(state.W/2, state.H/2, Math.min(state.W,state.H)/2, 0, Math.PI*2);
        ctx.clip();
        const bg = ctx.createRadialGradient(state.W/2, state.H/2, 0, state.W/2, state.H/2, state.R);
        bg.addColorStop(0, 'rgba(255,255,255,0.05)');
        bg.addColorStop(1, 'rgba(255,255,255,0.02)');
        ctx.fillStyle = bg; ctx.fillRect(0,0,state.W,state.H);
        ctx.restore();
        seedAgents();
      }
      window.addEventListener('resize', resize, { passive: true });

      // Dynamics
      function step(dt) {
        state.t += dt * 0.001 * state.speed;
        if (state.spin) state.rot += dt * 0.0002 * (0.6 + state.speed);

        const cx = state.W / 2, cy = state.H / 2;

        for (let i = 0; i < state.agents.length; i++) {
          const a = state.agents[i];
          const rr = a.baseR * (1 + a.wob * Math.sin(state.t * (a.freq * 1.2) + a.phase));
          const ang = a.baseA + Math.sin(state.t * (a.freq * 1.5) + a.phase) * 1.7;
          a.prev.x = a.cur.x || (cx + Math.cos(ang) * rr);
          a.prev.y = a.cur.y || (cy + Math.sin(ang) * rr);
          a.cur.x = cx + Math.cos(ang) * rr;
          a.cur.y = cy + Math.sin(ang) * rr;
        }
      }

      function drawFrame() {
        // Clip to circle for clean portal edges
        ctx.save();
        ctx.beginPath();
        ctx.arc(state.W/2, state.H/2, Math.min(state.W,state.H)/2, 0, Math.PI*2);
        ctx.clip();

        // Trails or clear
        if (state.trails) {
          ctx.fillStyle = `rgba(6, 12, 24, ${state.trail})`;
          ctx.fillRect(0,0,state.W,state.H);
        } else {
          ctx.clearRect(0,0,state.W,state.H);
          const bg = ctx.createRadialGradient(state.W/2, state.H/2, 0, state.W/2, state.H/2, state.R);
          bg.addColorStop(0, 'rgba(255,255,255,0.05)');
          bg.addColorStop(1, 'rgba(255,255,255,0.02)');
          ctx.fillStyle = bg; ctx.fillRect(0,0,state.W,state.H);
        }

        ctx.translate(state.W/2, state.H/2);
        const n = Math.max(4, Math.min(24, state.sectors));
        const stepAng = (Math.PI * 2) / n;
        const comp = state.glow ? 'lighter' : 'source-over';
        ctx.globalCompositeOperation = comp;

        for (let k = 0; k < n; k++) {
          ctx.save();
          ctx.rotate(state.rot + k * stepAng);
          if (state.mirror && (k % 2 === 1)) ctx.scale(-1, 1);

          for (let i = 0; i < state.agents.length; i++) {
            const a = state.agents[i];
            const color = paletteColor(a.tint, state.glow ? 0.9 : 0.8);
            ctx.strokeStyle = color;
            ctx.lineCap = 'round';
            ctx.lineWidth = a.w * (1 + 0.4 * Math.sin(state.t * 1.1 + a.phase));

            if (state.glow) {
              ctx.shadowColor = color;
              ctx.shadowBlur = 18 + a.w * 8;
            } else {
              ctx.shadowBlur = 0;
            }

            ctx.beginPath();
            ctx.moveTo(a.prev.x - state.W/2, a.prev.y - state.H/2);
            ctx.lineTo(a.cur.x - state.W/2, a.cur.y - state.H/2);
            ctx.stroke();
          }

          ctx.restore();
        }

        ctx.globalCompositeOperation = 'source-over';
        ctx.restore();
      }

      // Loop
      let RAF = 0, last = 0;
      function loop(now) {
        RAF = requestAnimationFrame(loop);
        const dt = Math.min(32, now - last || 16);
        last = now;
        step(dt);
        drawFrame();
      }

      // Pointer tilt
      portal.addEventListener('pointermove', (e) => {
        const r = portal.getBoundingClientRect();
        const px = (e.clientX - r.left) / Math.max(1, r.width);
        const py = (e.clientY - r.top) / Math.max(1, r.height);
        state.pointer.x = px; state.pointer.y = py;
        const rx = (0.5 - py) * 5;
        const ry = (px - 0.5) * 8;
        portal.style.transform = `perspective(1100px) rotateX(${rx}deg) rotateY(${ry}deg)`;
      }, { passive: true });
      portal.addEventListener('pointerleave', () => { portal.style.transform = ''; });

      // Toggles
      playBtn.addEventListener('click', () => {
        state.running = !state.running;
        playBtn.textContent = state.running ? 'Pause' : 'Play';
        if (state.running && !reduce) {
          last = performance.now();
          RAF = requestAnimationFrame(loop);
        } else {
          cancelAnimationFrame(RAF);
        }
      });
      trailsBtn.addEventListener('click', () => {
        const on = trailsBtn.getAttribute('aria-pressed') !== 'true';
        trailsBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
        state.trails = on;
      });
      glowBtn.addEventListener('click', () => {
        const on = glowBtn.getAttribute('aria-pressed') !== 'true';
        glowBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
        state.glow = on;
      });
      mirrorBtn.addEventListener('click', () => {
        const on = mirrorBtn.getAttribute('aria-pressed') !== 'true';
        mirrorBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
        state.mirror = on;
      });
      spinBtn.addEventListener('click', () => {
        const on = spinBtn.getAttribute('aria-pressed') !== 'true';
        spinBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
        state.spin = on;
      });
      noiseBtn.addEventListener('click', () => {
        const on = noiseBtn.getAttribute('aria-pressed') !== 'true';
        noiseBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
        root.classList.toggle('grain-off', !on);
      });
      saveBtn.addEventListener('click', () => {
        try {
          const a = document.createElement('a');
          a.download = `halo-${Date.now()}.png`;
          canvas.toBlob((blob) => {
            if (!blob) return;
            const url = URL.createObjectURL(blob);
            a.href = url; a.click();
            setTimeout(() => URL.revokeObjectURL(url), 800);
          }, 'image/png');
        } catch {}
      });

      // Sliders
      function updateVals() {
        valSectors.textContent = String(state.sectors);
        valSpeed.textContent = parseFloat(state.speed).toFixed(2);
        valTrail.textContent = parseFloat(state.trail).toFixed(2);
      }
      sectorsKnob.addEventListener('input', () => { state.sectors = parseInt(sectorsKnob.value, 10); updateVals(); });
      speedKnob.addEventListener('input', () => { state.speed = parseFloat(speedKnob.value); updateVals(); });
      trailKnob.addEventListener('input', () => { state.trail = parseFloat(trailKnob.value); updateVals(); });

      // Bootstrap
      function firstResize() { resize(); window.removeEventListener('load', firstResize); }
      window.addEventListener('load', firstResize);
      resize();
      updateVals();

      if (state.running && !reduce) {
        last = performance.now();
        RAF = requestAnimationFrame(loop);
      }
    })();
  </script>
</div>
      </section>
      <!-- END_EDITABLE -->
    <script>
      // Only show a local placeholder if the agent hasn't written a timestamp yet
      const el = document.getElementById('last-updated');
      if (el && (!el.textContent || el.textContent.includes('not yet'))) {
        const now = new Date();
        el.textContent = `Last updated: ${now.toLocaleString(undefined, { hour12: false })}`;
      }
    </script>
  </body>
  </html>


