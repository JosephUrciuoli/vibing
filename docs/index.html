<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vibing</title>
    <style>
      :root {
        --bg: #0f1221;
        --fg: #e6e8f0;
        --muted: #9aa3b2;
        --accent: #8b5cf6;
      }
      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--fg);
        background: radial-gradient(1200px 800px at 70% 10%, #1b1f3a, var(--bg));
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        width: min(720px, 92vw);
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px;
        padding: 28px 24px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        backdrop-filter: blur(6px);
      }
      h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
        letter-spacing: 0.3px;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 18px;
      }
      #content {
        font-size: 18px;
        line-height: 1.6;
        background: rgba(255,255,255,0.04);
        border: 1px dashed rgba(255,255,255,0.12);
        border-radius: 12px;
        padding: 16px;
      }
      .footer {
        margin-top: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: var(--muted);
      }
      .badge {
        display: inline-block;
        background: rgba(139, 92, 246, 0.18);
        color: #d4c2ff;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(139, 92, 246, 0.35);
        letter-spacing: 0.2px;
      }
    </style>
  </head>
  <body>
    <!-- BEGIN_EDITABLE -->
      <section id="content">
<div id="vibe-1293" class="aether" aria-label="Aether Bloom — kinetic orbital studio">
  <style>
    /* Aether Bloom — scoped to #vibe-1293 */
    #vibe-1293 {
      --ink: #eaf2ff;
      --muted: #b0bdd6;
      --bg-0: #070b14;
      --bg-1: #0b1323;
      --p1: 126, 211, 255;  /* glacier */
      --p2: 255, 129, 181;  /* petal */
      --p3: 122, 255, 198;  /* mint */
      color: var(--ink);
      position: relative;
      min-height: 900px;
      border-radius: 36px;
      overflow: hidden;
      isolation: isolate;
      background:
        radial-gradient(1400px 900px at -10% -20%, rgba(var(--p2),0.10), transparent 55%),
        radial-gradient(1200px 1000px at 110% 120%, rgba(var(--p3),0.10), transparent 50%),
        radial-gradient(800px 600px at 50% 0%, rgba(255,255,255,0.06), transparent 65%),
        linear-gradient(180deg, var(--bg-0), var(--bg-1));
      box-shadow:
        0 50px 160px rgba(2, 6, 20, 0.55),
        inset 0 0 0 1px rgba(255,255,255,0.04);
    }
    #vibe-1293::before {
      /* subtle radial vignette */
      content: ""; position: absolute; inset: 0; pointer-events: none;
      background: radial-gradient(120% 80% at 50% 10%, rgba(255,255,255,0.06), transparent 60%),
                  radial-gradient(120% 120% at 50% 50%, rgba(0,0,0,0.42), transparent 60%);
      mix-blend-mode: overlay; opacity: 0.5; z-index: 1;
    }
    #vibe-1293::after {
      /* grain */
      content: ""; position: absolute; inset: 0; z-index: 1; pointer-events: none;
      opacity: 0.16; mix-blend-mode: soft-light;
      background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='180' height='180' viewBox='0 0 180 180'><filter id='g'><feTurbulence baseFrequency='0.8' numOctaves='2' seed='11'/><feColorMatrix type='saturate' values='0'/><feComponentTransfer><feFuncA type='table' tableValues='0 0.24'/></feComponentTransfer></filter><rect width='100%' height='100%' filter='url(%23g)'/></svg>") repeat;
      background-size: 220px 220px;
      transition: opacity 220ms ease;
    }
    #vibe-1293.grain-off::after { opacity: 0; }

    /* Header */
    #vibe-1293 .bar {
      position: relative; z-index: 3;
      display: flex; align-items: center; justify-content: space-between; gap: 16px;
      padding: clamp(14px, 3.6vw, 28px);
    }
    #vibe-1293 .brand {
      display: inline-flex; align-items: center; gap: 10px;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      font-weight: 900; letter-spacing: 0.16em; text-transform: uppercase; font-size: 12px;
      padding: 10px 14px; border-radius: 999px;
      color: #0a1020;
      background: rgba(255,255,255,0.75);
      border: 1px solid rgba(255,255,255,0.5);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.85);
      backdrop-filter: blur(10px) saturate(140%);
    }
    #vibe-1293 .pals {
      display: inline-flex; gap: 10px; padding: 8px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 999px;
      backdrop-filter: blur(12px) saturate(140%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.12);
    }
    #vibe-1293 .swatch {
      width: 32px; height: 32px; border-radius: 50%; border: 0; cursor: pointer; outline: none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.25), 0 8px 20px rgba(0,0,0,0.25);
      transition: transform 140ms ease, filter 160ms ease, box-shadow 180ms ease;
    }
    #vibe-1293 .swatch:hover { transform: translateY(-1px) scale(1.05); filter: saturate(114%); }
    #vibe-1293 .swatch[aria-pressed="true"] { box-shadow: inset 0 0 0 2px rgba(255,255,255,0.9), 0 12px 28px rgba(0,0,0,0.35); }

    /* Hero */
    #vibe-1293 .wrap {
      position: relative; z-index: 2;
      display: grid; place-items: center; gap: 20px;
      padding: 2px clamp(14px, 4vw, 38px) 26px;
    }
    #vibe-1293 h1 {
      margin: 4px 0 0; text-align: center;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      font-weight: 1000; letter-spacing: -0.02em;
      font-size: clamp(48px, 9vw, 124px); line-height: 0.9;
      background: conic-gradient(from 120deg,
        rgba(var(--p1),1),
        rgba(var(--p2),1),
        rgba(var(--p3),1),
        rgba(var(--p1),1));
      -webkit-background-clip: text; background-clip: text; color: transparent;
      filter: drop-shadow(0 24px 80px rgba(0, 0, 0, 0.6));
    }
    #vibe-1293 .lead {
      text-align: center; max-width: 64ch;
      color: var(--muted);
      font-size: clamp(16px, 2.2vw, 20px);
      text-wrap: balance;
      transition: opacity 180ms ease;
    }

    /* Stage */
    #vibe-1293 .stage {
      position: relative; width: min(95vmin, 1100px); aspect-ratio: 16 / 10;
      border-radius: 30px; overflow: hidden; transform-style: preserve-3d;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow:
        0 60px 180px rgba(2, 6, 20, 0.55),
        inset 0 1px 0 rgba(255,255,255,0.35),
        inset 0 0 180px rgba(255,255,255,0.06);
    }
    #vibe-1293 canvas.field { position: absolute; inset: 0; width: 100%; height: 100%; display: block; }
    #vibe-1293 .glow {
      position: absolute; inset: -20%;
      background:
        radial-gradient(50% 30% at 20% 10%, rgba(255,255,255,0.35), transparent 60%),
        radial-gradient(50% 30% at 80% 90%, rgba(255,255,255,0.28), transparent 60%);
      pointer-events: none; mix-blend-mode: screen; filter: blur(24px);
      animation: g-1293 22s linear infinite;
    }
    @keyframes g-1293 { to { transform: rotate(360deg); } }

    /* Dock */
    #vibe-1293 .dock {
      position: relative; z-index: 3; display: grid; gap: 12px;
      width: min(1100px, 94%); margin: 8px auto 0; padding: 16px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      backdrop-filter: blur(12px) saturate(140%);
      box-shadow: 0 30px 90px rgba(2, 6, 20, 0.6), inset 0 1px 0 rgba(255,255,255,0.18);
    }
    #vibe-1293 .cta { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    #vibe-1293 .btn {
      appearance: none; border: 0; cursor: pointer;
      padding: 12px 16px; border-radius: 14px;
      font-weight: 900; letter-spacing: 0.02em; color: #071022;
      background: linear-gradient(135deg, rgba(var(--p1),1), rgba(var(--p3),1));
      box-shadow: 0 14px 34px rgba(0,0,0,0.45);
      transition: transform 120ms ease, filter 160ms ease, box-shadow 220ms ease, background 220ms ease;
    }
    #vibe-1293 .btn:hover { transform: translateY(-1px); filter: saturate(110%); }
    #vibe-1293 .btn:active { transform: translateY(1px); }

    #vibe-1293 .chip {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 12px; border-radius: 999px; cursor: pointer; user-select: none;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.18);
      color: var(--ink);
      font-size: 12px; font-weight: 800; letter-spacing: 0.02em;
      transition: transform 120ms ease, background 200ms ease, color 200ms ease, border 200ms ease;
    }
    #vibe-1293 .chip[aria-pressed="true"] {
      background: linear-gradient(135deg, rgba(var(--p2),0.25), rgba(var(--p1),0.25));
      border-color: rgba(255,255,255,0.28);
    }
    #vibe-1293 .chip:active { transform: translateY(1px); }

    #vibe-1293 .controls { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px 14px; }
    @media (max-width: 900px) { #vibe-1293 .controls { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 580px) { #vibe-1293 .controls { grid-template-columns: 1fr; } }

    #vibe-1293 .control {
      display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center;
      color: var(--muted); font-size: 12px;
      padding: 8px 10px; border-radius: 12px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
    }
    #vibe-1293 .val { color: var(--ink); font-weight: 900; min-width: 52px; text-align: right; }

    #vibe-1293 .knob {
      appearance: none; width: 100%; height: 8px; border-radius: 999px; outline: none;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.18);
    }
    #vibe-1293 .knob::-webkit-slider-thumb,
    #vibe-1293 .knob::-moz-range-thumb {
      -webkit-appearance: none; appearance: none;
      width: 22px; height: 22px; border-radius: 50%;
      background: linear-gradient(135deg, rgba(var(--p1),1), rgba(var(--p2),1));
      border: 1px solid rgba(255,255,255,0.28);
      box-shadow: 0 10px 24px rgba(0,0,0,0.45);
      cursor: pointer;
    }

    /* Meta */
    #vibe-1293 .meta {
      position: relative; z-index: 2;
      display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: center;
      margin: 16px auto 26px; padding: 0 16px;
      color: var(--muted); font-size: 12px;
    }
    #vibe-1293 .meta .tag {
      padding: 8px 12px; border-radius: 999px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(6px);
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      #vibe-1293 .btn, #vibe-1293 .swatch, #vibe-1293 .chip { transition: none !important; }
      #vibe-1293 .glow { animation: none !important; }
    }
  </style>

  <div class="bar" role="group" aria-label="Palette switcher and brand">
    <span class="brand">Edition 1293 • Aether Bloom</span>
    <div class="pals">
      <button class="swatch" type="button" aria-label="Glacier Petal Mint" data-pal="#7ed3ff|#ff81b5|#7affc6" style="background: conic-gradient(#7ed3ff,#ff81b5,#7affc6,#7ed3ff)" aria-pressed="true"></button>
      <button class="swatch" type="button" aria-label="Nocturne" data-pal="#9eb2ff|#6788ff|#0b1220" style="background: conic-gradient(#9eb2ff,#6788ff,#0b1220,#9eb2ff)" aria-pressed="false"></button>
      <button class="swatch" type="button" aria-label="Citrus Dawn" data-pal="#ffd36b|#ff6aa2|#7aa7ff" style="background: conic-gradient(#ffd36b,#ff6aa2,#7aa7ff,#ffd36b)" aria-pressed="false"></button>
      <button class="swatch" type="button" aria-label="Aurora" data-pal="#54c0ff|#7affc6|#e8f9ff" style="background: conic-gradient(#54c0ff,#7affc6,#e8f9ff,#54c0ff)" aria-pressed="false"></button>
      <button class="swatch" type="button" aria-label="Jade Night" data-pal="#00d1a0|#4b6cff|#0b1220" style="background: conic-gradient(#00d1a0,#4b6cff,#0b1220,#00d1a0)" aria-pressed="false"></button>
    </div>
  </div>

  <div class="wrap">
    <h1>Aether Bloom</h1>
    <p class="lead" aria-live="polite">Orbits of light, calmly colliding.</p>

    <section class="stage" role="region" aria-label="Orbital field">
      <canvas class="field" aria-hidden="true"></canvas>
      <i class="glow" aria-hidden="true"></i>
    </section>

    <div class="dock" role="group" aria-label="Controls">
      <div class="cta">
        <button class="btn play" type="button" aria-label="Pause or Play">Pause</button>
        <button class="chip toggle trails" type="button" aria-pressed="true" aria-label="Toggle trails">Trails</button>
        <button class="chip toggle glow" type="button" aria-pressed="true" aria-label="Toggle glow">Glow</button>
        <button class="chip toggle noise" type="button" aria-pressed="true" aria-label="Toggle grain">Noise</button>
        <button class="chip toggle lines" type="button" aria-pressed="false" aria-label="Toggle field lines">Field Lines</button>
        <button class="chip save" type="button" aria-label="Save PNG">Save PNG</button>
      </div>

      <div class="controls">
        <div class="control">
          <span>Orbs</span>
          <input class="knob orbs" type="range" min="6" max="128" value="36" step="1" aria-label="Orb count">
          <span class="val val-orbs">36</span>
        </div>
        <div class="control">
          <span>Gravity</span>
          <input class="knob gravity" type="range" min="0" max="2.0" value="0.6" step="0.02" aria-label="Gravity">
          <span class="val val-gravity">0.60</span>
        </div>
        <div class="control">
          <span>Drift</span>
          <input class="knob drift" type="range" min="0" max="2.0" value="0.8" step="0.02" aria-label="Drift">
          <span class="val val-drift">0.80</span>
        </div>
        <div class="control">
          <span>Trail</span>
          <input class="knob trail" type="range" min="0" max="0.3" value="0.08" step="0.01" aria-label="Trail fade">
          <span class="val val-trail">0.08</span>
        </div>
      </div>
    </div>
  </div>

  <div class="meta">
    <span class="tag">Additive orbs</span>
    <span class="tag">Parallax tilt</span>
    <span id="last-updated" class="tag" aria-live="polite"></span>
  </div>

  <script>
    (function () {
      const root = document.getElementById('vibe-1293');
      const canvas = root.querySelector('canvas.field');
      const ctx = canvas.getContext('2d');

      const stage = root.querySelector('.stage');
      const lead = root.querySelector('.lead');
      const updated = root.querySelector('#last-updated');

      const playBtn = root.querySelector('.btn.play');
      const trailsBtn = root.querySelector('.chip.trails');
      const glowBtn = root.querySelector('.chip.glow');
      const noiseBtn = root.querySelector('.chip.noise');
      const linesBtn = root.querySelector('.chip.lines');
      const saveBtn = root.querySelector('.chip.save');
      const swatches = Array.from(root.querySelectorAll('.swatch'));

      const orbsKnob = root.querySelector('.knob.orbs');
      const gravKnob = root.querySelector('.knob.gravity');
      const driftKnob = root.querySelector('.knob.drift');
      const trailKnob = root.querySelector('.knob.trail');

      const valOrbs = root.querySelector('.val-orbs');
      const valGrav = root.querySelector('.val-gravity');
      const valDrift = root.querySelector('.val-drift');
      const valTrail = root.querySelector('.val-trail');

      // Timestamp
      try {
        const now = new Date();
        const opts = { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' };
        updated.textContent = `Updated ${now.toLocaleString([], opts)}`;
      } catch { updated.textContent = 'Updated just now'; }

      // Copy rotation
      const lines = [
        'Orbits of light, calmly colliding.',
        'A quiet galaxy in your hands.',
        'Pull gently; the stars will follow.',
        'Silk-bright halos, soft as sleep.'
      ];
      let lineIdx = 0;
      const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      function cycleLead() {
        lineIdx = (lineIdx + 1) % lines.length;
        lead.style.opacity = '0';
        setTimeout(() => { lead.textContent = lines[lineIdx]; lead.style.opacity = '1'; }, 180);
      }
      if (!reduce) setInterval(cycleLead, 3600);

      // Palette
      function hexToRgb(hex) {
        const s = hex.replace('#', '').trim();
        const n = s.length === 3 ? s.split('').map(h => h + h).join('') : s;
        const m = n.match(/.{1,2}/g) || ['00','00','00'];
        return m.map(v => parseInt(v, 16));
      }
      function lerp(a, b, t) { return a + (b - a) * t; }
      function mix(c1, c2, t) {
        return [Math.round(lerp(c1[0], c2[0], t)), Math.round(lerp(c1[1], c2[1], t)), Math.round(lerp(c1[2], c2[2], t))];
      }
      function rgbStr(c, a = 1) { return `rgba(${c[0]},${c[1]},${c[2]},${a})`; }

      const PAL_KEY = 'vibe1293-pal';
      const defaultPal = swatches[0].dataset.pal;
      const savedPal = localStorage.getItem(PAL_KEY) || defaultPal;
      let colors = savedPal.split('|').map(hexToRgb);
      function applyPalette(p) {
        colors = p.split('|').map(hexToRgb);
        const [c1, c2, c3] = colors;
        root.style.setProperty('--p1', `${c1[0]},${c1[1]},${c1[2]}`);
        root.style.setProperty('--p2', `${c2[0]},${c2[1]},${c2[2]}`);
        root.style.setProperty('--p3', `${c3[0]},${c3[1]},${c3[2]}`);
        swatches.forEach(s => s.setAttribute('aria-pressed', s.dataset.pal === p ? 'true' : 'false'));
        localStorage.setItem(PAL_KEY, p);
      }
      applyPalette(savedPal);
      function pickColor(t, a = 1) {
        if (t <= 0.5) return rgbStr(mix(colors[0], colors[1], t / 0.5), a);
        return rgbStr(mix(colors[1], colors[2], (t - 0.5) / 0.5), a);
        }

      // State
      const state = {
        running: true,
        trails: true,
        glow: true,
        showLines: false,
        pointer: { x: 0.5, y: 0.5, down: false },
        t: 0,
        dpr: 1, W: 1, H: 1,
        orbs: parseInt(orbsKnob.value, 10),
        gravity: parseFloat(gravKnob.value),
        drift: parseFloat(driftKnob.value),
        trail: parseFloat(trailKnob.value),
        bodies: []
      };

      // Build
      function seedOrbs() {
        const N = state.orbs;
        state.bodies = [];
        for (let i = 0; i < N; i++) {
          const t = i / Math.max(1, N - 1);
          const r = lerp(2.5, 6.5, Math.pow(Math.sin((t) * Math.PI), 0.7));
          const mass = lerp(0.2, 1.2, Math.random());
          const angle = Math.random() * Math.PI * 2;
          const speed = lerp(-0.6, 0.6, Math.random());
          state.bodies.push({
            t,
            x: Math.random() * state.W,
            y: Math.random() * state.H,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            r,
            m: mass
          });
        }
      }

      // Sizing
      let RAF = 0, last = 0;
      function resize() {
        const r = canvas.getBoundingClientRect();
        state.dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        state.W = Math.max(1, Math.floor(r.width));
        state.H = Math.max(1, Math.floor(r.height));
        canvas.width = state.W * state.dpr; canvas.height = state.H * state.dpr;
        ctx.setTransform(state.dpr, 0, 0, state.dpr, 0, 0);
        seedOrbs();
        // Prime background
        ctx.clearRect(0,0,state.W,state.H);
        const bg = ctx.createLinearGradient(0,0,0,state.H);
        bg.addColorStop(0, 'rgba(255,255,255,0.05)');
        bg.addColorStop(1, 'rgba(255,255,255,0.02)');
        ctx.fillStyle = bg; ctx.fillRect(0,0,state.W,state.H);
      }
      window.addEventListener('resize', resize, { passive: true });

      // Dynamics
      function step(dt) {
        state.t += dt / 1000;
        const gx = state.pointer.x * state.W;
        const gy = state.pointer.y * state.H;

        for (let i = 0; i < state.bodies.length; i++) {
          const b = state.bodies[i];
          // field swirl
          const s = 0.0018 * state.drift;
          const fx = Math.sin((b.y * s) + state.t * 0.9) * 0.8;
          const fy = Math.cos((b.x * s) - state.t * 0.7) * 0.8;

          // gravity toward pointer
          const dx = gx - b.x, dy = gy - b.y;
          const dist2 = Math.max(60, dx*dx + dy*dy);
          const inv = 1 / Math.sqrt(dist2);
          const g = state.gravity * 0.8 * b.m;

          b.vx += (dx * inv * g + fx) * dt/16;
          b.vy += (dy * inv * g + fy) * dt/16;

          // damp
          b.vx *= 0.995; b.vy *= 0.995;

          // integrate
          b.x += b.vx; b.y += b.vy;

          // bounce
          if (b.x < b.r || b.x > state.W - b.r) { b.vx *= -0.96; b.x = Math.min(Math.max(b.x, b.r), state.W - b.r); }
          if (b.y < b.r || b.y > state.H - b.r) { b.vy *= -0.96; b.y = Math.min(Math.max(b.y, b.r), state.H - b.r); }
        }
      }

      function drawFrame(dt) {
        // Trails or clear
        if (state.trails) {
          ctx.fillStyle = `rgba(10, 16, 32, ${state.trail})`;
          ctx.fillRect(0,0,state.W,state.H);
        } else {
          ctx.clearRect(0,0,state.W,state.H);
          const bg = ctx.createLinearGradient(0,0,0,state.H);
          bg.addColorStop(0, 'rgba(255,255,255,0.05)');
          bg.addColorStop(1, 'rgba(255,255,255,0.02)');
          ctx.fillStyle = bg; ctx.fillRect(0,0,state.W,state.H);
        }

        const comp = state.glow ? 'lighter' : 'source-over';
        ctx.globalCompositeOperation = comp;

        // Optional field lines
        if (state.showLines) {
          ctx.save();
          ctx.globalAlpha = 0.18;
          ctx.lineWidth = 1;
          for (let i = 0; i < state.bodies.length; i += 3) {
            const a = state.bodies[i];
            for (let j = i + 1; j < Math.min(i + 5, state.bodies.length); j++) {
              const b = state.bodies[j];
              const ddx = b.x - a.x, ddy = b.y - a.y;
              const d = Math.hypot(ddx, ddy);
              if (d < Math.min(state.W, state.H) * 0.28) {
                const t = (a.t + b.t) * 0.5;
                ctx.strokeStyle = pickColor(t, 0.35);
                ctx.beginPath();
                // a silky curve between points
                const cx = (a.x + b.x) / 2 + (ddy * 0.12);
                const cy = (a.y + b.y) / 2 - (ddx * 0.12);
                ctx.moveTo(a.x, a.y);
                ctx.quadraticCurveTo(cx, cy, b.x, b.y);
                ctx.stroke();
              }
            }
          }
          ctx.restore();
        }

        // Orbs
        for (let i = 0; i < state.bodies.length; i++) {
          const b = state.bodies[i];
          const t = b.t;
          const color = pickColor(t, state.glow ? 0.9 : 0.8);

          // soft core gradient
          const g = ctx.createRadialGradient(b.x, b.y, 0, b.x, b.y, b.r * 6);
          g.addColorStop(0, color);
          g.addColorStop(0.35, pickColor(Math.min(1, t + 0.2), state.glow ? 0.55 : 0.45));
          g.addColorStop(1, 'rgba(0,0,0,0)');
          ctx.fillStyle = g;

          if (state.glow) {
            ctx.shadowColor = color;
            ctx.shadowBlur = 20 + t * 30;
          } else {
            ctx.shadowBlur = 0;
          }

          ctx.beginPath();
          ctx.arc(b.x, b.y, b.r * 2.1, 0, Math.PI * 2);
          ctx.fill();

          // halo
          ctx.beginPath();
          ctx.arc(b.x, b.y, b.r * 6, 0, Math.PI * 2);
          ctx.fill();
        }

        ctx.globalCompositeOperation = 'source-over';
      }

      function loop(now) {
        RAF = requestAnimationFrame(loop);
        const dt = Math.min(32, now - last || 16);
        last = now;
        step(dt);
        drawFrame(dt);
      }

      // Pointer
      stage.addEventListener('pointermove', (e) => {
        const r = stage.getBoundingClientRect();
        state.pointer.x = (e.clientX - r.left) / Math.max(1, r.width);
        state.pointer.y = (e.clientY - r.top) / Math.max(1, r.height);
        const rx = (0.5 - state.pointer.y) * 4;
        const ry = (state.pointer.x - 0.5) * 6;
        stage.style.transform = `perspective(1100px) rotateX(${rx}deg) rotateY(${ry}deg)`;
      }, { passive: true });
      stage.addEventListener('pointerleave', () => { stage.style.transform = ''; });
      stage.addEventListener('pointerdown', () => { state.pointer.down = true; });
      window.addEventListener('pointerup', () => { state.pointer.down = false; });

      // Toggles
      playBtn.addEventListener('click', () => {
        state.running = !state.running;
        playBtn.textContent = state.running ? 'Pause' : 'Play';
        if (state.running && !reduce) {
          last = performance.now();
          RAF = requestAnimationFrame(loop);
        } else {
          cancelAnimationFrame(RAF);
        }
      });
      trailsBtn.addEventListener('click', () => {
        const on = trailsBtn.getAttribute('aria-pressed') !== 'true';
        trailsBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
        state.trails = on;
      });
      glowBtn.addEventListener('click', () => {
        const on = glowBtn.getAttribute('aria-pressed') !== 'true';
        glowBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
        state.glow = on;
      });
      noiseBtn.addEventListener('click', () => {
        const on = noiseBtn.getAttribute('aria-pressed') !== 'true';
        noiseBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
        root.classList.toggle('grain-off', !on);
      });
      linesBtn.addEventListener('click', () => {
        const on = linesBtn.getAttribute('aria-pressed') !== 'true';
        linesBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
        state.showLines = on;
      });
      saveBtn.addEventListener('click', () => {
        try {
          const a = document.createElement('a');
          a.download = `aether-bloom-${Date.now()}.png`;
          canvas.toBlob((blob) => {
            if (!blob) return;
            const url = URL.createObjectURL(blob);
            a.href = url; a.click();
            setTimeout(() => URL.revokeObjectURL(url), 800);
          }, 'image/png');
        } catch {}
      });

      swatches.forEach(s => s.addEventListener('click', () => applyPalette(s.dataset.pal)));

      // Sliders
      function updateVals() {
        valOrbs.textContent = String(state.orbs);
        valGrav.textContent = parseFloat(state.gravity).toFixed(2);
        valDrift.textContent = parseFloat(state.drift).toFixed(2);
        valTrail.textContent = parseFloat(state.trail).toFixed(2);
      }
      orbsKnob.addEventListener('input', () => { state.orbs = parseInt(orbsKnob.value, 10); seedOrbs(); updateVals(); });
      gravKnob.addEventListener('input', () => { state.gravity = parseFloat(gravKnob.value); updateVals(); });
      driftKnob.addEventListener('input', () => { state.drift = parseFloat(driftKnob.value); updateVals(); });
      trailKnob.addEventListener('input', () => { state.trail = parseFloat(trailKnob.value); updateVals(); });

      // Bootstrap
      function firstResize() { resize(); window.removeEventListener('load', firstResize); }
      window.addEventListener('load', firstResize);
      resize();
      updateVals();
      seedOrbs();

      if (!reduce) {
        last = performance.now();
        RAF = requestAnimationFrame(loop);
      }
    })();
  </script>
</div>
      </section>
      <!-- END_EDITABLE -->
    <script>
      // Only show a local placeholder if the agent hasn't written a timestamp yet
      const el = document.getElementById('last-updated');
      if (el && (!el.textContent || el.textContent.includes('not yet'))) {
        const now = new Date();
        el.textContent = `Last updated: ${now.toLocaleString(undefined, { hour12: false })}`;
      }
    </script>
  </body>
  </html>


