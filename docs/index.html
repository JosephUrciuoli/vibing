<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vibing</title>
    <style>
      :root {
        --bg: #0f1221;
        --fg: #e6e8f0;
        --muted: #9aa3b2;
        --accent: #8b5cf6;
      }
      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--fg);
        background: radial-gradient(1200px 800px at 70% 10%, #1b1f3a, var(--bg));
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        width: min(720px, 92vw);
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px;
        padding: 28px 24px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        backdrop-filter: blur(6px);
      }
      h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
        letter-spacing: 0.3px;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 18px;
      }
      #content {
        font-size: 18px;
        line-height: 1.6;
        background: rgba(255,255,255,0.04);
        border: 1px dashed rgba(255,255,255,0.12);
        border-radius: 12px;
        padding: 16px;
      }
      .footer {
        margin-top: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: var(--muted);
      }
      .badge {
        display: inline-block;
        background: rgba(139, 92, 246, 0.18);
        color: #d4c2ff;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(139, 92, 246, 0.35);
        letter-spacing: 0.2px;
      }
    </style>
  </head>
  <body>
    <!-- BEGIN_EDITABLE -->
      <section id="content">
<section class="vibe886" data-scheme="light" aria-live="polite">
  <style>
    .vibe886 {
      --ink: #0c1222;
      --muted: #5a647a;
      --line: rgba(12,18,34,0.12);
      --glass: rgba(255,255,255,0.62);
      --bg0: #fbfdff;
      --bg1: #eef5ff;
      --accent: #3c89ff;
      --accent-2: #a0ffe1;
      --r: 22px;
      position: relative;
      padding: 26px;
      border-radius: var(--r);
      color: var(--ink);
      background:
        radial-gradient(800px 600px at 110% -10%, rgba(60,137,255,0.14), transparent 60%),
        radial-gradient(900px 700px at -10% 120%, rgba(160,255,225,0.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.9),
        0 50px 100px rgba(17,24,40,0.18),
        0 10px 30px rgba(17,24,40,0.10);
      overflow: hidden;
      isolation: isolate;
    }
    .vibe886[data-scheme="dark"] {
      --ink: #eaf1ff;
      --muted: #93a0b8;
      --line: rgba(255,255,255,0.12);
      --glass: rgba(16,22,35,0.6);
      --bg0: #080c14;
      --bg1: #0d1422;
      --accent: #7dfdd6;
      --accent-2: #6bb6ff;
      background:
        radial-gradient(900px 700px at 10% -10%, rgba(109,160,255,0.20), transparent 60%),
        radial-gradient(900px 700px at 120% 120%, rgba(137,255,210,0.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.15),
        0 60px 130px rgba(0,0,0,0.55),
        0 10px 30px rgba(0,0,0,0.35);
    }
    .vibe886 * { box-sizing: border-box; }
    .vibe886 .noise {
      position: absolute; inset: 0; pointer-events: none; z-index: 0;
      background:
        repeating-linear-gradient(0deg, rgba(255,255,255,0.02) 0 2px, transparent 2px 4px),
        repeating-linear-gradient(90deg, rgba(0,0,0,0.02) 0 2px, transparent 2px 4px);
      mix-blend-mode: soft-light; opacity: .25;
    }
    .vibe886 .halo {
      position: absolute; inset: -30%; pointer-events: none; z-index: 0;
      background:
        radial-gradient(600px 600px at 25% 35%, rgba(60,137,255,0.20), transparent 60%),
        radial-gradient(900px 700px at 75% 70%, rgba(160,255,225,0.16), transparent 70%),
        radial-gradient(700px 600px at 40% 90%, rgba(255,160,210,0.10), transparent 70%);
      animation: hue886 28s linear infinite;
      filter: saturate(115%);
      mix-blend-mode: screen;
      opacity: .9;
    }
    @keyframes hue886 { 0% { filter: hue-rotate(0deg) saturate(115%); } 100% { filter: hue-rotate(360deg) saturate(115%); } }

    /* Top */
    .vibe886 .top {
      position: relative; z-index: 2; margin-bottom: 18px;
      display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: center;
    }
    .vibe886 .brand {
      display: inline-flex; align-items: center; gap: 12px;
      padding: 10px 14px; border-radius: 999px;
      border: 1px solid var(--line);
      background: linear-gradient(180deg, var(--glass), color-mix(in oklab, var(--glass) 40%, transparent));
      backdrop-filter: blur(12px) saturate(130%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
      user-select: none;
    }
    .vibe886 .gem {
      width: 30px; height: 30px; border-radius: 10px;
      display: grid; place-items: center;
      background: conic-gradient(from 0deg, var(--accent), var(--accent-2), #ff8ed2, #ffea7a, var(--accent));
      color: #0b1020; font: 900 12px/1 ui-sans-serif, system-ui;
      box-shadow: 0 12px 24px rgba(0,0,0,0.18), inset 0 1px 0 rgba(255,255,255,0.7);
      animation: float886 6s ease-in-out infinite;
    }
    @keyframes float886 { 0%,100% { transform: translateY(0) } 50% { transform: translateY(-3px) } }
    .vibe886 .brand b {
      font: 800 12px/1 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      letter-spacing: .22em; text-transform: uppercase; color: color-mix(in oklab, var(--ink) 82%, var(--muted));
      white-space: nowrap;
    }
    .vibe886 .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .vibe886 .chip {
      appearance: none; border: 1px solid var(--line); cursor: pointer;
      background: linear-gradient(180deg, var(--glass), color-mix(in oklab, var(--glass) 55%, transparent));
      color: var(--ink); padding: 10px 12px; border-radius: 999px;
      font: 900 11px/1 ui-sans-serif, system-ui; letter-spacing: .14em; text-transform: uppercase;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.55);
      transition: transform .14s ease, box-shadow .22s ease, background .22s ease;
    }
    .vibe886 .chip:hover { transform: translateY(-1px); }
    .vibe886 .chip:focus-visible { outline: none; box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 60%, white 20%); }

    /* Hero */
    .vibe886 .hero {
      position: relative; z-index: 2;
      display: grid; grid-template-columns: 1.1fr 1fr; gap: 20px; align-items: start;
    }
    @media (max-width: 980px) { .vibe886 .hero { grid-template-columns: 1fr; } }
    .vibe886 h1 {
      margin: 0;
      font: 900 clamp(34px, 7.6vw, 74px)/1.02 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      letter-spacing: -0.01em;
      background: radial-gradient(120% 120% at 0% 50%, var(--accent), var(--accent-2) 45%, #ff8ed2 75%, #ffea7a 100%);
      -webkit-background-clip: text; background-clip: text; color: transparent;
      filter: drop-shadow(0 8px 28px color-mix(in oklab, var(--accent) 20%, transparent));
    }
    .vibe886 .sub {
      margin: 10px 0 16px 0; color: var(--muted);
      font: 600 14px/1.8 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      max-width: 64ch;
    }

    /* Stage */
    .vibe886 .stage {
      position: relative;
      border-radius: 24px;
      border: 1px solid var(--line);
      background: linear-gradient(180deg, var(--glass), color-mix(in oklab, var(--glass) 45%, transparent));
      backdrop-filter: blur(14px) saturate(120%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.45), 0 18px 46px rgba(0,0,0,0.18);
      padding: 12px;
    }
    .vibe886 .wrap {
      position: relative; border-radius: 20px; overflow: hidden;
      height: min(68vh, 560px); min-height: 300px;
      transform-style: preserve-3d; transition: transform 220ms ease;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05), inset 0 -80px 120px rgba(0,0,0,0.15);
      mask-image: radial-gradient(120% 120% at 50% 40%, black 62%, transparent 106%);
    }
    .vibe886 canvas.sky {
      position: absolute; inset: 0; width: 100%; height: 100%;
      background: linear-gradient(180deg, color-mix(in oklab, var(--bg0) 95%, transparent), color-mix(in oklab, var(--bg1) 95%, transparent));
    }
    .vibe886 .overlay {
      position: absolute; right: 12px; top: 12px; z-index: 3;
      padding: 8px 10px; border-radius: 12px; color: var(--muted);
      font: 900 11px/1 ui-sans-serif, system-ui; letter-spacing: .14em; text-transform: uppercase;
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.3));
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.55);
    }

    /* Actions + Panels */
    .vibe886 .actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 6px; }
    .vibe886 .btn {
      appearance: none; border: 0; cursor: pointer; border-radius: 14px;
      padding: 12px 16px;
      font: 900 13px/1 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      letter-spacing: .02em; color: #0b0f18;
      background: linear-gradient(180deg, color-mix(in oklab, var(--accent) 85%, white 10%), color-mix(in oklab, var(--accent) 45%, black 0%));
      text-shadow: 0 1px 0 rgba(255,255,255,0.55);
      box-shadow: 0 14px 34px color-mix(in oklab, var(--accent) 28%, black 62%);
      transition: transform 160ms ease, box-shadow 220ms ease, background 220ms ease;
    }
    .vibe886 .btn:hover { transform: translateY(-1px); }
    .vibe886 .btn.ghost {
      color: var(--ink); background: linear-gradient(180deg, rgba(255,255,255,0.75), rgba(255,255,255,0.4));
      border: 1px solid var(--line); text-shadow: none; box-shadow: inset 0 1px 0 rgba(255,255,255,0.5);
    }

    .vibe886 .panel {
      display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 14px;
    }
    @media (max-width: 980px) { .vibe886 .panel { grid-template-columns: 1fr; } }
    .vibe886 .glass {
      border: 1px solid var(--line);
      background: linear-gradient(180deg, var(--glass), color-mix(in oklab, var(--glass) 55%, transparent));
      border-radius: 18px; padding: 14px;
      backdrop-filter: blur(12px) saturate(115%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.45);
      display: grid; gap: 12px;
    }
    .vibe886 .row { display: grid; gap: 8px; }
    .vibe886 label {
      font: 900 11px/1 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      letter-spacing: .18em; text-transform: uppercase; color: color-mix(in oklab, var(--ink) 75%, var(--muted));
    }
    .vibe886 input[type="range"] {
      -webkit-appearance: none; appearance: none; width: 100%;
      height: 8px; border-radius: 999px; outline: none; cursor: pointer;
      background: linear-gradient(90deg, var(--accent), var(--accent-2), #ff8ed2, #ffea7a);
    }
    .vibe886 input[type="range"]::-webkit-slider-thumb,
    .vibe886 input[type="range"]::-moz-range-thumb {
      -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%;
      background: #fff; border: 2px solid color-mix(in oklab, var(--accent) 70%, white 10%);
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
    }

    .vibe886 .stats {
      display: grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 10px;
    }
    .vibe886 .stat {
      border: 1px solid var(--line);
      background: linear-gradient(180deg, var(--glass), color-mix(in oklab, var(--glass) 55%, transparent));
      border-radius: 16px; padding: 12px;
      backdrop-filter: blur(10px) saturate(115%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.45);
    }
    .vibe886 .stat b { display: block; font: 900 22px/1.1 ui-sans-serif, system-ui; letter-spacing: -0.01em; color: var(--ink); }
    .vibe886 .stat span { display: block; margin-top: 2px; color: var(--muted); font: 800 12px/1.4 ui-sans-serif, system-ui; letter-spacing: .08em; text-transform: uppercase; }

    .vibe886 .foot {
      margin-top: 16px; display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 12px;
      color: var(--muted); font: 500 12px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
    }
    .vibe886 .hint { display: inline-flex; align-items: center; gap: 8px; }
    .vibe886 .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 16px color-mix(in oklab, var(--accent) 70%, transparent);
      animation: breathe886 3s ease-in-out infinite;
    }
    @keyframes breathe886 { 0%,100% { transform: scale(.9); opacity: .85 } 50% { transform: scale(1.18); opacity: 1 } }

    @media (prefers-reduced-motion: reduce) {
      .vibe886 .dot, .vibe886 .gem, .vibe886 .halo { animation: none; }
      .vibe886 .chip, .vibe886 .btn, .vibe886 .wrap { transition: none; }
    }
  </style>

  <div class="noise" aria-hidden="true"></div>
  <div class="halo" aria-hidden="true"></div>

  <div class="top" role="region" aria-label="Nebula Atelier 886">
    <div class="brand" aria-label="Brand">
      <span class="gem" aria-hidden="true">886</span>
      <b>Nebula Atelier • 886</b>
    </div>
    <div class="chips">
      <button class="chip" data-action="scheme" aria-pressed="false" title="Toggle Light/Dark">Light</button>
      <button class="chip" data-action="motion" aria-pressed="true" title="Pause/Play">Motion: On</button>
      <button class="chip" data-action="mode" title="Switch mode">Mode: Flock</button>
      <button class="chip" data-action="palette" title="Cycle colors">Palette: Iridescent</button>
      <button class="chip" data-action="save" title="Save image">Save PNG</button>
    </div>
  </div>

  <section class="hero" aria-label="Headline and scene">
    <div class="copy">
      <h1>Murmuration</h1>
      <p class="sub">A quiet flock navigates a luminous sky. Tug gently to steer; switch modes to orbit or cohere. Every movement leaves a whisper.</p>

      <div class="actions">
        <button class="btn" data-action="whirl">Whirl</button>
        <button class="btn ghost" data-action="scatter">Scatter</button>
        <button class="btn ghost" data-action="add">+ Birds</button>
      </div>

      <div class="panel" aria-label="Controls and stats">
        <div class="glass">
          <div class="row">
            <label for="count886">Count</label>
            <input id="count886" type="range" min="40" max="420" step="10" value="140" aria-label="Bird count">
          </div>
          <div class="row">
            <label for="cohere886">Cohesion</label>
            <input id="cohere886" type="range" min="0.02" max="0.5" step="0.01" value="0.16" aria-label="Cohesion strength">
          </div>
          <div class="row">
            <label for="trail886">Trail Fade</label>
            <input id="trail886" type="range" min="0.02" max="0.25" step="0.01" value="0.08" aria-label="Trail fade">
          </div>
        </div>
        <div class="stats" role="list">
          <div class="stat" role="listitem"><b data-stat="birds">140</b><span>Birds</span></div>
          <div class="stat" role="listitem"><b data-stat="mode">Flock</b><span>Mode</span></div>
          <div class="stat" role="listitem"><b data-stat="fps">—</b><span>FPS</span></div>
        </div>
      </div>
    </div>

    <div class="stage" aria-label="Sky stage">
      <div class="wrap" data-tilt>
        <canvas class="sky" aria-hidden="true"></canvas>
        <div class="overlay" aria-hidden="true">Drag to Guide</div>
      </div>
    </div>
  </section>

  <div class="foot">
    <div class="hint"><span class="dot" aria-hidden="true"></span><span>Tip: In Orbit mode, “Whirl” creates a graceful spiral bloom.</span></div>
    <span id="last-updated">Last updated: 2025-11-26 02:17:48 EST</span>
  </div>

  <script>
    (function () {
      const root = document.currentScript.closest('.vibe886');
      const canvas = root.querySelector('canvas.sky');
      const ctx = canvas.getContext('2d', { alpha: true });
      const wrap = root.querySelector('.wrap');

      const stamp = root.querySelector('#last-updated');

      const btnScheme  = root.querySelector('[data-action="scheme"]');
      const btnMotion  = root.querySelector('[data-action="motion"]');
      const btnMode    = root.querySelector('[data-action="mode"]');
      const btnPalette = root.querySelector('[data-action="palette"]');
      const btnSave    = root.querySelector('[data-action="save"]');
      const btnWhirl   = root.querySelector('[data-action="whirl"]');
      const btnScatter = root.querySelector('[data-action="scatter"]');
      const btnAdd     = root.querySelector('[data-action="add"]');

      const rangeCount   = root.querySelector('#count886');
      const rangeCohere  = root.querySelector('#cohere886');
      const rangeTrail   = root.querySelector('#trail886');

      const statBirds = root.querySelector('[data-stat="birds"]');
      const statMode  = root.querySelector('[data-stat="mode"]');
      const statFPS   = root.querySelector('[data-stat="fps"]');

      // Timestamp
      try {
        const d = new Date();
        const fmt = new Intl.DateTimeFormat(undefined, { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit', timeZoneName:'short' });
        stamp.textContent = 'Last updated: ' + fmt.format(d);
      } catch {
        stamp.textContent = 'Last updated: ' + new Date().toLocaleString();
      }

      // Palettes
      const palettes = [
        { name: 'Iridescent', stops: ['#3c89ff','#7dfdd6','#ff8ed2','#ffea7a'] },
        { name: 'Citrus',     stops: ['#ffb200','#8aff6b','#1ee6d0','#ff6392'] },
        { name: 'Violet',     stops: ['#c3a6ff','#7aa2ff','#5ee7ff','#ffd1ff'] },
        { name: 'Mono',       stops: ['#a8b3c7','#d2dae6','#8aa1c1','#ffffff'] }
      ];
      let paletteIndex = 0;

      function lerp(a,b,t){ return a + (b-a)*t; }
      function hexToRgb(h){
        const s = h.replace('#','');
        const n = parseInt(s.length===3 ? s.split('').map(c=>c+c).join('') : s, 16);
        return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
      }
      const palRGB = () => palettes[paletteIndex].stops.map(hexToRgb);
      function sample(t) {
        const stops = palRGB();
        const n = stops.length - 1;
        const p = Math.min(n, Math.max(0, Math.floor(t*n)));
        const lt = (t*n) - p;
        const a = stops[p], b = stops[Math.min(n, p+1)];
        const r = Math.round(lerp(a.r,b.r,lt));
        const g = Math.round(lerp(a.g,b.g,lt));
        const b2 = Math.round(lerp(a.b,b.b,lt));
        return 'rgb('+r+','+g+','+b2+')';
      }

      // Canvas sizing
      let dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      let W = 0, H = 0;
      function resize() {
        const rect = canvas.getBoundingClientRect();
        W = Math.max(320, Math.floor(rect.width));
        H = Math.max(260, Math.floor(rect.height));
        canvas.width = Math.floor(W * dpr);
        canvas.height = Math.floor(H * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        hardClear();
      }
      function hardClear() {
        const dark = root.getAttribute('data-scheme') === 'dark';
        ctx.globalCompositeOperation = 'source-over';
        ctx.globalAlpha = 1;
        ctx.fillStyle = dark ? 'rgba(8,12,20,1)' : 'rgba(251,253,255,1)';
        ctx.fillRect(0,0,W,H);
      }
      resize();
      window.addEventListener('resize', resize, { passive: true });

      // World
      const pointer = { x: W/2, y: H/2, down: false };
      let running = !window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      let trail = parseFloat(rangeTrail.value) || 0.08;
      let cohesion = parseFloat(rangeCohere.value) || 0.16;
      let mode = 'Flock'; // or 'Orbit'

      // Birds
      let COUNT = parseInt(rangeCount.value, 10) || 140;
      const birds = [];
      function makeBird() {
        return {
          x: Math.random() * W,
          y: Math.random() * H,
          vx: (Math.random()-0.5)*2,
          vy: (Math.random()-0.5)*2,
          hue: Math.random()
        };
      }
      function rebuild() {
        birds.length = 0;
        for (let i = 0; i < COUNT; i++) birds.push(makeBird());
        statBirds.textContent = String(COUNT);
      }
      rebuild();

      // Input + tilt
      function toLocal(e) {
        const rect = canvas.getBoundingClientRect();
        const cx = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const cy = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        return { x: cx, y: cy, rect };
      }
      function onMove(e) {
        const { x, y, rect } = toLocal(e);
        pointer.x = x; pointer.y = y;
        const nx = (x / rect.width) * 2 - 1;
        const ny = (y / rect.height) * 2 - 1;
        wrap.style.transform = 'rotateX(' + (ny * -5) + 'deg) rotateY(' + (nx * 5) + 'deg) translateZ(0)';
      }
      function onDown(e){ pointer.down = true; onMove(e); }
      function onUp(){ pointer.down = false; }
      root.addEventListener('pointermove', onMove, { passive: true });
      root.addEventListener('touchmove', onMove, { passive: true });
      root.addEventListener('pointerdown', onDown, { passive: true });
      root.addEventListener('touchstart', onDown, { passive: true });
      window.addEventListener('pointerup', onUp, { passive: true });
      window.addEventListener('touchend', onUp, { passive: true });

      // Physics helpers
      function limit(vx, vy, max) {
        const m = Math.hypot(vx, vy);
        if (m > max) { const s = max / (m + 1e-6); return [vx*s, vy*s]; }
        return [vx, vy];
      }

      // Render
      let last = performance.now();
      let accFPS = 0, accN = 0, fpsStamp = last;

      function step(now) {
        if (!running) return;
        const dt = Math.min(32, now - last);
        last = now;

        // FPS
        accN++; accFPS += 1000 / Math.max(1, dt);
        if (now - fpsStamp > 500) {
          statFPS.textContent = String(Math.round(accFPS / accN));
          accFPS = 0; accN = 0; fpsStamp = now;
        }

        // Fade canvas
        ctx.globalCompositeOperation = 'source-over';
        const dark = root.getAttribute('data-scheme') === 'dark';
        ctx.fillStyle = (dark ? 'rgba(8,12,20,' : 'rgba(251,253,255,') + trail + ')';
        ctx.fillRect(0,0,W,H);

        // Update
        const sepDist = 26;
        const maxSpeed = 2.6;
        const alignF = 0.06;
        const sepF = 0.09;
        const cohF = cohesion;

        for (let i = 0; i < birds.length; i++) {
          const b = birds[i];

          let ax = 0, ay = 0;
          let cx = 0, cy = 0, count = 0;
          let vxAvg = 0, vyAvg = 0;

          for (let j = 0; j < birds.length; j++) {
            if (i === j) continue;
            const o = birds[j];
            const dx = o.x - b.x;
            const dy = o.y - b.y;

            // Toroidal wrapping distance
            let ddx = dx, ddy = dy;
            if (Math.abs(dx) > W*0.5) ddx = dx - Math.sign(dx) * W;
            if (Math.abs(dy) > H*0.5) ddy = dy - Math.sign(dy) * H;

            const d2 = ddx*ddx + ddy*ddy;
            if (d2 < 120*120) {
              count++;
              cx += o.x; cy += o.y;
              vxAvg += o.vx; vyAvg += o.vy;
              if (d2 < sepDist*sepDist) {
                ax -= ddx * sepF; ay -= ddy * sepF;
              }
            }
          }

          if (count > 0) {
            // Alignment
            ax += (vxAvg / count - b.vx) * alignF;
            ay += (vyAvg / count - b.vy) * alignF;

            // Cohesion
            const tx = (cx / count) - b.x;
            const ty = (cy / count) - b.y;
            ax += tx * cohF; ay += ty * cohF;
          }

          // Modes
          if (mode === 'Orbit') {
            const dx = (W/2) - b.x;
            const dy = (H/2) - b.y;
            const dist = Math.hypot(dx, dy) + 1e-5;
            const pull = Math.min(0.12, 40 / (dist*dist));
            // radial pull
            ax += dx * pull; ay += dy * pull;
            // tangential swirl
            ax += -dy * 0.0028; ay += dx * 0.0028;
          }

          // Pointer influence
          if (pointer.down) {
            const dx = pointer.x - b.x;
            const dy = pointer.y - b.y;
            const d = Math.hypot(dx, dy) + 1e-5;
            const attract = 75 / (d*d);
            ax += dx * attract * 0.6;
            ay += dy * attract * 0.6;
          }

          b.vx += ax * (dt * 0.016);
          b.vy += ay * (dt * 0.016);
          [b.vx, b.vy] = limit(b.vx, b.vy, maxSpeed);

          b.x += b.vx * (dt * 0.06);
          b.y += b.vy * (dt * 0.06);

          // Wrap
          if (b.x < 0) b.x += W; if (b.x > W) b.x -= W;
          if (b.y < 0) b.y += H; if (b.y > H) b.y -= H;
        }

        // Draw
        ctx.globalCompositeOperation = 'lighter';
        for (let i = 0; i < birds.length; i++) {
          const b = birds[i];
          const spd = Math.hypot(b.vx, b.vy);
          const dir = Math.atan2(b.vy, b.vx);
          const t = ((i / birds.length) + (now*0.00008)) % 1;
          const col = sample(t);

          ctx.save();
          ctx.translate(b.x, b.y);
          ctx.rotate(dir);

          // soft triangle "plane"
          ctx.shadowColor = col;
          ctx.shadowBlur = 14 + spd * 6;
          ctx.globalAlpha = 0.10 + Math.min(0.4, spd * 0.14);
          ctx.fillStyle = col;

          const size = 5 + (i % 7) * 0.6;
          ctx.beginPath();
          ctx.moveTo(size*2.2, 0);
          ctx.lineTo(-size*1.4, size*0.9);
          ctx.lineTo(-size*1.4, -size*0.9);
          ctx.closePath();
          ctx.fill();
          ctx.restore();
        }

        requestAnimationFrame(step);
      }

      // Start
      hardClear();
      if (running) requestAnimationFrame((t0)=>{ last=t0; requestAnimationFrame(step); });

      // UI
      function syncUI() {
        btnMotion.textContent = 'Motion: ' + (running ? 'On' : 'Off');
        btnMotion.setAttribute('aria-pressed', String(running));
        btnPalette.textContent = 'Palette: ' + palettes[paletteIndex].name;
        statMode.textContent = mode;
        btnMode.textContent = 'Mode: ' + mode;
        const scheme = root.getAttribute('data-scheme');
        btnScheme.textContent = scheme === 'dark' ? 'Dark' : 'Light';
        btnScheme.setAttribute('aria-pressed', scheme === 'dark' ? 'true' : 'false');
      }
      syncUI();

      // Buttons
      btnScheme.addEventListener('click', () => {
        const dark = root.getAttribute('data-scheme') === 'dark';
        root.setAttribute('data-scheme', dark ? 'light' : 'dark');
        hardClear();
        syncUI();
      });

      btnMotion.addEventListener('click', () => {
        running = !running;
        syncUI();
        if (running) {
          last = performance.now();
          requestAnimationFrame(step);
        }
      });

      btnMode.addEventListener('click', () => {
        mode = mode === 'Flock' ? 'Orbit' : 'Flock';
        syncUI();
      });

      btnPalette.addEventListener('click', () => {
        paletteIndex = (paletteIndex + 1) % palettes.length;
        syncUI();
      });

      btnSave.addEventListener('click', () => {
        try {
          const a = document.createElement('a');
          a.download = 'murmuration-' + Date.now() + '.png';
          a.href = canvas.toDataURL('image/png');
          a.click();
        } catch {}
      });

      btnWhirl.addEventListener('click', () => {
        const cx = W/2, cy = H/2;
        for (let i = 0; i < birds.length; i++) {
          const b = birds[i];
          const dx = b.x - cx, dy = b.y - cy;
          const d = Math.hypot(dx, dy) + 1e-5;
          b.vx += -dy / d * 3.0;
          b.vy +=  dx / d * 3.0;
        }
      });

      btnScatter.addEventListener('click', () => {
        for (let i = 0; i < birds.length; i++) {
          const b = birds[i];
          b.vx = (Math.random()-0.5) * 5;
          b.vy = (Math.random()-0.5) * 5;
        }
        hardClear();
      });

      btnAdd.addEventListener('click', () => {
        COUNT = Math.min(600, COUNT + 20);
        for (let i = 0; i < 20; i++) birds.push(makeBird());
        statBirds.textContent = String(COUNT);
      });

      // Sliders
      rangeCount.addEventListener('input', () => {
        COUNT = parseInt(rangeCount.value, 10) || COUNT;
        rebuild();
      });
      rangeCohere.addEventListener('input', () => { cohesion = parseFloat(rangeCohere.value) || cohesion; });
      rangeTrail.addEventListener('input', () => { trail = parseFloat(rangeTrail.value) || trail; });

      // Respect reduced motion
      if (!running) {
        syncUI();
      }
    })();
  </script>
</section>
      </section>
      <!-- END_EDITABLE -->
    <script>
      // Only show a local placeholder if the agent hasn't written a timestamp yet
      const el = document.getElementById('last-updated');
      if (el && (!el.textContent || el.textContent.includes('not yet'))) {
        const now = new Date();
        el.textContent = `Last updated: ${now.toLocaleString(undefined, { hour12: false })}`;
      }
    </script>
  </body>
  </html>


