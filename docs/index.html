<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vibing</title>
    <style>
      :root {
        --bg: #0f1221;
        --fg: #e6e8f0;
        --muted: #9aa3b2;
        --accent: #8b5cf6;
      }
      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--fg);
        background: radial-gradient(1200px 800px at 70% 10%, #1b1f3a, var(--bg));
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        width: min(720px, 92vw);
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px;
        padding: 28px 24px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        backdrop-filter: blur(6px);
      }
      h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
        letter-spacing: 0.3px;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 18px;
      }
      #content {
        font-size: 18px;
        line-height: 1.6;
        background: rgba(255,255,255,0.04);
        border: 1px dashed rgba(255,255,255,0.12);
        border-radius: 12px;
        padding: 16px;
      }
      .footer {
        margin-top: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: var(--muted);
      }
      .badge {
        display: inline-block;
        background: rgba(139, 92, 246, 0.18);
        color: #d4c2ff;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(139, 92, 246, 0.35);
        letter-spacing: 0.2px;
      }
    </style>
  </head>
  <body>
    <!-- BEGIN_EDITABLE -->
      <section id="content">
<section class="orbital" data-theme="ice" data-zen="off">
  <style>
    .orbital{
      --ink: #0b0f14;
      --bg-a: #eef7ff;
      --bg-b: #fff7f1;
      --p1: #7ad9ff; --p2:#89a7ff; --p3:#8cf7e2; --p4:#e3f0ff;
      --ring: color-mix(in oklab, var(--p2), white 40%);
      --glass: rgba(255,255,255,.72);
      position: relative; border-radius: 28px; padding: clamp(18px, 4vmin, 30px);
      background:
        radial-gradient(120% 100% at 10% -10%, rgba(255,255,255,.9), transparent 60%),
        radial-gradient(120% 120% at 100% 0%, rgba(255,255,255,.8), transparent 55%),
        linear-gradient(160deg, var(--bg-a), var(--bg-b));
      border: 1px solid color-mix(in oklab, var(--ink), white 88%);
      box-shadow: 0 30px 80px rgba(12,18,30,.16), inset 0 0 0 1px rgba(255,255,255,.6);
      color: var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Display", Inter, Segoe UI, Roboto, Helvetica, Arial;
      overflow: hidden; isolation: isolate;
    }
    .orbital::after{
      content:""; position:absolute; inset:-40%;
      background:
        conic-gradient(from 0deg, color-mix(in oklab, var(--p1), transparent 80%) 0 12%, transparent 12% 28%, color-mix(in oklab, var(--p3), transparent 80%) 28% 42%, transparent 42% 70%, color-mix(in oklab, var(--p2), transparent 82%) 70% 86%, transparent 86% 100%);
      filter: blur(60px) saturate(130%);
      opacity:.8; pointer-events:none; animation: swirl 42s linear infinite;
    }
    @keyframes swirl{ to{ transform: rotate(360deg) scale(1.02);} }

    .top{
      display:grid; grid-template-columns: 1fr auto; gap: 14px; align-items: start; position: relative; z-index: 2;
    }
    .brand{
      display:flex; flex-direction:column; gap:8px;
    }
    .title{
      margin:0; font-weight:1000; letter-spacing:-.03em; line-height: .95;
      font-size: clamp(32px, 8.4vw, 92px);
      background: linear-gradient(180deg, #0a0e14, color-mix(in oklab, var(--ink), #5a6877 46%));
      -webkit-background-clip: text; background-clip: text; color: transparent;
      text-shadow: 0 1px 0 rgba(255,255,255,.6);
    }
    .subtitle{
      margin:0; font-size: 13px; letter-spacing:.12em; text-transform: uppercase; color: color-mix(in oklab, var(--ink), white 55%);
    }

    .themes{
      display:flex; gap:8px; align-items:center; padding:6px; border-radius:16px;
      background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.6));
      border:1px solid color-mix(in oklab, var(--ink), white 86%);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.9);
      backdrop-filter: blur(10px) saturate(120%);
    }
    .theme{
      appearance:none; border:0; cursor:pointer; border-radius:12px; padding:8px 12px;
      font-weight:900; letter-spacing:.02em; font-size:12px; color: color-mix(in oklab, var(--ink), white 55%); background:transparent;
      transition: transform .08s ease, box-shadow .2s ease, color .2s ease, background .2s ease;
    }
    .theme[aria-selected="true"]{
      color:#0a0e14;
      background: linear-gradient(180deg, color-mix(in oklab, var(--p1), white 28%), color-mix(in oklab, var(--p2), white 28%));
      box-shadow: 0 10px 26px rgba(40,60,100,.25), inset 0 0 0 1px rgba(255,255,255,.8);
    }

    .wrap{
      margin-top: 14px; display:grid; grid-template-columns: 1fr auto; gap: 16px; align-items: start;
    }

    .orb{
      position: relative; width: min(86vw, 860px); aspect-ratio: 1 / 1; border-radius: 50%;
      background: radial-gradient(120% 120% at 50% 48%, rgba(255,255,255,.85), rgba(255,255,255,.6));
      border: 1px solid color-mix(in oklab, var(--ink), white 84%);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.9),
        0 10px 30px rgba(15,20,30,.08),
        0 50px 140px rgba(15,20,30,.2);
      overflow: hidden; transform: rotateX(var(--rx,0deg)) rotateY(var(--ry,0deg)); transform-style: preserve-3d; perspective: 1000px;
      transition: box-shadow .2s ease;
    }
    .orb:hover{ box-shadow:
      inset 0 0 0 1px rgba(255,255,255,.95),
      0 14px 36px rgba(15,20,30,.1),
      0 70px 180px rgba(15,20,30,.24);
    }
    canvas.ink{ position:absolute; inset:0; width:100%; height:100%; display:block; }
    .specular, .ring{
      pointer-events:none; position:absolute; inset:0; border-radius:50%;
    }
    .specular{
      background:
        radial-gradient(60% 20% at 20% 12%, rgba(255,255,255,.9), transparent 60%),
        radial-gradient(55% 18% at 78% 8%, rgba(255,255,255,.75), transparent 62%),
        radial-gradient(60% 70% at 50% 70%, rgba(255,255,255,.06), transparent 70%);
      mix-blend-mode: screen;
    }
    .ring{
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.8),
        inset 0 0 0 10px rgba(255,255,255,.06),
        0 0 0 1px color-mix(in oklab, var(--ink), white 86%);
      background:
        radial-gradient(75% 75% at 50% 50%, transparent 60%, rgba(255,255,255,.06) 61% 100%),
        conic-gradient(from 90deg, transparent 0 25%, var(--ring) 25% 35%, transparent 35% 65%, var(--ring) 65% 75%, transparent 75% 100%);
      animation: halo 18s linear infinite;
      opacity:.9;
    }
    @keyframes halo{ to{ transform: rotate(360deg);} }

    .read{
      display:flex; flex-direction:column; gap:8px; align-items:flex-start; min-width: 220px; padding: 8px;
    }
    .chip{
      padding:7px 10px; border-radius:999px; font-size:12px; color:var(--ink);
      border:1px solid color-mix(in oklab, var(--ink), white 82%);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.74));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.9);
      font-variant-numeric: tabular-nums; white-space:nowrap;
    }

    .dock{
      margin-top: 16px; display:grid; grid-template-columns: 1.2fr .8fr; gap: 12px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.7));
      border:1px solid color-mix(in oklab, var(--ink), white 83%);
      border-radius:16px; padding:12px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.92), 0 14px 30px rgba(25,30,45,.12);
      backdrop-filter: blur(8px) saturate(120%);
      transition: transform .12s ease, box-shadow .2s ease;
    }
    .card:hover{ transform: translateY(-2px); box-shadow: 0 18px 42px rgba(25,30,45,.16), inset 0 0 0 1px rgba(255,255,255,.95); }
    .label{
      display:flex; align-items:center; gap:8px; font-size:12px; font-weight:900; letter-spacing:.06em; text-transform:uppercase; color: color-mix(in oklab, var(--ink), white 55%); margin-bottom:8px;
    }
    .seed{ width:10px; height:10px; border-radius:50%;
      background: linear-gradient(180deg, var(--p1), var(--p2));
      box-shadow: 0 0 0 1px rgba(0,0,0,.08), 0 6px 16px color-mix(in oklab, var(--p2), transparent 60%);
    }

    .row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .range{ appearance:none; width:100%; height:36px; background:transparent; }
    .range::-webkit-slider-runnable-track{
      height:10px; border-radius:999px; border:1px solid color-mix(in oklab, var(--ink), white 82%);
      background: linear-gradient(90deg, var(--p1), var(--p2), var(--p3));
    }
    .range::-webkit-slider-thumb{
      -webkit-appearance:none; width:22px; height:22px; border-radius:50%; margin-top:-6px;
      background:var(--glass); border:1px solid rgba(0,0,0,.12);
      box-shadow: 0 4px 10px rgba(0,0,0,.15), inset 0 0 0 4px color-mix(in oklab, var(--p2), white 25%);
      cursor:pointer;
    }
    .range::-moz-range-track{
      height:10px; border-radius:999px; border:1px solid color-mix(in oklab, var(--ink), white 82%);
      background: linear-gradient(90deg, var(--p1), var(--p2), var(--p3));
    }
    .range::-moz-range-thumb{
      width:22px; height:22px; border-radius:50%;
      background:var(--glass); border:1px solid rgba(0,0,0,.12);
      box-shadow: 0 4px 10px rgba(0,0,0,.15), inset 0 0 0 4px color-mix(in oklab, var(--p2), white 25%);
      cursor:pointer;
    }

    .bubble{
      min-width:110px; text-align:center; font-weight:900; font-size:12px; letter-spacing:.04em; padding:8px 10px; border-radius:12px;
      border:1px solid color-mix(in oklab, var(--ink), white 80%);
      background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.7));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.9); color:var(--ink);
    }
    .btn{
      appearance:none; border:1px solid color-mix(in oklab, var(--ink), white 82%); border-radius:12px; padding:10px 14px; cursor:pointer;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.75));
      color: var(--ink); font-weight:900; font-size:12px; letter-spacing:.04em;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.95), 0 8px 18px rgba(25,30,45,.12);
      transition: transform .08s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
    }
    .btn:hover{ box-shadow: inset 0 0 0 1px rgba(255,255,255,1), 0 12px 26px rgba(25,30,45,.16); }
    .btn:active{ transform: translateY(1px); }
    .btn.on{
      color:#0b0e13;
      background: linear-gradient(180deg, color-mix(in oklab, var(--p1), white 25%), color-mix(in oklab, var(--p2), white 25%));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.95), 0 10px 26px color-mix(in oklab, var(--p2), transparent 70%);
    }

    .rule{ height:1px; width:100%; margin:16px 0; background: linear-gradient(90deg, transparent, color-mix(in oklab, var(--ink), white 82%), transparent); }
    .foot{ display:flex; justify-content:space-between; align-items:center; gap:10px; color: color-mix(in oklab, var(--ink), white 55%); font-size:12px; }

    .orbital[data-zen="on"] .dock,
    .orbital[data-zen="on"] .themes,
    .orbital[data-zen="on"] .read { opacity:.7; }

    @media (max-width: 980px){
      .top{ grid-template-columns: 1fr; }
      .wrap{ grid-template-columns: 1fr; }
      .dock{ grid-template-columns: 1fr; }
      .read{ flex-direction: row; flex-wrap: wrap; }
    }
  </style>

  <div class="top">
    <div class="brand">
      <h1 class="title">Vortice</h1>
      <p class="subtitle">A breathing glass orb of light</p>
    </div>
    <div class="themes" role="tablist" aria-label="Theme">
      <button class="theme" role="tab" data-theme="ice" aria-selected="true">Ice</button>
      <button class="theme" role="tab" data-theme="aurora" aria-selected="false">Aurora</button>
      <button class="theme" role="tab" data-theme="ember" aria-selected="false">Ember</button>
      <button class="theme" role="tab" data-theme="forest" aria-selected="false">Forest</button>
      <button class="theme" role="tab" data-theme="noir" aria-selected="false">Noir</button>
    </div>
  </div>

  <div class="wrap" aria-label="Glass orb playground">
    <div class="orb" data-tilt>
      <canvas class="ink"></canvas>
      <div class="specular"></div>
      <div class="ring"></div>
    </div>
    <div class="read">
      <span class="chip" data-count>â€”</span>
      <span class="chip" data-speed-pill>Speed 1.0x</span>
      <span class="chip" data-trail-pill>Trail 0.08</span>
      <span class="chip" data-density-pill>Density 1.00</span>
    </div>
  </div>

  <div class="dock">
    <div class="card">
      <div class="label"><span class="seed"></span> Motion</div>
      <div class="row" style="margin-bottom:8px;">
        <input class="range" type="range" min="0.4" max="2.2" step="0.1" value="1.0" aria-label="Speed" data-speed>
        <div class="bubble" data-speed-bubble>Speed 1.0x</div>
      </div>
      <div class="row">
        <input class="range" type="range" min="0.02" max="0.18" step="0.01" value="0.08" aria-label="Trail (fade)" data-trail>
        <div class="bubble" data-trail-bubble>Trail 0.08</div>
      </div>
    </div>

    <div class="card">
      <div class="label"><span class="seed"></span> Field</div>
      <div class="row" style="margin-bottom:8px;">
        <input class="range" type="range" min="0.6" max="2.4" step="0.05" value="1.0" aria-label="Density" data-density>
        <div class="bubble" data-density-bubble>Density 1.00</div>
      </div>
      <div class="row">
        <input class="range" type="range" min="6" max="30" step="1" value="14" aria-label="Glow" data-glow>
        <div class="bubble" data-glow-bubble>Glow 14</div>
      </div>
    </div>

    <div class="card">
      <div class="label"><span class="seed"></span> Controls</div>
      <div class="row" style="margin-bottom:8px;">
        <button class="btn" data-breathe>Breathe</button>
        <button class="btn" data-zen>Zen</button>
        <button class="btn" data-shuffle>Shuffle</button>
        <button class="btn" data-pause>Pause</button>
        <button class="btn" data-save>Save PNG</button>
      </div>
      <div class="subtitle">Drag to tilt the orb. Let it breathe.</div>
    </div>
  </div>

  <div class="rule"></div>
  <div class="foot">
    <span class="chip">Theme: <span data-theme-name>Ice</span></span>
    <span id="last-updated">Last updated: 2025-12-30 10:20:14 EST</span>
  </div>

  <script>
    (function(){
      const root = document.currentScript.closest('.orbital');
      const orb = root.querySelector('.orb');
      const canvas = root.querySelector('canvas.ink');
      const ctx = canvas.getContext('2d');
      const themes = root.querySelectorAll('.theme');
      const themeNameEl = root.querySelector('[data-theme-name]');
      const last = root.querySelector('#last-updated');

      const countChip = root.querySelector('[data-count]');
      const speedBubble = root.querySelector('[data-speed-bubble]');
      const trailBubble = root.querySelector('[data-trail-bubble]');
      const densityBubble = root.querySelector('[data-density-bubble]');
      const glowBubble = root.querySelector('[data-glow-bubble]');
      const speedPill = root.querySelector('[data-speed-pill]');
      const trailPill = root.querySelector('[data-trail-pill]');
      const densityPill = root.querySelector('[data-density-pill]');

      const speedRange = root.querySelector('[data-speed]');
      const trailRange = root.querySelector('[data-trail]');
      const densityRange = root.querySelector('[data-density]');
      const glowRange = root.querySelector('[data-glow]');
      const breatheBtn = root.querySelector('[data-breathe]');
      const zenBtn = root.querySelector('[data-zen]');
      const shuffleBtn = root.querySelector('[data-shuffle]');
      const pauseBtn = root.querySelector('[data-pause]');
      const saveBtn = root.querySelector('[data-save]');

      const THEMES = {
        ice:    { bgA:'#eef7ff', bgB:'#fff7f1', p1:'#7ad9ff', p2:'#89a7ff', p3:'#8cf7e2', ring:'#9fb7ff', ink:'#0b0f14' },
        aurora: { bgA:'#eef6ff', bgB:'#faf3ff', p1:'#6ef1b6', p2:'#7acbff', p3:'#b99bff', ring:'#a8ffe7', ink:'#0b1211' },
        ember:  { bgA:'#fff2ea', bgB:'#fff9ee', p1:'#ffb36e', p2:'#ff7a7a', p3:'#ffd36e', ring:'#ffc7a3', ink:'#1a100b' },
        forest: { bgA:'#f1fff7', bgB:'#f9fff2', p1:'#4fe0a1', p2:'#78e27c', p3:'#8bd4ff', ring:'#a6f3bf', ink:'#0e160d' },
        noir:   { bgA:'#f3f4f7', bgB:'#f9f9fb', p1:'#5b6b7a', p2:'#8b98a8', p3:'#b8c2ce', ring:'#cbd6e2', ink:'#0b0e12' }
      };

      function applyTheme(name){
        const t = THEMES[name] || THEMES.ice;
        root.style.setProperty('--bg-a', t.bgA);
        root.style.setProperty('--bg-b', t.bgB);
        root.style.setProperty('--p1', t.p1);
        root.style.setProperty('--p2', t.p2);
        root.style.setProperty('--p3', t.p3);
        root.style.setProperty('--ring', t.ring);
        root.style.setProperty('--ink', t.ink);
        root.setAttribute('data-theme', name);
        themes.forEach(b => b.setAttribute('aria-selected', String(b.dataset.theme===name)));
        themeNameEl.textContent = name[0].toUpperCase()+name.slice(1);
        palette = buildPalette();
      }
      themes.forEach(b => b.addEventListener('click', ()=> applyTheme(b.dataset.theme)));

      // Tilt
      function tilt(e){
        const r = orb.getBoundingClientRect();
        const x = (e.clientX - r.left)/r.width - 0.5;
        const y = (e.clientY - r.top)/r.height - 0.5;
        orb.style.setProperty('--rx', `${-y*10}deg`);
        orb.style.setProperty('--ry', `${x*10}deg`);
      }
      orb.addEventListener('pointermove', tilt);
      orb.addEventListener('pointerleave', ()=>{ orb.style.setProperty('--rx','0deg'); orb.style.setProperty('--ry','0deg'); });

      // Canvas sizing
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
      let W=0, H=0, R=0, area=0;
      function resize(){
        const r = canvas.getBoundingClientRect();
        W = Math.max(1, Math.floor(r.width));
        H = Math.max(1, Math.floor(r.height));
        area = W*H;
        R = Math.min(W,H)/2;
        canvas.width = Math.floor(W*dpr);
        canvas.height = Math.floor(H*dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
        reset();
      }
      new ResizeObserver(resize).observe(orb);

      // Palette
      function hexToRGB(h){ const v=h.replace('#',''); const s=v.length===3? v.split('').map(c=>c+c).join(''):v; const n=parseInt(s,16); return [(n>>16)&255,(n>>8)&255,n&255]; }
      function lerp(a,b,t){ return a + (b-a)*t; }
      function mix(a,b,t){ return [Math.round(lerp(a[0],b[0],t)),Math.round(lerp(a[1],b[1],t)),Math.round(lerp(a[2],b[2],t))]; }
      function buildPalette(){
        const p1 = hexToRGB(getComputedStyle(root).getPropertyValue('--p1'));
        const p2 = hexToRGB(getComputedStyle(root).getPropertyValue('--p2'));
        const p3 = hexToRGB(getComputedStyle(root).getPropertyValue('--p3'));
        const out = [];
        const n=48;
        for(let i=0;i<n;i++){
          const t=i/(n-1);
          const a=mix(p1,p2,t);
          const b=mix(p2,p3,1-t);
          const u=mix(a,b,0.5+0.5*Math.sin(t*Math.PI));
          out.push(`rgba(${u[0]},${u[1]},${u[2]},0.22)`);
        }
        return out;
      }
      let palette = buildPalette();

      // Parameters
      let SPEED = parseFloat(speedRange.value);
      let TRAIL = parseFloat(trailRange.value);
      let DENSITY = parseFloat(densityRange.value);
      let GLOW = parseInt(glowRange.value,10);

      function updateBubbles(){
        speedBubble.textContent = `Speed ${SPEED.toFixed(1)}x`;
        trailBubble.textContent = `Trail ${TRAIL.toFixed(2)}`;
        densityBubble.textContent = `Density ${DENSITY.toFixed(2)}`;
        glowBubble.textContent = `Glow ${GLOW}`;
        speedPill.textContent = `Speed ${SPEED.toFixed(1)}x`;
        trailPill.textContent = `Trail ${TRAIL.toFixed(2)}`;
        densityPill.textContent = `Density ${DENSITY.toFixed(2)}`;
      }
      speedRange.addEventListener('input', e=>{ SPEED=parseFloat(e.target.value); updateBubbles(); });
      trailRange.addEventListener('input', e=>{ TRAIL=parseFloat(e.target.value); updateBubbles(); });
      densityRange.addEventListener('input', e=>{ DENSITY=parseFloat(e.target.value); reset(); updateBubbles(); });
      glowRange.addEventListener('input', e=>{ GLOW=parseInt(e.target.value,10); updateBubbles(); });

      // Particles
      let particles = [];
      function reset(){
        const k = 0.0009 * DENSITY; // density per px
        const target = Math.max(360, Math.floor(area * k));
        particles = new Array(target).fill(0).map((_,i)=>({
          a: Math.random()*Math.PI*2, // angle
          r: 10 + Math.random()*R*0.92, // radius
          h: Math.random(),             // hue index
          w: 0.6 + Math.random()*0.7,   // line weight factor
          s: 0.3 + Math.random()*0.7    // speed factor
        }));
        countChip.textContent = `${particles.length.toLocaleString()} filaments`;
        // soften reset
        ctx.clearRect(0,0,W,H);
        ctx.fillStyle = 'rgba(255,255,255,1)';
        ctx.fillRect(0,0,W,H);
      }

      // Field influence
      function flow(t, a, r){
        // gentle spiral with small radial breathing
        const swirl = 0.8 + 0.6*Math.sin(t*0.35 + r*0.003);
        const drift = 0.4*Math.sin( (a*3) + t*0.7 ) * (r/R);
        return {
          da: (0.002 + 0.0015*(r/R)) * swirl + drift*0.0008,
          dr: Math.sin(a*2 + t*0.9)*0.6 + Math.cos(a*3 - t*0.6)*0.4
        };
      }

      // Animation
      let t=0, running=true, breathe=true;
      function step(){
        if(!running) return;
        t += 0.016 * SPEED;

        // Fade with trail
        ctx.globalCompositeOperation='source-over';
        ctx.fillStyle = `rgba(255,255,255,${TRAIL})`;
        ctx.fillRect(0,0,W,H);

        // Draw
        ctx.globalCompositeOperation='lighter';
        ctx.lineCap='round';
        ctx.shadowBlur = GLOW;
        ctx.shadowColor = palette[(Math.floor((t*12)%palette.length))] || palette[0];

        const cx=W/2, cy=H/2;
        for(let i=0;i<particles.length;i++){
          const p=particles[i];
          // previous position
          const x1 = cx + Math.cos(p.a)*p.r;
          const y1 = cy + Math.sin(p.a)*p.r;

          // influence
          const f = flow(t, p.a, p.r);
          p.a += (0.9 + 0.4*Math.sin(t*0.6 + p.r*0.01)) * f.da * p.s;
          p.r += f.dr * 0.4;

          // keep within orb
          if (p.r > R-6) p.r = 10;
          if (p.r < 8) p.r = R-10;

          const x2 = cx + Math.cos(p.a)*p.r;
          const y2 = cy + Math.sin(p.a)*p.r;

          const col = palette[(i + Math.floor(t*60)) % palette.length];
          ctx.strokeStyle = col;
          ctx.lineWidth = 0.5 + p.w * (0.6 + 0.5*Math.sin(p.a*2 + t));

          ctx.beginPath();
          ctx.moveTo(x1,y1);
          ctx.lineTo(x2,y2);
          ctx.stroke();
        }

        // pills
        speedPill.textContent = `Speed ${SPEED.toFixed(1)}x`;
        trailPill.textContent = `Trail ${TRAIL.toFixed(2)}`;
        densityPill.textContent = `Density ${DENSITY.toFixed(2)}`;

        requestAnimationFrame(step);
      }

      // Breathe modulation
      function breatheTick(){
        if(!breathe) return;
        const s = 0.5 + 0.5*Math.sin(t*0.25);
        TRAIL = 0.04 + s*0.07;
        SPEED = 0.9 + s*0.8;
        speedRange.value = SPEED.toFixed(1);
        trailRange.value = TRAIL.toFixed(2);
        updateBubbles();
        requestAnimationFrame(breatheTick);
      }

      // Controls
      zenBtn.addEventListener('click', ()=>{
        const on = root.getAttribute('data-zen')==='off';
        root.setAttribute('data-zen', on?'on':'off');
        zenBtn.classList.toggle('on', on);
      });

      breatheBtn.addEventListener('click', ()=>{
        breathe = !breathe;
        breatheBtn.classList.toggle('on', breathe);
        if (breathe) breatheTick();
      });

      pauseBtn.addEventListener('click', ()=>{
        running = !running;
        pauseBtn.classList.toggle('on', !running);
        pauseBtn.textContent = running ? 'Pause' : 'Resume';
        if (running) requestAnimationFrame(step);
      });

      shuffleBtn.addEventListener('click', ()=>{
        // random theme & params
        const keys = Object.keys(THEMES);
        const next = keys[Math.floor(Math.random()*keys.length)];
        applyTheme(next);
        SPEED = +(0.6 + Math.random()*1.6).toFixed(1);
        TRAIL = +(0.03 + Math.random()*0.12).toFixed(2);
        DENSITY = +(0.7 + Math.random()*1.6).toFixed(2);
        GLOW = 8 + Math.floor(Math.random()*20);
        speedRange.value = SPEED;
        trailRange.value = TRAIL;
        densityRange.value = DENSITY;
        glowRange.value = GLOW;
        updateBubbles();
        reset();
        flash(shuffleBtn);
      });

      function flash(btn){ btn.classList.add('on'); setTimeout(()=> btn.classList.remove('on'), 340); }

      saveBtn.addEventListener('click', ()=>{
        try{
          const off = document.createElement('canvas');
          off.width = canvas.width;
          off.height = canvas.height;
          const octx = off.getContext('2d');
          octx.drawImage(canvas,0,0);
          const link = document.createElement('a');
          link.download = `vortice-${(new Date()).toISOString().replace(/[:.]/g,'-')}.png`;
          link.href = off.toDataURL('image/png');
          link.click();
        }catch(e){}
      });

      // Keyboard theme navigation
      themes.forEach((m,idx)=>{
        m.addEventListener('keydown', e=>{
          if (e.key==='ArrowRight' || e.key==='ArrowDown'){ e.preventDefault(); themes[(idx+1)%themes.length].focus(); }
          if (e.key==='ArrowLeft' || e.key==='ArrowUp'){ e.preventDefault(); themes[(idx-1+themes.length)%themes.length].focus(); }
          if (e.key==='Enter' || e.key===' '){ e.preventDefault(); m.click(); }
        });
      });

      // Init
      applyTheme(root.getAttribute('data-theme') || 'ice');
      resize(); updateBubbles();
      requestAnimationFrame(step);
      breatheBtn.classList.add('on'); breathe = true; requestAnimationFrame(breatheTick);

      // Last updated
      try{
        const fmt = new Intl.DateTimeFormat(undefined, { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit', timeZoneName:'short' });
        last.textContent = 'Last updated: ' + fmt.format(new Date());
      } catch(e){
        last.textContent = 'Last updated: ' + new Date().toLocaleString();
      }
    })();
  </script>
</section>
      </section>
      <!-- END_EDITABLE -->
    <script>
      // Only show a local placeholder if the agent hasn't written a timestamp yet
      const el = document.getElementById('last-updated');
      if (el && (!el.textContent || el.textContent.includes('not yet'))) {
        const now = new Date();
        el.textContent = `Last updated: ${now.toLocaleString(undefined, { hour12: false })}`;
      }
    </script>
  </body>
  </html>


