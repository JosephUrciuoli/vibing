<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vibing</title>
    <style>
      :root {
        --bg: #0f1221;
        --fg: #e6e8f0;
        --muted: #9aa3b2;
        --accent: #8b5cf6;
      }
      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--fg);
        background: radial-gradient(1200px 800px at 70% 10%, #1b1f3a, var(--bg));
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        width: min(720px, 92vw);
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px;
        padding: 28px 24px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        backdrop-filter: blur(6px);
      }
      h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
        letter-spacing: 0.3px;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 18px;
      }
      #content {
        font-size: 18px;
        line-height: 1.6;
        background: rgba(255,255,255,0.04);
        border: 1px dashed rgba(255,255,255,0.12);
        border-radius: 12px;
        padding: 16px;
      }
      .footer {
        margin-top: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: var(--muted);
      }
      .badge {
        display: inline-block;
        background: rgba(139, 92, 246, 0.18);
        color: #d4c2ff;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(139, 92, 246, 0.35);
        letter-spacing: 0.2px;
      }
    </style>
  </head>
  <body>
    <!-- BEGIN_EDITABLE -->
      <section id="content">
<section class="v148" aria-label="Nocturne Observatory — Orbit Forge">
  <style>
    .v148 {
      --ink: hsl(220 22% 92%);
      --muted: hsl(220 10% 70%);
      --bg0: hsl(230 35% 6%);
      --bg1: hsl(250 36% 9%);
      --ring: hsl(230 70% 60% / 0.22);
      --glass: hsl(0 0% 100% / 0.05);
      --a1: hsl(195 90% 64%);
      --a2: hsl(280 88% 66%);
      --a3: hsl(42 90% 60%);
      --tempo: 1;
      color: var(--ink);
      background:
        radial-gradient(160% 120% at 0% 0%, hsl(260 80% 14% / 0.35), transparent 50%),
        radial-gradient(140% 120% at 100% 100%, hsl(200 80% 16% / 0.35), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      border-radius: 32px;
      box-shadow:
        inset 0 1px 0 hsl(0 0% 100% / 0.06),
        0 40px 160px hsl(220 60% 30% / 0.4),
        0 12px 44px hsl(220 50% 20% / 0.45);
      font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial;
      position: relative;
      overflow: hidden;
      min-height: 880px;
      isolation: isolate;
    }
    .v148::before,
    .v148::after {
      content: "";
      position: absolute; inset: -20%;
      background:
        radial-gradient(40% 28% at 15% 20%, hsl(195 95% 62% / 0.16), transparent 60%),
        radial-gradient(36% 26% at 85% 80%, hsl(285 88% 66% / 0.16), transparent 60%),
        conic-gradient(from var(--spin, 0deg) at 60% 40%, hsl(195 95% 62% / 0.06), transparent 16%, hsl(285 88% 66% / 0.06) 32%, transparent 50%, hsl(42 90% 60% / 0.06) 70%, transparent 100%);
      filter: blur(48px) saturate(120%);
      pointer-events: none;
      opacity: 0.65;
    }
    .v148::after { opacity: 0.35; transform: rotate(12deg) scale(1.12); }
    @keyframes spin {
      to { --spin: 360deg; }
    }
    .v148:not(.rm)::before { animation: spin calc(90s / var(--tempo)) linear infinite; }
    .v148 .wrap { width: min(1200px, 100%); margin-inline: auto; padding: clamp(20px, 5.2vw, 56px); position: relative; z-index: 1; }

    .v148 .top { display: grid; grid-template-columns: 1fr auto; align-items: end; gap: 14px; }
    .v148 .mark {
      display: inline-flex; align-items: center; gap: 10px;
      letter-spacing: 0.18em; text-transform: uppercase;
      color: var(--muted); font-weight: 800; font-size: 11px;
    }
    .v148 .gem {
      width: 26px; height: 26px; border-radius: 8px;
      background: linear-gradient(135deg, var(--a1), var(--a2));
      box-shadow:
        0 0 0 2px hsl(0 0% 100% / 0.12) inset,
        0 10px 26px hsl(260 80% 60% / 0.45),
        0 0 24px hsl(195 95% 62% / 0.35);
      position: relative;
    }
    .v148 .gem::after {
      content: "";
      position: absolute; inset: 3px;
      border-radius: 6px;
      background: radial-gradient(60% 60% at 30% 30%, hsl(0 0% 100% / 0.22), transparent 60%);
      mix-blend-mode: screen;
    }
    .v148 .pill {
      padding: 8px 12px; border-radius: 999px;
      border: 1px solid var(--ring);
      background: var(--glass);
      backdrop-filter: blur(10px) saturate(140%);
      color: var(--muted); font-weight: 700; font-size: 11px;
      box-shadow: 0 1px 0 hsl(0 0% 100% / 0.08) inset, 0 10px 30px hsl(220 80% 30% / 0.18);
    }

    .v148 .title {
      margin: 16px 0 8px 0;
      font-weight: 900; letter-spacing: -0.02em; line-height: 0.96;
      font-size: clamp(50px, 9.6vw, 120px);
      background: linear-gradient(100deg, hsl(0 0% 100%), var(--a1) 40%, var(--a2) 60%, var(--a3));
      -webkit-background-clip: text; background-clip: text; color: transparent;
      filter: drop-shadow(0 18px 40px hsl(240 80% 60% / 0.18));
      text-wrap: balance;
    }
    .v148 .sub {
      color: var(--muted); font-size: clamp(14px, 2.2vw, 18px);
      max-width: 72ch; text-wrap: balance;
    }

    .v148 .stage {
      position: relative; margin-top: clamp(18px, 4vw, 30px);
      border-radius: 26px; overflow: hidden; min-height: 620px;
      border: 1px solid var(--ring);
      background:
        radial-gradient(160% 140% at 50% 50%, hsl(220 40% 6%), hsl(230 40% 4%));
      box-shadow:
        0 12px 70px hsl(230 75% 30% / 0.25),
        inset 0 1px 0 hsl(0 0% 100% / 0.06);
      perspective: 900px; transform-style: preserve-3d;
    }
    .v148 canvas { position: absolute; inset: 0; width: 100%; height: 100%; display: block; }

    .v148 .frame {
      position: absolute; inset: 0; pointer-events: none;
      border-radius: 26px;
      box-shadow:
        0 0 0 1px var(--ring) inset,
        0 0 0 2px hsl(0 0% 100% / 0.06) inset,
        0 0 120px hsl(195 90% 64% / 0.14) inset,
        0 0 120px hsl(280 88% 66% / 0.14) inset;
      mask: radial-gradient(140% 120% at 50% 50%, #000 72%, transparent);
    }

    .v148 .controls {
      position: absolute; z-index: 2;
      left: 50%; bottom: clamp(10px, 4vw, 22px); transform: translateX(-50%);
      display: grid; grid-auto-flow: column; gap: 10px; align-items: center;
      background: hsl(220 30% 12% / 0.55); border: 1px solid var(--ring); border-radius: 999px; padding: 10px 12px;
      box-shadow: 0 16px 50px hsl(230 70% 30% / 0.28), 0 1px 0 hsl(0 0% 100% / 0.06) inset;
      backdrop-filter: blur(14px) saturate(160%);
    }
    .v148 .btn, .v148 .toggle {
      appearance: none; cursor: pointer; user-select: none;
      border-radius: 999px; padding: 10px 14px;
      font-weight: 800; letter-spacing: 0.01em; font-size: 12px;
      color: var(--ink); border: 1px solid var(--ring);
      background: linear-gradient(180deg, hsl(220 20% 18%), hsl(220 20% 12% / 0.6));
      box-shadow: 0 1px 0 hsl(0 0% 100% / 0.06) inset, 0 6px 16px hsl(230 70% 30% / 0.28);
      transition: transform 120ms ease, background 220ms ease, border-color 220ms ease, box-shadow 220ms ease, color 220ms ease;
    }
    .v148 .btn:hover, .v148 .toggle:hover { transform: translateY(-1px); }
    .v148 .btn:active, .v148 .toggle:active { transform: translateY(0); box-shadow: 0 2px 8px hsl(230 70% 30% / 0.28) inset; }
    .v148 .primary {
      color: white;
      background: linear-gradient(92deg, var(--a1), var(--a2));
      border-color: transparent;
      box-shadow: 0 10px 22px rgba(148, 99, 255, 0.36), 0 0 0 1px hsl(0 0% 100% / 0.05) inset;
    }
    .v148 .toggle[aria-pressed="true"] { outline: 2px solid var(--a1); outline-offset: 2px; }

    .v148 .slider {
      display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 8px;
      color: var(--muted); font-size: 12px;
      border: 1px solid var(--ring);
      background: linear-gradient(180deg, hsl(220 20% 16%), hsl(220 20% 12% / 0.8));
      padding: 8px 10px; border-radius: 999px;
      box-shadow: 0 1px 0 hsl(0 0% 100% / 0.06) inset;
      backdrop-filter: blur(10px) saturate(140%);
    }
    .v148 input[type="range"] {
      accent-color: hsl(195 90% 64%);
      width: 160px; height: 6px; cursor: pointer; appearance: none; outline: none; border-radius: 999px;
      background: linear-gradient(90deg, var(--a1), var(--a2), var(--a3));
    }
    .v148 input[type="range"]::-webkit-slider-thumb {
      appearance: none; width: 18px; height: 18px; border-radius: 50%;
      background: hsl(0 0% 100% / 0.95); border: 2px solid hsl(0 0% 100% / 0.12);
      box-shadow: 0 8px 18px hsl(240 80% 40% / 0.35);
      margin-top: -6px;
    }
    .v148 input[type="range"]::-moz-range-thumb {
      width: 18px; height: 18px; border-radius: 50%;
      background: hsl(0 0% 100% / 0.95); border: 2px solid hsl(0 0% 100% / 0.12);
    }
    .v148 .val { font-variant-numeric: tabular-nums; color: var(--ink); font-weight: 800; padding: 6px 10px; }

    .v148 .foot {
      display: flex; justify-content: space-between; align-items: center;
      padding: 22px clamp(20px, 5.2vw, 56px) 36px; color: var(--muted);
      font-size: 12px; flex-wrap: wrap; gap: 10px; position: relative; z-index: 1;
    }
    .v148 .tags { display: flex; gap: 8px; flex-wrap: wrap; }
    .v148 .tag {
      padding: 6px 10px; border-radius: 999px;
      border: 1px solid var(--ring);
      background: hsl(220 30% 12% / 0.6);
      color: var(--ink);
      backdrop-filter: blur(6px);
    }
    .v148 .kbd {
      padding: 4px 8px; border-radius: 6px; border: 1px solid var(--ring);
      background: hsl(220 30% 12% / 0.5);
      font-variant-numeric: tabular-nums; color: var(--ink);
    }

    /* Reduced motion */
    .v148.rm * { transition: none !important; animation: none !important; }
  </style>

  <div class="wrap" tabindex="0">
    <div class="top">
      <div class="mark">
        <span class="gem" aria-hidden="true"></span>
        Edition 148 — Nocturne Observatory
      </div>
      <div class="pill">Night · Gravity · Glow</div>
    </div>

    <h2 class="title">Orbit Forge</h2>
    <p class="sub">Sketch gravity with your cursor; release to let the galaxy remember. Save a frame when it sings.</p>

    <div class="stage" id="v148-stage" aria-label="Generative orbital painter">
      <canvas id="v148-canvas" role="img" aria-label="Neon startrails weaving over a midnight field"></canvas>
      <div class="frame" aria-hidden="true"></div>

      <div class="controls" aria-label="Controls">
        <button class="btn primary" id="v148-palette" type="button" aria-label="Cycle palette">Palette: Nocturne</button>
        <button class="toggle" id="v148-afterglow" type="button" aria-pressed="true" aria-label="Toggle afterglow">Afterglow</button>
        <button class="toggle" id="v148-glow" type="button" aria-pressed="true" aria-label="Toggle glow">Glow</button>
        <button class="btn" id="v148-burst" type="button" aria-label="Burst">Pulse</button>
        <button class="btn" id="v148-reseed" type="button" aria-label="Reseed system">Reseed</button>
        <button class="btn" id="v148-play" type="button" aria-label="Pause animation">Pause</button>
        <button class="btn" id="v148-save" type="button" aria-label="Save image">Save</button>

        <label class="slider" for="v148-grav">
          <span>Gravity</span>
          <input id="v148-grav" type="range" min="20" max="240" value="120" />
          <span class="val" id="v148-grav-val">1.2×</span>
        </label>

        <label class="slider" for="v148-pop">
          <span>Population</span>
          <input id="v148-pop" type="range" min="120" max="1200" value="480" />
          <span class="val" id="v148-pop-val">480</span>
        </label>
      </div>
    </div>
  </div>

  <div class="foot">
    <div class="tags" role="list" aria-label="design notes">
      <span class="tag" role="listitem">Dark theme</span>
      <span class="tag" role="listitem">Orbits & attractors</span>
      <span class="tag" role="listitem">Save as PNG</span>
      <span class="tag" role="listitem">Shortcuts: <span class="kbd">Space</span> <span class="kbd">G</span> <span class="kbd">A</span> <span class="kbd">P</span> <span class="kbd">S</span> <span class="kbd">R</span></span>
    </div>
    <small><span id="last-updated">Last updated: 2025-10-23 10:18:45 EST</span></small>
  </div>

  <script>
    (function () {
      const root = document.currentScript.closest('.v148');
      const stage = root.querySelector('#v148-stage');
      const canvas = root.querySelector('#v148-canvas');
      const ctx = canvas.getContext('2d', { alpha: true });
      const updated = root.querySelector('#last-updated');

      // Last updated timestamp
      try {
        const fmt = new Intl.DateTimeFormat([], { dateStyle: 'medium', timeStyle: 'short' });
        updated.textContent = 'Updated ' + fmt.format(new Date());
      } catch { updated.textContent = 'Updated ' + new Date().toLocaleString(); }

      const reducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (reducedMotion) root.classList.add('rm');

      // Controls
      const paletteBtn = root.querySelector('#v148-palette');
      const afterglowBtn = root.querySelector('#v148-afterglow');
      const glowBtn = root.querySelector('#v148-glow');
      const burstBtn = root.querySelector('#v148-burst');
      const reseedBtn = root.querySelector('#v148-reseed');
      const playBtn = root.querySelector('#v148-play');
      const saveBtn = root.querySelector('#v148-save');
      const gravEl = root.querySelector('#v148-grav');
      const gravVal = root.querySelector('#v148-grav-val');
      const popEl = root.querySelector('#v148-pop');
      const popVal = root.querySelector('#v148-pop-val');

      // Size and DPR
      let dpr = 1;
      function size() {
        dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        const rect = stage.getBoundingClientRect();
        canvas.width = Math.floor(rect.width * dpr);
        canvas.height = Math.floor(rect.height * dpr);
        canvas.style.width = rect.width + 'px';
        canvas.style.height = rect.height + 'px';
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        // base clear
        ctx.fillStyle = '#090b12';
        ctx.fillRect(0, 0, rect.width, rect.height);
        starfield(rect.width, rect.height);
      }
      size();
      addEventListener('resize', size);

      // Palettes (nocturne → solar → abyss → prism)
      const palettes = [
        { name: 'Nocturne', inks: ['hsl(195 90% 64%)','hsl(280 88% 66%)','hsl(160 80% 56%)'] },
        { name: 'Solaris', inks: ['hsl(42 95% 60%)','hsl(12 86% 64%)','hsl(190 82% 58%)'] },
        { name: 'Abyss', inks: ['hsl(205 90% 68%)','hsl(185 80% 58%)','hsl(245 70% 68%)'] },
        { name: 'Prism', inks: ['hsl(0 80% 62%)','hsl(46 90% 60%)','hsl(120 80% 58%)','hsl(200 90% 60%)','hsl(283 80% 66%)'] }
      ];
      let paletteIndex = 0;

      function applyPalette(i) {
        const p = palettes[i];
        root.style.setProperty('--a1', p.inks[0 % p.inks.length]);
        root.style.setProperty('--a2', p.inks[1 % p.inks.length]);
        root.style.setProperty('--a3', p.inks[2 % p.inks.length]);
        paletteBtn.textContent = 'Palette: ' + p.name;
        // recolor particles next frame
        particles.forEach((pt, idx) => pt.color = p.inks[idx % p.inks.length]);
        flash(paletteBtn);
      }

      function flash(el) {
        el.classList.add('primary');
        setTimeout(() => el.classList.remove('primary'), 220);
      }

      // Pointer + tilt
      const pointer = { x: 0.5, y: 0.5, down: false };
      function setPointer(e) {
        const rect = stage.getBoundingClientRect();
        const t = e.touches ? e.touches[0] : e;
        pointer.x = (t.clientX - rect.left) / rect.width;
        pointer.y = (t.clientY - rect.top) / rect.height;
        tilt();
      }
      function tilt() {
        if (reducedMotion) return;
        const dx = (pointer.x - 0.5);
        const dy = (pointer.y - 0.5);
        const rx = dy * -5;
        const ry = dx * 5;
        stage.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg)`;
      }
      stage.addEventListener('mousemove', setPointer, { passive: true });
      stage.addEventListener('touchmove', setPointer, { passive: true });
      stage.addEventListener('pointerleave', () => { pointer.x = 0.5; pointer.y = 0.5; tilt(); }, { passive: true });
      stage.addEventListener('pointerdown', () => pointer.down = true);
      stage.addEventListener('pointerup', () => pointer.down = false);

      // Simulation
      let afterglow = true;
      let glow = true;
      let running = !reducedMotion;

      let gMult = 1.2;
      let targetPop = 480;

      const particles = [];
      const center = () => {
        const w = stage.clientWidth, h = stage.clientHeight;
        return { x: w / 2, y: h / 2, r: Math.min(w, h) * 0.5 };
      };

      // Orbiting attractors (one pull, one push)
      const orbiters = [
        { r: 0.28, phase: 0.0, power: 1600 },
        { r: 0.18, phase: 2.1, power: -1100 }
      ];

      function starfield(w, h) {
        // sprinkle subtle stars on clear
        const n = Math.floor((w * h) / 16000);
        ctx.save();
        ctx.globalAlpha = 0.25;
        ctx.globalCompositeOperation = 'screen';
        for (let i = 0; i < n; i++) {
          const x = Math.random() * w, y = Math.random() * h;
          const s = Math.random() * 1.2 + 0.2;
          const hue = 195 + Math.random() * 90;
          ctx.fillStyle = `hsla(${hue} 80% 70% / 0.6)`;
          ctx.fillRect(x, y, s, s);
        }
        ctx.restore();
      }

      function makeParticle(i) {
        const w = stage.clientWidth, h = stage.clientHeight;
        const cx = w / 2, cy = h / 2;
        const ang = Math.random() * Math.PI * 2;
        const rad = Math.random() * 0.48 * Math.min(w, h);
        const x = cx + Math.cos(ang) * rad;
        const y = cy + Math.sin(ang) * rad;
        const p = palettes[paletteIndex].inks;
        return {
          x, y,
          px: x, py: y,
          vx: (Math.random() - 0.5) * 0.2,
          vy: (Math.random() - 0.5) * 0.2,
          color: p[i % p.length]
        };
      }

      function syncPopulation() {
        while (particles.length < targetPop) particles.push(makeParticle(particles.length));
        while (particles.length > targetPop) particles.pop();
      }

      function reseed() {
        for (let i = 0; i < particles.length; i++) {
          const repl = makeParticle(i);
          particles[i].x = repl.x; particles[i].y = repl.y;
          particles[i].px = repl.x; particles[i].py = repl.y;
          particles[i].vx = repl.vx; particles[i].vy = repl.vy;
          particles[i].color = repl.color;
        }
      }

      function burst() {
        const w = stage.clientWidth, h = stage.clientHeight;
        const bx = pointer.x * w, by = pointer.y * h;
        for (let i = 0; i < 80; i++) {
          const idx = Math.floor(Math.random() * particles.length);
          const p = particles[idx];
          const ang = Math.random() * Math.PI * 2;
          const spd = 2 + Math.random() * 3.5;
          p.x = bx; p.y = by; p.px = bx; p.py = by;
          p.vx = Math.cos(ang) * spd; p.vy = Math.sin(ang) * spd;
        }
      }

      function fadeCanvas() {
        const w = stage.clientWidth, h = stage.clientHeight;
        if (afterglow) {
          ctx.globalCompositeOperation = 'source-over';
          ctx.fillStyle = 'rgba(9,11,18,0.06)';
          ctx.fillRect(0, 0, w, h);
        } else {
          ctx.clearRect(0, 0, w, h);
          ctx.fillStyle = '#090b12';
          ctx.fillRect(0, 0, w, h);
          starfield(w, h);
        }
      }

      function draw(now) {
        const w = stage.clientWidth, h = stage.clientHeight;
        const { x: cx, y: cy, r } = center();
        const t = now * 0.001 * gMult;

        // compute dynamic attractor positions
        const atts = orbiters.map(o => ({
          x: cx + Math.cos(t * 0.4 + o.phase) * o.r * Math.min(w, h),
          y: cy + Math.sin(t * 0.4 + o.phase) * o.r * Math.min(w, h),
          power: o.power * gMult
        }));
        if (pointer.down) {
          atts.push({
            x: pointer.x * w,
            y: pointer.y * h,
            power: 2200 * gMult
          });
        }

        const swirl = 0.06 * gMult;
        const maxSpeed = 2.5 * gMult + 0.8;

        // render trails
        ctx.save();
        ctx.globalCompositeOperation = 'lighter';

        for (let i = 0; i < particles.length; i++) {
          const p = particles[i];

          let ax = 0, ay = 0;

          // swirl about center
          const dx0 = p.x - cx, dy0 = p.y - cy;
          ax += -dy0 * swirl * 0.4;
          ay +=  dx0 * swirl * 0.4;

          // attractors
          for (let k = 0; k < atts.length; k++) {
            const a = atts[k];
            const dx = a.x - p.x, dy = a.y - p.y;
            const d2 = dx * dx + dy * dy + 80;
            const f = a.power / d2;
            ax += dx * f; ay += dy * f;
          }

          // integrate
          p.vx = (p.vx + ax) * 0.992;
          p.vy = (p.vy + ay) * 0.992;

          // clamp
          const sp = Math.hypot(p.vx, p.vy);
          if (sp > maxSpeed) { const s = maxSpeed / sp; p.vx *= s; p.vy *= s; }

          // trail from previous position
          const ox = p.x, oy = p.y;
          p.x += p.vx; p.y += p.vy;

          // wrap softly
          if (p.x < -20) { p.x = w + 20; p.px = p.x; }
          if (p.x > w + 20) { p.x = -20; p.px = p.x; }
          if (p.y < -20) { p.y = h + 20; p.py = p.y; }
          if (p.y > h + 20) { p.y = -20; p.py = p.y; }

          // draw
          ctx.lineJoin = 'round';
          ctx.lineCap = 'round';
          ctx.strokeStyle = p.color;
          ctx.lineWidth = 1 + Math.min(1.6, sp * 0.12);

          if (glow) { ctx.shadowColor = p.color; ctx.shadowBlur = 12; }
          else { ctx.shadowBlur = 0; }

          ctx.beginPath();
          ctx.moveTo(ox, oy);
          ctx.lineTo(p.x, p.y);
          ctx.stroke();
        }
        ctx.restore();
      }

      // Animation loop
      let last = performance.now();
      function tick(now) {
        if (!running) return;
        fadeCanvas();
        draw(now);
        if (!reducedMotion) requestAnimationFrame(tick);
      }

      function setGrav(v) {
        const mult = Math.max(0.4, Math.min(3.0, Math.round((v / 100) * 10) / 10));
        gMult = mult;
        root.style.setProperty('--tempo', String(mult));
        gravVal.textContent = mult.toFixed(1) + '×';
      }
      function setPop(v) {
        targetPop = Math.max(120, Math.min(2000, v | 0));
        popVal.textContent = String(targetPop);
        syncPopulation();
      }

      afterglowBtn.addEventListener('click', () => {
        afterglow = !afterglow;
        afterglowBtn.setAttribute('aria-pressed', afterglow ? 'true' : 'false');
        flash(afterglowBtn);
      });

      glowBtn.addEventListener('click', () => {
        glow = !glow;
        glowBtn.setAttribute('aria-pressed', glow ? 'true' : 'false');
        flash(glowBtn);
      });

      playBtn.addEventListener('click', () => {
        running = !running;
        playBtn.textContent = running ? 'Pause' : 'Play';
        flash(playBtn);
        if (running && !reducedMotion) requestAnimationFrame((t) => { last = t; tick(t); });
      });

      saveBtn.addEventListener('click', () => {
        try {
          const link = document.createElement('a');
          link.download = 'orbit-forge.png';
          link.href = canvas.toDataURL('image/png');
          link.click();
          flash(saveBtn);
        } catch {}
      });

      burstBtn.addEventListener('click', () => { burst(); flash(burstBtn); });
      reseedBtn.addEventListener('click', () => { reseed(); flash(reseedBtn); });

      paletteBtn.addEventListener('click', () => {
        paletteIndex = (paletteIndex + 1) % palettes.length;
        applyPalette(paletteIndex);
      });

      gravEl.addEventListener('input', (e) => setGrav(Number(e.target.value)));
      popEl.addEventListener('input', (e) => setPop(Number(e.target.value)));

      // Keyboard shortcuts
      root.addEventListener('keydown', (e) => {
        const k = e.key.toLowerCase();
        if (k === ' ') { e.preventDefault(); playBtn.click(); }
        if (k === 'g') glowBtn.click();     // Glow
        if (k === 'a') afterglowBtn.click();// Afterglow
        if (k === 'p') paletteBtn.click();  // Palette
        if (k === 's') saveBtn.click();     // Save
        if (k === 'r') reseedBtn.click();   // Reseed
        if (k === 'b') burstBtn.click();    // Burst
      });

      // Init
      applyPalette(paletteIndex);
      setGrav(Number(gravEl.value));
      setPop(Number(popEl.value));
      syncPopulation();
      if (!reducedMotion) requestAnimationFrame((t) => { last = t; tick(t); });
      else {
        // Static snapshot
        fadeCanvas();
        draw(performance.now());
      }

      // Rebuild on resize
      addEventListener('resize', () => {
        size();
        syncPopulation();
      });
    })();
  </script>
</section>
      </section>
      <!-- END_EDITABLE -->
    <script>
      // Only show a local placeholder if the agent hasn't written a timestamp yet
      const el = document.getElementById('last-updated');
      if (el && (!el.textContent || el.textContent.includes('not yet'))) {
        const now = new Date();
        el.textContent = `Last updated: ${now.toLocaleString(undefined, { hour12: false })}`;
      }
    </script>
  </body>
  </html>


